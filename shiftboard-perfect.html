<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>シフト管理</title>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        background: #FFFFFF;
        -webkit-font-smoothing: antialiased;
        line-height: 1.4;
      }
      
      .header {
        padding: 16px;
        border-bottom: 1px solid #E0E0E0;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      
      .header-title {
        font-size: 18px;
        font-weight: 500;
        color: #333;
      }
      
      .header-subtitle {
        font-size: 14px;
        color: #666;
      }
      
      .calendar-container {
        padding: 16px;
      }
      
      .weekdays {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 1px;
        margin-bottom: 8px;
      }
      
      .weekday {
        text-align: center;
        padding: 4px;
        font-size: 12px;
        font-weight: 500;
      }
      
      .weekday.sunday { color: #FF5252; }
      .weekday.saturday { color: #2196F3; }
      .weekday.normal { color: #666; }
      
      .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 1px;
      }
      
      .calendar-cell {
        aspect-ratio: 1;
        border: 1px solid #E0E0E0;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        cursor: pointer;
        background: #FFFFFF;
        transition: background 0.2s ease;
      }
      
      .calendar-cell:hover {
        background: #F5F5F5;
      }
      
      .calendar-cell.today {
        background: #E3F2FD;
      }
      
      .calendar-cell.today:hover {
        background: #BBDEFB;
      }
      
      .calendar-cell.disabled {
        cursor: default;
        opacity: 0.3;
      }
      
      .calendar-cell.disabled:hover {
        background: #FFFFFF;
      }
      
      .calendar-day {
        font-size: 14px;
        color: #333;
      }
      
      .calendar-day.today {
        font-weight: 500;
      }
      
      .shift-dot {
        position: absolute;
        top: 4px;
        right: 4px;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #4CAF50;
      }
      
      .shift-dot.warning {
        background: #FF9800;
      }
      
      .shift-dot.danger {
        background: #F44336;
      }
      
      .earnings-section {
        padding: 16px;
        border-top: 1px solid #E0E0E0;
      }
      
      .earnings-label {
        font-size: 14px;
        color: #666;
        margin-bottom: 8px;
      }
      
      .earnings-amount {
        font-size: 24px;
        font-weight: 500;
        color: #333;
      }
      
      .fuyou-warning {
        font-size: 12px;
        margin-top: 4px;
      }
      
      .fuyou-warning.warning {
        color: #FF9800;
      }
      
      .fuyou-warning.danger {
        color: #F44336;
      }
      
      .overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.3);
        z-index: 999;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease;
      }
      
      .overlay.show {
        opacity: 1;
        visibility: visible;
      }
      
      .bottom-sheet {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: #FFFFFF;
        border-top: 1px solid #E0E0E0;
        border-radius: 16px 16px 0 0;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        z-index: 1000;
        transform: translateY(100%);
        transition: transform 0.3s ease-out;
      }
      
      .bottom-sheet.show {
        transform: translateY(0);
      }
      
      .sheet-content {
        padding: 24px;
      }
      
      .sheet-title {
        font-size: 18px;
        font-weight: 500;
        margin-bottom: 24px;
        color: #333;
      }
      
      .form-group {
        margin-bottom: 16px;
      }
      
      .form-label {
        font-size: 14px;
        color: #666;
        margin-bottom: 8px;
        display: block;
      }
      
      .form-input {
        width: 100%;
        padding: 12px;
        border: 1px solid #E0E0E0;
        border-radius: 8px;
        font-size: 16px;
        background: #FFFFFF;
      }
      
      .form-input:focus {
        outline: none;
        border-color: #4CAF50;
      }
      
      .time-inputs {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      
      .time-inputs input {
        flex: 1;
      }
      
      .time-separator {
        color: #666;
        font-size: 14px;
      }
      
      .history-section {
        margin-bottom: 24px;
      }
      
      .history-item {
        padding: 12px;
        margin-bottom: 8px;
        border: 1px solid #E0E0E0;
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.2s ease;
      }
      
      .history-item:hover {
        background: #F5F5F5;
      }
      
      .history-main {
        font-size: 14px;
        color: #333;
        margin-bottom: 4px;
      }
      
      .history-sub {
        font-size: 12px;
        color: #666;
      }
      
      .earnings-preview {
        padding: 16px;
        background: #F5F5F5;
        border-radius: 8px;
        margin-bottom: 24px;
      }
      
      .preview-label {
        font-size: 14px;
        color: #666;
        margin-bottom: 4px;
      }
      
      .preview-amount {
        font-size: 20px;
        font-weight: 500;
        color: #333;
      }
      
      .button-group {
        display: flex;
        gap: 8px;
      }
      
      .button {
        flex: 1;
        padding: 12px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        transition: background 0.2s ease;
      }
      
      .button.primary {
        background: #4CAF50;
        color: #FFFFFF;
      }
      
      .button.primary:hover {
        background: #45A049;
      }
      
      .button.primary:disabled {
        background: #E0E0E0;
        color: #999;
        cursor: not-allowed;
      }
      
      .button.secondary {
        background: #FFFFFF;
        color: #666;
        border: 1px solid #E0E0E0;
      }
      
      .button.secondary:hover {
        background: #F5F5F5;
      }
      
      .shift-list {
        margin-bottom: 16px;
      }
      
      .shift-item {
        padding: 16px;
        margin-bottom: 8px;
        border: 1px solid #E0E0E0;
        border-radius: 8px;
      }
      
      .shift-time {
        font-size: 16px;
        font-weight: 500;
        color: #333;
        margin-bottom: 4px;
      }
      
      .shift-workplace {
        font-size: 14px;
        color: #666;
        margin-bottom: 4px;
      }
      
      .shift-earnings {
        font-size: 14px;
        font-weight: 500;
        color: #4CAF50;
      }
      
      @keyframes slideUp {
        from { transform: translateY(100%); }
        to { transform: translateY(0); }
      }
    </style>
  </head>
  <body>
    <div id="app"></div>

    <script>
      // ローカルストレージのユーティリティ
      const storage = {
        get(key, defaultValue = null) {
          try {
            const item = localStorage.getItem(key);
            return item ? JSON.parse(item) : defaultValue;
          } catch (error) {
            console.warn('localStorage read error:', error);
            return defaultValue;
          }
        },
        set(key, value) {
          try {
            localStorage.setItem(key, JSON.stringify(value));
          } catch (error) {
            console.warn('localStorage write error:', error);
          }
        }
      };

      // アプリ状態
      let state = {
        shifts: storage.get('fuyou_shifts', []),
        yearlyTotal: storage.get('fuyou_yearly_total', 0),
        shiftHistory: storage.get('fuyou_shift_history', []),
        selectedDate: null,
        showDetail: false
      };

      // 状態更新とレンダリング
      function setState(updates) {
        state = { ...state, ...updates };
        render();
        
        // データ保存
        storage.set('fuyou_shifts', state.shifts);
        storage.set('fuyou_yearly_total', state.yearlyTotal);
        storage.set('fuyou_shift_history', state.shiftHistory);
      }

      // 定数
      const FUYOU_LIMIT = 1030000;

      // ユーティリティ関数
      function getCurrentYearMonth() {
        const now = new Date();
        return {
          year: now.getFullYear(),
          month: now.getMonth(),
          yearMonth: `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`
        };
      }

      function formatDate(day) {
        const { yearMonth } = getCurrentYearMonth();
        return `${yearMonth}-${String(day).padStart(2, '0')}`;
      }

      function getShiftsForDate(day) {
        if (!day) return [];
        const dateStr = formatDate(day);
        return state.shifts.filter(shift => shift.date === dateStr);
      }

      function calculateMonthlyEarnings() {
        const { yearMonth } = getCurrentYearMonth();
        return state.shifts
          .filter(shift => shift.date.startsWith(yearMonth))
          .reduce((sum, shift) => sum + shift.earnings, 0);
      }

      function getFuyouRisk() {
        const percentage = (state.yearlyTotal / FUYOU_LIMIT) * 100;
        if (percentage > 95) return 'danger';
        if (percentage > 90) return 'warning';
        return 'safe';
      }

      function generateCalendar() {
        const { year, month } = getCurrentYearMonth();
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        
        const calendar = [];
        
        // 前月の空白
        for (let i = 0; i < firstDay; i++) {
          calendar.push(null);
        }
        
        // 当月の日付
        for (let day = 1; day <= daysInMonth; day++) {
          calendar.push(day);
        }
        
        return calendar;
      }

      // イベントハンドラー
      function handleDateClick(day) {
        if (!day) return;
        setState({ selectedDate: day, showDetail: true });
      }

      function handleCloseDetail() {
        setState({ showDetail: false });
        setTimeout(() => setState({ selectedDate: null }), 300);
      }

      function handleAddShift(shiftData) {
        const newShift = {
          id: Date.now(),
          date: formatDate(state.selectedDate),
          ...shiftData
        };

        // シフト追加
        const newShifts = [...state.shifts, newShift];
        
        // 年間合計更新
        const newYearlyTotal = state.yearlyTotal + newShift.earnings;
        
        // 履歴更新
        const historyKey = `${shiftData.startTime}-${shiftData.endTime}-${shiftData.workplace}`;
        let newHistory = [...state.shiftHistory];
        
        if (!newHistory.some(h => `${h.startTime}-${h.endTime}-${h.workplace}` === historyKey)) {
          newHistory = [{
            startTime: shiftData.startTime,
            endTime: shiftData.endTime,
            workplace: shiftData.workplace,
            hourlyWage: shiftData.hourlyWage
          }, ...newHistory].slice(0, 5);
        }

        setState({
          shifts: newShifts,
          yearlyTotal: newYearlyTotal,
          shiftHistory: newHistory,
          showDetail: false,
          selectedDate: null
        });
      }

      // コンポーネント
      function Calendar() {
        const calendar = generateCalendar();
        const fuyouRisk = getFuyouRisk();
        const today = new Date().getDate();

        return `
          <div class="calendar-container">
            <div class="weekdays">
              <div class="weekday sunday">日</div>
              <div class="weekday normal">月</div>
              <div class="weekday normal">火</div>
              <div class="weekday normal">水</div>
              <div class="weekday normal">木</div>
              <div class="weekday normal">金</div>
              <div class="weekday saturday">土</div>
            </div>
            <div class="calendar-grid">
              ${calendar.map((day, index) => {
                const isToday = day === today;
                const hasShift = getShiftsForDate(day).length > 0;
                const cellClass = [
                  'calendar-cell',
                  isToday ? 'today' : '',
                  !day ? 'disabled' : ''
                ].filter(Boolean).join(' ');

                return `
                  <div class="${cellClass}" onclick="${day ? `handleDateClick(${day})` : ''}">
                    ${day ? `
                      <div class="calendar-day ${isToday ? 'today' : ''}">${day}</div>
                      ${hasShift ? `<div class="shift-dot ${fuyouRisk}"></div>` : ''}
                    ` : ''}
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        `;
      }

      function EarningsSection() {
        const monthlyEarnings = calculateMonthlyEarnings();
        const remaining = Math.max(0, FUYOU_LIMIT - state.yearlyTotal);
        const percentage = (state.yearlyTotal / FUYOU_LIMIT) * 100;
        const fuyouRisk = getFuyouRisk();

        return `
          <div class="earnings-section">
            <div class="earnings-label">今月の給料</div>
            <div class="earnings-amount">¥${monthlyEarnings.toLocaleString()}</div>
            ${percentage >= 90 ? `
              <div class="fuyou-warning ${fuyouRisk}">
                扶養まで: あと¥${remaining.toLocaleString()}
              </div>
            ` : ''}
          </div>
        `;
      }

      function ShiftForm() {
        const existingShifts = getShiftsForDate(state.selectedDate);
        
        if (existingShifts.length > 0) {
          return `
            <div class="sheet-content">
              <div class="sheet-title">${state.selectedDate}日のシフト</div>
              <div class="shift-list">
                ${existingShifts.map(shift => `
                  <div class="shift-item">
                    <div class="shift-time">${shift.startTime} - ${shift.endTime}</div>
                    <div class="shift-workplace">${shift.workplace}</div>
                    <div class="shift-earnings">¥${shift.earnings.toLocaleString()}</div>
                  </div>
                `).join('')}
              </div>
              <button class="button secondary" onclick="handleCloseDetail()">閉じる</button>
            </div>
          `;
        }

        return `
          <div class="sheet-content">
            <div class="sheet-title">${state.selectedDate}日のシフト追加</div>
            
            ${state.shiftHistory.length > 0 ? `
              <div class="history-section">
                <div class="form-label">履歴から選択</div>
                ${state.shiftHistory.map((item, index) => `
                  <div class="history-item" onclick="selectFromHistory(${index})">
                    <div class="history-main">${item.startTime}-${item.endTime} ${item.workplace}</div>
                    <div class="history-sub">時給¥${item.hourlyWage}</div>
                  </div>
                `).join('')}
              </div>
            ` : ''}

            <form id="shiftForm">
              <div class="form-group">
                <label class="form-label">時間</label>
                <div class="time-inputs">
                  <input type="time" id="startTime" class="form-input" value="10:00" required>
                  <span class="time-separator">〜</span>
                  <input type="time" id="endTime" class="form-input" value="18:00" required>
                </div>
              </div>

              <div class="form-group">
                <label class="form-label">勤務先</label>
                <input type="text" id="workplace" class="form-input" placeholder="例: コンビニ" required>
              </div>

              <div class="form-group">
                <label class="form-label">時給</label>
                <input type="number" id="hourlyWage" class="form-input" value="1000" min="1" required>
              </div>

              <div class="earnings-preview">
                <div class="preview-label">予定給料</div>
                <div class="preview-amount" id="previewEarnings">¥0</div>
              </div>

              <div class="button-group">
                <button type="submit" class="button primary">追加</button>
                <button type="button" class="button secondary" onclick="handleCloseDetail()">キャンセル</button>
              </div>
            </form>
          </div>
        `;
      }

      function BottomSheet() {
        if (!state.selectedDate) return '';

        return `
          <div class="overlay ${state.showDetail ? 'show' : ''}" onclick="handleCloseDetail()"></div>
          <div class="bottom-sheet ${state.showDetail ? 'show' : ''}">
            ${ShiftForm()}
          </div>
        `;
      }

      // メインレンダリング
      function render() {
        const app = document.getElementById('app');
        app.innerHTML = `
          <div class="header">
            <div class="header-title">
              ${new Date().getFullYear()}年${new Date().getMonth() + 1}月
            </div>
            <div class="header-subtitle">シフト管理</div>
          </div>
          
          ${Calendar()}
          ${EarningsSection()}
          ${BottomSheet()}
        `;

        // フォームイベントリスナー
        const form = document.getElementById('shiftForm');
        if (form) {
          form.addEventListener('submit', handleFormSubmit);
          
          // 給料プレビュー更新
          const inputs = ['startTime', 'endTime', 'hourlyWage'];
          inputs.forEach(id => {
            const input = document.getElementById(id);
            if (input) {
              input.addEventListener('input', updatePreview);
            }
          });
          
          updatePreview();
        }
      }

      // フォーム処理
      function handleFormSubmit(e) {
        e.preventDefault();
        
        const formData = new FormData(e.target);
        const startTime = document.getElementById('startTime').value;
        const endTime = document.getElementById('endTime').value;
        const workplace = document.getElementById('workplace').value;
        const hourlyWage = parseInt(document.getElementById('hourlyWage').value);
        
        if (!startTime || !endTime || !workplace || !hourlyWage) {
          alert('すべての項目を入力してください');
          return;
        }
        
        const earnings = calculateEarnings(startTime, endTime, hourlyWage);
        
        handleAddShift({
          startTime,
          endTime,
          workplace,
          hourlyWage,
          earnings
        });
      }

      function calculateEarnings(startTime, endTime, hourlyWage) {
        const start = new Date(`2000-01-01T${startTime}`);
        const end = new Date(`2000-01-01T${endTime}`);
        const hours = (end - start) / (1000 * 60 * 60);
        return Math.round(hours * hourlyWage);
      }

      function updatePreview() {
        const startTime = document.getElementById('startTime')?.value;
        const endTime = document.getElementById('endTime')?.value;
        const hourlyWage = document.getElementById('hourlyWage')?.value;
        const preview = document.getElementById('previewEarnings');
        
        if (startTime && endTime && hourlyWage && preview) {
          const earnings = calculateEarnings(startTime, endTime, parseInt(hourlyWage));
          preview.textContent = `¥${earnings.toLocaleString()}`;
        }
      }

      function selectFromHistory(index) {
        const item = state.shiftHistory[index];
        if (item) {
          document.getElementById('startTime').value = item.startTime;
          document.getElementById('endTime').value = item.endTime;
          document.getElementById('workplace').value = item.workplace;
          document.getElementById('hourlyWage').value = item.hourlyWage;
          updatePreview();
        }
      }

      // 初期レンダリング
      render();
    </script>
  </body>
</html>