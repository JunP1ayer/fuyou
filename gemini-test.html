<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini API ãƒ†ã‚¹ãƒˆ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #45a049; }
    </style>
</head>
<body>
    <h1>ğŸ¤– Gemini API ãƒ†ã‚¹ãƒˆ</h1>
    
    <div class="test-section">
        <h2>åŸºæœ¬ãƒ†ã‚¹ãƒˆ</h2>
        <button onclick="testBasicLoad()">åŸºæœ¬ãƒ­ãƒ¼ãƒ‰ãƒ†ã‚¹ãƒˆ</button>
        <button onclick="testGeminiService()">Gemini Service ãƒ†ã‚¹ãƒˆ</button>
        <button onclick="testAIVisionService()">AI Vision Service ãƒ†ã‚¹ãƒˆ</button>
        <div id="basicResult" class="result"></div>
    </div>

    <div class="test-section">
        <h2>ãƒ¢ãƒƒã‚¯è§£æãƒ†ã‚¹ãƒˆ</h2>
        <button onclick="testMockAnalysis()">ãƒ¢ãƒƒã‚¯è§£æå®Ÿè¡Œ</button>
        <div id="mockResult" class="result"></div>
    </div>

    <div class="test-section">
        <h2>ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆ</h2>
        <button onclick="testErrorHandling()">ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°</button>
        <div id="errorResult" class="result"></div>
    </div>

    <!-- ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿ -->
    <script src="config.js"></script>
    <script src="gemini-vision-service.js"></script>
    <script src="ai-vision-service.js"></script>

    <script>
        function showResult(elementId, className, message) {
            const element = document.getElementById(elementId);
            element.className = `result ${className}`;
            element.innerHTML = message;
        }

        function testBasicLoad() {
            try {
                let results = [];
                
                // è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ†ã‚¹ãƒˆ
                if (typeof window.FUYOU_CONFIG !== 'undefined') {
                    results.push('âœ… Config èª­ã¿è¾¼ã¿æˆåŠŸ');
                } else {
                    results.push('âŒ Config èª­ã¿è¾¼ã¿å¤±æ•—');
                }

                // Gemini Service ã®ãƒ†ã‚¹ãƒˆ
                if (typeof GeminiVisionService !== 'undefined') {
                    results.push('âœ… GeminiVisionService å®šç¾©ç¢ºèª');
                    
                    try {
                        const geminiService = new GeminiVisionService();
                        results.push('âœ… GeminiVisionService ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆæˆåŠŸ');
                        
                        if (typeof geminiService.isAvailable === 'function') {
                            results.push('âœ… isAvailable ãƒ¡ã‚½ãƒƒãƒ‰ç¢ºèª');
                        } else {
                            results.push('âŒ isAvailable ãƒ¡ã‚½ãƒƒãƒ‰ãªã—');
                        }
                        
                    } catch (e) {
                        results.push(`âŒ GeminiVisionService ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆå¤±æ•—: ${e.message}`);
                    }
                } else {
                    results.push('âŒ GeminiVisionService æœªå®šç¾©');
                }

                // AI Vision Service ã®ãƒ†ã‚¹ãƒˆ
                if (typeof AIVisionService !== 'undefined') {
                    results.push('âœ… AIVisionService å®šç¾©ç¢ºèª');
                    
                    try {
                        const aiService = new AIVisionService();
                        results.push('âœ… AIVisionService ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆæˆåŠŸ');
                        
                        if (typeof aiService.initializeGeminiService === 'function') {
                            results.push('âœ… initializeGeminiService ãƒ¡ã‚½ãƒƒãƒ‰ç¢ºèª');
                            const initResult = aiService.initializeGeminiService();
                            results.push(`Gemini åˆæœŸåŒ–çµæœ: ${initResult ? 'æˆåŠŸ' : 'å¤±æ•—'}`);
                        } else {
                            results.push('âŒ initializeGeminiService ãƒ¡ã‚½ãƒƒãƒ‰ãªã—');
                        }
                        
                    } catch (e) {
                        results.push(`âŒ AIVisionService ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆå¤±æ•—: ${e.message}`);
                    }
                } else {
                    results.push('âŒ AIVisionService æœªå®šç¾©');
                }

                showResult('basicResult', 'success', results.join('<br>'));
                
            } catch (error) {
                showResult('basicResult', 'error', `åŸºæœ¬ãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}`);
            }
        }

        function testGeminiService() {
            try {
                if (typeof GeminiVisionService === 'undefined') {
                    throw new Error('GeminiVisionService ãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                }

                const geminiService = new GeminiVisionService();
                const results = [];

                // APIã‚­ãƒ¼è¨­å®šãƒã‚§ãƒƒã‚¯
                const isAvailable = geminiService.isAvailable();
                results.push(`API åˆ©ç”¨å¯èƒ½æ€§: ${isAvailable ? 'âœ…' : 'âŒ'} (${isAvailable ? 'APIã‚­ãƒ¼è¨­å®šæ¸ˆã¿' : 'APIã‚­ãƒ¼æœªè¨­å®š'})`);

                // ãƒ¡ã‚½ãƒƒãƒ‰å­˜åœ¨ç¢ºèª
                const methods = ['analyzeShiftTable', 'getMockResponse', 'checkImageQuality', 'generateMockShifts'];
                methods.forEach(method => {
                    if (typeof geminiService[method] === 'function') {
                        results.push(`âœ… ${method} ãƒ¡ã‚½ãƒƒãƒ‰å­˜åœ¨`);
                    } else {
                        results.push(`âŒ ${method} ãƒ¡ã‚½ãƒƒãƒ‰ä¸å­˜åœ¨`);
                    }
                });

                showResult('basicResult', 'success', results.join('<br>'));

            } catch (error) {
                showResult('basicResult', 'error', `Gemini Service ãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}`);
            }
        }

        function testAIVisionService() {
            try {
                if (typeof AIVisionService === 'undefined') {
                    throw new Error('AIVisionService ãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                }

                const aiService = new AIVisionService();
                const results = [];

                // Gemini åˆæœŸåŒ–ãƒ†ã‚¹ãƒˆ
                const geminiInit = aiService.initializeGeminiService();
                results.push(`Gemini åˆæœŸåŒ–: ${geminiInit ? 'âœ…' : 'âŒ'}`);

                // Gemini Service ç¢ºèª
                if (aiService.geminiService) {
                    results.push('âœ… Gemini Service é€£æºæˆåŠŸ');
                    const geminiAvailable = aiService.geminiService.isAvailable();
                    results.push(`Gemini åˆ©ç”¨å¯èƒ½æ€§: ${geminiAvailable ? 'âœ…' : 'âŒ'}`);
                } else {
                    results.push('âŒ Gemini Service é€£æºå¤±æ•—');
                }

                // è¤‡æ•°ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼å¯¾å¿œç¢ºèª
                if (typeof aiService.analyzeWithMultipleProviders === 'function') {
                    results.push('âœ… è¤‡æ•°ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼å¯¾å¿œãƒ¡ã‚½ãƒƒãƒ‰å­˜åœ¨');
                } else {
                    results.push('âŒ è¤‡æ•°ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼å¯¾å¿œãƒ¡ã‚½ãƒƒãƒ‰ä¸å­˜åœ¨');
                }

                showResult('basicResult', 'success', results.join('<br>'));

            } catch (error) {
                showResult('basicResult', 'error', `AI Vision Service ãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}`);
            }
        }

        async function testMockAnalysis() {
            try {
                if (typeof GeminiVisionService === 'undefined') {
                    throw new Error('GeminiVisionService ãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                }

                showResult('mockResult', 'warning', 'ğŸ”„ ãƒ¢ãƒƒã‚¯è§£æãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...');

                const geminiService = new GeminiVisionService();
                
                // ãƒ†ã‚¹ãƒˆç”¨ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
                const mockFile = new File(['test image data'], 'test-shift.jpg', { 
                    type: 'image/jpeg',
                    lastModified: Date.now()
                });

                // ãƒ¢ãƒƒã‚¯è§£æå®Ÿè¡Œ
                const result = await geminiService.getMockResponse(mockFile);

                const results = [];
                results.push(`âœ… ãƒ¢ãƒƒã‚¯è§£æå®Œäº†`);
                results.push(`æˆåŠŸãƒ•ãƒ©ã‚°: ${result.success ? 'âœ…' : 'âŒ'}`);
                results.push(`ã‚·ãƒ•ãƒˆæ•°: ${result.shifts ? result.shifts.length : 0}ä»¶`);
                results.push(`ä¿¡é ¼åº¦: ${Math.round((result.confidence || 0) * 100)}%`);
                results.push(`ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼: ${result.metadata?.provider || 'unknown'}`);
                results.push(`ãƒ‡ãƒ¢ãƒ•ãƒ©ã‚°: ${result.metadata?.isDemo ? 'âœ…' : 'âŒ'}`);

                if (result.shifts && result.shifts.length > 0) {
                    results.push('<br><strong>ç”Ÿæˆã•ã‚ŒãŸã‚·ãƒ•ãƒˆä¾‹:</strong>');
                    const firstShift = result.shifts[0];
                    results.push(`â€¢ æ—¥ä»˜: ${firstShift.date}`);
                    results.push(`â€¢ æ™‚é–“: ${firstShift.startTime} - ${firstShift.endTime}`);
                    results.push(`â€¢ å‹¤å‹™å…ˆ: ${firstShift.workplaceName}`);
                    results.push(`â€¢ åŠ´åƒæ™‚é–“: ${firstShift.hours}æ™‚é–“`);
                }

                showResult('mockResult', 'success', results.join('<br>'));

            } catch (error) {
                showResult('mockResult', 'error', `ãƒ¢ãƒƒã‚¯è§£æãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}<br>Stack: ${error.stack}`);
            }
        }

        async function testErrorHandling() {
            try {
                showResult('errorResult', 'warning', 'ğŸ”„ ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...');

                const results = [];

                // 1. ç„¡åŠ¹ãªãƒ•ã‚¡ã‚¤ãƒ«ã§ã®ãƒ†ã‚¹ãƒˆ
                try {
                    const geminiService = new GeminiVisionService();
                    const invalidFile = new File([''], 'invalid.txt', { type: 'text/plain' });
                    
                    const result = await geminiService.analyzeShiftTable(invalidFile);
                    results.push('âœ… ç„¡åŠ¹ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†: ãƒ¢ãƒƒã‚¯ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã§æ­£å¸¸å‡¦ç†');
                    results.push(`ãƒ¬ã‚¹ãƒãƒ³ã‚¹æˆåŠŸ: ${result.success ? 'âœ…' : 'âŒ'}`);
                    
                    if (result.metadata?.isFallback) {
                        results.push('âœ… ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿèƒ½å‹•ä½œç¢ºèª');
                    }
                    
                } catch (error) {
                    results.push(`âŒ ç„¡åŠ¹ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                }

                // 2. AIVisionService ã®è¤‡æ•°ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ãƒ†ã‚¹ãƒˆ
                try {
                    const aiService = new AIVisionService();
                    aiService.initializeGeminiService();
                    
                    const testFile = new File(['test'], 'test.jpg', { type: 'image/jpeg' });
                    const result = await aiService.analyzeWithMultipleProviders(testFile);
                    
                    results.push('âœ… è¤‡æ•°ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ãƒ†ã‚¹ãƒˆæˆåŠŸ');
                    results.push(`ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼: ${result.metadata?.provider || 'unknown'}`);
                    
                } catch (error) {
                    results.push(`âŒ è¤‡æ•°ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}`);
                }

                // 3. è¨­å®šãƒã‚§ãƒƒã‚¯
                const config = window.FUYOU_CONFIG || {};
                results.push('<br><strong>è¨­å®šç¢ºèª:</strong>');
                results.push(`Gemini APIã‚­ãƒ¼è¨­å®š: ${config.api?.gemini?.apiKey ? 'âœ…' : 'âŒ'}`);
                results.push(`Gemini æœ‰åŠ¹åŒ–: ${config.api?.gemini?.enabled ? 'âœ…' : 'âŒ'}`);
                results.push(`ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æœ‰åŠ¹: ${config.api?.fallback?.enableMockService !== false ? 'âœ…' : 'âŒ'}`);

                showResult('errorResult', 'success', results.join('<br>'));

            } catch (error) {
                showResult('errorResult', 'error', `ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}<br>Stack: ${error.stack}`);
            }
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸãƒã‚§ãƒƒã‚¯
        window.addEventListener('DOMContentLoaded', () => {
            console.log('Gemini ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†');
            
            // åŸºæœ¬çš„ãªå¯ç”¨æ€§ãƒã‚§ãƒƒã‚¯
            const checks = [];
            checks.push(`window.FUYOU_CONFIG: ${typeof window.FUYOU_CONFIG !== 'undefined' ? 'âœ…' : 'âŒ'}`);
            checks.push(`GeminiVisionService: ${typeof GeminiVisionService !== 'undefined' ? 'âœ…' : 'âŒ'}`);
            checks.push(`AIVisionService: ${typeof AIVisionService !== 'undefined' ? 'âœ…' : 'âŒ'}`);
            
            console.log('åˆæœŸãƒã‚§ãƒƒã‚¯çµæœ:', checks);
        });
    </script>
</body>
</html>