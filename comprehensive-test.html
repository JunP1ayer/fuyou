<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰¶é¤Šãƒ—ãƒ­ åŒ…æ‹¬çš„å‹•ä½œç¢ºèªãƒ†ã‚¹ãƒˆ</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 32px;
            color: #333;
        }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }
        .test-card { 
            background: #f8f9fa; 
            padding: 20px; 
            border-radius: 12px; 
            border: 1px solid #e9ecef;
            transition: all 0.3s ease;
        }
        .test-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        .test-card h3 {
            margin: 0 0 16px;
            color: #495057;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .result { 
            padding: 12px; 
            margin: 12px 0; 
            border-radius: 8px; 
            font-family: 'SF Mono', 'Monaco', 'Cascadia Code', monospace;
            font-size: 14px;
            line-height: 1.4;
            min-height: 100px;
            overflow-y: auto;
            max-height: 300px;
        }
        .success { background: #d1f2eb; color: #0e6b3a; border-left: 4px solid #28a745; }
        .error { background: #f8d7da; color: #721c24; border-left: 4px solid #dc3545; }
        .warning { background: #fff3cd; color: #856404; border-left: 4px solid #ffc107; }
        .info { background: #cce7ff; color: #004085; border-left: 4px solid #007bff; }
        .loading { background: #e2e3e5; color: #6c757d; border-left: 4px solid #6c757d; }
        
        button { 
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white; 
            border: none; 
            padding: 12px 24px; 
            border-radius: 8px; 
            cursor: pointer; 
            margin: 6px 4px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        button:hover { 
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .test-all-btn {
            background: linear-gradient(135deg, #007bff, #0056b3);
            font-size: 16px;
            padding: 16px 32px;
            margin: 20px auto;
            display: block;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 24px;
        }
        .stat-card {
            background: #f8f9fa;
            padding: 16px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #495057;
        }
        .stat-label {
            font-size: 14px;
            color: #6c757d;
        }
        
        .feature-status {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 8px 0;
        }
        .status-icon {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        .status-working { background: #28a745; }
        .status-error { background: #dc3545; }
        .status-warning { background: #ffc107; }
        .status-unknown { background: #6c757d; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ§ª æ‰¶é¤Šãƒ—ãƒ­ åŒ…æ‹¬çš„å‹•ä½œç¢ºèªãƒ†ã‚¹ãƒˆ</h1>
            <p>å…¨æ©Ÿèƒ½ã®å‹•ä½œçŠ¶æ³ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ç¢ºèªã—ã¾ã™</p>
            <button class="test-all-btn" onclick="runAllTests()">ğŸš€ å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
        </div>

        <div class="test-grid">
            <!-- åŸºæœ¬ã‚·ã‚¹ãƒ†ãƒ ç¢ºèª -->
            <div class="test-card">
                <h3>âš™ï¸ åŸºæœ¬ã‚·ã‚¹ãƒ†ãƒ </h3>
                <button onclick="testBasicSystem()">ã‚·ã‚¹ãƒ†ãƒ ç¢ºèª</button>
                <div id="basicResult" class="result">ãƒ†ã‚¹ãƒˆæœªå®Ÿè¡Œ</div>
            </div>

            <!-- è¨­å®šãƒ»æ§‹æˆç¢ºèª -->
            <div class="test-card">
                <h3>ğŸ”§ è¨­å®šãƒ»æ§‹æˆ</h3>
                <button onclick="testConfiguration()">è¨­å®šç¢ºèª</button>
                <div id="configResult" class="result">ãƒ†ã‚¹ãƒˆæœªå®Ÿè¡Œ</div>
            </div>

            <!-- AIæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ -->
            <div class="test-card">
                <h3>ğŸ¤– AIæ©Ÿèƒ½</h3>
                <button onclick="testAIFeatures()">AI ãƒ†ã‚¹ãƒˆ</button>
                <div id="aiResult" class="result">ãƒ†ã‚¹ãƒˆæœªå®Ÿè¡Œ</div>
            </div>

            <!-- ãƒ—ãƒ¬ãƒŸã‚¢ãƒ æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ -->
            <div class="test-card">
                <h3>â­ ãƒ—ãƒ¬ãƒŸã‚¢ãƒ æ©Ÿèƒ½</h3>
                <button onclick="testPremiumFeatures()">ãƒ—ãƒ¬ãƒŸã‚¢ãƒ  ãƒ†ã‚¹ãƒˆ</button>
                <div id="premiumResult" class="result">ãƒ†ã‚¹ãƒˆæœªå®Ÿè¡Œ</div>
            </div>

            <!-- ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ -->
            <div class="test-card">
                <h3>ğŸ’¾ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</h3>
                <button onclick="testBackupFeatures()">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ— ãƒ†ã‚¹ãƒˆ</button>
                <div id="backupResult" class="result">ãƒ†ã‚¹ãƒˆæœªå®Ÿè¡Œ</div>
            </div>

            <!-- ã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ -->
            <div class="test-card">
                <h3>ğŸ“Š ã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹</h3>
                <button onclick="testAnalytics()">ã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹ ãƒ†ã‚¹ãƒˆ</button>
                <div id="analyticsResult" class="result">ãƒ†ã‚¹ãƒˆæœªå®Ÿè¡Œ</div>
            </div>

            <!-- PWAæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ -->
            <div class="test-card">
                <h3>ğŸ“± PWAæ©Ÿèƒ½</h3>
                <button onclick="testPWAFeatures()">PWA ãƒ†ã‚¹ãƒˆ</button>
                <div id="pwaResult" class="result">ãƒ†ã‚¹ãƒˆæœªå®Ÿè¡Œ</div>
            </div>

            <!-- ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰ãƒ†ã‚¹ãƒˆ -->
            <div class="test-card">
                <h3>ğŸ¯ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—</h3>
                <button onclick="testSetupWizard()">ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰ ãƒ†ã‚¹ãƒˆ</button>
                <div id="setupResult" class="result">ãƒ†ã‚¹ãƒˆæœªå®Ÿè¡Œ</div>
            </div>
        </div>

        <!-- çµ±è¨ˆæƒ…å ± -->
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="passCount">0</div>
                <div class="stat-label">æˆåŠŸãƒ†ã‚¹ãƒˆ</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="failCount">0</div>
                <div class="stat-label">å¤±æ•—ãƒ†ã‚¹ãƒˆ</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalTests">8</div>
                <div class="stat-label">ç·ãƒ†ã‚¹ãƒˆæ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="completionRate">0%</div>
                <div class="stat-label">å®Œäº†ç‡</div>
            </div>
        </div>

        <!-- å…¨ä½“çš„ãªã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ -->
        <div class="test-card" style="margin-top: 24px;">
            <h3>ğŸ¯ ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“çŠ¶æ…‹</h3>
            <div id="systemOverview" class="result info">
                ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ã‚’ç¢ºèªä¸­...
            </div>
        </div>
    </div>

    <!-- JavaScript ãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿ -->
    <script src="config.js"></script>
    <script src="ai-vision-service.js"></script>
    <script src="gemini-vision-service.js"></script>
    <script src="setup-wizard.js"></script>
    <script src="analytics-tracker.js"></script>
    <script src="backup-manager.js"></script>
    <script src="premium-features.js"></script>

    <script>
        // ãƒ†ã‚¹ãƒˆçµæœã®è¿½è·¡
        let testResults = {
            passed: 0,
            failed: 0,
            total: 8
        };

        // çµæœè¡¨ç¤ºãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
        function showResult(elementId, type, message, includeTimestamp = true) {
            const element = document.getElementById(elementId);
            const timestamp = includeTimestamp ? `[${new Date().toLocaleTimeString()}] ` : '';
            element.className = `result ${type}`;
            element.innerHTML = timestamp + message;
        }

        function updateStats() {
            document.getElementById('passCount').textContent = testResults.passed;
            document.getElementById('failCount').textContent = testResults.failed;
            const completion = Math.round(((testResults.passed + testResults.failed) / testResults.total) * 100);
            document.getElementById('completionRate').textContent = completion + '%';
        }

        function incrementResult(passed) {
            if (passed) {
                testResults.passed++;
            } else {
                testResults.failed++;
            }
            updateStats();
        }

        // 1. åŸºæœ¬ã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆ
        function testBasicSystem() {
            showResult('basicResult', 'loading', 'åŸºæœ¬ã‚·ã‚¹ãƒ†ãƒ ã‚’ãƒã‚§ãƒƒã‚¯ä¸­...');
            
            try {
                let results = [];
                
                // ãƒ–ãƒ©ã‚¦ã‚¶æ©Ÿèƒ½ãƒã‚§ãƒƒã‚¯
                const browserFeatures = {
                    localStorage: typeof localStorage !== 'undefined',
                    serviceWorker: 'serviceWorker' in navigator,
                    fetch: typeof fetch !== 'undefined',
                    es6: typeof Promise !== 'undefined',
                    fileReader: typeof FileReader !== 'undefined'
                };
                
                for (const [feature, supported] of Object.entries(browserFeatures)) {
                    const status = supported ? 'âœ…' : 'âŒ';
                    results.push(`${status} ${feature}: ${supported ? 'ã‚µãƒãƒ¼ãƒˆæ¸ˆã¿' : 'æœªã‚µãƒãƒ¼ãƒˆ'}`);
                }
                
                // DOMè¦ç´ ãƒã‚§ãƒƒã‚¯
                const domElements = ['HTML', 'HEAD', 'BODY'];
                domElements.forEach(tag => {
                    const exists = document.querySelector(tag.toLowerCase()) !== null;
                    const status = exists ? 'âœ…' : 'âŒ';
                    results.push(`${status} ${tag}è¦ç´ : ${exists ? 'æ­£å¸¸' : 'ç•°å¸¸'}`);
                });
                
                // JavaScriptå®Ÿè¡Œç’°å¢ƒ
                results.push(`âœ… JavaScript: å®Ÿè¡Œä¸­`);
                results.push(`âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ: ${navigator.userAgent.substring(0, 50)}...`);
                
                const allPassed = Object.values(browserFeatures).every(v => v);
                showResult('basicResult', allPassed ? 'success' : 'warning', results.join('\\n'));
                incrementResult(allPassed);
                
            } catch (error) {
                showResult('basicResult', 'error', `åŸºæœ¬ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                incrementResult(false);
            }
        }

        // 2. è¨­å®šãƒ»æ§‹æˆãƒ†ã‚¹ãƒˆ
        function testConfiguration() {
            showResult('configResult', 'loading', 'è¨­å®šã‚’ç¢ºèªä¸­...');
            
            try {
                let results = [];
                
                // è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
                if (typeof window.FUYOU_CONFIG === 'undefined') {
                    results.push('âŒ FUYOU_CONFIGæœªå®šç¾©');
                    showResult('configResult', 'error', results.join('\\n'));
                    incrementResult(false);
                    return;
                }
                
                const config = window.FUYOU_CONFIG;
                results.push('âœ… è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿æˆåŠŸ');
                
                // ä¸»è¦è¨­å®šé …ç›®ã®ç¢ºèª
                const checkConfig = (path, expected) => {
                    const keys = path.split('.');
                    let value = config;
                    for (const key of keys) {
                        value = value?.[key];
                    }
                    const exists = value !== undefined;
                    const status = exists ? 'âœ…' : 'âŒ';
                    results.push(`${status} ${path}: ${exists ? 'è¨­å®šæ¸ˆã¿' : 'æœªè¨­å®š'}`);
                    return exists;
                };
                
                const configChecks = [
                    'environment',
                    'api.openai.model',
                    'api.gemini.model',
                    'fuyou.dependentLimit',
                    'pwa.enableServiceWorker',
                    'features.aiAnalysis'
                ];
                
                const configResults = configChecks.map(path => checkConfig(path));
                const configPassed = configResults.filter(r => r).length;
                
                results.push(`\\nè¨­å®šå®Œäº†åº¦: ${configPassed}/${configChecks.length} (${Math.round(configPassed/configChecks.length*100)}%)`);
                
                // API ã‚­ãƒ¼çŠ¶æ…‹
                const hasOpenAI = config.api?.openai?.apiKey && config.api.openai.apiKey !== null;
                const hasGemini = config.api?.gemini?.apiKey && config.api.gemini.apiKey !== null;
                
                results.push(`\\nAPIè¨­å®šçŠ¶æ³:`);
                results.push(`${hasOpenAI ? 'âœ…' : 'âŒ'} OpenAI API ã‚­ãƒ¼`);
                results.push(`${hasGemini ? 'âœ…' : 'âŒ'} Gemini API ã‚­ãƒ¼`);
                
                const overallPassed = configPassed >= configChecks.length * 0.8;
                showResult('configResult', overallPassed ? 'success' : 'warning', results.join('\\n'));
                incrementResult(overallPassed);
                
            } catch (error) {
                showResult('configResult', 'error', `è¨­å®šã‚¨ãƒ©ãƒ¼: ${error.message}`);
                incrementResult(false);
            }
        }

        // 3. AIæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
        function testAIFeatures() {
            showResult('aiResult', 'loading', 'AIæ©Ÿèƒ½ã‚’ç¢ºèªä¸­...');
            
            try {
                let results = [];
                
                // AIVisionService ã®ç¢ºèª
                if (typeof AIVisionService === 'undefined') {
                    results.push('âŒ AIVisionService ã‚¯ãƒ©ã‚¹æœªå®šç¾©');
                } else {
                    results.push('âœ… AIVisionService ã‚¯ãƒ©ã‚¹å®šç¾©æ¸ˆã¿');
                    
                    const aiService = new AIVisionService();
                    
                    // åˆæœŸåŒ–ç¢ºèª
                    if (typeof aiService.initializeGeminiService === 'function') {
                        aiService.initializeGeminiService();
                        results.push('âœ… Gemini Service åˆæœŸåŒ–å®Ÿè¡Œ');
                    }
                    
                    // ãƒ¡ã‚½ãƒƒãƒ‰ã®å­˜åœ¨ç¢ºèª
                    const methods = [
                        'analyzeShiftTable',
                        'convertToBase64', 
                        'isAvailable',
                        'estimateCost',
                        'analyzeWithMultipleProviders'
                    ];
                    
                    methods.forEach(method => {
                        const exists = typeof aiService[method] === 'function';
                        const status = exists ? 'âœ…' : 'âŒ';
                        results.push(`${status} ${method}ãƒ¡ã‚½ãƒƒãƒ‰`);
                    });
                    
                    // åˆ©ç”¨å¯èƒ½æ€§ãƒã‚§ãƒƒã‚¯
                    const isAvailable = aiService.isAvailable();
                    results.push(`${isAvailable ? 'âœ…' : 'ğŸ”¶'} OpenAI API åˆ©ç”¨å¯èƒ½æ€§: ${isAvailable}`);
                }
                
                // GeminiVisionService ã®ç¢ºèª
                if (typeof GeminiVisionService !== 'undefined') {
                    results.push('âœ… GeminiVisionService ã‚¯ãƒ©ã‚¹å®šç¾©æ¸ˆã¿');
                    const geminiService = new GeminiVisionService();
                    const geminiAvailable = geminiService.isAvailable();
                    results.push(`${geminiAvailable ? 'âœ…' : 'ğŸ”¶'} Gemini API åˆ©ç”¨å¯èƒ½æ€§: ${geminiAvailable}`);
                } else {
                    results.push('âŒ GeminiVisionService ã‚¯ãƒ©ã‚¹æœªå®šç¾©');
                }
                
                // ãƒ†ã‚¹ãƒˆç”¨ç”»åƒå‡¦ç†ï¼ˆæ¨¡æ“¬ï¼‰
                const testBlob = new Blob(['test'], { type: 'text/plain' });
                const testFile = new File([testBlob], 'test.txt', { type: 'text/plain' });
                
                if (typeof AIVisionService !== 'undefined') {
                    const aiService = new AIVisionService();
                    try {
                        const costEstimate = aiService.estimateCost(testFile);
                        results.push(`âœ… ã‚³ã‚¹ãƒˆè¦‹ç©ã‚‚ã‚Šæ©Ÿèƒ½: $${costEstimate.estimatedCostUSD?.toFixed(4) || 'N/A'}`);
                    } catch (e) {
                        results.push(`ğŸ”¶ ã‚³ã‚¹ãƒˆè¦‹ç©ã‚‚ã‚Š: ${e.message}`);
                    }
                }
                
                const aiPassed = results.filter(r => r.startsWith('âœ…')).length >= 3;
                showResult('aiResult', aiPassed ? 'success' : 'warning', results.join('\\n'));
                incrementResult(aiPassed);
                
            } catch (error) {
                showResult('aiResult', 'error', `AIæ©Ÿèƒ½ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                incrementResult(false);
            }
        }

        // 4. ãƒ—ãƒ¬ãƒŸã‚¢ãƒ æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
        function testPremiumFeatures() {
            showResult('premiumResult', 'loading', 'ãƒ—ãƒ¬ãƒŸã‚¢ãƒ æ©Ÿèƒ½ã‚’ç¢ºèªä¸­...');
            
            try {
                let results = [];
                
                if (typeof premium === 'undefined') {
                    results.push('âŒ ãƒ—ãƒ¬ãƒŸã‚¢ãƒ æ©Ÿèƒ½ã‚·ã‚¹ãƒ†ãƒ æœªå®šç¾©');
                    showResult('premiumResult', 'error', results.join('\\n'));
                    incrementResult(false);
                    return;
                }
                
                results.push('âœ… ãƒ—ãƒ¬ãƒŸã‚¢ãƒ æ©Ÿèƒ½ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–æ¸ˆã¿');
                
                // ç¾åœ¨ã®ãƒ—ãƒ¬ãƒŸã‚¢ãƒ çŠ¶æ…‹
                const isPremium = premium.isPremium;
                const isTrialUser = premium.isTrialUser;
                results.push(`${isPremium ? 'â­' : 'ğŸ”¶'} ãƒ—ãƒ¬ãƒŸã‚¢ãƒ çŠ¶æ…‹: ${isPremium ? 'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–' : 'ç„¡æ–™ç‰ˆ'}`);
                
                if (isTrialUser) {
                    results.push('ğŸ”¥ ãƒˆãƒ©ã‚¤ã‚¢ãƒ«æœŸé–“ä¸­');
                }
                
                // æ©Ÿèƒ½ãƒã‚§ãƒƒã‚¯
                const features = [
                    'unlimited_ai_scans',
                    'unlimited_workplaces', 
                    'advanced_analytics',
                    'smart_optimization',
                    'cloud_backup'
                ];
                
                features.forEach(feature => {
                    try {
                        const canUse = premium.canUseFeature(feature);
                        const status = canUse.allowed ? 'âœ…' : 'ğŸ”¶';
                        const reason = canUse.reason || 'unknown';
                        results.push(`${status} ${feature}: ${reason}`);
                    } catch (e) {
                        results.push(`âŒ ${feature}: ã‚¨ãƒ©ãƒ¼`);
                    }
                });
                
                // ä½¿ç”¨é‡çŠ¶æ³
                const allFeatures = premium.getAllFeaturesStatus();
                results.push(`\\nğŸ“Š æ©Ÿèƒ½çŠ¶æ³: ${Object.keys(allFeatures.features).length}æ©Ÿèƒ½ç¢ºèªæ¸ˆã¿`);
                
                const premiumPassed = results.filter(r => r.startsWith('âœ…')).length >= 3;
                showResult('premiumResult', premiumPassed ? 'success' : 'warning', results.join('\\n'));
                incrementResult(premiumPassed);
                
            } catch (error) {
                showResult('premiumResult', 'error', `ãƒ—ãƒ¬ãƒŸã‚¢ãƒ æ©Ÿèƒ½ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                incrementResult(false);
            }
        }

        // 5. ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
        function testBackupFeatures() {
            showResult('backupResult', 'loading', 'ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ©Ÿèƒ½ã‚’ç¢ºèªä¸­...');
            
            try {
                let results = [];
                
                if (typeof backupManager === 'undefined') {
                    results.push('âŒ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼æœªå®šç¾©');
                    showResult('backupResult', 'error', results.join('\\n'));
                    incrementResult(false);
                    return;
                }
                
                results.push('âœ… ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼åˆæœŸåŒ–æ¸ˆã¿');
                
                // ãƒ¡ã‚½ãƒƒãƒ‰å­˜åœ¨ç¢ºèª
                const methods = [
                    'createFullBackup',
                    'exportToFile',
                    'importFromFile',
                    'getBackupList',
                    'validateBackup'
                ];
                
                methods.forEach(method => {
                    const exists = typeof backupManager[method] === 'function';
                    const status = exists ? 'âœ…' : 'âŒ';
                    results.push(`${status} ${method}ãƒ¡ã‚½ãƒƒãƒ‰`);
                });
                
                // è¨­å®šç¢ºèª
                const autoBackupEnabled = backupManager.autoBackupEnabled;
                results.push(`${autoBackupEnabled ? 'âœ…' : 'ğŸ”¶'} è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—: ${autoBackupEnabled ? 'æœ‰åŠ¹' : 'ç„¡åŠ¹'}`);
                
                // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¸€è¦§å–å¾—ãƒ†ã‚¹ãƒˆ
                try {
                    const backupList = backupManager.getBackupList();
                    results.push(`âœ… ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¸€è¦§å–å¾—: ${backupList.length}ä»¶`);
                } catch (e) {
                    results.push(`ğŸ”¶ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¸€è¦§: ${e.message}`);
                }
                
                // ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ç¢ºèª
                const dataSources = backupManager.dataSources;
                results.push(`âœ… ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹: ${dataSources.length}ç¨®é¡å¯¾å¿œ`);
                
                const backupPassed = results.filter(r => r.startsWith('âœ…')).length >= 4;
                showResult('backupResult', backupPassed ? 'success' : 'warning', results.join('\\n'));
                incrementResult(backupPassed);
                
            } catch (error) {
                showResult('backupResult', 'error', `ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ©Ÿèƒ½ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                incrementResult(false);
            }
        }

        // 6. ã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
        function testAnalytics() {
            showResult('analyticsResult', 'loading', 'ã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹æ©Ÿèƒ½ã‚’ç¢ºèªä¸­...');
            
            try {
                let results = [];
                
                if (typeof analytics === 'undefined') {
                    results.push('âŒ ã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹ãƒˆãƒ©ãƒƒã‚«ãƒ¼æœªå®šç¾©');
                    showResult('analyticsResult', 'error', results.join('\\n'));
                    incrementResult(false);
                    return;
                }
                
                results.push('âœ… ã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹ãƒˆãƒ©ãƒƒã‚«ãƒ¼åˆæœŸåŒ–æ¸ˆã¿');
                
                // ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼è¨­å®šç¢ºèª
                const privacyMode = analytics.privacyMode;
                const consentGiven = analytics.consentGiven;
                results.push(`âœ… ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒ¢ãƒ¼ãƒ‰: ${privacyMode ? 'æœ‰åŠ¹' : 'ç„¡åŠ¹'}`);
                results.push(`${consentGiven ? 'âœ…' : 'ğŸ”¶'} ãƒ¦ãƒ¼ã‚¶ãƒ¼åŒæ„: ${consentGiven ? 'å–å¾—æ¸ˆã¿' : 'æœªå–å¾—'}`);
                
                // ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±
                const sessionId = analytics.sessionId;
                results.push(`âœ… ã‚»ãƒƒã‚·ãƒ§ãƒ³ ID: ${sessionId.substring(0, 12)}...`);
                
                // ãƒ¡ã‚½ãƒƒãƒ‰ç¢ºèª
                const methods = [
                    'trackEvent',
                    'trackFeatureUsage',
                    'trackError',
                    'trackPerformance',
                    'generateReport'
                ];
                
                methods.forEach(method => {
                    const exists = typeof analytics[method] === 'function';
                    const status = exists ? 'âœ…' : 'âŒ';
                    results.push(`${status} ${method}ãƒ¡ã‚½ãƒƒãƒ‰`);
                });
                
                // ãƒ†ã‚¹ãƒˆã‚¤ãƒ™ãƒ³ãƒˆé€ä¿¡
                try {
                    analytics.trackEvent('test', 'comprehensive_test', 'analytics_check');
                    results.push('âœ… ãƒ†ã‚¹ãƒˆã‚¤ãƒ™ãƒ³ãƒˆé€ä¿¡æˆåŠŸ');
                } catch (e) {
                    results.push(`ğŸ”¶ ã‚¤ãƒ™ãƒ³ãƒˆé€ä¿¡: ${e.message}`);
                }
                
                const analyticsPassed = results.filter(r => r.startsWith('âœ…')).length >= 5;
                showResult('analyticsResult', analyticsPassed ? 'success' : 'warning', results.join('\\n'));
                incrementResult(analyticsPassed);
                
            } catch (error) {
                showResult('analyticsResult', 'error', `ã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                incrementResult(false);
            }
        }

        // 7. PWAæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
        function testPWAFeatures() {
            showResult('pwaResult', 'loading', 'PWAæ©Ÿèƒ½ã‚’ç¢ºèªä¸­...');
            
            try {
                let results = [];
                
                // Service Worker ç¢ºèª
                if ('serviceWorker' in navigator) {
                    results.push('âœ… Service Worker ã‚µãƒãƒ¼ãƒˆæ¸ˆã¿');
                    
                    navigator.serviceWorker.getRegistrations().then(registrations => {
                        const swCount = registrations.length;
                        results.push(`${swCount > 0 ? 'âœ…' : 'ğŸ”¶'} Service Worker ç™»éŒ²: ${swCount}ä»¶`);
                    });
                } else {
                    results.push('âŒ Service Worker æœªã‚µãƒãƒ¼ãƒˆ');
                }
                
                // ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆç¢ºèª
                const manifestLink = document.querySelector('link[rel="manifest"]');
                results.push(`${manifestLink ? 'âœ…' : 'âŒ'} PWAãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆ: ${manifestLink ? 'è¨­å®šæ¸ˆã¿' : 'æœªè¨­å®š'}`);
                
                // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ©Ÿèƒ½
                const isOnline = navigator.onLine;
                results.push(`${isOnline ? 'âœ…' : 'ğŸ”¶'} ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯çŠ¶æ…‹: ${isOnline ? 'ã‚ªãƒ³ãƒ©ã‚¤ãƒ³' : 'ã‚ªãƒ•ãƒ©ã‚¤ãƒ³'}`);
                
                // ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã‚µãƒãƒ¼ãƒˆ
                const pushSupported = 'PushManager' in window;
                results.push(`${pushSupported ? 'âœ…' : 'âŒ'} ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥: ${pushSupported ? 'ã‚µãƒãƒ¼ãƒˆæ¸ˆã¿' : 'æœªã‚µãƒãƒ¼ãƒˆ'}`);
                
                // localStorage ç¢ºèª
                try {
                    localStorage.setItem('pwa_test', 'test');
                    localStorage.removeItem('pwa_test');
                    results.push('âœ… LocalStorage: åˆ©ç”¨å¯èƒ½');
                } catch (e) {
                    results.push('âŒ LocalStorage: åˆ©ç”¨ä¸å¯');
                }
                
                // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¯èƒ½æ€§
                let installPrompt = null;
                window.addEventListener('beforeinstallprompt', (e) => {
                    installPrompt = e;
                });
                
                results.push(`${installPrompt ? 'âœ…' : 'ğŸ”¶'} ã‚¢ãƒ—ãƒªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«: ${installPrompt ? 'å¯èƒ½' : 'çŠ¶æ³ä¸æ˜'}`);
                
                // ç”»é¢æƒ…å ±
                results.push(`âœ… ç”»é¢ã‚µã‚¤ã‚º: ${window.screen.width}x${window.screen.height}`);
                results.push(`âœ… è¡¨ç¤ºé ˜åŸŸ: ${window.innerWidth}x${window.innerHeight}`);
                
                const pwaPassed = results.filter(r => r.startsWith('âœ…')).length >= 4;
                showResult('pwaResult', pwaPassed ? 'success' : 'warning', results.join('\\n'));
                incrementResult(pwaPassed);
                
            } catch (error) {
                showResult('pwaResult', 'error', `PWAæ©Ÿèƒ½ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                incrementResult(false);
            }
        }

        // 8. ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰ãƒ†ã‚¹ãƒˆ
        function testSetupWizard() {
            showResult('setupResult', 'loading', 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰ã‚’ç¢ºèªä¸­...');
            
            try {
                let results = [];
                
                if (typeof wizardInstance === 'undefined') {
                    results.push('âŒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰æœªå®šç¾©');
                    showResult('setupResult', 'error', results.join('\\n'));
                    incrementResult(false);
                    return;
                }
                
                results.push('âœ… ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰åˆæœŸåŒ–æ¸ˆã¿');
                
                // ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰ã®è¨­å®šç¢ºèª
                const steps = wizardInstance.steps;
                results.push(`âœ… ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰ã‚¹ãƒ†ãƒƒãƒ—: ${steps ? steps.length : 0}æ®µéš`);
                
                // ãƒ¡ã‚½ãƒƒãƒ‰ç¢ºèª
                const methods = [
                    'start',
                    'showStep',
                    'saveSettings',
                    'checkPremiumStatus'
                ];
                
                methods.forEach(method => {
                    const exists = typeof wizardInstance[method] === 'function';
                    const status = exists ? 'âœ…' : 'âŒ';
                    results.push(`${status} ${method}ãƒ¡ã‚½ãƒƒãƒ‰`);
                });
                
                // ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†çŠ¶æ³
                const setupCompleted = localStorage.getItem('fuyou_setup_completed');
                results.push(`${setupCompleted ? 'âœ…' : 'ğŸ”¶'} ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—çŠ¶æ³: ${setupCompleted ? 'å®Œäº†æ¸ˆã¿' : 'æœªå®Œäº†'}`);
                
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šç¢ºèª
                const userSettings = localStorage.getItem('fuyou_user_settings');
                results.push(`${userSettings ? 'âœ…' : 'ğŸ”¶'} ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®š: ${userSettings ? 'ä¿å­˜æ¸ˆã¿' : 'æœªä¿å­˜'}`);
                
                const setupPassed = results.filter(r => r.startsWith('âœ…')).length >= 3;
                showResult('setupResult', setupPassed ? 'success' : 'warning', results.join('\\n'));
                incrementResult(setupPassed);
                
            } catch (error) {
                showResult('setupResult', 'error', `ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                incrementResult(false);
            }
        }

        // å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        async function runAllTests() {
            // çµ±è¨ˆãƒªã‚»ãƒƒãƒˆ
            testResults = { passed: 0, failed: 0, total: 8 };
            updateStats();
            
            showResult('systemOverview', 'loading', 'å…¨ä½“ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­...');
            
            const tests = [
                testBasicSystem,
                testConfiguration,
                testAIFeatures,
                testPremiumFeatures,
                testBackupFeatures,
                testAnalytics,
                testPWAFeatures,
                testSetupWizard
            ];
            
            for (let i = 0; i < tests.length; i++) {
                await new Promise(resolve => {
                    setTimeout(() => {
                        tests[i]();
                        resolve();
                    }, 500); // 500ms é–“éš”ã§å®Ÿè¡Œ
                });
            }
            
            // å…¨ä½“çµæœ
            setTimeout(() => {
                const successRate = Math.round((testResults.passed / testResults.total) * 100);
                let overallStatus = 'success';
                let message = '';
                
                if (successRate >= 90) {
                    overallStatus = 'success';
                    message = `ğŸ‰ å„ªç§€ï¼ å…¨æ©Ÿèƒ½ãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™ (${successRate}%)\\n\\nâœ… æˆåŠŸ: ${testResults.passed}/${testResults.total}\\nâŒ å¤±æ•—: ${testResults.failed}/${testResults.total}\\n\\nğŸ“‹ ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹: æœ¬ç•ªãƒªãƒªãƒ¼ã‚¹æº–å‚™å®Œäº†`;
                } else if (successRate >= 70) {
                    overallStatus = 'warning';
                    message = `âš ï¸ è‰¯å¥½ ä¸€éƒ¨æ”¹å–„ã®ä½™åœ°ãŒã‚ã‚Šã¾ã™ (${successRate}%)\\n\\nâœ… æˆåŠŸ: ${testResults.passed}/${testResults.total}\\nâŒ å¤±æ•—: ${testResults.failed}/${testResults.total}\\n\\nğŸ“‹ ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹: è»½å¾®ãªä¿®æ­£å¾Œã«ãƒªãƒªãƒ¼ã‚¹å¯èƒ½`;
                } else {
                    overallStatus = 'error';
                    message = `ğŸš¨ è¦ä¿®æ­£ é‡è¦ãªå•é¡ŒãŒã‚ã‚Šã¾ã™ (${successRate}%)\\n\\nâœ… æˆåŠŸ: ${testResults.passed}/${testResults.total}\\nâŒ å¤±æ•—: ${testResults.failed}/${testResults.total}\\n\\nğŸ“‹ ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹: ä¿®æ­£ä½œæ¥­ãŒå¿…è¦`;
                }
                
                showResult('systemOverview', overallStatus, message);
            }, 1000);
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸãƒã‚§ãƒƒã‚¯
        window.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                showResult('systemOverview', 'info', 'ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†ã€‚ã€ŒğŸš€ å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã€ãƒœã‚¿ãƒ³ã§åŒ…æ‹¬çš„ãªãƒ†ã‚¹ãƒˆã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚', false);
            }, 1000);
        });
    </script>
</body>
</html>