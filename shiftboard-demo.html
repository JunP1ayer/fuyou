<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ãƒã‚¤ãƒˆæ‰¶é¤Šç®¡ç†ã‚¢ãƒ—ãƒª - ã‚·ãƒ•ãƒˆãƒœãƒ¼ãƒ‰ v2.0</title>
    <!-- Cache busting: 2025-01-21T23:30 -->
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Roboto', 'Noto Sans JP', sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      .header {
        background: white;
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 20px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      }

      .header h1 {
        color: #1976d2;
        font-size: 28px;
        font-weight: bold;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .header .subtitle {
        color: #666;
        font-size: 16px;
      }

      .status-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
      }

      .fuyou-status {
        background: white;
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      }

      .alert {
        padding: 16px;
        border-radius: 12px;
        margin-bottom: 20px;
        font-weight: 500;
      }

      .alert.success {
        background: #e8f5e8;
        color: #2e7d32;
        border-left: 4px solid #4caf50;
      }

      .alert.warning {
        background: #fff8e1;
        color: #f57c00;
        border-left: 4px solid #ff9800;
      }

      .alert.danger {
        background: #ffebee;
        color: #c62828;
        border-left: 4px solid #f44336;
      }

      .progress-bar {
        background: #e0e0e0;
        height: 8px;
        border-radius: 4px;
        margin: 16px 0;
        overflow: hidden;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #4caf50, #66bb6a);
        width: 63%;
        transition: width 0.3s ease;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 16px;
        margin-top: 20px;
      }

      .stat-card {
        background: #f5f5f5;
        padding: 16px;
        border-radius: 12px;
        text-align: center;
      }

      .stat-value {
        font-size: 20px;
        font-weight: bold;
        color: #1976d2;
      }

      .stat-label {
        font-size: 12px;
        color: #666;
        margin-top: 4px;
      }

      .quick-actions {
        background: white;
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      }

      .action-button {
        width: 100%;
        padding: 16px;
        margin-bottom: 12px;
        border: none;
        border-radius: 12px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }

      .action-button.primary {
        background: #1976d2;
        color: white;
      }

      .action-button.primary:hover {
        background: #1565c0;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(25, 118, 210, 0.3);
      }

      .action-button.outlined {
        background: white;
        border: 2px solid #1976d2;
        color: #1976d2;
      }

      .action-button.outlined:hover {
        background: #f3f9ff;
        transform: translateY(-1px);
      }

      .calendar-card {
        background: white;
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      }

      .calendar-header {
        display: flex;
        justify-content: between;
        align-items: center;
        margin-bottom: 20px;
      }

      .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 8px;
      }

      .calendar-day {
        aspect-ratio: 1;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        padding: 4px;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
        background: white;
        min-height: 80px;
      }

      .calendar-day:hover {
        background: #f0f9ff;
        border-color: #1976d2;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(25, 118, 210, 0.2);
      }

      .calendar-day.other-month {
        color: #ccc;
        background: #f8f8f8;
      }

      .calendar-day.today {
        background: #fff3cd;
        border-color: #ffc107;
        font-weight: bold;
      }

      .date-number {
        font-size: 16px;
        font-weight: 500;
        margin-bottom: 4px;
      }

      .shift-chip {
        background: linear-gradient(135deg, #4caf50, #66bb6a);
        color: white;
        font-size: 10px;
        padding: 2px 6px;
        border-radius: 12px;
        margin: 1px 0;
        font-weight: 500;
        min-width: 0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 100%;
        cursor: pointer;
        transition: transform 0.2s ease;
      }

      .shift-chip:hover {
        transform: scale(1.05);
        z-index: 10;
      }

      .delete-btn {
        position: absolute;
        top: -5px;
        right: -5px;
        width: 16px;
        height: 16px;
        background: #f44336;
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.2s ease;
        opacity: 0;
      }

      .shift-chip {
        position: relative;
      }

      .shift-chip:hover .delete-btn {
        opacity: 1;
      }

      .delete-btn:hover {
        background: #d32f2f;
        transform: scale(1.1);
      }

      .delete-shift-btn:hover {
        background: #d32f2f !important;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(244, 67, 54, 0.3);
      }

      .shift-chip.company-a {
        background: linear-gradient(135deg, #2e7d32, #4caf50);
      }

      .shift-chip.company-b {
        background: linear-gradient(135deg, #e65100, #ff9800);
      }

      .shift-chip.company-c {
        background: linear-gradient(135deg, #ad1457, #e91e63);
      }

      .floating-btn {
        position: fixed;
        bottom: 24px;
        right: 24px;
        width: 64px;
        height: 64px;
        background: linear-gradient(135deg, #1976d2, #42a5f5);
        color: white;
        border: none;
        border-radius: 50%;
        font-size: 24px;
        cursor: pointer;
        box-shadow: 0 4px 20px rgba(25, 118, 210, 0.4);
        transition: all 0.3s ease;
      }

      .floating-btn:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 25px rgba(25, 118, 210, 0.5);
      }

      /* ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
      .popup {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        min-width: 320px;
        display: none;
        max-height: 90vh;
        overflow-y: auto;
      }

      .shift-popup {
        min-width: 320px;
      }

      .workplace-popup {
        min-width: 480px;
      }

      .popup-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.3);
        z-index: 999;
        display: none;
      }

      .popup-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .popup-title {
        font-size: 18px;
        font-weight: bold;
        color: #1976d2;
      }

      .close-btn {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #666;
        padding: 4px;
      }

      .form-group {
        margin-bottom: 16px;
      }

      .form-label {
        display: block;
        font-weight: 500;
        margin-bottom: 8px;
        color: #333;
      }

      .form-input,
      .form-select {
        width: 100%;
        padding: 12px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 14px;
        transition: border-color 0.2s ease;
      }

      .form-input:focus,
      .form-select:focus {
        outline: none;
        border-color: #1976d2;
      }

      .time-inputs {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }

      .template-buttons {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
        margin-bottom: 16px;
      }

      .template-btn {
        padding: 10px;
        border: 2px solid #e0e0e0;
        background: white;
        border-radius: 8px;
        cursor: pointer;
        font-size: 12px;
        transition: all 0.2s ease;
      }

      .template-btn:hover {
        border-color: #1976d2;
        background: #f0f9ff;
      }

      .submit-btn {
        width: 100%;
        padding: 12px;
        background: linear-gradient(135deg, #1976d2, #42a5f5);
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
        transition: transform 0.2s ease;
      }

      .submit-btn:hover {
        transform: translateY(-2px);
      }

      /* è·å ´ç®¡ç† */
      .workplace-list {
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        margin-bottom: 16px;
      }

      .workplace-item {
        padding: 12px 16px;
        border-bottom: 1px solid #f0f0f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .workplace-item:last-child {
        border-bottom: none;
      }

      .workplace-info {
        flex: 1;
      }

      .workplace-name {
        font-weight: 500;
        color: #333;
      }

      .workplace-details {
        font-size: 12px;
        color: #666;
        margin-top: 2px;
      }

      .workplace-actions {
        display: flex;
        gap: 8px;
      }

      .btn-small {
        padding: 4px 8px;
        border: none;
        border-radius: 4px;
        font-size: 12px;
        cursor: pointer;
        transition: opacity 0.2s;
      }

      .btn-edit {
        background: #2196f3;
        color: white;
      }

      .btn-delete {
        background: #f44336;
        color: white;
      }

      .btn-small:hover {
        opacity: 0.8;
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }

      .form-row-3 {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 12px;
      }

      .checkbox-group {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 8px;
        margin-top: 8px;
      }

      .checkbox-item {
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 12px;
      }

      /* åˆè¨ˆè¡¨ç¤ºã‚¨ãƒªã‚¢ */
      .summary-panel {
        background: white;
        border-radius: 16px;
        padding: 20px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        margin-top: 20px;
      }

      .summary-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 16px;
      }

      .summary-item {
        text-align: center;
      }

      .summary-value {
        font-size: 20px;
        font-weight: bold;
        color: #1976d2;
      }

      .summary-label {
        font-size: 12px;
        color: #666;
        margin-top: 4px;
      }

      @media (max-width: 768px) {
        .status-grid {
          grid-template-columns: 1fr;
        }
        .stats-grid {
          grid-template-columns: repeat(2, 1fr);
        }
        .summary-grid {
          grid-template-columns: repeat(2, 1fr);
        }
        .shift-popup {
          width: 90%;
          min-width: 0;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
      <div class="header">
        <h1>ğŸ¦ æ‰¶é¤Šç®¡ç† - ã‚·ãƒ•ãƒˆãƒœãƒ¼ãƒ‰</h1>
        <div class="subtitle">å­¦ç”Ÿã‚¢ãƒ«ãƒã‚¤ã‚¿ãƒ¼å‘ã‘æ‰¶é¤Šæ§é™¤è‡ªå‹•ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </div>
      </div>

      <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
      <div class="status-grid">
        <!-- æ‰¶é¤Šã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
        <div class="fuyou-status">
          <h2>ğŸ“Š æ‰¶é¤Šã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h2>

          <div class="alert success" id="fuyouAlert">
            æ‰¶é¤Šç®¡ç†ã‚·ã‚¹ãƒ†ãƒ æº–å‚™å®Œäº†
          </div>

          <div>
            <div
              style="
                display: flex;
                justify-content: space-between;
                margin-bottom: 8px;
              "
            >
              <span>ä»Šå¹´ã®åå…¥: <span id="yearlyIncome">0å††</span></span>
              <span>é™åº¦é¡: 1,030,000å††</span>
            </div>
            <div class="progress-bar">
              <div
                class="progress-fill"
                id="progressFill"
                style="width: 0%"
              ></div>
            </div>
          </div>

          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-value" id="achievementRate">0%</div>
              <div class="stat-label">é”æˆç‡</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="remainingAmount">1,030,000å††</div>
              <div class="stat-label">æ®‹ã‚Šä½™è£•</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="yearEndPrediction">0å††</div>
              <div class="stat-label">å¹´æœ«äºˆæ¸¬</div>
            </div>
          </div>
        </div>

        <!-- ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="quick-actions">
          <h3>âš¡ ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h3>
          <br />

          <button
            class="action-button primary"
            onclick="openWorkplaceManager()"
          >
            ğŸ¢ ãƒã‚¤ãƒˆå…ˆã‚’ç®¡ç†
          </button>

          <button class="action-button outlined" onclick="addShift()">
            â• ã‚·ãƒ•ãƒˆè¿½åŠ 
          </button>

          <button class="action-button outlined" onclick="startOCR()">
            ğŸ“¸ ã‚·ãƒ•ãƒˆè¡¨ã‚’æ’®å½±
          </button>
        </div>
      </div>

      <!-- ã‚·ãƒ•ãƒˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ -->
      <div class="calendar-card">
        <div class="calendar-header">
          <h3>ğŸ“… ã‚·ãƒ•ãƒˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ - 2025å¹´1æœˆ</h3>
        </div>

        <div class="calendar-grid">
          <!-- æ›œæ—¥ãƒ˜ãƒƒãƒ€ãƒ¼ -->
          <div
            style="
              font-weight: bold;
              text-align: center;
              padding: 8px;
              color: #ef5350;
            "
          >
            æ—¥
          </div>
          <div style="font-weight: bold; text-align: center; padding: 8px">
            æœˆ
          </div>
          <div style="font-weight: bold; text-align: center; padding: 8px">
            ç«
          </div>
          <div style="font-weight: bold; text-align: center; padding: 8px">
            æ°´
          </div>
          <div style="font-weight: bold; text-align: center; padding: 8px">
            æœ¨
          </div>
          <div style="font-weight: bold; text-align: center; padding: 8px">
            é‡‘
          </div>
          <div
            style="
              font-weight: bold;
              text-align: center;
              padding: 8px;
              color: #2196f3;
            "
          >
            åœŸ
          </div>

          <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ—¥ä»˜ -->
          <div
            class="calendar-day other-month"
            onclick="openShiftPopup('2024-12-29')"
          >
            <span class="date-number">29</span>
          </div>
          <div
            class="calendar-day other-month"
            onclick="openShiftPopup('2024-12-30')"
          >
            <span class="date-number">30</span>
          </div>
          <div
            class="calendar-day other-month"
            onclick="openShiftPopup('2024-12-31')"
          >
            <span class="date-number">31</span>
          </div>
          <div class="calendar-day" onclick="openShiftPopup('2025-01-01')">
            <span class="date-number">1</span>
          </div>
          <div class="calendar-day" onclick="openShiftPopup('2025-01-02')">
            <span class="date-number">2</span>
          </div>
          <div class="calendar-day" onclick="openShiftPopup('2025-01-03')">
            <span class="date-number">3</span>
          </div>
          <div class="calendar-day" onclick="openShiftPopup('2025-01-04')">
            <span class="date-number">4</span>
          </div>

          <div class="calendar-day" onclick="openShiftPopup('2025-01-05')">
            <span class="date-number">5</span>
          </div>
          <div class="calendar-day" onclick="openShiftPopup('2025-01-06')">
            <span class="date-number">6</span>
          </div>
          <div class="calendar-day" onclick="openShiftPopup('2025-01-07')">
            <span class="date-number">7</span>
          </div>
          <div class="calendar-day" onclick="openShiftPopup('2025-01-08')">
            <span class="date-number">8</span>
          </div>
          <div class="calendar-day" onclick="openShiftPopup('2025-01-09')">
            <span class="date-number">9</span>
          </div>
          <div class="calendar-day" onclick="openShiftPopup('2025-01-10')">
            <span class="date-number">10</span>
          </div>
          <div class="calendar-day" onclick="openShiftPopup('2025-01-11')">
            <span class="date-number">11</span>
          </div>

          <div class="calendar-day" onclick="openShiftPopup('2025-01-12')">
            <span class="date-number">12</span>
          </div>
          <div class="calendar-day" onclick="openShiftPopup('2025-01-13')">
            <span class="date-number">13</span>
          </div>
          <div class="calendar-day" onclick="openShiftPopup('2025-01-14')">
            <span class="date-number">14</span>
          </div>
          <div class="calendar-day" onclick="openShiftPopup('2025-01-15')">
            <span class="date-number">15</span>
          </div>
          <div class="calendar-day" onclick="openShiftPopup('2025-01-16')">
            <span class="date-number">16</span>
          </div>
          <div class="calendar-day" onclick="openShiftPopup('2025-01-17')">
            <span class="date-number">17</span>
          </div>
          <div class="calendar-day" onclick="openShiftPopup('2025-01-18')">
            <span class="date-number">18</span>
          </div>

          <div class="calendar-day" onclick="openShiftPopup('2025-01-19')">
            <span class="date-number">19</span>
          </div>
          <div class="calendar-day" onclick="openShiftPopup('2025-01-20')">
            <span class="date-number">20</span>
          </div>
          <div
            class="calendar-day today"
            onclick="openShiftPopup('2025-01-21')"
          >
            <span class="date-number">21</span>
          </div>
          <div class="calendar-day" onclick="openShiftPopup('2025-01-22')">
            <span class="date-number">22</span>
          </div>
          <div class="calendar-day" onclick="openShiftPopup('2025-01-23')">
            <span class="date-number">23</span>
          </div>
          <div class="calendar-day" onclick="openShiftPopup('2025-01-24')">
            <span class="date-number">24</span>
          </div>
          <div class="calendar-day" onclick="openShiftPopup('2025-01-25')">
            <span class="date-number">25</span>
          </div>

          <div class="calendar-day" onclick="openShiftPopup('2025-01-26')">
            <span class="date-number">26</span>
          </div>
          <div class="calendar-day" onclick="openShiftPopup('2025-01-27')">
            <span class="date-number">27</span>
          </div>
          <div class="calendar-day" onclick="openShiftPopup('2025-01-28')">
            <span class="date-number">28</span>
          </div>
          <div class="calendar-day" onclick="openShiftPopup('2025-01-29')">
            <span class="date-number">29</span>
          </div>
          <div class="calendar-day" onclick="openShiftPopup('2025-01-30')">
            <span class="date-number">30</span>
          </div>
          <div class="calendar-day" onclick="openShiftPopup('2025-01-31')">
            <span class="date-number">31</span>
          </div>
          <div
            class="calendar-day other-month"
            onclick="openShiftPopup('2025-02-01')"
          >
            <span class="date-number">1</span>
          </div>
        </div>
      </div>

      <!-- æœˆæ¬¡ã‚µãƒãƒªãƒ¼ -->
      <div class="summary-panel">
        <h3>ğŸ“Š ä»Šæœˆã®å®Ÿç¸¾ãƒ»äºˆæ¸¬</h3>
        <div class="summary-grid">
          <div class="summary-item">
            <div class="summary-value" id="monthlyHours">0h</div>
            <div class="summary-label">ä»Šæœˆå‹¤å‹™æ™‚é–“</div>
          </div>
          <div class="summary-item">
            <div class="summary-value" id="monthlyEarnings">0å††</div>
            <div class="summary-label">ä»Šæœˆåå…¥</div>
          </div>
          <div class="summary-item">
            <div class="summary-value" id="shiftCount">0æ—¥</div>
            <div class="summary-label">ã‚·ãƒ•ãƒˆæ—¥æ•°</div>
          </div>
          <div class="summary-item">
            <div class="summary-value" id="avgHours">0h</div>
            <div class="summary-label">1æ—¥å¹³å‡</div>
          </div>
        </div>
      </div>
    </div>

    <!-- ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div class="popup-overlay" id="popupOverlay" onclick="closePopups()"></div>

    <!-- è·å ´ç®¡ç†ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— -->
    <div class="popup workplace-popup" id="workplacePopup">
      <div class="popup-header">
        <div class="popup-title">ğŸ¢ ãƒã‚¤ãƒˆå…ˆç®¡ç†</div>
        <button class="close-btn" onclick="closePopups()">&times;</button>
      </div>

      <div class="workplace-list" id="workplaceList">
        <div style="text-align: center; padding: 20px; color: #666">
          ã¾ã ãƒã‚¤ãƒˆå…ˆãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“
        </div>
      </div>

      <button
        class="submit-btn"
        onclick="openWorkplaceForm()"
        style="margin-bottom: 16px"
      >
        â• æ–°ã—ã„ãƒã‚¤ãƒˆå…ˆã‚’è¿½åŠ 
      </button>
    </div>

    <!-- è·å ´ç™»éŒ²ãƒ»ç·¨é›†ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— -->
    <div class="popup workplace-popup" id="workplaceFormPopup">
      <div class="popup-header">
        <div class="popup-title">
          ğŸ¢ <span id="workplaceFormTitle">æ–°ã—ã„ãƒã‚¤ãƒˆå…ˆã‚’è¿½åŠ </span>
        </div>
        <button class="close-btn" onclick="closePopups()">&times;</button>
      </div>

      <div class="form-group">
        <label class="form-label">è·å ´å *</label>
        <input
          type="text"
          class="form-input"
          id="workplaceName"
          placeholder="ä¾‹: ãƒ•ã‚¡ãƒŸãƒªãƒ¼ãƒãƒ¼ãƒˆæ–°å®¿åº—"
        />
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label">åŸºæœ¬æ™‚çµ¦ (å††) *</label>
          <input
            type="number"
            class="form-input"
            id="baseHourlyWage"
            placeholder="1000"
          />
        </div>
        <div class="form-group">
          <label class="form-label">äº¤é€šè²» (å††)</label>
          <input
            type="number"
            class="form-input"
            id="transportationFee"
            placeholder="200"
            value="0"
          />
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">æ·±å¤œãƒ»æ™‚é–“å¸¯åˆ¥å‰²å¢—</label>
        <div class="form-row">
          <select class="form-select" id="nightShiftType">
            <option value="none">å‰²å¢—ãªã—</option>
            <option value="legal">æ³•å®šæ·±å¤œå‰²å¢— (22:00-5:00, 25%)</option>
            <option value="flexible">æŸ”è»Ÿãªæ™‚é–“å¸¯è¨­å®š</option>
          </select>
          <button
            type="button"
            class="form-input"
            id="configureFlexible"
            onclick="openFlexibleRateConfig()"
            style="display: none; background: #f5f5f5; border: 2px dashed #ccc"
          >
            æ™‚é–“å¸¯ã‚’è¨­å®š
          </button>
        </div>
        <div id="flexibleRatesDisplay" style="margin-top: 8px; display: none">
          <div style="font-size: 12px; color: #666">è¨­å®šã•ã‚ŒãŸæ™‚é–“å¸¯å‰²å¢—ï¼š</div>
          <div
            id="flexibleRatesList"
            style="font-size: 11px; color: #888; margin-top: 4px"
          ></div>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">æ›œæ—¥åˆ¥æ™‚çµ¦è¨­å®š</label>
        <div class="checkbox-group">
          <div class="checkbox-item">
            <input type="checkbox" id="dayPremium_0" />
            <label for="dayPremium_0">æ—¥</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="dayPremium_1" />
            <label for="dayPremium_1">æœˆ</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="dayPremium_2" />
            <label for="dayPremium_2">ç«</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="dayPremium_3" />
            <label for="dayPremium_3">æ°´</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="dayPremium_4" />
            <label for="dayPremium_4">æœ¨</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="dayPremium_5" />
            <label for="dayPremium_5">é‡‘</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="dayPremium_6" />
            <label for="dayPremium_6">åœŸ</label>
          </div>
        </div>
        <div class="form-row" style="margin-top: 8px">
          <input
            type="number"
            class="form-input"
            id="dayPremiumRate"
            placeholder="1100 (å††)"
            disabled
          />
          <select class="form-select" id="dayPremiumType" disabled>
            <option value="rate">å›ºå®šæ™‚çµ¦</option>
            <option value="multiplier">å‰²å¢— (%)</option>
          </select>
        </div>
      </div>

      <div class="form-row">
        <button
          class="submit-btn"
          onclick="saveWorkplace()"
          id="saveWorkplaceBtn"
        >
          ä¿å­˜
        </button>
        <button
          class="submit-btn"
          onclick="closeWorkplaceForm()"
          style="background: #666"
        >
          ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        </button>
      </div>
    </div>

    <!-- æŸ”è»Ÿãªæ™‚é–“å¸¯è¨­å®šãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— -->
    <div class="popup" id="flexibleRatePopup" style="min-width: 500px">
      <div class="popup-header">
        <div class="popup-title">â° æ™‚é–“å¸¯åˆ¥å‰²å¢—è¨­å®š</div>
        <button class="close-btn" onclick="closeFlexibleRateConfig()">
          &times;
        </button>
      </div>

      <div style="margin-bottom: 16px; font-size: 14px; color: #666">
        æ™‚é–“å¸¯ã”ã¨ã«ç•°ãªã‚‹å‰²å¢—ç‡ã‚’è¨­å®šã§ãã¾ã™ï¼ˆä¾‹ï¼š22:00-1:00ã¯25%ã€1:00-5:00ã¯15%ãªã©ï¼‰
      </div>

      <div id="flexibleTimeSlots">
        <!-- å‹•çš„ã«ç”Ÿæˆ -->
      </div>

      <button
        class="submit-btn"
        onclick="addFlexibleTimeSlot()"
        style="background: #4caf50; margin-bottom: 16px"
      >
        â• æ™‚é–“å¸¯ã‚’è¿½åŠ 
      </button>

      <div class="form-row">
        <button class="submit-btn" onclick="saveFlexibleRates()">ä¿å­˜</button>
        <button
          class="submit-btn"
          onclick="closeFlexibleRateConfig()"
          style="background: #666"
        >
          ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        </button>
      </div>
    </div>

    <!-- ã‚·ãƒ•ãƒˆç™»éŒ²ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— -->
    <div class="popup shift-popup" id="shiftPopup">
      <div class="popup-header">
        <div class="popup-title">
          ğŸ“… <span id="popupDate">2025-01-21</span> ã®ã‚·ãƒ•ãƒˆç™»éŒ²
        </div>
        <button class="close-btn" onclick="closeShiftPopup()">&times;</button>
      </div>

      <div class="form-group">
        <label class="form-label">è·å ´</label>
        <select class="form-select" id="workplaceSelect">
          <option value="convenience-a">ã‚³ãƒ³ãƒ“ãƒ‹Aåº— (æ™‚çµ¦1,200å††)</option>
          <option value="cafe-b">ã‚«ãƒ•ã‚§Båº— (æ™‚çµ¦1,100å††)</option>
          <option value="restaurant-c">ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³Cåº— (æ™‚çµ¦1,300å††)</option>
        </select>
      </div>

      <div class="form-group">
        <label class="form-label">å‹¤å‹™æ™‚é–“</label>
        <div class="time-inputs">
          <div>
            <label style="font-size: 12px; color: #666">é–‹å§‹æ™‚é–“</label>
            <input
              type="time"
              class="form-input"
              id="startTime"
              value="10:00"
            />
          </div>
          <div>
            <label style="font-size: 12px; color: #666">çµ‚äº†æ™‚é–“</label>
            <input type="time" class="form-input" id="endTime" value="18:00" />
            <label style="font-size: 11px; color: #888">
              <input
                type="checkbox"
                id="crossMidnight"
                style="margin-right: 4px"
              />ç¿Œæ—¥ã¾ã§åƒã
            </label>
          </div>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label"
          >äºˆæƒ³åå…¥: <span id="predictedEarnings">9,600å††</span></label
        >
      </div>

      <div style="display: flex; gap: 10px; justify-content: space-between">
        <button class="submit-btn" onclick="saveShift()" style="flex: 1">
          ã‚·ãƒ•ãƒˆç™»éŒ²
        </button>
        <button
          class="delete-shift-btn"
          id="deleteShiftBtn"
          onclick="deleteCurrentShift()"
          style="
            display: none;
            flex: 0 0 120px;
            background: #f44336;
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
          "
        >
          å‰Šé™¤
        </button>
      </div>
    </div>

    <!-- ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚«ãƒ¡ãƒ©ãƒœã‚¿ãƒ³ -->
    <button
      class="floating-btn"
      onclick="startOCR()"
      title="AIã‚·ãƒ•ãƒˆè¡¨èª­ã¿å–ã‚Š"
    >
      ğŸ“¸
    </button>

    <script>
      // ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸
      let shifts = {};
      let workplaces = JSON.parse(localStorage.getItem('workplaces') || '{}');
      let workplaceIdCounter = parseInt(
        localStorage.getItem('workplaceIdCounter') || '1'
      );

      // ç¾åœ¨ç·¨é›†ä¸­ã®è·å ´ID
      let editingWorkplaceId = null;

      // æŸ”è»Ÿãªæ™‚é–“å¸¯è¨­å®š
      let currentFlexibleRates = [];

      // ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆ
      const colorPalette = [
        'company-a',
        'company-b',
        'company-c',
        '#9c27b0',
        '#3f51b5',
        '#009688',
        '#ff5722',
        '#795548',
      ];

      let currentDate = '';

      // === æŸ”è»Ÿãªæ™‚é–“å¸¯è¨­å®šæ©Ÿèƒ½ ===

      // æŸ”è»Ÿãªæ™‚é–“å¸¯è¨­å®šãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‹ã
      function openFlexibleRateConfig() {
        currentFlexibleRates = [
          ...((editingWorkplaceId &&
            workplaces[editingWorkplaceId]?.flexibleRates) ||
            []),
        ];
        document.getElementById('flexibleRatePopup').style.display = 'block';
        renderFlexibleTimeSlots();
      }

      // æŸ”è»Ÿãªæ™‚é–“å¸¯è¨­å®šãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‰ã˜ã‚‹
      function closeFlexibleRateConfig() {
        document.getElementById('flexibleRatePopup').style.display = 'none';
      }

      // æ™‚é–“å¸¯ã‚¹ãƒ­ãƒƒãƒˆã‚’è¿½åŠ 
      function addFlexibleTimeSlot() {
        const newSlot = {
          id: Date.now(),
          startTime: '22:00',
          endTime: '05:00',
          crossMidnight: true,
          rate: 125,
        };
        currentFlexibleRates.push(newSlot);
        renderFlexibleTimeSlots();
      }

      // æ™‚é–“å¸¯ã‚¹ãƒ­ãƒƒãƒˆã‚’å‰Šé™¤
      function removeFlexibleTimeSlot(id) {
        currentFlexibleRates = currentFlexibleRates.filter(
          slot => slot.id !== id
        );
        renderFlexibleTimeSlots();
      }

      // æ™‚é–“å¸¯ã‚¹ãƒ­ãƒƒãƒˆã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
      function renderFlexibleTimeSlots() {
        const container = document.getElementById('flexibleTimeSlots');

        if (currentFlexibleRates.length === 0) {
          container.innerHTML =
            '<div style="text-align: center; padding: 20px; color: #666;">æ™‚é–“å¸¯ã‚’è¿½åŠ ã—ã¦ãã ã•ã„</div>';
          return;
        }

        container.innerHTML = currentFlexibleRates
          .map(
            (slot, index) => `
                <div class="form-group" style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 12px; margin-bottom: 12px;">
                    <div class="form-row-3">
                        <div>
                            <label style="font-size: 12px; color: #666;">é–‹å§‹æ™‚é–“</label>
                            <input type="time" class="form-input" value="${slot.startTime}" 
                                   onchange="updateFlexibleSlot(${slot.id}, 'startTime', this.value)">
                        </div>
                        <div>
                            <label style="font-size: 12px; color: #666;">çµ‚äº†æ™‚é–“</label>
                            <input type="time" class="form-input" value="${slot.endTime}"
                                   onchange="updateFlexibleSlot(${slot.id}, 'endTime', this.value)">
                            <label style="font-size: 11px; color: #888;">
                                <input type="checkbox" ${slot.crossMidnight ? 'checked' : ''} 
                                       onchange="updateFlexibleSlot(${slot.id}, 'crossMidnight', this.checked)" style="margin-right: 4px;">ç¿Œæ—¥
                            </label>
                        </div>
                        <div>
                            <label style="font-size: 12px; color: #666;">å‰²å¢—ç‡(%)</label>
                            <input type="number" class="form-input" value="${slot.rate}" min="100" max="200"
                                   onchange="updateFlexibleSlot(${slot.id}, 'rate', parseFloat(this.value))">
                        </div>
                    </div>
                    <button type="button" class="btn-small btn-delete" onclick="removeFlexibleTimeSlot(${slot.id})" 
                            style="float: right; margin-top: 8px;">å‰Šé™¤</button>
                    <div style="clear: both;"></div>
                </div>
            `
          )
          .join('');
      }

      // æ™‚é–“å¸¯ã‚¹ãƒ­ãƒƒãƒˆã‚’æ›´æ–°
      function updateFlexibleSlot(id, property, value) {
        const slot = currentFlexibleRates.find(s => s.id === id);
        if (slot) {
          slot[property] = value;
        }
      }

      // æŸ”è»Ÿãªæ™‚é–“å¸¯è¨­å®šã‚’ä¿å­˜
      function saveFlexibleRates() {
        closeFlexibleRateConfig();
        updateFlexibleRatesDisplay();
      }

      // æŸ”è»Ÿãªæ™‚é–“å¸¯è¨­å®šã®è¡¨ç¤ºã‚’æ›´æ–°
      function updateFlexibleRatesDisplay() {
        const display = document.getElementById('flexibleRatesDisplay');
        const list = document.getElementById('flexibleRatesList');

        if (currentFlexibleRates.length === 0) {
          display.style.display = 'none';
          return;
        }

        display.style.display = 'block';
        list.innerHTML = currentFlexibleRates
          .map(
            slot =>
              `${slot.startTime}-${slot.endTime}${slot.crossMidnight ? '(ç¿Œæ—¥)' : ''}: ${slot.rate}%`
          )
          .join(' â€¢ ');
      }

      // === è·å ´ç®¡ç†æ©Ÿèƒ½ ===

      // è·å ´ç®¡ç†ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‹ã
      function openWorkplaceManager() {
        document.getElementById('popupOverlay').style.display = 'block';
        document.getElementById('workplacePopup').style.display = 'block';
        renderWorkplaceList();
      }

      // è·å ´ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‹ã
      function openWorkplaceForm(workplaceId = null) {
        editingWorkplaceId = workplaceId;
        document.getElementById('workplacePopup').style.display = 'none';
        document.getElementById('workplaceFormPopup').style.display = 'block';

        if (workplaceId) {
          // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰
          document.getElementById('workplaceFormTitle').textContent =
            'ãƒã‚¤ãƒˆå…ˆã‚’ç·¨é›†';
          loadWorkplaceForm(workplaces[workplaceId]);
        } else {
          // æ–°è¦ä½œæˆãƒ¢ãƒ¼ãƒ‰
          document.getElementById('workplaceFormTitle').textContent =
            'æ–°ã—ã„ãƒã‚¤ãƒˆå…ˆã‚’è¿½åŠ ';
          clearWorkplaceForm();
        }
      }

      // è·å ´ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
      function clearWorkplaceForm() {
        document.getElementById('workplaceName').value = '';
        document.getElementById('baseHourlyWage').value = '';
        document.getElementById('transportationFee').value = '0';
        document.getElementById('nightShiftType').value = 'none';
        document.getElementById('nightShiftRate').value = '';
        document.getElementById('nightShiftRate').style.display = 'none';

        // æ›œæ—¥åˆ¥ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ã‚¯ãƒªã‚¢
        for (let i = 0; i < 7; i++) {
          document.getElementById(`dayPremium_${i}`).checked = false;
        }
        document.getElementById('dayPremiumRate').value = '';
        document.getElementById('dayPremiumType').value = 'rate';
        updateDayPremiumFields();
      }

      // è·å ´ãƒ•ã‚©ãƒ¼ãƒ ã«æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
      function loadWorkplaceForm(workplace) {
        document.getElementById('workplaceName').value = workplace.name;
        document.getElementById('baseHourlyWage').value = workplace.baseHourly;
        document.getElementById('transportationFee').value =
          workplace.transportation || 0;
        document.getElementById('nightShiftType').value =
          workplace.nightShift?.type || 'none';

        if (workplace.nightShift?.type === 'custom') {
          document.getElementById('nightShiftRate').value =
            workplace.nightShift.rate;
          document.getElementById('nightShiftRate').style.display = 'block';
        }

        // æ›œæ—¥åˆ¥è¨­å®šã‚’èª­ã¿è¾¼ã¿
        if (workplace.dayPremium) {
          workplace.dayPremium.days.forEach(day => {
            document.getElementById(`dayPremium_${day}`).checked = true;
          });
          document.getElementById('dayPremiumRate').value =
            workplace.dayPremium.rate;
          document.getElementById('dayPremiumType').value =
            workplace.dayPremium.type;
        }
        updateDayPremiumFields();
      }

      // è·å ´ãƒªã‚¹ãƒˆã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
      function renderWorkplaceList() {
        const listElement = document.getElementById('workplaceList');
        const workplaceEntries = Object.entries(workplaces);

        if (workplaceEntries.length === 0) {
          listElement.innerHTML =
            '<div style="text-align: center; padding: 20px; color: #666;">ã¾ã ãƒã‚¤ãƒˆå…ˆãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';
          return;
        }

        listElement.innerHTML = workplaceEntries
          .map(
            ([id, workplace]) => `
                <div class="workplace-item">
                    <div class="workplace-info">
                        <div class="workplace-name">${workplace.name}</div>
                        <div class="workplace-details">
                            æ™‚çµ¦ ${workplace.baseHourly}å†† 
                            ${workplace.transportation ? `â€¢ äº¤é€šè²» ${workplace.transportation}å††` : ''}
                            ${workplace.nightShift?.type !== 'none' ? 'â€¢ æ·±å¤œå‰²å¢—ã‚ã‚Š' : ''}
                        </div>
                    </div>
                    <div class="workplace-actions">
                        <button class="btn-small btn-edit" onclick="openWorkplaceForm('${id}')">ç·¨é›†</button>
                        <button class="btn-small btn-delete" onclick="deleteWorkplace('${id}')">å‰Šé™¤</button>
                    </div>
                </div>
            `
          )
          .join('');
      }

      // è·å ´ã‚’ä¿å­˜
      function saveWorkplace() {
        const name = document.getElementById('workplaceName').value.trim();
        const baseHourly = parseInt(
          document.getElementById('baseHourlyWage').value
        );

        if (!name || !baseHourly || baseHourly <= 0) {
          alert('è·å ´åã¨åŸºæœ¬æ™‚çµ¦ã¯å¿…é ˆã§ã™ã€‚');
          return;
        }

        const nightShiftType = document.getElementById('nightShiftType').value;
        const workplace = {
          name: name,
          baseHourly: baseHourly,
          transportation:
            parseInt(document.getElementById('transportationFee').value) || 0,
          color: colorPalette[(workplaceIdCounter - 1) % colorPalette.length],
        };

        // æ·±å¤œæ™‚çµ¦è¨­å®šã‚’çµ±ä¸€ã•ã‚ŒãŸæ§‹é€ ã§ä¿å­˜
        if (nightShiftType && nightShiftType !== 'none') {
          workplace.nightRate = {
            enabled: true,
            multiplier: nightShiftType === 'standard' ? 1.25 : 1.25, // æ¨™æº–25%ã‚¢ãƒƒãƒ—
            type: nightShiftType,
          };
        }

        // æŸ”è»Ÿãªæ™‚é–“å¸¯è¨­å®šã‚’ä¿å­˜
        if (nightShiftType === 'flexible') {
          workplace.flexibleRates = [...currentFlexibleRates];
        }

        // æ›œæ—¥åˆ¥è¨­å®šã‚’çµ±ä¸€ã•ã‚ŒãŸæ§‹é€ ã§ä¿å­˜
        const selectedDays = [];
        for (let i = 0; i < 7; i++) {
          if (document.getElementById(`dayPremium_${i}`).checked) {
            selectedDays.push(i);
          }
        }

        if (selectedDays.length > 0) {
          const dayPremiumType =
            document.getElementById('dayPremiumType').value;
          const premiumValue = parseFloat(
            document.getElementById('dayPremiumRate').value
          );
          let multiplier = 1.0;

          if (dayPremiumType === 'rate') {
            // å›ºå®šæ™‚çµ¦ã®å ´åˆ: å…¥åŠ›ã•ã‚ŒãŸæ™‚çµ¦ã‚’ãã®ã¾ã¾ä½¿ç”¨
            if (premiumValue && premiumValue > 0) {
              multiplier = premiumValue / workplace.baseHourly;
              console.log(
                `å›ºå®šæ™‚çµ¦è¨­å®š: ${premiumValue}å†† / ${workplace.baseHourly}å†† = ${multiplier}å€`
              );
            }
          } else if (dayPremiumType === 'multiplier') {
            // å‰²å¢—%ã®å ´åˆ: ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸ã‚’å€ç‡ã«å¤‰æ›
            if (premiumValue && premiumValue >= 0) {
              multiplier = 1 + premiumValue / 100;
              console.log(`å‰²å¢—%è¨­å®š: ${premiumValue}% â†’ ${multiplier}å€`);
            }
          }

          workplace.dayPremium = {
            enabled: true,
            days: selectedDays,
            multiplier: multiplier,
            type: dayPremiumType,
            inputValue: premiumValue, // ãƒ‡ãƒãƒƒã‚°ç”¨
          };

          console.log('æ›œæ—¥åˆ¥è¨­å®šä¿å­˜:', workplace.dayPremium);
          console.log(
            'é¸æŠã•ã‚ŒãŸæ›œæ—¥:',
            selectedDays
              .map(d => ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'][d])
              .join(',')
          );
        }

        // ä¿å­˜
        const workplaceId =
          editingWorkplaceId || `workplace_${workplaceIdCounter++}`;
        workplaces[workplaceId] = workplace;

        localStorage.setItem('workplaces', JSON.stringify(workplaces));
        localStorage.setItem(
          'workplaceIdCounter',
          workplaceIdCounter.toString()
        );

        // UIæ›´æ–°
        closeWorkplaceForm();
        renderWorkplaceList();
        updateShiftWorkplaceOptions();
      }

      // è·å ´ã‚’å‰Šé™¤
      function deleteWorkplace(workplaceId) {
        if (confirm('ã“ã®ãƒã‚¤ãƒˆå…ˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
          delete workplaces[workplaceId];
          localStorage.setItem('workplaces', JSON.stringify(workplaces));
          renderWorkplaceList();
          updateShiftWorkplaceOptions();
        }
      }

      // è·å ´ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‰ã˜ã‚‹
      function closeWorkplaceForm() {
        document.getElementById('workplaceFormPopup').style.display = 'none';
        document.getElementById('workplacePopup').style.display = 'block';
        editingWorkplaceId = null;
      }

      // å…¨ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‰ã˜ã‚‹
      function closePopups() {
        document.getElementById('popupOverlay').style.display = 'none';
        document.getElementById('workplacePopup').style.display = 'none';
        document.getElementById('workplaceFormPopup').style.display = 'none';
        document.getElementById('shiftPopup').style.display = 'none';
        editingWorkplaceId = null;
      }

      // === ã‚·ãƒ•ãƒˆç®¡ç†æ©Ÿèƒ½ ===

      // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‹ã
      function openShiftPopup(date) {
        currentDate = date;
        console.log('=== ã‚·ãƒ•ãƒˆãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—é–‹ã ===');
        console.log('é¸æŠã•ã‚ŒãŸæ—¥ä»˜:', date);
        console.log(
          'æ›œæ—¥:',
          new Date(date).getDay(),
          ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'][new Date(date).getDay()]
        );

        document.getElementById('popupDate').textContent = date;
        document.getElementById('popupOverlay').style.display = 'block';
        document.getElementById('shiftPopup').style.display = 'block';

        // è·å ´é¸æŠè‚¢ã‚’æ›´æ–°
        updateShiftWorkplaceOptions();

        // æ—¢å­˜ã‚·ãƒ•ãƒˆãŒã‚ã‚Œã°è¨­å®š
        const deleteBtn = document.getElementById('deleteShiftBtn');
        if (shifts[date]) {
          const shift = shifts[date];
          document.getElementById('workplaceSelect').value =
            shift.workplaceId || Object.keys(workplaces)[0] || '';
          document.getElementById('startTime').value = shift.start;
          document.getElementById('endTime').value = shift.end;

          // ç¿Œæ—¥ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®è¨­å®š
          const crossMidnight = document.getElementById('crossMidnight');
          if (crossMidnight) {
            crossMidnight.checked = shift.crossMidnight || false;
          }

          // å‰Šé™¤ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
          if (deleteBtn) {
            deleteBtn.style.display = 'block';
          }
        } else {
          // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
          const firstWorkplace = Object.keys(workplaces)[0];
          document.getElementById('workplaceSelect').value =
            firstWorkplace || '';
          document.getElementById('startTime').value = '10:00';
          document.getElementById('endTime').value = '18:00';

          // ç¿Œæ—¥ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ
          const crossMidnight = document.getElementById('crossMidnight');
          if (crossMidnight) {
            crossMidnight.checked = false;
          }

          // å‰Šé™¤ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
          if (deleteBtn) {
            deleteBtn.style.display = 'none';
          }
        }
        updatePredictedEarnings();
      }

      // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‰ã˜ã‚‹
      function closeShiftPopup() {
        document.getElementById('popupOverlay').style.display = 'none';
        document.getElementById('shiftPopup').style.display = 'none';
      }

      // åå…¥äºˆæ¸¬æ›´æ–°
      function updatePredictedEarnings() {
        const workplaceId = document.getElementById('workplaceSelect').value;
        const startTime = document.getElementById('startTime').value;
        const endTime = document.getElementById('endTime').value;
        const crossMidnight =
          document.getElementById('crossMidnight')?.checked || false;

        console.log('=== åå…¥äºˆæ¸¬æ›´æ–° ===');
        console.log('å‹¤å‹™å…ˆID:', workplaceId);
        console.log('æ™‚é–“:', startTime, '-', endTime);
        console.log('ç¿Œæ—¥:', crossMidnight);
        console.log('æ—¥ä»˜:', currentDate);

        if (workplaceId && startTime && endTime && workplaces[workplaceId]) {
          const calculation = calculateExactEarnings(
            workplaceId,
            startTime,
            endTime,
            crossMidnight,
            currentDate
          );
          document.getElementById('predictedEarnings').textContent =
            calculation.totalEarnings.toLocaleString() + 'å††';

          // å†…è¨³è¡¨ç¤º
          console.log('äºˆæ¸¬åå…¥:', calculation.totalEarnings + 'å††');
          if (calculation.breakdown && calculation.breakdown.length > 0) {
            console.log('å†…è¨³:', calculation.breakdown);
          }
        } else {
          document.getElementById('predictedEarnings').textContent = '0å††';
          console.log('æ¡ä»¶ä¸è¶³: ãƒ‡ãƒ¼ã‚¿ä¸å‚™');
        }
      }

      // === é«˜åº¦ãªçµ¦ä¸è¨ˆç®—ã‚·ã‚¹ãƒ†ãƒ  ===

      // ãƒ¡ã‚¤ãƒ³ã®çµ¦ä¸è¨ˆç®—é–¢æ•°ï¼ˆç¿Œæ—¥ãƒ»æŸ”è»Ÿãªæ™‚é–“å¸¯å¯¾å¿œï¼‰
      function calculateAdvancedEarnings(
        workplaceId,
        date,
        startTime,
        endTime,
        nextDayEnd = false
      ) {
        const workplace = workplaces[workplaceId];
        if (!workplace) return { totalEarnings: 0, breakdown: {} };

        const dayOfWeek = new Date(date).getDay();
        const [startHour, startMin] = startTime.split(':').map(Number);
        const [endHour, endMin] = endTime.split(':').map(Number);

        let totalEarnings = 0;
        let breakdown = {
          regularHours: 0,
          regularEarnings: 0,
          nightHours: 0,
          nightEarnings: 0,
          flexibleHours: 0,
          flexibleEarnings: 0,
          dayPremiumHours: 0,
          dayPremiumEarnings: 0,
          transportation: workplace.transportation || 0,
        };

        // æ™‚é–“ã‚’åˆ†å˜ä½ã§è¨ˆç®—
        let currentMinutes = startHour * 60 + startMin;
        let endMinutes = endHour * 60 + endMin;

        // ç¿Œæ—¥çµ‚äº†ã®å ´åˆã¯24æ™‚é–“ã‚’è¿½åŠ 
        if (nextDayEnd && endMinutes <= currentMinutes) {
          endMinutes += 24 * 60;
        }

        // 15åˆ†å˜ä½ã§è¨ˆç®—
        while (currentMinutes < endMinutes) {
          const nextMinutes = Math.min(currentMinutes + 15, endMinutes);
          const segmentHours = (nextMinutes - currentMinutes) / 60;
          const currentHour = Math.floor(currentMinutes / 60) % 24;

          // åŸºæœ¬æ™‚çµ¦ã‚’æ±ºå®š
          let baseHourly = workplace.baseHourly;
          let isSpecialDay = false;

          // æ›œæ—¥åˆ¥æ™‚çµ¦ãƒã‚§ãƒƒã‚¯
          if (
            workplace.dayPremium &&
            workplace.dayPremium.days.includes(dayOfWeek)
          ) {
            isSpecialDay = true;
            if (workplace.dayPremium.type === 'fixed') {
              baseHourly = workplace.dayPremium.rate;
            } else if (workplace.dayPremium.type === 'premium') {
              baseHourly =
                workplace.baseHourly * (workplace.dayPremium.rate / 100);
            }
          }

          // æ™‚é–“å¸¯åˆ¥å‰²å¢—ãƒã‚§ãƒƒã‚¯
          let timeRateMultiplier = 1;
          let isFlexibleTime = false;

          if (
            workplace.nightShift?.type === 'flexible' &&
            workplace.flexibleRates
          ) {
            // æŸ”è»Ÿãªæ™‚é–“å¸¯è¨­å®šã‚’ãƒã‚§ãƒƒã‚¯
            for (const slot of workplace.flexibleRates) {
              if (isTimeInSlot(currentHour, slot)) {
                timeRateMultiplier = slot.rate / 100;
                isFlexibleTime = true;
                break;
              }
            }
          } else if (workplace.nightShift?.type === 'legal') {
            // æ³•å®šæ·±å¤œæ™‚é–“å¸¯ (22:00-5:00)
            if (currentHour >= 22 || currentHour < 5) {
              timeRateMultiplier = 1.25;
              isFlexibleTime = true;
            }
          }

          const hourlyWage = baseHourly * timeRateMultiplier;
          const earnings = hourlyWage * segmentHours;

          if (isFlexibleTime) {
            breakdown.flexibleHours += segmentHours;
            breakdown.flexibleEarnings += earnings;
          } else if (isSpecialDay) {
            breakdown.dayPremiumHours += segmentHours;
            breakdown.dayPremiumEarnings += earnings;
          } else {
            breakdown.regularHours += segmentHours;
            breakdown.regularEarnings += earnings;
          }

          totalEarnings += earnings;
          currentMinutes = nextMinutes;
        }

        // äº¤é€šè²»ã‚’è¿½åŠ 
        totalEarnings += breakdown.transportation;

        return {
          totalEarnings: Math.round(totalEarnings),
          breakdown: breakdown,
        };
      }

      // æŒ‡å®šæ™‚é–“ãŒæ™‚é–“å¸¯ã‚¹ãƒ­ãƒƒãƒˆã«å«ã¾ã‚Œã‚‹ã‹ãƒã‚§ãƒƒã‚¯
      function isTimeInSlot(hour, slot) {
        const [startHour] = slot.startTime.split(':').map(Number);
        const [endHour] = slot.endTime.split(':').map(Number);

        if (slot.crossMidnight) {
          // ç¿Œæ—¥ã«ã¾ãŸãŒã‚‹å ´åˆ
          return hour >= startHour || hour < endHour;
        } else {
          // åŒæ—¥å†…ã®å ´åˆ
          return hour >= startHour && hour < endHour;
        }
      }

      // ã‚·ãƒ³ãƒ—ãƒ«ãªåŠ´åƒæ™‚é–“è¨ˆç®—ï¼ˆå¾Œæ–¹äº’æ›ç”¨ï¼‰
      function calculateHours(start, end) {
        const [startHour, startMin] = start.split(':').map(Number);
        const [endHour, endMin] = end.split(':').map(Number);
        const startMinutes = startHour * 60 + startMin;
        const endMinutes = endHour * 60 + endMin;
        return (endMinutes - startMinutes) / 60;
      }

      // ã‚·ãƒ•ãƒˆä¿å­˜
      function saveShift() {
        const workplaceId = document.getElementById('workplaceSelect').value;
        const startTime = document.getElementById('startTime').value;
        const endTime = document.getElementById('endTime').value;
        const crossMidnight =
          document.getElementById('crossMidnight')?.checked || false;

        if (!workplaceId || !startTime || !endTime) {
          alert('ãƒã‚¤ãƒˆå…ˆã€é–‹å§‹æ™‚é–“ã€çµ‚äº†æ™‚é–“ã‚’å…¨ã¦å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
          return;
        }

        if (!workplaces[workplaceId]) {
          alert('é¸æŠã•ã‚ŒãŸãƒã‚¤ãƒˆå…ˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
          return;
        }

        // æ–°ã—ã„åå…¥è¨ˆç®—ã‚’ä½¿ç”¨ï¼ˆç¾åœ¨ã®æ—¥ä»˜ã‚’æ¸¡ã™ï¼‰
        const calculation = calculateExactEarnings(
          workplaceId,
          startTime,
          endTime,
          crossMidnight,
          currentDate
        );
        if (calculation.hours <= 0) {
          alert(
            'æœ‰åŠ¹ãªåŠ´åƒæ™‚é–“ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚ç¿Œæ—¥ã¾ã§åƒãå ´åˆã¯ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚'
          );
          return;
        }

        // ã‚·ãƒ•ãƒˆãƒ‡ãƒ¼ã‚¿ä¿å­˜ï¼ˆæ–°ã—ã„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ ï¼‰
        shifts[currentDate] = {
          workplaceId: workplaceId,
          workplace: workplaces[workplaceId].name,
          start: startTime,
          end: endTime,
          crossMidnight: crossMidnight,
          earnings: calculation.totalEarnings,
          breakdown: calculation.breakdown,
          hours: calculation.hours,
        };

        // UIæ›´æ–°
        addShiftToCalendar(
          currentDate,
          workplaceId,
          startTime,
          endTime,
          crossMidnight
        );
        updateSummary();
        closePopups();
      }

      // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«ã‚·ãƒ•ãƒˆã‚’è¿½åŠ 
      function addShiftToCalendar(
        date,
        workplaceId,
        startTime,
        endTime,
        crossMidnight = false
      ) {
        const dayElement = document.querySelector(
          `[onclick="openShiftPopup('${date}')"]`
        );
        if (dayElement && workplaces[workplaceId]) {
          // æ—¢å­˜ã®ã‚·ãƒ•ãƒˆãƒãƒƒãƒ—ã‚’å‰Šé™¤
          const existingChip = dayElement.querySelector('.shift-chip');
          if (existingChip) {
            existingChip.remove();
          }

          // æ™‚é–“è¡¨ç¤ºã‚’ç¿Œæ—¥å¯¾å¿œã§èª¿æ•´
          let timeDisplay = `${startTime}-${endTime}`;
          if (crossMidnight) {
            const [endHour] = endTime.split(':');
            if (parseInt(endHour) < 12) {
              // çµ‚äº†æ™‚é–“ãŒåˆå‰ä¸­ãªã‚‰ç¿Œæ—¥è¡¨ç¤º
              timeDisplay = `${startTime}-ç¿Œ${endTime}`;
            }
          }

          // æ–°ã—ã„ã‚·ãƒ•ãƒˆãƒãƒƒãƒ—ã‚’è¿½åŠ 
          const shiftChip = document.createElement('div');
          shiftChip.className = `shift-chip ${workplaces[workplaceId].color}`;
          shiftChip.textContent = timeDisplay;
          shiftChip.title = `${workplaces[workplaceId].name} ${timeDisplay}`;
          shiftChip.onclick = event => editShift(event, date);
          dayElement.appendChild(shiftChip);
        }
      }

      // ã‚·ãƒ•ãƒˆå‰Šé™¤
      function deleteShift(date) {
        if (confirm('ã“ã®ã‚·ãƒ•ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
          // ã‚·ãƒ•ãƒˆãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å‰Šé™¤
          delete shifts[date];

          // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰å‰Šé™¤
          const dayElement = document.querySelector(
            `[onclick="openShiftPopup('${date}')"]`
          );
          if (dayElement) {
            const existingChip = dayElement.querySelector('.shift-chip');
            if (existingChip) {
              existingChip.remove();
            }
          }

          // çµ±è¨ˆã‚’æ›´æ–°
          updateSummary();
        }
      }

      // ç¾åœ¨ã®ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‹ã‚‰ã‚·ãƒ•ãƒˆå‰Šé™¤
      function deleteCurrentShift() {
        if (currentDate && shifts[currentDate]) {
          deleteShift(currentDate);
          closePopups(); // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‰ã˜ã‚‹
        }
      }

      // 25æ™‚å¯¾å¿œã®æ™‚é–“å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¨­å®š
      function setupExtendedTimeInputs() {
        const endTimeInput = document.getElementById('endTime');
        if (endTimeInput) {
          // 25æ™‚ã¾ã§å¯¾å¿œã™ã‚‹ãŸã‚ã®ã‚«ã‚¹ã‚¿ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
          endTimeInput.addEventListener('change', function () {
            const timeValue = this.value;
            if (timeValue) {
              const [hours, minutes] = timeValue.split(':').map(Number);
              if (hours >= 0 && hours <= 23) {
                // é€šå¸¸ã®æ™‚é–“ç¯„å›²ã§ã¯ä½•ã‚‚ã—ãªã„
              } else if (hours === 24 || hours === 25) {
                // 24æ™‚ã€25æ™‚ã®å ´åˆã¯ç‰¹åˆ¥å‡¦ç†ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶åˆ¶é™ã«ã‚ˆã‚Šæ‰‹å‹•å…¥åŠ›ãŒå¿…è¦ï¼‰
                alert(
                  '24æ™‚ä»¥é™ã®æ™‚é–“ã¯ã€Œç¿Œæ—¥ã¾ã§åƒãã€ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦è¨­å®šã—ã¦ãã ã•ã„'
                );
              }
            }
          });
        }
      }

      // åŠ´åƒæ™‚é–“è¨ˆç®—ã‚’æ”¹è‰¯ï¼ˆ25æ™‚ã¾ã§å¯¾å¿œï¼‰
      function calculateAdvancedHours(
        startTime,
        endTime,
        crossMidnight = false
      ) {
        let [startHour, startMin] = startTime.split(':').map(Number);
        let [endHour, endMin] = endTime.split(':').map(Number);

        // 25æ™‚å¯¾å¿œï¼ˆ25:00 = ç¿Œæ—¥1:00ã¨ã—ã¦æ‰±ã†ï¼‰
        if (crossMidnight) {
          if (endHour < startHour) {
            endHour += 24; // ç¿Œæ—¥æ‰±ã„
          }
        }

        const startMinutes = startHour * 60 + startMin;
        const endMinutes = endHour * 60 + endMin;

        if (endMinutes <= startMinutes) {
          return 0; // ç„¡åŠ¹ãªæ™‚é–“
        }

        return (endMinutes - startMinutes) / 60;
      }

      // æ­£ç¢ºãªåå…¥è¨ˆç®—ï¼ˆç™»éŒ²ã•ã‚ŒãŸãƒã‚¤ãƒˆå…ˆãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ï¼‰
      function calculateExactEarnings(
        workplaceId,
        startTime,
        endTime,
        crossMidnight = false,
        workDate = null
      ) {
        const workplace = workplaces[workplaceId];
        if (!workplace) return { totalEarnings: 0, breakdown: [] };

        const totalHours = calculateAdvancedHours(
          startTime,
          endTime,
          crossMidnight
        );
        if (totalHours <= 0) return { totalEarnings: 0, breakdown: [] };

        // å‹¤å‹™æ—¥ã®æ›œæ—¥ã‚’å–å¾—
        let dayOfWeek = 0; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯æ—¥æ›œæ—¥
        if (workDate) {
          dayOfWeek = new Date(workDate).getDay();
        } else if (currentDate) {
          dayOfWeek = new Date(currentDate).getDay();
        }

        // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
        console.log('=== åå…¥è¨ˆç®—ãƒ‡ãƒãƒƒã‚° ===');
        console.log('å‹¤å‹™å…ˆãƒ‡ãƒ¼ã‚¿:', workplace);
        console.log('å‹¤å‹™æ—¥:', workDate || currentDate, 'æ›œæ—¥:', dayOfWeek);
        console.log(
          'å‹¤å‹™æ™‚é–“:',
          startTime,
          '-',
          endTime,
          '(',
          totalHours,
          'h)'
        );
        console.log('ç¿Œæ—¥:', crossMidnight);

        let totalEarnings = 0;
        const breakdown = [];

        // åŸºæœ¬æ™‚çµ¦ã‚’æ›œæ—¥åˆ¥ã§èª¿æ•´
        let hourlyRate = workplace.baseHourly;
        let isWeekendPremium = false;

        // æ›œæ—¥åˆ¥å‰²å¢—ã®ç¢ºèªï¼ˆé‡‘åœŸæ—¥ï¼š5, 6, 0ï¼‰
        console.log('æ›œæ—¥åˆ¥å‰²å¢—ãƒã‚§ãƒƒã‚¯:', workplace.dayPremium);
        if (
          workplace.dayPremium &&
          workplace.dayPremium.enabled &&
          workplace.dayPremium.days
        ) {
          console.log('è¨­å®šã•ã‚ŒãŸæ›œæ—¥:', workplace.dayPremium.days);
          console.log(
            'ä»Šæ—¥ã®æ›œæ—¥:',
            dayOfWeek,
            'å«ã¾ã‚Œã‚‹?',
            workplace.dayPremium.days.includes(dayOfWeek)
          );

          if (workplace.dayPremium.days.includes(dayOfWeek)) {
            hourlyRate = workplace.baseHourly * workplace.dayPremium.multiplier;
            isWeekendPremium = true;

            const dayNames = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
            breakdown.push(
              `${dayNames[dayOfWeek]}æ›œæ—¥å‰²å¢—: ${workplace.baseHourly}å†† â†’ ${Math.round(hourlyRate)}å†† (Ã—${workplace.dayPremium.multiplier})`
            );
            console.log('æ›œæ—¥å‰²å¢—é©ç”¨:', hourlyRate);
          }
        }

        // åŸºæœ¬æ™‚çµ¦è¨ˆç®—
        let baseEarnings = totalHours * hourlyRate;
        totalEarnings += baseEarnings;

        if (isWeekendPremium) {
          breakdown.push(
            `å‰²å¢—çµ¦ä¸: ${totalHours}h Ã— ${Math.round(hourlyRate)}å†† = ${Math.round(baseEarnings)}å††`
          );
        } else {
          breakdown.push(
            `åŸºæœ¬çµ¦: ${totalHours}h Ã— ${hourlyRate}å†† = ${Math.round(baseEarnings)}å††`
          );
        }

        // æ·±å¤œæ‰‹å½“è¨ˆç®—ï¼ˆè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆï¼‰
        console.log('æ·±å¤œæ‰‹å½“ãƒã‚§ãƒƒã‚¯:', workplace.nightRate);
        if (workplace.nightRate && workplace.nightRate.enabled) {
          const nightHours = calculateNightHours(
            startTime,
            endTime,
            workplace.nightRate,
            crossMidnight
          );
          console.log('æ·±å¤œæ™‚é–“:', nightHours, 'h');

          if (nightHours > 0) {
            // æ·±å¤œæ‰‹å½“ã¯æ›œæ—¥åˆ¥æ™‚çµ¦ã‚’åŸºæº–ã«è¨ˆç®—
            const nightBonus =
              nightHours * hourlyRate * (workplace.nightRate.multiplier - 1);
            totalEarnings += nightBonus;
            breakdown.push(
              `æ·±å¤œæ‰‹å½“: ${nightHours}h Ã— ${Math.round(hourlyRate)}å†† Ã— ${((workplace.nightRate.multiplier - 1) * 100).toFixed(0)}% = ${Math.round(nightBonus)}å††`
            );
            console.log('æ·±å¤œæ‰‹å½“é©ç”¨:', nightBonus, 'å††');
          }
        }

        // ä¼‘æ—¥æ‰‹å½“è¨ˆç®—ï¼ˆè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆï¼‰- æ›œæ—¥åˆ¥å‰²å¢—ã¨é‡è¤‡ã—ãªã„å ´åˆã®ã¿
        if (
          workplace.holidayRate &&
          workplace.holidayRate.enabled &&
          !isWeekendPremium
        ) {
          if (
            workplace.holidayRate.days &&
            workplace.holidayRate.days.includes(dayOfWeek)
          ) {
            const holidayBonus =
              totalHours * hourlyRate * (workplace.holidayRate.multiplier - 1);
            totalEarnings += holidayBonus;
            breakdown.push(
              `ä¼‘æ—¥æ‰‹å½“: ${totalHours}h Ã— ${Math.round(hourlyRate)}å†† Ã— ${((workplace.holidayRate.multiplier - 1) * 100).toFixed(0)}% = ${Math.round(holidayBonus)}å††`
            );
          }
        }

        // äº¤é€šè²»è¨ˆç®—
        if (workplace.transportation && workplace.transportation > 0) {
          totalEarnings += workplace.transportation;
          breakdown.push(`äº¤é€šè²»: ${workplace.transportation}å††`);
        }

        console.log('æœ€çµ‚è¨ˆç®—çµæœ:', Math.round(totalEarnings), 'å††');
        console.log('å†…è¨³:', breakdown);
        console.log('========================');

        return {
          totalEarnings: Math.round(totalEarnings),
          breakdown: breakdown,
          hours: totalHours,
        };
      }

      // æ·±å¤œæ™‚é–“ã®è¨ˆç®—ï¼ˆ22æ™‚-5æ™‚ï¼‰
      function calculateNightHours(
        startTime,
        endTime,
        nightRate,
        crossMidnight = false
      ) {
        const [startHour, startMin] = startTime.split(':').map(Number);
        let [endHour, endMin] = endTime.split(':').map(Number);

        if (crossMidnight && endHour < startHour) {
          endHour += 24;
        }

        let nightMinutes = 0;

        // 1åˆ†ã”ã¨ã«æ·±å¤œæ™‚é–“ã‚’ãƒã‚§ãƒƒã‚¯
        for (
          let minute = startHour * 60 + startMin;
          minute < endHour * 60 + endMin;
          minute++
        ) {
          const currentHour = Math.floor(minute / 60) % 24;
          if (currentHour >= 22 || currentHour < 5) {
            nightMinutes++;
          }
        }

        return nightMinutes / 60; // æ™‚é–“ã«å¤‰æ›
      }

      // ã‚·ãƒ•ãƒˆã®è·å ´é¸æŠè‚¢ã‚’æ›´æ–°
      function updateShiftWorkplaceOptions() {
        const selectElement = document.getElementById('workplaceSelect');
        const workplaceEntries = Object.entries(workplaces);

        if (workplaceEntries.length === 0) {
          selectElement.innerHTML =
            '<option value="">ã¾ãšãƒã‚¤ãƒˆå…ˆã‚’ç™»éŒ²ã—ã¦ãã ã•ã„</option>';
          return;
        }

        selectElement.innerHTML = workplaceEntries
          .map(
            ([id, workplace]) =>
              `<option value="${id}">${workplace.name} (æ™‚çµ¦${workplace.baseHourly}å††)</option>`
          )
          .join('');
      }

      // æ›œæ—¥åˆ¥è¨­å®šãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®è¡¨ç¤º/éè¡¨ç¤º
      function updateDayPremiumFields() {
        const hasSelectedDays = Array.from(
          document.querySelectorAll('[id^="dayPremium_"]')
        ).some(checkbox => checkbox.checked);

        const rateInput = document.getElementById('dayPremiumRate');
        const typeSelect = document.getElementById('dayPremiumType');

        rateInput.disabled = !hasSelectedDays;
        typeSelect.disabled = !hasSelectedDays;

        // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’å‹•çš„ã«æ›´æ–°
        if (hasSelectedDays) {
          const baseHourly =
            parseInt(document.getElementById('baseHourlyWage').value) || 1000;
          const type = typeSelect.value;

          if (type === 'rate') {
            rateInput.placeholder = `${baseHourly + 100} (å††)`;
          } else if (type === 'multiplier') {
            rateInput.placeholder = '10 (%)';
          }
        } else {
          rateInput.placeholder = 'æ™‚çµ¦ (å††)';
        }
      }

      // æ·±å¤œè¨­å®šãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®è¡¨ç¤º/éè¡¨ç¤º
      function updateNightShiftFields() {
        const nightShiftType = document.getElementById('nightShiftType').value;
        const configureButton = document.getElementById('configureFlexible');
        const display = document.getElementById('flexibleRatesDisplay');

        if (nightShiftType === 'flexible') {
          configureButton.style.display = 'block';
          updateFlexibleRatesDisplay();
        } else {
          configureButton.style.display = 'none';
          display.style.display = 'none';
        }
      }

      // ã‚µãƒãƒªãƒ¼æ›´æ–°
      function updateSummary() {
        const thisMonthShifts = Object.values(shifts);
        const totalHours = thisMonthShifts.reduce(
          (sum, shift) => sum + calculateHours(shift.start, shift.end),
          0
        );
        const totalEarnings = thisMonthShifts.reduce(
          (sum, shift) => sum + shift.earnings,
          0
        );
        const shiftCount = thisMonthShifts.length;
        const avgHours = shiftCount > 0 ? totalHours / shiftCount : 0;

        // æœˆæ¬¡ã‚µãƒãƒªãƒ¼æ›´æ–°
        document.getElementById('monthlyHours').textContent =
          Math.round(totalHours) + 'h';
        document.getElementById('monthlyEarnings').textContent =
          totalEarnings.toLocaleString() + 'å††';
        document.getElementById('shiftCount').textContent = shiftCount + 'æ—¥';
        document.getElementById('avgHours').textContent =
          avgHours.toFixed(1) + 'h';

        // å¹´é–“æ‰¶é¤Šã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ï¼ˆç°¡æ˜“è¨ˆç®—ï¼‰
        const yearlyEarnings = totalEarnings * 12; // æœˆå¹³å‡ã‹ã‚‰å¹´é–“äºˆæ¸¬
        const fuyouLimit = 1030000;
        const remainingAmount = Math.max(0, fuyouLimit - yearlyEarnings);
        const achievementRate = Math.min(
          100,
          Math.round((yearlyEarnings / fuyouLimit) * 100)
        );

        document.getElementById('yearlyIncome').textContent =
          yearlyEarnings.toLocaleString() + 'å††';
        document.getElementById('remainingAmount').textContent =
          remainingAmount.toLocaleString() + 'å††';
        document.getElementById('achievementRate').textContent =
          achievementRate + '%';
        document.getElementById('yearEndPrediction').textContent =
          yearlyEarnings.toLocaleString() + 'å††';
        document.getElementById('progressFill').style.width =
          achievementRate + '%';

        // ã‚¢ãƒ©ãƒ¼ãƒˆæ›´æ–°
        const alertElement = document.getElementById('fuyouAlert');
        if (achievementRate < 80) {
          alertElement.textContent = 'æ‰¶é¤Šå†…ã§ã™ï¼å®‰å…¨ãªç¯„å›²ã§åƒã‘ã¦ã„ã¾ã™ã€‚';
          alertElement.className = 'alert success';
        } else if (achievementRate < 95) {
          alertElement.textContent = 'æ³¨æ„: æ‰¶é¤Šé™åº¦é¡ã«è¿‘ã¥ã„ã¦ã„ã¾ã™ã€‚';
          alertElement.className = 'alert warning';
        } else {
          alertElement.textContent =
            'å±é™º: æ‰¶é¤Šé™åº¦é¡ã‚’è¶…éã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼';
          alertElement.className = 'alert danger';
        }
      }

      // ã‚·ãƒ•ãƒˆç·¨é›†
      function editShift(event, date) {
        event.stopPropagation();
        openShiftPopup(date);
      }

      // ãã®ä»–ã®æ©Ÿèƒ½
      function startOCR() {
        // OCRæ©Ÿèƒ½ã¯å¾Œã§å®Ÿè£…
        console.log('OCRæ©Ÿèƒ½');
      }

      function addShift() {
        const today = new Date().toISOString().split('T')[0];
        openShiftPopup(today);
      }

      function uploadPayslip() {
        // çµ¦ä¸æ˜ç´°ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ã¯å¾Œã§å®Ÿè£…
        console.log('çµ¦ä¸æ˜ç´°ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½');
      }

      // ãƒ†ã‚¹ãƒˆç”¨é–¢æ•°ï¼ˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰å®Ÿè¡Œå¯èƒ½ï¼‰
      function testCalculation(
        workplaceId,
        startTime,
        endTime,
        crossMidnight = false,
        testDate = null
      ) {
        console.log('=== æ‰‹å‹•ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ ===');
        const result = calculateExactEarnings(
          workplaceId,
          startTime,
          endTime,
          crossMidnight,
          testDate
        );
        console.log('ãƒ†ã‚¹ãƒˆçµæœ:', result);
        return result;
      }

      // ãƒ‡ãƒãƒƒã‚°ç”¨: LocalStorageã‚’ã‚¯ãƒªã‚¢
      function clearAllData() {
        localStorage.removeItem('workplaces');
        localStorage.removeItem('workplaceIdCounter');
        localStorage.removeItem('shifts');
        console.log('LocalStorageã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
        location.reload();
      }

      // ãƒ‡ãƒãƒƒã‚°ç”¨: ç¾åœ¨ã®å‹¤å‹™å…ˆãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
      function showWorkplaceData() {
        console.log('ç¾åœ¨ã®å‹¤å‹™å…ˆãƒ‡ãƒ¼ã‚¿:', workplaces);
        return workplaces;
      }

      // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
      document.addEventListener('DOMContentLoaded', function () {
        // ã‚·ãƒ•ãƒˆé–¢é€£ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        const workplaceSelect = document.getElementById('workplaceSelect');
        const startTime = document.getElementById('startTime');
        const endTime = document.getElementById('endTime');
        const crossMidnight = document.getElementById('crossMidnight');

        if (workplaceSelect)
          workplaceSelect.addEventListener('change', updatePredictedEarnings);
        if (startTime)
          startTime.addEventListener('change', updatePredictedEarnings);
        if (endTime)
          endTime.addEventListener('change', updatePredictedEarnings);
        if (crossMidnight)
          crossMidnight.addEventListener('change', updatePredictedEarnings);

        // æ‹¡å¼µæ™‚é–“å…¥åŠ›ã®è¨­å®š
        setupExtendedTimeInputs();

        // è·å ´ãƒ•ã‚©ãƒ¼ãƒ é–¢é€£ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        const nightShiftType = document.getElementById('nightShiftType');
        if (nightShiftType)
          nightShiftType.addEventListener('change', updateNightShiftFields);

        // æ›œæ—¥åˆ¥ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹
        for (let i = 0; i < 7; i++) {
          const checkbox = document.getElementById(`dayPremium_${i}`);
          if (checkbox)
            checkbox.addEventListener('change', updateDayPremiumFields);
        }

        // æ›œæ—¥åˆ¥è¨­å®šã‚¿ã‚¤ãƒ—å¤‰æ›´æ™‚
        const dayPremiumType = document.getElementById('dayPremiumType');
        if (dayPremiumType)
          dayPremiumType.addEventListener('change', updateDayPremiumFields);

        // åŸºæœ¬æ™‚çµ¦å¤‰æ›´æ™‚
        const baseHourlyWage = document.getElementById('baseHourlyWage');
        if (baseHourlyWage)
          baseHourlyWage.addEventListener('input', updateDayPremiumFields);

        // åˆæœŸåŒ–
        updateSummary();
        updateShiftWorkplaceOptions();

        // ãƒ‡ãƒãƒƒã‚°: èª­ã¿è¾¼ã¾ã‚ŒãŸå‹¤å‹™å…ˆãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
        console.log('=== ã‚¢ãƒ—ãƒªåˆæœŸåŒ– ===');
        console.log('èª­ã¿è¾¼ã¾ã‚ŒãŸå‹¤å‹™å…ˆãƒ‡ãƒ¼ã‚¿:', workplaces);
        Object.entries(workplaces).forEach(([id, workplace]) => {
          console.log(`${id}:`, workplace);
          if (workplace.dayPremium) {
            console.log(
              `  æ›œæ—¥åˆ¥è¨­å®š: ${workplace.dayPremium.days?.map(d => ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'][d]).join(',')} - ${workplace.dayPremium.multiplier}å€`
            );
          }
        });

        // è·å ´ãŒç©ºã®å ´åˆã¯æ³¨æ„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        if (Object.keys(workplaces).length === 0) {
          console.log(
            'ãƒã‚¤ãƒˆå…ˆãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã¾ãšã€Œãƒã‚¤ãƒˆå…ˆã‚’ç®¡ç†ã€ã‹ã‚‰è·å ´ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚'
          );
        }
      });
    </script>
  </body>
</html>
<!-- Force deploy: Mon Jul 21 23:20:41 JST 2025 -->
