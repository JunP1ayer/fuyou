<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>バイト扶養管理アプリ - シフトボード v2.0</title>
    <!-- Cache busting: 2025-01-21T23:30 -->
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Roboto', 'Noto Sans JP', sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      .header {
        background: white;
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 20px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      }

      .header h1 {
        color: #1976d2;
        font-size: 28px;
        font-weight: bold;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .header .subtitle {
        color: #666;
        font-size: 16px;
      }

      .status-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
      }

      .fuyou-status {
        background: white;
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      }

      .alert {
        padding: 16px;
        border-radius: 12px;
        margin-bottom: 20px;
        font-weight: 500;
      }

      .alert.success {
        background: #e8f5e8;
        color: #2e7d32;
        border-left: 4px solid #4caf50;
      }

      .alert.warning {
        background: #fff8e1;
        color: #f57c00;
        border-left: 4px solid #ff9800;
      }

      .alert.danger {
        background: #ffebee;
        color: #c62828;
        border-left: 4px solid #f44336;
      }

      .progress-bar {
        background: #e0e0e0;
        height: 8px;
        border-radius: 4px;
        margin: 16px 0;
        overflow: hidden;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #4caf50, #66bb6a);
        width: 63%;
        transition: width 0.3s ease;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 16px;
        margin-top: 20px;
      }

      .stat-card {
        background: #f5f5f5;
        padding: 16px;
        border-radius: 12px;
        text-align: center;
      }

      .stat-value {
        font-size: 20px;
        font-weight: bold;
        color: #1976d2;
      }

      .stat-label {
        font-size: 12px;
        color: #666;
        margin-top: 4px;
      }

      .quick-actions {
        background: white;
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      }

      .action-button {
        width: 100%;
        padding: 16px;
        margin-bottom: 12px;
        border: none;
        border-radius: 12px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }

      .action-button.primary {
        background: #1976d2;
        color: white;
      }

      .action-button.primary:hover {
        background: #1565c0;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(25, 118, 210, 0.3);
      }

      .action-button.outlined {
        background: white;
        border: 2px solid #1976d2;
        color: #1976d2;
      }

      .action-button.outlined:hover {
        background: #f3f9ff;
        transform: translateY(-1px);
      }

      .calendar-card {
        background: white;
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      }

      .calendar-header {
        display: flex;
        justify-content: between;
        align-items: center;
        margin-bottom: 20px;
      }

      .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 8px;
      }

      .calendar-day {
        aspect-ratio: 1;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        padding: 4px;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
        background: white;
        min-height: 80px;
      }

      .calendar-day:hover {
        background: #f0f9ff;
        border-color: #1976d2;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(25, 118, 210, 0.2);
      }

      .calendar-day.other-month {
        color: #ccc;
        background: #f8f8f8;
      }

      .calendar-day.today {
        background: #fff3cd;
        border-color: #ffc107;
        font-weight: bold;
      }

      .date-number {
        font-size: 16px;
        font-weight: 500;
        margin-bottom: 4px;
      }

      .shift-chip {
        background: linear-gradient(135deg, #4caf50, #66bb6a);
        color: white;
        font-size: 10px;
        padding: 2px 6px;
        border-radius: 12px;
        margin: 1px 0;
        font-weight: 500;
        min-width: 0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 100%;
        cursor: pointer;
        transition: transform 0.2s ease;
      }

      .shift-chip:hover {
        transform: scale(1.05);
        z-index: 10;
      }

      .delete-btn {
        position: absolute;
        top: -5px;
        right: -5px;
        width: 16px;
        height: 16px;
        background: #f44336;
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.2s ease;
        opacity: 0;
      }

      .shift-chip {
        position: relative;
      }

      .shift-chip:hover .delete-btn {
        opacity: 1;
      }

      .delete-btn:hover {
        background: #d32f2f;
        transform: scale(1.1);
      }

      .delete-shift-btn:hover {
        background: #d32f2f !important;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(244, 67, 54, 0.3);
      }

      .shift-chip.company-a {
        background: linear-gradient(135deg, #2e7d32, #4caf50);
      }

      .shift-chip.company-b {
        background: linear-gradient(135deg, #e65100, #ff9800);
      }

      .shift-chip.company-c {
        background: linear-gradient(135deg, #ad1457, #e91e63);
      }

      .floating-btn {
        position: fixed;
        bottom: 24px;
        right: 24px;
        width: 64px;
        height: 64px;
        background: linear-gradient(135deg, #1976d2, #42a5f5);
        color: white;
        border: none;
        border-radius: 50%;
        font-size: 24px;
        cursor: pointer;
        box-shadow: 0 4px 20px rgba(25, 118, 210, 0.4);
        transition: all 0.3s ease;
      }

      .floating-btn:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 25px rgba(25, 118, 210, 0.5);
      }

      /* ポップアップ共通スタイル */
      .popup {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        min-width: 320px;
        display: none;
        max-height: 90vh;
        overflow-y: auto;
      }

      .shift-popup {
        min-width: 320px;
      }

      .workplace-popup {
        min-width: 480px;
      }

      .popup-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.3);
        z-index: 999;
        display: none;
      }

      .popup-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .popup-title {
        font-size: 18px;
        font-weight: bold;
        color: #1976d2;
      }

      .close-btn {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #666;
        padding: 4px;
      }

      .form-group {
        margin-bottom: 16px;
      }

      .form-label {
        display: block;
        font-weight: 500;
        margin-bottom: 8px;
        color: #333;
      }

      .form-input,
      .form-select {
        width: 100%;
        padding: 12px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 14px;
        transition: border-color 0.2s ease;
      }

      .form-input:focus,
      .form-select:focus {
        outline: none;
        border-color: #1976d2;
      }

      .time-inputs {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }

      .template-buttons {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
        margin-bottom: 16px;
      }

      .template-btn {
        padding: 10px;
        border: 2px solid #e0e0e0;
        background: white;
        border-radius: 8px;
        cursor: pointer;
        font-size: 12px;
        transition: all 0.2s ease;
      }

      .template-btn:hover {
        border-color: #1976d2;
        background: #f0f9ff;
      }

      .submit-btn {
        width: 100%;
        padding: 12px;
        background: linear-gradient(135deg, #1976d2, #42a5f5);
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
        transition: transform 0.2s ease;
      }

      .submit-btn:hover {
        transform: translateY(-2px);
      }

      /* 職場管理 */
      .workplace-list {
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        margin-bottom: 16px;
      }

      .workplace-item {
        padding: 12px 16px;
        border-bottom: 1px solid #f0f0f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .workplace-item:last-child {
        border-bottom: none;
      }

      .workplace-info {
        flex: 1;
      }

      .workplace-name {
        font-weight: 500;
        color: #333;
      }

      .workplace-details {
        font-size: 12px;
        color: #666;
        margin-top: 2px;
      }

      .workplace-actions {
        display: flex;
        gap: 8px;
      }

      .btn-small {
        padding: 4px 8px;
        border: none;
        border-radius: 4px;
        font-size: 12px;
        cursor: pointer;
        transition: opacity 0.2s;
      }

      .btn-edit {
        background: #2196f3;
        color: white;
      }

      .btn-delete {
        background: #f44336;
        color: white;
      }

      .btn-small:hover {
        opacity: 0.8;
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }

      .form-row-3 {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 12px;
      }

      .checkbox-group {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 8px;
        margin-top: 8px;
      }

      .checkbox-item {
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 12px;
      }

      /* 合計表示エリア */
      .summary-panel {
        background: white;
        border-radius: 16px;
        padding: 20px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        margin-top: 20px;
      }

      .summary-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 16px;
      }

      .summary-item {
        text-align: center;
      }

      .summary-value {
        font-size: 20px;
        font-weight: bold;
        color: #1976d2;
      }

      .summary-label {
        font-size: 12px;
        color: #666;
        margin-top: 4px;
      }

      @media (max-width: 768px) {
        .status-grid {
          grid-template-columns: 1fr;
        }
        .stats-grid {
          grid-template-columns: repeat(2, 1fr);
        }
        .summary-grid {
          grid-template-columns: repeat(2, 1fr);
        }
        .shift-popup {
          width: 90%;
          min-width: 0;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- ヘッダー -->
      <div class="header">
        <h1>🏦 扶養管理 - シフトボード</h1>
        <div class="subtitle">学生アルバイター向け扶養控除自動管理システム</div>
      </div>

      <!-- メインコンテンツ -->
      <div class="status-grid">
        <!-- 扶養ステータス -->
        <div class="fuyou-status">
          <h2>📊 扶養ステータス</h2>

          <div class="alert success" id="fuyouAlert">
            扶養管理システム準備完了
          </div>

          <div>
            <div
              style="
                display: flex;
                justify-content: space-between;
                margin-bottom: 8px;
              "
            >
              <span>今年の収入: <span id="yearlyIncome">0円</span></span>
              <span>限度額: 1,030,000円</span>
            </div>
            <div class="progress-bar">
              <div
                class="progress-fill"
                id="progressFill"
                style="width: 0%"
              ></div>
            </div>
          </div>

          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-value" id="achievementRate">0%</div>
              <div class="stat-label">達成率</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="remainingAmount">1,030,000円</div>
              <div class="stat-label">残り余裕</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="yearEndPrediction">0円</div>
              <div class="stat-label">年末予測</div>
            </div>
          </div>
        </div>

        <!-- クイックアクション -->
        <div class="quick-actions">
          <h3>⚡ クイックアクション</h3>
          <br />

          <button
            class="action-button primary"
            onclick="openWorkplaceManager()"
          >
            🏢 バイト先を管理
          </button>

          <button class="action-button outlined" onclick="addShift()">
            ➕ シフト追加
          </button>

          <button class="action-button outlined" onclick="startOCR()">
            📸 シフト表を撮影
          </button>
        </div>
      </div>

      <!-- シフトカレンダー -->
      <div class="calendar-card">
        <div class="calendar-header">
          <h3>📅 シフトカレンダー - 2025年1月</h3>
        </div>

        <div class="calendar-grid">
          <!-- 曜日ヘッダー -->
          <div
            style="
              font-weight: bold;
              text-align: center;
              padding: 8px;
              color: #ef5350;
            "
          >
            日
          </div>
          <div style="font-weight: bold; text-align: center; padding: 8px">
            月
          </div>
          <div style="font-weight: bold; text-align: center; padding: 8px">
            火
          </div>
          <div style="font-weight: bold; text-align: center; padding: 8px">
            水
          </div>
          <div style="font-weight: bold; text-align: center; padding: 8px">
            木
          </div>
          <div style="font-weight: bold; text-align: center; padding: 8px">
            金
          </div>
          <div
            style="
              font-weight: bold;
              text-align: center;
              padding: 8px;
              color: #2196f3;
            "
          >
            土
          </div>

          <!-- カレンダー日付 -->
          <div
            class="calendar-day other-month"
            onclick="openShiftPopup('2024-12-29')"
          >
            <span class="date-number">29</span>
          </div>
          <div
            class="calendar-day other-month"
            onclick="openShiftPopup('2024-12-30')"
          >
            <span class="date-number">30</span>
          </div>
          <div
            class="calendar-day other-month"
            onclick="openShiftPopup('2024-12-31')"
          >
            <span class="date-number">31</span>
          </div>
          <div class="calendar-day" onclick="openShiftPopup('2025-01-01')">
            <span class="date-number">1</span>
          </div>
          <div class="calendar-day" onclick="openShiftPopup('2025-01-02')">
            <span class="date-number">2</span>
          </div>
          <div class="calendar-day" onclick="openShiftPopup('2025-01-03')">
            <span class="date-number">3</span>
          </div>
          <div class="calendar-day" onclick="openShiftPopup('2025-01-04')">
            <span class="date-number">4</span>
          </div>

          <div class="calendar-day" onclick="openShiftPopup('2025-01-05')">
            <span class="date-number">5</span>
          </div>
          <div class="calendar-day" onclick="openShiftPopup('2025-01-06')">
            <span class="date-number">6</span>
          </div>
          <div class="calendar-day" onclick="openShiftPopup('2025-01-07')">
            <span class="date-number">7</span>
          </div>
          <div class="calendar-day" onclick="openShiftPopup('2025-01-08')">
            <span class="date-number">8</span>
          </div>
          <div class="calendar-day" onclick="openShiftPopup('2025-01-09')">
            <span class="date-number">9</span>
          </div>
          <div class="calendar-day" onclick="openShiftPopup('2025-01-10')">
            <span class="date-number">10</span>
          </div>
          <div class="calendar-day" onclick="openShiftPopup('2025-01-11')">
            <span class="date-number">11</span>
          </div>

          <div class="calendar-day" onclick="openShiftPopup('2025-01-12')">
            <span class="date-number">12</span>
          </div>
          <div class="calendar-day" onclick="openShiftPopup('2025-01-13')">
            <span class="date-number">13</span>
          </div>
          <div class="calendar-day" onclick="openShiftPopup('2025-01-14')">
            <span class="date-number">14</span>
          </div>
          <div class="calendar-day" onclick="openShiftPopup('2025-01-15')">
            <span class="date-number">15</span>
          </div>
          <div class="calendar-day" onclick="openShiftPopup('2025-01-16')">
            <span class="date-number">16</span>
          </div>
          <div class="calendar-day" onclick="openShiftPopup('2025-01-17')">
            <span class="date-number">17</span>
          </div>
          <div class="calendar-day" onclick="openShiftPopup('2025-01-18')">
            <span class="date-number">18</span>
          </div>

          <div class="calendar-day" onclick="openShiftPopup('2025-01-19')">
            <span class="date-number">19</span>
          </div>
          <div class="calendar-day" onclick="openShiftPopup('2025-01-20')">
            <span class="date-number">20</span>
          </div>
          <div
            class="calendar-day today"
            onclick="openShiftPopup('2025-01-21')"
          >
            <span class="date-number">21</span>
          </div>
          <div class="calendar-day" onclick="openShiftPopup('2025-01-22')">
            <span class="date-number">22</span>
          </div>
          <div class="calendar-day" onclick="openShiftPopup('2025-01-23')">
            <span class="date-number">23</span>
          </div>
          <div class="calendar-day" onclick="openShiftPopup('2025-01-24')">
            <span class="date-number">24</span>
          </div>
          <div class="calendar-day" onclick="openShiftPopup('2025-01-25')">
            <span class="date-number">25</span>
          </div>

          <div class="calendar-day" onclick="openShiftPopup('2025-01-26')">
            <span class="date-number">26</span>
          </div>
          <div class="calendar-day" onclick="openShiftPopup('2025-01-27')">
            <span class="date-number">27</span>
          </div>
          <div class="calendar-day" onclick="openShiftPopup('2025-01-28')">
            <span class="date-number">28</span>
          </div>
          <div class="calendar-day" onclick="openShiftPopup('2025-01-29')">
            <span class="date-number">29</span>
          </div>
          <div class="calendar-day" onclick="openShiftPopup('2025-01-30')">
            <span class="date-number">30</span>
          </div>
          <div class="calendar-day" onclick="openShiftPopup('2025-01-31')">
            <span class="date-number">31</span>
          </div>
          <div
            class="calendar-day other-month"
            onclick="openShiftPopup('2025-02-01')"
          >
            <span class="date-number">1</span>
          </div>
        </div>
      </div>

      <!-- 月次サマリー -->
      <div class="summary-panel">
        <h3>📊 今月の実績・予測</h3>
        <div class="summary-grid">
          <div class="summary-item">
            <div class="summary-value" id="monthlyHours">0h</div>
            <div class="summary-label">今月勤務時間</div>
          </div>
          <div class="summary-item">
            <div class="summary-value" id="monthlyEarnings">0円</div>
            <div class="summary-label">今月収入</div>
          </div>
          <div class="summary-item">
            <div class="summary-value" id="shiftCount">0日</div>
            <div class="summary-label">シフト日数</div>
          </div>
          <div class="summary-item">
            <div class="summary-value" id="avgHours">0h</div>
            <div class="summary-label">1日平均</div>
          </div>
        </div>
      </div>
    </div>

    <!-- ポップアップオーバーレイ -->
    <div class="popup-overlay" id="popupOverlay" onclick="closePopups()"></div>

    <!-- 職場管理ポップアップ -->
    <div class="popup workplace-popup" id="workplacePopup">
      <div class="popup-header">
        <div class="popup-title">🏢 バイト先管理</div>
        <button class="close-btn" onclick="closePopups()">&times;</button>
      </div>

      <div class="workplace-list" id="workplaceList">
        <div style="text-align: center; padding: 20px; color: #666">
          まだバイト先が登録されていません
        </div>
      </div>

      <button
        class="submit-btn"
        onclick="openWorkplaceForm()"
        style="margin-bottom: 16px"
      >
        ➕ 新しいバイト先を追加
      </button>
    </div>

    <!-- 職場登録・編集ポップアップ -->
    <div class="popup workplace-popup" id="workplaceFormPopup">
      <div class="popup-header">
        <div class="popup-title">
          🏢 <span id="workplaceFormTitle">新しいバイト先を追加</span>
        </div>
        <button class="close-btn" onclick="closePopups()">&times;</button>
      </div>

      <div class="form-group">
        <label class="form-label">職場名 *</label>
        <input
          type="text"
          class="form-input"
          id="workplaceName"
          placeholder="例: ファミリーマート新宿店"
        />
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label">基本時給 (円) *</label>
          <input
            type="number"
            class="form-input"
            id="baseHourlyWage"
            placeholder="1000"
          />
        </div>
        <div class="form-group">
          <label class="form-label">交通費 (円)</label>
          <input
            type="number"
            class="form-input"
            id="transportationFee"
            placeholder="200"
            value="0"
          />
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">深夜・時間帯別割増</label>
        <div class="form-row">
          <select class="form-select" id="nightShiftType">
            <option value="none">割増なし</option>
            <option value="legal">法定深夜割増 (22:00-5:00, 25%)</option>
            <option value="flexible">柔軟な時間帯設定</option>
          </select>
          <button
            type="button"
            class="form-input"
            id="configureFlexible"
            onclick="openFlexibleRateConfig()"
            style="display: none; background: #f5f5f5; border: 2px dashed #ccc"
          >
            時間帯を設定
          </button>
        </div>
        <div id="flexibleRatesDisplay" style="margin-top: 8px; display: none">
          <div style="font-size: 12px; color: #666">設定された時間帯割増：</div>
          <div
            id="flexibleRatesList"
            style="font-size: 11px; color: #888; margin-top: 4px"
          ></div>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">曜日別時給設定</label>
        <div class="checkbox-group">
          <div class="checkbox-item">
            <input type="checkbox" id="dayPremium_0" />
            <label for="dayPremium_0">日</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="dayPremium_1" />
            <label for="dayPremium_1">月</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="dayPremium_2" />
            <label for="dayPremium_2">火</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="dayPremium_3" />
            <label for="dayPremium_3">水</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="dayPremium_4" />
            <label for="dayPremium_4">木</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="dayPremium_5" />
            <label for="dayPremium_5">金</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="dayPremium_6" />
            <label for="dayPremium_6">土</label>
          </div>
        </div>
        <div class="form-row" style="margin-top: 8px">
          <input
            type="number"
            class="form-input"
            id="dayPremiumRate"
            placeholder="1100 (円)"
            disabled
          />
          <select class="form-select" id="dayPremiumType" disabled>
            <option value="rate">固定時給</option>
            <option value="multiplier">割増 (%)</option>
          </select>
        </div>
      </div>

      <div class="form-row">
        <button
          class="submit-btn"
          onclick="saveWorkplace()"
          id="saveWorkplaceBtn"
        >
          保存
        </button>
        <button
          class="submit-btn"
          onclick="closeWorkplaceForm()"
          style="background: #666"
        >
          キャンセル
        </button>
      </div>
    </div>

    <!-- 柔軟な時間帯設定ポップアップ -->
    <div class="popup" id="flexibleRatePopup" style="min-width: 500px">
      <div class="popup-header">
        <div class="popup-title">⏰ 時間帯別割増設定</div>
        <button class="close-btn" onclick="closeFlexibleRateConfig()">
          &times;
        </button>
      </div>

      <div style="margin-bottom: 16px; font-size: 14px; color: #666">
        時間帯ごとに異なる割増率を設定できます（例：22:00-1:00は25%、1:00-5:00は15%など）
      </div>

      <div id="flexibleTimeSlots">
        <!-- 動的に生成 -->
      </div>

      <button
        class="submit-btn"
        onclick="addFlexibleTimeSlot()"
        style="background: #4caf50; margin-bottom: 16px"
      >
        ➕ 時間帯を追加
      </button>

      <div class="form-row">
        <button class="submit-btn" onclick="saveFlexibleRates()">保存</button>
        <button
          class="submit-btn"
          onclick="closeFlexibleRateConfig()"
          style="background: #666"
        >
          キャンセル
        </button>
      </div>
    </div>

    <!-- シフト登録ポップアップ -->
    <div class="popup shift-popup" id="shiftPopup">
      <div class="popup-header">
        <div class="popup-title">
          📅 <span id="popupDate">2025-01-21</span> のシフト登録
        </div>
        <button class="close-btn" onclick="closeShiftPopup()">&times;</button>
      </div>

      <div class="form-group">
        <label class="form-label">職場</label>
        <select class="form-select" id="workplaceSelect">
          <option value="convenience-a">コンビニA店 (時給1,200円)</option>
          <option value="cafe-b">カフェB店 (時給1,100円)</option>
          <option value="restaurant-c">レストランC店 (時給1,300円)</option>
        </select>
      </div>

      <div class="form-group">
        <label class="form-label">勤務時間</label>
        <div class="time-inputs">
          <div>
            <label style="font-size: 12px; color: #666">開始時間</label>
            <input
              type="time"
              class="form-input"
              id="startTime"
              value="10:00"
            />
          </div>
          <div>
            <label style="font-size: 12px; color: #666">終了時間</label>
            <input type="time" class="form-input" id="endTime" value="18:00" />
            <label style="font-size: 11px; color: #888">
              <input
                type="checkbox"
                id="crossMidnight"
                style="margin-right: 4px"
              />翌日まで働く
            </label>
          </div>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label"
          >予想収入: <span id="predictedEarnings">9,600円</span></label
        >
      </div>

      <div style="display: flex; gap: 10px; justify-content: space-between">
        <button class="submit-btn" onclick="saveShift()" style="flex: 1">
          シフト登録
        </button>
        <button
          class="delete-shift-btn"
          id="deleteShiftBtn"
          onclick="deleteCurrentShift()"
          style="
            display: none;
            flex: 0 0 120px;
            background: #f44336;
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
          "
        >
          削除
        </button>
      </div>
    </div>

    <!-- フローティングカメラボタン -->
    <button
      class="floating-btn"
      onclick="startOCR()"
      title="AIシフト表読み取り"
    >
      📸
    </button>

    <script>
      // データストレージ
      let shifts = {};
      let workplaces = JSON.parse(localStorage.getItem('workplaces') || '{}');
      let workplaceIdCounter = parseInt(
        localStorage.getItem('workplaceIdCounter') || '1'
      );

      // 現在編集中の職場ID
      let editingWorkplaceId = null;

      // 柔軟な時間帯設定
      let currentFlexibleRates = [];

      // カラーパレット
      const colorPalette = [
        'company-a',
        'company-b',
        'company-c',
        '#9c27b0',
        '#3f51b5',
        '#009688',
        '#ff5722',
        '#795548',
      ];

      let currentDate = '';

      // === 柔軟な時間帯設定機能 ===

      // 柔軟な時間帯設定ポップアップを開く
      function openFlexibleRateConfig() {
        currentFlexibleRates = [
          ...((editingWorkplaceId &&
            workplaces[editingWorkplaceId]?.flexibleRates) ||
            []),
        ];
        document.getElementById('flexibleRatePopup').style.display = 'block';
        renderFlexibleTimeSlots();
      }

      // 柔軟な時間帯設定ポップアップを閉じる
      function closeFlexibleRateConfig() {
        document.getElementById('flexibleRatePopup').style.display = 'none';
      }

      // 時間帯スロットを追加
      function addFlexibleTimeSlot() {
        const newSlot = {
          id: Date.now(),
          startTime: '22:00',
          endTime: '05:00',
          crossMidnight: true,
          rate: 125,
        };
        currentFlexibleRates.push(newSlot);
        renderFlexibleTimeSlots();
      }

      // 時間帯スロットを削除
      function removeFlexibleTimeSlot(id) {
        currentFlexibleRates = currentFlexibleRates.filter(
          slot => slot.id !== id
        );
        renderFlexibleTimeSlots();
      }

      // 時間帯スロットをレンダリング
      function renderFlexibleTimeSlots() {
        const container = document.getElementById('flexibleTimeSlots');

        if (currentFlexibleRates.length === 0) {
          container.innerHTML =
            '<div style="text-align: center; padding: 20px; color: #666;">時間帯を追加してください</div>';
          return;
        }

        container.innerHTML = currentFlexibleRates
          .map(
            (slot, index) => `
                <div class="form-group" style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 12px; margin-bottom: 12px;">
                    <div class="form-row-3">
                        <div>
                            <label style="font-size: 12px; color: #666;">開始時間</label>
                            <input type="time" class="form-input" value="${slot.startTime}" 
                                   onchange="updateFlexibleSlot(${slot.id}, 'startTime', this.value)">
                        </div>
                        <div>
                            <label style="font-size: 12px; color: #666;">終了時間</label>
                            <input type="time" class="form-input" value="${slot.endTime}"
                                   onchange="updateFlexibleSlot(${slot.id}, 'endTime', this.value)">
                            <label style="font-size: 11px; color: #888;">
                                <input type="checkbox" ${slot.crossMidnight ? 'checked' : ''} 
                                       onchange="updateFlexibleSlot(${slot.id}, 'crossMidnight', this.checked)" style="margin-right: 4px;">翌日
                            </label>
                        </div>
                        <div>
                            <label style="font-size: 12px; color: #666;">割増率(%)</label>
                            <input type="number" class="form-input" value="${slot.rate}" min="100" max="200"
                                   onchange="updateFlexibleSlot(${slot.id}, 'rate', parseFloat(this.value))">
                        </div>
                    </div>
                    <button type="button" class="btn-small btn-delete" onclick="removeFlexibleTimeSlot(${slot.id})" 
                            style="float: right; margin-top: 8px;">削除</button>
                    <div style="clear: both;"></div>
                </div>
            `
          )
          .join('');
      }

      // 時間帯スロットを更新
      function updateFlexibleSlot(id, property, value) {
        const slot = currentFlexibleRates.find(s => s.id === id);
        if (slot) {
          slot[property] = value;
        }
      }

      // 柔軟な時間帯設定を保存
      function saveFlexibleRates() {
        closeFlexibleRateConfig();
        updateFlexibleRatesDisplay();
      }

      // 柔軟な時間帯設定の表示を更新
      function updateFlexibleRatesDisplay() {
        const display = document.getElementById('flexibleRatesDisplay');
        const list = document.getElementById('flexibleRatesList');

        if (currentFlexibleRates.length === 0) {
          display.style.display = 'none';
          return;
        }

        display.style.display = 'block';
        list.innerHTML = currentFlexibleRates
          .map(
            slot =>
              `${slot.startTime}-${slot.endTime}${slot.crossMidnight ? '(翌日)' : ''}: ${slot.rate}%`
          )
          .join(' • ');
      }

      // === 職場管理機能 ===

      // 職場管理ポップアップを開く
      function openWorkplaceManager() {
        document.getElementById('popupOverlay').style.display = 'block';
        document.getElementById('workplacePopup').style.display = 'block';
        renderWorkplaceList();
      }

      // 職場登録フォームを開く
      function openWorkplaceForm(workplaceId = null) {
        editingWorkplaceId = workplaceId;
        document.getElementById('workplacePopup').style.display = 'none';
        document.getElementById('workplaceFormPopup').style.display = 'block';

        if (workplaceId) {
          // 編集モード
          document.getElementById('workplaceFormTitle').textContent =
            'バイト先を編集';
          loadWorkplaceForm(workplaces[workplaceId]);
        } else {
          // 新規作成モード
          document.getElementById('workplaceFormTitle').textContent =
            '新しいバイト先を追加';
          clearWorkplaceForm();
        }
      }

      // 職場フォームをクリア
      function clearWorkplaceForm() {
        document.getElementById('workplaceName').value = '';
        document.getElementById('baseHourlyWage').value = '';
        document.getElementById('transportationFee').value = '0';
        document.getElementById('nightShiftType').value = 'none';
        document.getElementById('nightShiftRate').value = '';
        document.getElementById('nightShiftRate').style.display = 'none';

        // 曜日別チェックボックスをクリア
        for (let i = 0; i < 7; i++) {
          document.getElementById(`dayPremium_${i}`).checked = false;
        }
        document.getElementById('dayPremiumRate').value = '';
        document.getElementById('dayPremiumType').value = 'rate';
        updateDayPremiumFields();
      }

      // 職場フォームに既存データを読み込み
      function loadWorkplaceForm(workplace) {
        document.getElementById('workplaceName').value = workplace.name;
        document.getElementById('baseHourlyWage').value = workplace.baseHourly;
        document.getElementById('transportationFee').value =
          workplace.transportation || 0;
        document.getElementById('nightShiftType').value =
          workplace.nightShift?.type || 'none';

        if (workplace.nightShift?.type === 'custom') {
          document.getElementById('nightShiftRate').value =
            workplace.nightShift.rate;
          document.getElementById('nightShiftRate').style.display = 'block';
        }

        // 曜日別設定を読み込み
        if (workplace.dayPremium) {
          workplace.dayPremium.days.forEach(day => {
            document.getElementById(`dayPremium_${day}`).checked = true;
          });
          document.getElementById('dayPremiumRate').value =
            workplace.dayPremium.rate;
          document.getElementById('dayPremiumType').value =
            workplace.dayPremium.type;
        }
        updateDayPremiumFields();
      }

      // 職場リストをレンダリング
      function renderWorkplaceList() {
        const listElement = document.getElementById('workplaceList');
        const workplaceEntries = Object.entries(workplaces);

        if (workplaceEntries.length === 0) {
          listElement.innerHTML =
            '<div style="text-align: center; padding: 20px; color: #666;">まだバイト先が登録されていません</div>';
          return;
        }

        listElement.innerHTML = workplaceEntries
          .map(
            ([id, workplace]) => `
                <div class="workplace-item">
                    <div class="workplace-info">
                        <div class="workplace-name">${workplace.name}</div>
                        <div class="workplace-details">
                            時給 ${workplace.baseHourly}円 
                            ${workplace.transportation ? `• 交通費 ${workplace.transportation}円` : ''}
                            ${workplace.nightShift?.type !== 'none' ? '• 深夜割増あり' : ''}
                        </div>
                    </div>
                    <div class="workplace-actions">
                        <button class="btn-small btn-edit" onclick="openWorkplaceForm('${id}')">編集</button>
                        <button class="btn-small btn-delete" onclick="deleteWorkplace('${id}')">削除</button>
                    </div>
                </div>
            `
          )
          .join('');
      }

      // 職場を保存
      function saveWorkplace() {
        const name = document.getElementById('workplaceName').value.trim();
        const baseHourly = parseInt(
          document.getElementById('baseHourlyWage').value
        );

        if (!name || !baseHourly || baseHourly <= 0) {
          alert('職場名と基本時給は必須です。');
          return;
        }

        const nightShiftType = document.getElementById('nightShiftType').value;
        const workplace = {
          name: name,
          baseHourly: baseHourly,
          transportation:
            parseInt(document.getElementById('transportationFee').value) || 0,
          color: colorPalette[(workplaceIdCounter - 1) % colorPalette.length],
        };

        // 深夜時給設定を統一された構造で保存
        if (nightShiftType && nightShiftType !== 'none') {
          workplace.nightRate = {
            enabled: true,
            multiplier: nightShiftType === 'standard' ? 1.25 : 1.25, // 標準25%アップ
            type: nightShiftType,
          };
        }

        // 柔軟な時間帯設定を保存
        if (nightShiftType === 'flexible') {
          workplace.flexibleRates = [...currentFlexibleRates];
        }

        // 曜日別設定を統一された構造で保存
        const selectedDays = [];
        for (let i = 0; i < 7; i++) {
          if (document.getElementById(`dayPremium_${i}`).checked) {
            selectedDays.push(i);
          }
        }

        if (selectedDays.length > 0) {
          const dayPremiumType =
            document.getElementById('dayPremiumType').value;
          const premiumValue = parseFloat(
            document.getElementById('dayPremiumRate').value
          );
          let multiplier = 1.0;

          if (dayPremiumType === 'rate') {
            // 固定時給の場合: 入力された時給をそのまま使用
            if (premiumValue && premiumValue > 0) {
              multiplier = premiumValue / workplace.baseHourly;
              console.log(
                `固定時給設定: ${premiumValue}円 / ${workplace.baseHourly}円 = ${multiplier}倍`
              );
            }
          } else if (dayPremiumType === 'multiplier') {
            // 割増%の場合: パーセンテージを倍率に変換
            if (premiumValue && premiumValue >= 0) {
              multiplier = 1 + premiumValue / 100;
              console.log(`割増%設定: ${premiumValue}% → ${multiplier}倍`);
            }
          }

          workplace.dayPremium = {
            enabled: true,
            days: selectedDays,
            multiplier: multiplier,
            type: dayPremiumType,
            inputValue: premiumValue, // デバッグ用
          };

          console.log('曜日別設定保存:', workplace.dayPremium);
          console.log(
            '選択された曜日:',
            selectedDays
              .map(d => ['日', '月', '火', '水', '木', '金', '土'][d])
              .join(',')
          );
        }

        // 保存
        const workplaceId =
          editingWorkplaceId || `workplace_${workplaceIdCounter++}`;
        workplaces[workplaceId] = workplace;

        localStorage.setItem('workplaces', JSON.stringify(workplaces));
        localStorage.setItem(
          'workplaceIdCounter',
          workplaceIdCounter.toString()
        );

        // UI更新
        closeWorkplaceForm();
        renderWorkplaceList();
        updateShiftWorkplaceOptions();
      }

      // 職場を削除
      function deleteWorkplace(workplaceId) {
        if (confirm('このバイト先を削除しますか？')) {
          delete workplaces[workplaceId];
          localStorage.setItem('workplaces', JSON.stringify(workplaces));
          renderWorkplaceList();
          updateShiftWorkplaceOptions();
        }
      }

      // 職場フォームを閉じる
      function closeWorkplaceForm() {
        document.getElementById('workplaceFormPopup').style.display = 'none';
        document.getElementById('workplacePopup').style.display = 'block';
        editingWorkplaceId = null;
      }

      // 全ポップアップを閉じる
      function closePopups() {
        document.getElementById('popupOverlay').style.display = 'none';
        document.getElementById('workplacePopup').style.display = 'none';
        document.getElementById('workplaceFormPopup').style.display = 'none';
        document.getElementById('shiftPopup').style.display = 'none';
        editingWorkplaceId = null;
      }

      // === シフト管理機能 ===

      // ポップアップを開く
      function openShiftPopup(date) {
        currentDate = date;
        console.log('=== シフトポップアップ開く ===');
        console.log('選択された日付:', date);
        console.log(
          '曜日:',
          new Date(date).getDay(),
          ['日', '月', '火', '水', '木', '金', '土'][new Date(date).getDay()]
        );

        document.getElementById('popupDate').textContent = date;
        document.getElementById('popupOverlay').style.display = 'block';
        document.getElementById('shiftPopup').style.display = 'block';

        // 職場選択肢を更新
        updateShiftWorkplaceOptions();

        // 既存シフトがあれば設定
        const deleteBtn = document.getElementById('deleteShiftBtn');
        if (shifts[date]) {
          const shift = shifts[date];
          document.getElementById('workplaceSelect').value =
            shift.workplaceId || Object.keys(workplaces)[0] || '';
          document.getElementById('startTime').value = shift.start;
          document.getElementById('endTime').value = shift.end;

          // 翌日チェックボックスの設定
          const crossMidnight = document.getElementById('crossMidnight');
          if (crossMidnight) {
            crossMidnight.checked = shift.crossMidnight || false;
          }

          // 削除ボタンを表示
          if (deleteBtn) {
            deleteBtn.style.display = 'block';
          }
        } else {
          // デフォルト値
          const firstWorkplace = Object.keys(workplaces)[0];
          document.getElementById('workplaceSelect').value =
            firstWorkplace || '';
          document.getElementById('startTime').value = '10:00';
          document.getElementById('endTime').value = '18:00';

          // 翌日チェックボックスをリセット
          const crossMidnight = document.getElementById('crossMidnight');
          if (crossMidnight) {
            crossMidnight.checked = false;
          }

          // 削除ボタンを非表示
          if (deleteBtn) {
            deleteBtn.style.display = 'none';
          }
        }
        updatePredictedEarnings();
      }

      // ポップアップを閉じる
      function closeShiftPopup() {
        document.getElementById('popupOverlay').style.display = 'none';
        document.getElementById('shiftPopup').style.display = 'none';
      }

      // 収入予測更新
      function updatePredictedEarnings() {
        const workplaceId = document.getElementById('workplaceSelect').value;
        const startTime = document.getElementById('startTime').value;
        const endTime = document.getElementById('endTime').value;
        const crossMidnight =
          document.getElementById('crossMidnight')?.checked || false;

        console.log('=== 収入予測更新 ===');
        console.log('勤務先ID:', workplaceId);
        console.log('時間:', startTime, '-', endTime);
        console.log('翌日:', crossMidnight);
        console.log('日付:', currentDate);

        if (workplaceId && startTime && endTime && workplaces[workplaceId]) {
          const calculation = calculateExactEarnings(
            workplaceId,
            startTime,
            endTime,
            crossMidnight,
            currentDate
          );
          document.getElementById('predictedEarnings').textContent =
            calculation.totalEarnings.toLocaleString() + '円';

          // 内訳表示
          console.log('予測収入:', calculation.totalEarnings + '円');
          if (calculation.breakdown && calculation.breakdown.length > 0) {
            console.log('内訳:', calculation.breakdown);
          }
        } else {
          document.getElementById('predictedEarnings').textContent = '0円';
          console.log('条件不足: データ不備');
        }
      }

      // === 高度な給与計算システム ===

      // メインの給与計算関数（翌日・柔軟な時間帯対応）
      function calculateAdvancedEarnings(
        workplaceId,
        date,
        startTime,
        endTime,
        nextDayEnd = false
      ) {
        const workplace = workplaces[workplaceId];
        if (!workplace) return { totalEarnings: 0, breakdown: {} };

        const dayOfWeek = new Date(date).getDay();
        const [startHour, startMin] = startTime.split(':').map(Number);
        const [endHour, endMin] = endTime.split(':').map(Number);

        let totalEarnings = 0;
        let breakdown = {
          regularHours: 0,
          regularEarnings: 0,
          nightHours: 0,
          nightEarnings: 0,
          flexibleHours: 0,
          flexibleEarnings: 0,
          dayPremiumHours: 0,
          dayPremiumEarnings: 0,
          transportation: workplace.transportation || 0,
        };

        // 時間を分単位で計算
        let currentMinutes = startHour * 60 + startMin;
        let endMinutes = endHour * 60 + endMin;

        // 翌日終了の場合は24時間を追加
        if (nextDayEnd && endMinutes <= currentMinutes) {
          endMinutes += 24 * 60;
        }

        // 15分単位で計算
        while (currentMinutes < endMinutes) {
          const nextMinutes = Math.min(currentMinutes + 15, endMinutes);
          const segmentHours = (nextMinutes - currentMinutes) / 60;
          const currentHour = Math.floor(currentMinutes / 60) % 24;

          // 基本時給を決定
          let baseHourly = workplace.baseHourly;
          let isSpecialDay = false;

          // 曜日別時給チェック
          if (
            workplace.dayPremium &&
            workplace.dayPremium.days.includes(dayOfWeek)
          ) {
            isSpecialDay = true;
            if (workplace.dayPremium.type === 'fixed') {
              baseHourly = workplace.dayPremium.rate;
            } else if (workplace.dayPremium.type === 'premium') {
              baseHourly =
                workplace.baseHourly * (workplace.dayPremium.rate / 100);
            }
          }

          // 時間帯別割増チェック
          let timeRateMultiplier = 1;
          let isFlexibleTime = false;

          if (
            workplace.nightShift?.type === 'flexible' &&
            workplace.flexibleRates
          ) {
            // 柔軟な時間帯設定をチェック
            for (const slot of workplace.flexibleRates) {
              if (isTimeInSlot(currentHour, slot)) {
                timeRateMultiplier = slot.rate / 100;
                isFlexibleTime = true;
                break;
              }
            }
          } else if (workplace.nightShift?.type === 'legal') {
            // 法定深夜時間帯 (22:00-5:00)
            if (currentHour >= 22 || currentHour < 5) {
              timeRateMultiplier = 1.25;
              isFlexibleTime = true;
            }
          }

          const hourlyWage = baseHourly * timeRateMultiplier;
          const earnings = hourlyWage * segmentHours;

          if (isFlexibleTime) {
            breakdown.flexibleHours += segmentHours;
            breakdown.flexibleEarnings += earnings;
          } else if (isSpecialDay) {
            breakdown.dayPremiumHours += segmentHours;
            breakdown.dayPremiumEarnings += earnings;
          } else {
            breakdown.regularHours += segmentHours;
            breakdown.regularEarnings += earnings;
          }

          totalEarnings += earnings;
          currentMinutes = nextMinutes;
        }

        // 交通費を追加
        totalEarnings += breakdown.transportation;

        return {
          totalEarnings: Math.round(totalEarnings),
          breakdown: breakdown,
        };
      }

      // 指定時間が時間帯スロットに含まれるかチェック
      function isTimeInSlot(hour, slot) {
        const [startHour] = slot.startTime.split(':').map(Number);
        const [endHour] = slot.endTime.split(':').map(Number);

        if (slot.crossMidnight) {
          // 翌日にまたがる場合
          return hour >= startHour || hour < endHour;
        } else {
          // 同日内の場合
          return hour >= startHour && hour < endHour;
        }
      }

      // シンプルな労働時間計算（後方互換用）
      function calculateHours(start, end) {
        const [startHour, startMin] = start.split(':').map(Number);
        const [endHour, endMin] = end.split(':').map(Number);
        const startMinutes = startHour * 60 + startMin;
        const endMinutes = endHour * 60 + endMin;
        return (endMinutes - startMinutes) / 60;
      }

      // シフト保存
      function saveShift() {
        const workplaceId = document.getElementById('workplaceSelect').value;
        const startTime = document.getElementById('startTime').value;
        const endTime = document.getElementById('endTime').value;
        const crossMidnight =
          document.getElementById('crossMidnight')?.checked || false;

        if (!workplaceId || !startTime || !endTime) {
          alert('バイト先、開始時間、終了時間を全て入力してください。');
          return;
        }

        if (!workplaces[workplaceId]) {
          alert('選択されたバイト先が見つかりません。');
          return;
        }

        // 新しい収入計算を使用（現在の日付を渡す）
        const calculation = calculateExactEarnings(
          workplaceId,
          startTime,
          endTime,
          crossMidnight,
          currentDate
        );
        if (calculation.hours <= 0) {
          alert(
            '有効な労働時間を設定してください。翌日まで働く場合はチェックボックスを確認してください。'
          );
          return;
        }

        // シフトデータ保存（新しいフィールドを追加）
        shifts[currentDate] = {
          workplaceId: workplaceId,
          workplace: workplaces[workplaceId].name,
          start: startTime,
          end: endTime,
          crossMidnight: crossMidnight,
          earnings: calculation.totalEarnings,
          breakdown: calculation.breakdown,
          hours: calculation.hours,
        };

        // UI更新
        addShiftToCalendar(
          currentDate,
          workplaceId,
          startTime,
          endTime,
          crossMidnight
        );
        updateSummary();
        closePopups();
      }

      // カレンダーにシフトを追加
      function addShiftToCalendar(
        date,
        workplaceId,
        startTime,
        endTime,
        crossMidnight = false
      ) {
        const dayElement = document.querySelector(
          `[onclick="openShiftPopup('${date}')"]`
        );
        if (dayElement && workplaces[workplaceId]) {
          // 既存のシフトチップを削除
          const existingChip = dayElement.querySelector('.shift-chip');
          if (existingChip) {
            existingChip.remove();
          }

          // 時間表示を翌日対応で調整
          let timeDisplay = `${startTime}-${endTime}`;
          if (crossMidnight) {
            const [endHour] = endTime.split(':');
            if (parseInt(endHour) < 12) {
              // 終了時間が午前中なら翌日表示
              timeDisplay = `${startTime}-翌${endTime}`;
            }
          }

          // 新しいシフトチップを追加
          const shiftChip = document.createElement('div');
          shiftChip.className = `shift-chip ${workplaces[workplaceId].color}`;
          shiftChip.textContent = timeDisplay;
          shiftChip.title = `${workplaces[workplaceId].name} ${timeDisplay}`;
          shiftChip.onclick = event => editShift(event, date);
          dayElement.appendChild(shiftChip);
        }
      }

      // シフト削除
      function deleteShift(date) {
        if (confirm('このシフトを削除しますか？')) {
          // シフトデータから削除
          delete shifts[date];

          // カレンダーから削除
          const dayElement = document.querySelector(
            `[onclick="openShiftPopup('${date}')"]`
          );
          if (dayElement) {
            const existingChip = dayElement.querySelector('.shift-chip');
            if (existingChip) {
              existingChip.remove();
            }
          }

          // 統計を更新
          updateSummary();
        }
      }

      // 現在のポップアップからシフト削除
      function deleteCurrentShift() {
        if (currentDate && shifts[currentDate]) {
          deleteShift(currentDate);
          closePopups(); // ポップアップを閉じる
        }
      }

      // 25時対応の時間入力フィールドを設定
      function setupExtendedTimeInputs() {
        const endTimeInput = document.getElementById('endTime');
        if (endTimeInput) {
          // 25時まで対応するためのカスタムバリデーション
          endTimeInput.addEventListener('change', function () {
            const timeValue = this.value;
            if (timeValue) {
              const [hours, minutes] = timeValue.split(':').map(Number);
              if (hours >= 0 && hours <= 23) {
                // 通常の時間範囲では何もしない
              } else if (hours === 24 || hours === 25) {
                // 24時、25時の場合は特別処理（ブラウザ制限により手動入力が必要）
                alert(
                  '24時以降の時間は「翌日まで働く」にチェックを入れて設定してください'
                );
              }
            }
          });
        }
      }

      // 労働時間計算を改良（25時まで対応）
      function calculateAdvancedHours(
        startTime,
        endTime,
        crossMidnight = false
      ) {
        let [startHour, startMin] = startTime.split(':').map(Number);
        let [endHour, endMin] = endTime.split(':').map(Number);

        // 25時対応（25:00 = 翌日1:00として扱う）
        if (crossMidnight) {
          if (endHour < startHour) {
            endHour += 24; // 翌日扱い
          }
        }

        const startMinutes = startHour * 60 + startMin;
        const endMinutes = endHour * 60 + endMin;

        if (endMinutes <= startMinutes) {
          return 0; // 無効な時間
        }

        return (endMinutes - startMinutes) / 60;
      }

      // 正確な収入計算（登録されたバイト先データを使用）
      function calculateExactEarnings(
        workplaceId,
        startTime,
        endTime,
        crossMidnight = false,
        workDate = null
      ) {
        const workplace = workplaces[workplaceId];
        if (!workplace) return { totalEarnings: 0, breakdown: [] };

        const totalHours = calculateAdvancedHours(
          startTime,
          endTime,
          crossMidnight
        );
        if (totalHours <= 0) return { totalEarnings: 0, breakdown: [] };

        // 勤務日の曜日を取得
        let dayOfWeek = 0; // デフォルトは日曜日
        if (workDate) {
          dayOfWeek = new Date(workDate).getDay();
        } else if (currentDate) {
          dayOfWeek = new Date(currentDate).getDay();
        }

        // デバッグログ
        console.log('=== 収入計算デバッグ ===');
        console.log('勤務先データ:', workplace);
        console.log('勤務日:', workDate || currentDate, '曜日:', dayOfWeek);
        console.log(
          '勤務時間:',
          startTime,
          '-',
          endTime,
          '(',
          totalHours,
          'h)'
        );
        console.log('翌日:', crossMidnight);

        let totalEarnings = 0;
        const breakdown = [];

        // 基本時給を曜日別で調整
        let hourlyRate = workplace.baseHourly;
        let isWeekendPremium = false;

        // 曜日別割増の確認（金土日：5, 6, 0）
        console.log('曜日別割増チェック:', workplace.dayPremium);
        if (
          workplace.dayPremium &&
          workplace.dayPremium.enabled &&
          workplace.dayPremium.days
        ) {
          console.log('設定された曜日:', workplace.dayPremium.days);
          console.log(
            '今日の曜日:',
            dayOfWeek,
            '含まれる?',
            workplace.dayPremium.days.includes(dayOfWeek)
          );

          if (workplace.dayPremium.days.includes(dayOfWeek)) {
            hourlyRate = workplace.baseHourly * workplace.dayPremium.multiplier;
            isWeekendPremium = true;

            const dayNames = ['日', '月', '火', '水', '木', '金', '土'];
            breakdown.push(
              `${dayNames[dayOfWeek]}曜日割増: ${workplace.baseHourly}円 → ${Math.round(hourlyRate)}円 (×${workplace.dayPremium.multiplier})`
            );
            console.log('曜日割増適用:', hourlyRate);
          }
        }

        // 基本時給計算
        let baseEarnings = totalHours * hourlyRate;
        totalEarnings += baseEarnings;

        if (isWeekendPremium) {
          breakdown.push(
            `割増給与: ${totalHours}h × ${Math.round(hourlyRate)}円 = ${Math.round(baseEarnings)}円`
          );
        } else {
          breakdown.push(
            `基本給: ${totalHours}h × ${hourlyRate}円 = ${Math.round(baseEarnings)}円`
          );
        }

        // 深夜手当計算（設定されている場合）
        console.log('深夜手当チェック:', workplace.nightRate);
        if (workplace.nightRate && workplace.nightRate.enabled) {
          const nightHours = calculateNightHours(
            startTime,
            endTime,
            workplace.nightRate,
            crossMidnight
          );
          console.log('深夜時間:', nightHours, 'h');

          if (nightHours > 0) {
            // 深夜手当は曜日別時給を基準に計算
            const nightBonus =
              nightHours * hourlyRate * (workplace.nightRate.multiplier - 1);
            totalEarnings += nightBonus;
            breakdown.push(
              `深夜手当: ${nightHours}h × ${Math.round(hourlyRate)}円 × ${((workplace.nightRate.multiplier - 1) * 100).toFixed(0)}% = ${Math.round(nightBonus)}円`
            );
            console.log('深夜手当適用:', nightBonus, '円');
          }
        }

        // 休日手当計算（設定されている場合）- 曜日別割増と重複しない場合のみ
        if (
          workplace.holidayRate &&
          workplace.holidayRate.enabled &&
          !isWeekendPremium
        ) {
          if (
            workplace.holidayRate.days &&
            workplace.holidayRate.days.includes(dayOfWeek)
          ) {
            const holidayBonus =
              totalHours * hourlyRate * (workplace.holidayRate.multiplier - 1);
            totalEarnings += holidayBonus;
            breakdown.push(
              `休日手当: ${totalHours}h × ${Math.round(hourlyRate)}円 × ${((workplace.holidayRate.multiplier - 1) * 100).toFixed(0)}% = ${Math.round(holidayBonus)}円`
            );
          }
        }

        // 交通費計算
        if (workplace.transportation && workplace.transportation > 0) {
          totalEarnings += workplace.transportation;
          breakdown.push(`交通費: ${workplace.transportation}円`);
        }

        console.log('最終計算結果:', Math.round(totalEarnings), '円');
        console.log('内訳:', breakdown);
        console.log('========================');

        return {
          totalEarnings: Math.round(totalEarnings),
          breakdown: breakdown,
          hours: totalHours,
        };
      }

      // 深夜時間の計算（22時-5時）
      function calculateNightHours(
        startTime,
        endTime,
        nightRate,
        crossMidnight = false
      ) {
        const [startHour, startMin] = startTime.split(':').map(Number);
        let [endHour, endMin] = endTime.split(':').map(Number);

        if (crossMidnight && endHour < startHour) {
          endHour += 24;
        }

        let nightMinutes = 0;

        // 1分ごとに深夜時間をチェック
        for (
          let minute = startHour * 60 + startMin;
          minute < endHour * 60 + endMin;
          minute++
        ) {
          const currentHour = Math.floor(minute / 60) % 24;
          if (currentHour >= 22 || currentHour < 5) {
            nightMinutes++;
          }
        }

        return nightMinutes / 60; // 時間に変換
      }

      // シフトの職場選択肢を更新
      function updateShiftWorkplaceOptions() {
        const selectElement = document.getElementById('workplaceSelect');
        const workplaceEntries = Object.entries(workplaces);

        if (workplaceEntries.length === 0) {
          selectElement.innerHTML =
            '<option value="">まずバイト先を登録してください</option>';
          return;
        }

        selectElement.innerHTML = workplaceEntries
          .map(
            ([id, workplace]) =>
              `<option value="${id}">${workplace.name} (時給${workplace.baseHourly}円)</option>`
          )
          .join('');
      }

      // 曜日別設定フィールドの表示/非表示
      function updateDayPremiumFields() {
        const hasSelectedDays = Array.from(
          document.querySelectorAll('[id^="dayPremium_"]')
        ).some(checkbox => checkbox.checked);

        const rateInput = document.getElementById('dayPremiumRate');
        const typeSelect = document.getElementById('dayPremiumType');

        rateInput.disabled = !hasSelectedDays;
        typeSelect.disabled = !hasSelectedDays;

        // プレースホルダーを動的に更新
        if (hasSelectedDays) {
          const baseHourly =
            parseInt(document.getElementById('baseHourlyWage').value) || 1000;
          const type = typeSelect.value;

          if (type === 'rate') {
            rateInput.placeholder = `${baseHourly + 100} (円)`;
          } else if (type === 'multiplier') {
            rateInput.placeholder = '10 (%)';
          }
        } else {
          rateInput.placeholder = '時給 (円)';
        }
      }

      // 深夜設定フィールドの表示/非表示
      function updateNightShiftFields() {
        const nightShiftType = document.getElementById('nightShiftType').value;
        const configureButton = document.getElementById('configureFlexible');
        const display = document.getElementById('flexibleRatesDisplay');

        if (nightShiftType === 'flexible') {
          configureButton.style.display = 'block';
          updateFlexibleRatesDisplay();
        } else {
          configureButton.style.display = 'none';
          display.style.display = 'none';
        }
      }

      // サマリー更新
      function updateSummary() {
        const thisMonthShifts = Object.values(shifts);
        const totalHours = thisMonthShifts.reduce(
          (sum, shift) => sum + calculateHours(shift.start, shift.end),
          0
        );
        const totalEarnings = thisMonthShifts.reduce(
          (sum, shift) => sum + shift.earnings,
          0
        );
        const shiftCount = thisMonthShifts.length;
        const avgHours = shiftCount > 0 ? totalHours / shiftCount : 0;

        // 月次サマリー更新
        document.getElementById('monthlyHours').textContent =
          Math.round(totalHours) + 'h';
        document.getElementById('monthlyEarnings').textContent =
          totalEarnings.toLocaleString() + '円';
        document.getElementById('shiftCount').textContent = shiftCount + '日';
        document.getElementById('avgHours').textContent =
          avgHours.toFixed(1) + 'h';

        // 年間扶養ステータス更新（簡易計算）
        const yearlyEarnings = totalEarnings * 12; // 月平均から年間予測
        const fuyouLimit = 1030000;
        const remainingAmount = Math.max(0, fuyouLimit - yearlyEarnings);
        const achievementRate = Math.min(
          100,
          Math.round((yearlyEarnings / fuyouLimit) * 100)
        );

        document.getElementById('yearlyIncome').textContent =
          yearlyEarnings.toLocaleString() + '円';
        document.getElementById('remainingAmount').textContent =
          remainingAmount.toLocaleString() + '円';
        document.getElementById('achievementRate').textContent =
          achievementRate + '%';
        document.getElementById('yearEndPrediction').textContent =
          yearlyEarnings.toLocaleString() + '円';
        document.getElementById('progressFill').style.width =
          achievementRate + '%';

        // アラート更新
        const alertElement = document.getElementById('fuyouAlert');
        if (achievementRate < 80) {
          alertElement.textContent = '扶養内です！安全な範囲で働けています。';
          alertElement.className = 'alert success';
        } else if (achievementRate < 95) {
          alertElement.textContent = '注意: 扶養限度額に近づいています。';
          alertElement.className = 'alert warning';
        } else {
          alertElement.textContent =
            '危険: 扶養限度額を超過する可能性があります！';
          alertElement.className = 'alert danger';
        }
      }

      // シフト編集
      function editShift(event, date) {
        event.stopPropagation();
        openShiftPopup(date);
      }

      // その他の機能
      function startOCR() {
        // OCR機能は後で実装
        console.log('OCR機能');
      }

      function addShift() {
        const today = new Date().toISOString().split('T')[0];
        openShiftPopup(today);
      }

      function uploadPayslip() {
        // 給与明細アップロード機能は後で実装
        console.log('給与明細アップロード機能');
      }

      // テスト用関数（コンソールから実行可能）
      function testCalculation(
        workplaceId,
        startTime,
        endTime,
        crossMidnight = false,
        testDate = null
      ) {
        console.log('=== 手動テスト実行 ===');
        const result = calculateExactEarnings(
          workplaceId,
          startTime,
          endTime,
          crossMidnight,
          testDate
        );
        console.log('テスト結果:', result);
        return result;
      }

      // デバッグ用: LocalStorageをクリア
      function clearAllData() {
        localStorage.removeItem('workplaces');
        localStorage.removeItem('workplaceIdCounter');
        localStorage.removeItem('shifts');
        console.log('LocalStorageのデータをクリアしました');
        location.reload();
      }

      // デバッグ用: 現在の勤務先データを表示
      function showWorkplaceData() {
        console.log('現在の勤務先データ:', workplaces);
        return workplaces;
      }

      // イベントリスナー設定
      document.addEventListener('DOMContentLoaded', function () {
        // シフト関連イベントリスナー
        const workplaceSelect = document.getElementById('workplaceSelect');
        const startTime = document.getElementById('startTime');
        const endTime = document.getElementById('endTime');
        const crossMidnight = document.getElementById('crossMidnight');

        if (workplaceSelect)
          workplaceSelect.addEventListener('change', updatePredictedEarnings);
        if (startTime)
          startTime.addEventListener('change', updatePredictedEarnings);
        if (endTime)
          endTime.addEventListener('change', updatePredictedEarnings);
        if (crossMidnight)
          crossMidnight.addEventListener('change', updatePredictedEarnings);

        // 拡張時間入力の設定
        setupExtendedTimeInputs();

        // 職場フォーム関連イベントリスナー
        const nightShiftType = document.getElementById('nightShiftType');
        if (nightShiftType)
          nightShiftType.addEventListener('change', updateNightShiftFields);

        // 曜日別チェックボックス
        for (let i = 0; i < 7; i++) {
          const checkbox = document.getElementById(`dayPremium_${i}`);
          if (checkbox)
            checkbox.addEventListener('change', updateDayPremiumFields);
        }

        // 曜日別設定タイプ変更時
        const dayPremiumType = document.getElementById('dayPremiumType');
        if (dayPremiumType)
          dayPremiumType.addEventListener('change', updateDayPremiumFields);

        // 基本時給変更時
        const baseHourlyWage = document.getElementById('baseHourlyWage');
        if (baseHourlyWage)
          baseHourlyWage.addEventListener('input', updateDayPremiumFields);

        // 初期化
        updateSummary();
        updateShiftWorkplaceOptions();

        // デバッグ: 読み込まれた勤務先データを表示
        console.log('=== アプリ初期化 ===');
        console.log('読み込まれた勤務先データ:', workplaces);
        Object.entries(workplaces).forEach(([id, workplace]) => {
          console.log(`${id}:`, workplace);
          if (workplace.dayPremium) {
            console.log(
              `  曜日別設定: ${workplace.dayPremium.days?.map(d => ['日', '月', '火', '水', '木', '金', '土'][d]).join(',')} - ${workplace.dayPremium.multiplier}倍`
            );
          }
        });

        // 職場が空の場合は注意メッセージ
        if (Object.keys(workplaces).length === 0) {
          console.log(
            'バイト先が登録されていません。まず「バイト先を管理」から職場を追加してください。'
          );
        }
      });
    </script>
  </body>
</html>
<!-- Force deploy: Mon Jul 21 23:20:41 JST 2025 -->
