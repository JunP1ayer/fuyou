<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>扶養プロ - デバッグテスト</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #45a049;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>🔧 扶養プロ - デバッグテスト</h1>
    
    <div class="test-section">
        <h2>📋 基本機能テスト</h2>
        <button onclick="testBasicFunctions()">基本機能テスト実行</button>
        <div id="basicTest" class="test-result"></div>
    </div>

    <div class="test-section">
        <h2>🤖 AI Vision Service テスト</h2>
        <button onclick="testAIService()">AI Service テスト</button>
        <div id="aiTest" class="test-result"></div>
    </div>

    <div class="test-section">
        <h2>⚙️ 最適化エンジンテスト</h2>
        <button onclick="testOptimizationEngine()">最適化エンジンテスト</button>
        <div id="optimizationTest" class="test-result"></div>
    </div>

    <div class="test-section">
        <h2>📱 PWA機能テスト</h2>
        <button onclick="testPWAFeatures()">PWA機能テスト</button>
        <div id="pwaTest" class="test-result"></div>
    </div>

    <div class="test-section">
        <h2>📊 データ処理テスト</h2>
        <button onclick="testDataProcessing()">データ処理テスト</button>
        <div id="dataTest" class="test-result"></div>
    </div>

    <div class="test-section">
        <h2>🔍 コンソールログ</h2>
        <button onclick="clearLog()">ログクリア</button>
        <div id="consoleLog" class="log"></div>
    </div>

    <script src="ai-vision-service.js"></script>
    <script src="fuyou-optimization-engine.js"></script>
    
    <script>
        // ログ表示機能
        const originalConsole = {
            log: console.log,
            error: console.error,
            warn: console.warn
        };

        function addToLog(type, message) {
            const logDiv = document.getElementById('consoleLog');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `<div style="color: ${type === 'error' ? 'red' : type === 'warn' ? 'orange' : 'black'}">[${timestamp}] ${type.toUpperCase()}: ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        console.log = function(...args) {
            originalConsole.log(...args);
            addToLog('log', args.join(' '));
        };

        console.error = function(...args) {
            originalConsole.error(...args);
            addToLog('error', args.join(' '));
        };

        console.warn = function(...args) {
            originalConsole.warn(...args);
            addToLog('warn', args.join(' '));
        };

        function clearLog() {
            document.getElementById('consoleLog').innerHTML = '';
        }

        // テスト関数
        function testBasicFunctions() {
            const resultDiv = document.getElementById('basicTest');
            resultDiv.innerHTML = 'テスト実行中...';
            
            try {
                // LocalStorage テスト
                localStorage.setItem('test', 'value');
                const testValue = localStorage.getItem('test');
                
                if (testValue !== 'value') {
                    throw new Error('LocalStorage テスト失敗');
                }
                
                // Date処理テスト
                const today = new Date();
                const yearMonth = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
                
                // 基本的な計算テスト
                const hours = 8;
                const wage = 1000;
                const earnings = hours * wage;
                
                if (earnings !== 8000) {
                    throw new Error('計算テスト失敗');
                }
                
                resultDiv.className = 'test-result success';
                resultDiv.innerHTML = `
                    ✅ 基本機能テスト成功<br>
                    • LocalStorage: OK<br>
                    • Date処理: ${yearMonth}<br>
                    • 計算処理: ${earnings}円<br>
                `;
                
                console.log('基本機能テスト: 成功');
                
            } catch (error) {
                resultDiv.className = 'test-result error';
                resultDiv.innerHTML = `❌ 基本機能テスト失敗: ${error.message}`;
                console.error('基本機能テスト失敗:', error);
            }
        }

        async function testAIService() {
            const resultDiv = document.getElementById('aiTest');
            resultDiv.innerHTML = 'AI Service テスト実行中...';
            
            try {
                // AI Vision Service 初期化テスト
                if (typeof AIVisionService === 'undefined') {
                    throw new Error('AIVisionService クラスが見つかりません');
                }
                
                const aiService = new AIVisionService();
                console.log('AI Service 初期化成功');
                
                // モック画像ファイル作成
                const mockFile = new File(['test'], 'test-shift.jpg', { type: 'image/jpeg' });
                
                // モックレスポンステスト
                const result = await aiService.getMockResponse(mockFile);
                
                if (!result.success) {
                    throw new Error('モックレスポンステスト失敗');
                }
                
                if (!result.shifts || result.shifts.length === 0) {
                    throw new Error('シフトデータが生成されませんでした');
                }
                
                resultDiv.className = 'test-result success';
                resultDiv.innerHTML = `
                    ✅ AI Service テスト成功<br>
                    • クラス初期化: OK<br>
                    • モックレスポンス: OK<br>
                    • 生成されたシフト数: ${result.shifts.length}件<br>
                    • 信頼度: ${Math.round(result.confidence * 100)}%<br>
                `;
                
                console.log('AI Service テスト成功:', result);
                
            } catch (error) {
                resultDiv.className = 'test-result error';
                resultDiv.innerHTML = `❌ AI Service テスト失敗: ${error.message}`;
                console.error('AI Service テスト失敗:', error);
            }
        }

        function testOptimizationEngine() {
            const resultDiv = document.getElementById('optimizationTest');
            resultDiv.innerHTML = '最適化エンジンテスト実行中...';
            
            try {
                // 最適化エンジン初期化テスト
                if (typeof FuyouOptimizationEngine === 'undefined') {
                    throw new Error('FuyouOptimizationEngine クラスが見つかりません');
                }
                
                const engine = new FuyouOptimizationEngine();
                console.log('最適化エンジン初期化成功');
                
                // テストデータ
                const currentIncome = 800000; // 80万円
                const testShifts = [
                    {
                        id: 1,
                        date: '2025-07-15',
                        workplaceId: 1,
                        startTime: '10:00',
                        endTime: '18:00',
                        hours: 8,
                        earnings: 8000
                    }
                ];
                const testWorkplaces = [
                    {
                        id: 1,
                        name: 'テスト店舗',
                        hourlyWage: 1000
                    }
                ];
                
                // リスク分析テスト
                const analysis = engine.analyzeRisk(currentIncome, testShifts, testWorkplaces);
                
                if (!analysis.current || !analysis.prediction) {
                    throw new Error('リスク分析結果が不正です');
                }
                
                resultDiv.className = 'test-result success';
                resultDiv.innerHTML = `
                    ✅ 最適化エンジンテスト成功<br>
                    • エンジン初期化: OK<br>
                    • リスク分析: OK<br>
                    • 現在のリスクレベル: ${analysis.current.riskLevel}<br>
                    • 扶養残り予算: ¥${analysis.current.dependentRemaining.toLocaleString()}<br>
                    • 提案数: ${analysis.optimization.length}件<br>
                `;
                
                console.log('最適化エンジンテスト成功:', analysis);
                
            } catch (error) {
                resultDiv.className = 'test-result error';
                resultDiv.innerHTML = `❌ 最適化エンジンテスト失敗: ${error.message}`;
                console.error('最適化エンジンテスト失敗:', error);
            }
        }

        function testPWAFeatures() {
            const resultDiv = document.getElementById('pwaTest');
            resultDiv.innerHTML = 'PWA機能テスト実行中...';
            
            try {
                const features = {
                    serviceWorker: 'serviceWorker' in navigator,
                    notification: 'Notification' in window,
                    vibrate: 'vibrate' in navigator,
                    fullscreen: 'requestFullscreen' in document.documentElement,
                    orientation: 'orientation' in screen,
                    localStorage: typeof Storage !== 'undefined'
                };
                
                const supportedFeatures = Object.entries(features).filter(([key, value]) => value).length;
                const totalFeatures = Object.keys(features).length;
                
                resultDiv.className = 'test-result success';
                resultDiv.innerHTML = `
                    ✅ PWA機能テスト完了<br>
                    • サポート率: ${supportedFeatures}/${totalFeatures} (${Math.round(supportedFeatures/totalFeatures*100)}%)<br>
                    • Service Worker: ${features.serviceWorker ? '✅' : '❌'}<br>
                    • 通知機能: ${features.notification ? '✅' : '❌'}<br>
                    • 振動機能: ${features.vibrate ? '✅' : '❌'}<br>
                    • フルスクリーン: ${features.fullscreen ? '✅' : '❌'}<br>
                    • 画面向き: ${features.orientation ? '✅' : '❌'}<br>
                    • ローカルストレージ: ${features.localStorage ? '✅' : '❌'}<br>
                `;
                
                console.log('PWA機能テスト成功:', features);
                
            } catch (error) {
                resultDiv.className = 'test-result error';
                resultDiv.innerHTML = `❌ PWA機能テスト失敗: ${error.message}`;
                console.error('PWA機能テスト失敗:', error);
            }
        }

        function testDataProcessing() {
            const resultDiv = document.getElementById('dataTest');
            resultDiv.innerHTML = 'データ処理テスト実行中...';
            
            try {
                // 日付処理テスト
                const testDate = new Date('2025-07-19');
                const formattedDate = testDate.toISOString().split('T')[0];
                
                if (formattedDate !== '2025-07-19') {
                    throw new Error('日付フォーマット処理失敗');
                }
                
                // 時間計算テスト
                const startTime = '10:00';
                const endTime = '18:00';
                const start = new Date(`2000-01-01T${startTime}`);
                const end = new Date(`2000-01-01T${endTime}`);
                const hours = (end - start) / (1000 * 60 * 60);
                
                if (hours !== 8) {
                    throw new Error('時間計算処理失敗');
                }
                
                // 通貨フォーマットテスト
                const amount = 123456;
                const formatted = amount.toLocaleString();
                
                // JSONシリアライゼーションテスト
                const testObject = {
                    shifts: [{ id: 1, amount: 1000 }],
                    total: 1000
                };
                const serialized = JSON.stringify(testObject);
                const deserialized = JSON.parse(serialized);
                
                if (deserialized.total !== 1000) {
                    throw new Error('JSON処理失敗');
                }
                
                resultDiv.className = 'test-result success';
                resultDiv.innerHTML = `
                    ✅ データ処理テスト成功<br>
                    • 日付処理: ${formattedDate}<br>
                    • 時間計算: ${hours}時間<br>
                    • 通貨フォーマット: ${formatted}<br>
                    • JSON処理: OK<br>
                `;
                
                console.log('データ処理テスト成功');
                
            } catch (error) {
                resultDiv.className = 'test-result error';
                resultDiv.innerHTML = `❌ データ処理テスト失敗: ${error.message}`;
                console.error('データ処理テスト失敗:', error);
            }
        }

        // 自動テスト実行
        window.addEventListener('DOMContentLoaded', () => {
            console.log('デバッグテストページ読み込み完了');
            addToLog('log', 'デバッグテストページが読み込まれました');
        });
    </script>
</body>
</html>