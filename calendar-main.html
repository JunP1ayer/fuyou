<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>シフトカレンダー - 扶養管理</title>
    <!-- Cache busting: 2025-01-21T23:35 -->
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Roboto', 'Noto Sans JP', sans-serif;
        background: #f8f9fa;
        min-height: 100vh;
        color: #333;
      }

      /* ヘッダー */
      .header {
        background: white;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        padding: 16px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .header h1 {
        font-size: 24px;
        color: #2c3e50;
        font-weight: 600;
      }

      .nav-buttons {
        display: flex;
        gap: 12px;
      }

      .nav-btn {
        padding: 8px 16px;
        border: none;
        border-radius: 20px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      .nav-btn.active {
        background: #3498db;
        color: white;
      }

      .nav-btn:not(.active) {
        background: #ecf0f1;
        color: #7f8c8d;
      }

      .nav-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
      }

      /* メインコンテンツ */
      .main-content {
        max-width: 800px;
        margin: 20px auto;
        padding: 0 20px;
      }

      /* 月間ナビゲーション */
      .month-nav {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        background: white;
        padding: 16px 20px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      }

      .month-title {
        font-size: 20px;
        font-weight: 600;
        color: #2c3e50;
      }

      .month-btn {
        background: #ecf0f1;
        border: none;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        color: #7f8c8d;
        transition: all 0.2s;
      }

      .month-btn:hover {
        background: #3498db;
        color: white;
      }

      /* カレンダーグリッド */
      .calendar {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      }

      .calendar-header {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 1px;
        margin-bottom: 16px;
      }

      .day-header {
        text-align: center;
        padding: 12px 8px;
        font-weight: 600;
        font-size: 14px;
        color: #7f8c8d;
        background: #f8f9fa;
        border-radius: 8px;
      }

      .day-header.saturday {
        color: #3498db;
      }

      .day-header.sunday {
        color: #e74c3c;
      }

      .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 2px;
      }

      .calendar-day {
        aspect-ratio: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        padding: 8px 4px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        min-height: 80px;
        position: relative;
      }

      .calendar-day:hover {
        background: #ecf0f1;
      }

      .calendar-day.other-month {
        color: #bdc3c7;
      }

      .calendar-day.today {
        background: #3498db;
        color: white;
      }

      .calendar-day.has-shift {
        background: linear-gradient(135deg, #e8f5e8, #c8e6c9);
        border: 2px solid #4caf50;
      }

      .day-number {
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 4px;
      }

      .shift-indicator {
        background: #4caf50;
        color: white;
        padding: 2px 6px;
        border-radius: 10px;
        font-size: 10px;
        margin-bottom: 2px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 100%;
      }

      /* 月収サマリー */
      .monthly-summary {
        background: white;
        border-radius: 12px;
        padding: 16px 20px;
        margin-top: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .summary-item {
        text-align: center;
      }

      .summary-label {
        font-size: 12px;
        color: #7f8c8d;
        margin-bottom: 4px;
      }

      .summary-value {
        font-size: 18px;
        font-weight: 600;
        color: #2c3e50;
      }

      .summary-value.earnings {
        color: #27ae60;
      }


      .floating-workplace {
        position: fixed;
        bottom: 30px;
        right: 30px;
        width: 56px;
        height: 56px;
        background: #3498db;
        border: none;
        border-radius: 50%;
        color: white;
        font-size: 24px;
        cursor: pointer;
        box-shadow: 0 4px 16px rgba(52, 152, 219, 0.4);
        transition: all 0.3s;
      }

      .floating-workplace:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 20px rgba(52, 152, 219, 0.6);
      }

      /* ポップアップ */
      .popup {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        z-index: 1001;
        display: none;
        max-height: 90vh;
        overflow-y: auto;
      }

      .shift-popup {
        min-width: 320px;
      }

      .workplace-popup {
        min-width: 480px;
      }

      .popup-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        display: none;
      }

      .popup-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .popup-title {
        font-size: 18px;
        font-weight: bold;
        color: #2c3e50;
      }

      .close-btn {
        background: none;
        border: none;
        font-size: 24px;
        color: #7f8c8d;
        cursor: pointer;
        padding: 4px;
        border-radius: 4px;
      }

      .close-btn:hover {
        background: #ecf0f1;
      }

      .form-group {
        margin-bottom: 16px;
      }

      .form-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #2c3e50;
        font-size: 14px;
      }

      .form-input,
      .form-select {
        width: 100%;
        padding: 12px;
        border: 2px solid #ecf0f1;
        border-radius: 8px;
        font-size: 14px;
        transition: border-color 0.2s;
      }

      .form-input:focus,
      .form-select:focus {
        outline: none;
        border-color: #3498db;
      }

      .time-inputs {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }

      .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s;
      }

      .btn-primary {
        background: #3498db;
        color: white;
      }

      .btn-primary:hover {
        background: #2980b9;
      }

      .btn-secondary {
        background: #ecf0f1;
        color: #7f8c8d;
      }

      .btn-secondary:hover {
        background: #d5dbdb;
      }

      .btn-danger {
        background: #e74c3c;
        color: white;
      }

      .btn-danger:hover {
        background: #c0392b;
      }

      .workplace-list {
        max-height: 200px;
        overflow-y: auto;
        margin-bottom: 16px;
      }

      .workplace-item {
        padding: 12px;
        border: 1px solid #ecf0f1;
        border-radius: 8px;
        margin-bottom: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .workplace-info h4 {
        color: #2c3e50;
        margin-bottom: 4px;
      }

      .workplace-info p {
        color: #7f8c8d;
        font-size: 12px;
      }

      .workplace-actions {
        display: flex;
        gap: 8px;
      }

      .btn-small {
        padding: 6px 12px;
        font-size: 12px;
      }

      .checkbox-group {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 8px;
        margin-bottom: 12px;
      }

      .checkbox-item {
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .form-row {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 12px;
        align-items: end;
      }

      /* レスポンシブ */
      @media (max-width: 768px) {
        body {
          height: 100vh;
          overflow: hidden;
        }
        
        .main-content {
          padding: 0 8px;
          height: calc(100vh - 80px); /* ヘッダー分を除く */
          display: flex;
          flex-direction: column;
          overflow: hidden;
        }
        
        .header {
          flex-shrink: 0;
          padding: 12px 16px;
        }
        
        .calendar {
          flex: 1;
          display: flex;
          flex-direction: column;
          margin: 8px 0;
          padding: 12px;
          min-height: 0;
          overflow: hidden;
        }
        
        .calendar-header {
          flex-shrink: 0;
          margin-bottom: 8px;
        }
        
        .calendar-grid {
          flex: 1;
          gap: 1px;
          min-height: 0;
          display: grid;
          grid-template-rows: repeat(6, 1fr); /* 6行を等分 */
        }
        
        .calendar-day {
          min-height: unset;
          height: 100%;
          padding: 2px 1px;
          font-size: 10px;
        }
        
        .day-header {
          padding: 6px 2px;
          font-size: 11px;
        }
        
        .day-number {
          font-size: 10px;
          font-weight: 600;
          line-height: 1.2;
        }
        
        .shift-indicator {
          font-size: 7px;
          padding: 1px 2px;
          margin-top: 1px;
          line-height: 1;
        }
        
        .monthly-summary {
          flex-shrink: 0;
          margin-top: 8px;
          padding: 8px;
          font-size: 11px;
        }

        .popup {
          width: 90%;
          min-width: 0;
          max-width: 400px;
          max-height: 90vh;
          overflow-y: auto;
        }

        .workplace-popup {
          min-width: 0;
        }

        .time-inputs {
          grid-template-columns: 1fr;
        }

        .checkbox-group {
          grid-template-columns: repeat(3, 1fr);
        }
      }

      /* 非常に小さい画面対応 */
      @media (max-width: 480px) {
        .main-content {
          height: calc(100vh - 70px);
        }
        
        .header {
          padding: 8px 12px;
        }
        
        .header h1 {
          font-size: 18px;
        }
        
        .nav-btn {
          padding: 6px 12px;
          font-size: 12px;
        }
        
        .calendar {
          padding: 8px;
        }
        
        .day-header {
          padding: 4px 1px;
          font-size: 10px;
        }
        
        .calendar-day {
          padding: 1px;
          font-size: 9px;
        }
        
        .day-number {
          font-size: 9px;
        }
        
        .shift-indicator {
          font-size: 6px;
          padding: 0px 1px;
        }
        
        .monthly-summary {
          padding: 6px;
          font-size: 10px;
        }
      }
    </style>
  </head>
  <body>
    <!-- ヘッダー -->
    <header class="header">
      <h1>シフトカレンダー</h1>
      <nav class="nav-buttons">
        <a href="#" class="nav-btn active">📅 カレンダー</a>
        <a href="fuyou-status.html" class="nav-btn">📊 扶養状況</a>
      </nav>
    </header>

    <!-- メインコンテンツ -->
    <main class="main-content">
      <!-- 月間ナビゲーション -->
      <div class="month-nav">
        <button class="month-btn" onclick="changeMonth(-1)">‹</button>
        <h2 class="month-title" id="currentMonth">2025年1月</h2>
        <button class="month-btn" onclick="changeMonth(1)">›</button>
      </div>

      <!-- カレンダー -->
      <div class="calendar">
        <div class="calendar-header">
          <div class="day-header sunday">日</div>
          <div class="day-header">月</div>
          <div class="day-header">火</div>
          <div class="day-header">水</div>
          <div class="day-header">木</div>
          <div class="day-header">金</div>
          <div class="day-header saturday">土</div>
        </div>
        <div class="calendar-grid" id="calendarGrid">
          <!-- JavaScript で生成 -->
        </div>
      </div>

      <!-- 月収サマリー -->
      <div class="monthly-summary">
        <div class="summary-item">
          <div class="summary-label">今月勤務日数</div>
          <div class="summary-value" id="monthlyDays">12日</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">今月予定収入</div>
          <div class="summary-value earnings" id="monthlyEarnings">¥85,200</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">今月勤務時間</div>
          <div class="summary-value" id="monthlyHours">68h</div>
        </div>
      </div>
    </main>

    <!-- バイト先管理ボタン -->
    <button class="floating-workplace" onclick="openWorkplaceManager()" title="バイト先管理">+</button>

    <!-- ポップアップオーバーレイ -->
    <div class="popup-overlay" id="popupOverlay" onclick="closePopups()"></div>

    <!-- 職場管理ポップアップ -->
    <div class="popup workplace-popup" id="workplacePopup">
      <div class="popup-header">
        <div class="popup-title">🏢 バイト先管理</div>
        <button class="close-btn" onclick="closePopups()">&times;</button>
      </div>

      <div class="workplace-list" id="workplaceList">
        <div style="text-align: center; padding: 20px; color: #666">
          まだバイト先が登録されていません
        </div>
      </div>

      <button class="btn btn-primary" onclick="openWorkplaceForm()" style="width: 100%;">
        ➕ 新しいバイト先を追加
      </button>
    </div>

    <!-- 職場登録・編集ポップアップ -->
    <div class="popup workplace-popup" id="workplaceFormPopup">
      <div class="popup-header">
        <div class="popup-title">
          🏢 <span id="workplaceFormTitle">新しいバイト先を追加</span>
        </div>
        <button class="close-btn" onclick="closePopups()">&times;</button>
      </div>

      <div class="form-group">
        <label class="form-label">職場名 *</label>
        <input
          type="text"
          class="form-input"
          id="workplaceName"
          placeholder="例: ファミリーマート新宿店"
        />
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label">基本時給 (円) *</label>
          <input
            type="number"
            class="form-input"
            id="baseHourlyWage"
            placeholder="1000"
          />
        </div>
        <div class="form-group">
          <label class="form-label">交通費 (円)</label>
          <input
            type="number"
            class="form-input"
            id="transportationFee"
            placeholder="200"
            value="0"
          />
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">深夜・時間帯別割増</label>
        <div class="form-row">
          <select class="form-select" id="nightShiftType" onchange="updateNightShiftFields()">
            <option value="none">割増なし</option>
            <option value="legal">法定深夜割増 (22:00-5:00, 25%)</option>
            <option value="flexible">柔軟な時間帯設定</option>
          </select>
          <button
            type="button"
            class="form-input"
            id="configureFlexible"
            onclick="openFlexibleRateConfig()"
            style="display: none; background: #f5f5f5; border: 2px dashed #ccc; cursor: pointer;"
          >
            時間帯を設定
          </button>
        </div>
        <div id="flexibleRatesDisplay" style="margin-top: 8px; display: none;">
          <div style="font-size: 12px; color: #666;">設定された時間帯割増：</div>
          <div id="flexibleRatesList" style="font-size: 11px; color: #888; margin-top: 4px;"></div>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">曜日別時給設定</label>
        <div class="checkbox-group">
          <div class="checkbox-item">
            <input type="checkbox" id="dayPremium_0" onchange="updateDayPremiumFields()" />
            <label for="dayPremium_0">日</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="dayPremium_1" onchange="updateDayPremiumFields()" />
            <label for="dayPremium_1">月</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="dayPremium_2" onchange="updateDayPremiumFields()" />
            <label for="dayPremium_2">火</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="dayPremium_3" onchange="updateDayPremiumFields()" />
            <label for="dayPremium_3">水</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="dayPremium_4" onchange="updateDayPremiumFields()" />
            <label for="dayPremium_4">木</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="dayPremium_5" onchange="updateDayPremiumFields()" />
            <label for="dayPremium_5">金</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="dayPremium_6" onchange="updateDayPremiumFields()" />
            <label for="dayPremium_6">土</label>
          </div>
        </div>
        <div class="form-row">
          <input
            type="number"
            class="form-input"
            id="dayPremiumRate"
            placeholder="1100 (円)"
            disabled
          />
          <select class="form-select" id="dayPremiumType" disabled onchange="updateDayPremiumFields()">
            <option value="fixed">固定額</option>
            <option value="rate">割増率 (%)</option>
          </select>
        </div>
      </div>

      <div style="display: flex; gap: 12px;">
        <button class="btn btn-secondary" onclick="closeWorkplaceForm()" style="flex: 1;">
          キャンセル
        </button>
        <button class="btn btn-primary" onclick="saveWorkplace()" style="flex: 2;">
          保存
        </button>
      </div>
    </div>

    <!-- シフト登録ポップアップ -->
    <div class="popup shift-popup" id="shiftPopup">
      <div class="popup-header">
        <div class="popup-title">
          📅 <span id="popupDate">2025年1月21日</span> のシフト登録
        </div>
        <button class="close-btn" onclick="closeShiftPopup()">&times;</button>
      </div>
      <input type="hidden" id="shiftDate" />

      <div class="form-group">
        <label class="form-label">職場</label>
        <select class="form-select" id="workplaceSelect" onchange="updatePredictedEarnings()">
          <option value="">まずバイト先を登録してください</option>
        </select>
      </div>

      <div class="form-group">
        <label class="form-label">勤務時間</label>
        <div class="time-inputs">
          <div>
            <label style="font-size: 12px; color: #666">開始時間</label>
            <input
              type="time"
              class="form-input"
              id="startTime"
              value="10:00"
              onchange="updatePredictedEarnings()"
            />
          </div>
          <div>
            <label style="font-size: 12px; color: #666">終了時間</label>
            <input 
              type="time" 
              class="form-input" 
              id="endTime" 
              value="18:00" 
              onchange="updatePredictedEarnings()"
            />
            <label style="font-size: 11px; color: #888">
              <input
                type="checkbox"
                id="crossMidnight"
                style="margin-right: 4px"
                onchange="updatePredictedEarnings()"
              />
              翌日
            </label>
          </div>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">
          予想収入: <span id="predictedEarnings">0円</span>
        </label>
      </div>

      <div style="display: flex; gap: 12px; margin-top: 20px;">
        <button class="btn btn-danger" onclick="deleteShift()" style="flex: 1;" id="deleteShiftBtn">
          削除
        </button>
        <button class="btn btn-primary" onclick="saveShift()" style="flex: 2;">
          保存
        </button>
      </div>
    </div>

    <!-- フレキシブル時間帯設定ポップアップ -->
    <div class="popup" id="flexibleRatePopup" style="min-width: 500px; display: none;">
      <div class="popup-header">
        <div class="popup-title">⏰ 時間帯別割増設定</div>
        <button class="close-btn" onclick="closeFlexibleRateConfig()">&times;</button>
      </div>

      <div id="flexibleRateSlots">
        <!-- JavaScript で動的生成 -->
      </div>

      <button class="btn btn-secondary" onclick="addFlexibleTimeSlot()" style="width: 100%; margin: 12px 0;">
        ➕ 時間帯を追加
      </button>

      <div style="display: flex; gap: 12px;">
        <button class="btn btn-secondary" onclick="closeFlexibleRateConfig()" style="flex: 1;">
          キャンセル
        </button>
        <button class="btn btn-primary" onclick="saveFlexibleRateConfig()" style="flex: 2;">
          保存
        </button>
      </div>
    </div>

    <script>
      // 現在の日付
      let currentDate = new Date();
      
      // データ管理（LocalStorage）
      let workplaces = JSON.parse(localStorage.getItem('workplaces') || '{}');
      let shifts = JSON.parse(localStorage.getItem('shifts') || '{}');
      let workplaceIdCounter = parseInt(
        localStorage.getItem('workplaceIdCounter') || '1'
      );
      let editingWorkplaceId = null;
      let currentFlexibleRates = [];
      let flexibleRateIdCounter = 1;

      // 月変更
      function changeMonth(direction) {
        currentDate.setMonth(currentDate.getMonth() + direction);
        updateCalendar();
      }

      // カレンダー更新
      function updateCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        
        // 月タイトル更新
        document.getElementById('currentMonth').textContent = 
          `${year}年${month + 1}月`;

        // カレンダーグリッド作成
        const grid = document.getElementById('calendarGrid');
        grid.innerHTML = '';

        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const startDate = new Date(firstDay);
        startDate.setDate(startDate.getDate() - firstDay.getDay());

        const today = new Date();
        let monthlyEarnings = 0;
        let monthlyDays = 0;
        let monthlyHours = 0;

        for (let i = 0; i < 42; i++) {
          const date = new Date(startDate);
          date.setDate(startDate.getDate() + i);

          const dayElement = document.createElement('div');
          dayElement.className = 'calendar-day';
          
          // 時差の影響を避けるためローカル時間でISO文字列を作成
          const year = date.getFullYear();
          const monthNum = String(date.getMonth() + 1).padStart(2, '0');
          const day = String(date.getDate()).padStart(2, '0');
          const dateStr = `${year}-${monthNum}-${day}`;
          const isCurrentMonth = date.getMonth() === month;
          const isToday = date.toDateString() === today.toDateString();
          const hasShift = shifts[dateStr];

          if (!isCurrentMonth) {
            dayElement.classList.add('other-month');
          }
          if (isToday) {
            dayElement.classList.add('today');
          }
          if (hasShift) {
            dayElement.classList.add('has-shift');
            if (isCurrentMonth) {
              monthlyEarnings += hasShift.earnings;
              monthlyDays++;
              const hours = calculateHours(hasShift.start, hasShift.end);
              monthlyHours += hours;
            }
          }

          const timeDisplay = hasShift ? `${hasShift.start}-${hasShift.end}` : '';
          dayElement.innerHTML = `
            <div class="day-number">${date.getDate()}</div>
            ${hasShift ? `<div class="shift-indicator">${timeDisplay}</div>` : ''}
          `;

          dayElement.onclick = () => showDayDetails(dateStr);
          grid.appendChild(dayElement);
        }

        // サマリー更新
        document.getElementById('monthlyDays').textContent = `${monthlyDays}日`;
        document.getElementById('monthlyEarnings').textContent = `¥${monthlyEarnings.toLocaleString()}`;
        document.getElementById('monthlyHours').textContent = `${monthlyHours}h`;
      }

      // 労働時間計算
      function calculateHours(startTime, endTime) {
        const [startH, startM] = startTime.split(':').map(Number);
        const [endH, endM] = endTime.split(':').map(Number);
        
        let startMinutes = startH * 60 + startM;
        let endMinutes = endH * 60 + endM;
        
        // 翌日対応
        if (endMinutes < startMinutes) {
          endMinutes += 24 * 60;
        }
        
        return (endMinutes - startMinutes) / 60;
      }

      // 日詳細表示
      function showDayDetails(dateStr) {
        const shift = shifts[dateStr];
        if (shift) {
          // 既存シフトがある場合は編集画面を開く
          openShiftPopup(dateStr);
        } else {
          // 新規シフト作成
          openShiftPopup(dateStr);
        }
      }

      // シフト追加ダイアログ
      function showAddShiftDialog(dateStr = null) {
        if (!dateStr) {
          const today = new Date();
          const year = today.getFullYear();
          const month = String(today.getMonth() + 1).padStart(2, '0');
          const day = String(today.getDate()).padStart(2, '0');
          dateStr = `${year}-${month}-${day}`;
        }
        openShiftPopup(dateStr);
      }

      // ===== 職場管理機能 =====

      // 職場管理ポップアップを開く
      function openWorkplaceManager() {
        document.getElementById('popupOverlay').style.display = 'block';
        document.getElementById('workplacePopup').style.display = 'block';
        renderWorkplaceList();
      }

      // 職場登録フォームを開く
      function openWorkplaceForm(workplaceId = null) {
        editingWorkplaceId = workplaceId;
        document.getElementById('workplacePopup').style.display = 'none';
        document.getElementById('workplaceFormPopup').style.display = 'block';

        if (workplaceId) {
          // 編集モード
          document.getElementById('workplaceFormTitle').textContent = 'バイト先を編集';
          loadWorkplaceForm(workplaces[workplaceId]);
        } else {
          // 新規作成モード
          document.getElementById('workplaceFormTitle').textContent = '新しいバイト先を追加';
          clearWorkplaceForm();
        }
      }

      // 職場フォームをクリア
      function clearWorkplaceForm() {
        document.getElementById('workplaceName').value = '';
        document.getElementById('baseHourlyWage').value = '';
        document.getElementById('transportationFee').value = '0';
        
        // 深夜設定をクリア
        document.getElementById('nightShiftType').value = 'none';
        currentFlexibleRates = [];
        updateNightShiftFields();
        
        // 曜日チェックボックスをクリア
        ['0', '1', '2', '3', '4', '5', '6'].forEach(day => {
          const checkbox = document.getElementById(`dayPremium_${day}`);
          if (checkbox) checkbox.checked = false;
        });
        
        document.getElementById('dayPremiumRate').value = '';
        document.getElementById('dayPremiumType').value = 'fixed';
        updateDayPremiumFields();
      }

      // 職場フォームに既存データを読み込み
      function loadWorkplaceForm(workplace) {
        document.getElementById('workplaceName').value = workplace.name;
        document.getElementById('baseHourlyWage').value = workplace.baseHourly;
        document.getElementById('transportationFee').value = workplace.transportation || 0;

        // 深夜・時間帯別設定
        document.getElementById('nightShiftType').value = workplace.nightRate?.type || 'none';
        if (workplace.flexibleRates) {
          currentFlexibleRates = [...workplace.flexibleRates];
        }
        updateNightShiftFields();

        // 曜日別設定
        if (workplace.dayPremium && workplace.dayPremium.enabled) {
          workplace.dayPremium.days.forEach(day => {
            const checkbox = document.getElementById(`dayPremium_${day}`);
            if (checkbox) checkbox.checked = true;
          });
          
          document.getElementById('dayPremiumRate').value = workplace.dayPremium.rate;
          document.getElementById('dayPremiumType').value = workplace.dayPremium.type || 'fixed';
        }
        
        updateDayPremiumFields();
      }

      // 職場リストをレンダリング
      function renderWorkplaceList() {
        const listElement = document.getElementById('workplaceList');
        const workplaceEntries = Object.entries(workplaces);

        if (workplaceEntries.length === 0) {
          listElement.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">まだバイト先が登録されていません</div>';
          return;
        }

        listElement.innerHTML = workplaceEntries
          .map(([id, workplace]) => `
            <div class="workplace-item">
              <div class="workplace-info">
                <h4>${workplace.name}</h4>
                <p>基本時給: ${workplace.baseHourly}円 | 交通費: ${workplace.transportation || 0}円</p>
              </div>
              <div class="workplace-actions">
                <button class="btn btn-secondary btn-small" onclick="openWorkplaceForm('${id}')">編集</button>
                <button class="btn btn-danger btn-small" onclick="deleteWorkplace('${id}')">削除</button>
              </div>
            </div>
          `)
          .join('');
      }

      // 職場を保存
      function saveWorkplace() {
        const name = document.getElementById('workplaceName').value.trim();
        const baseHourly = parseInt(document.getElementById('baseHourlyWage').value);

        if (!name || !baseHourly || baseHourly <= 0) {
          alert('職場名と基本時給は必須です。');
          return;
        }

        const workplace = {
          name: name,
          baseHourly: baseHourly,
          transportation: parseInt(document.getElementById('transportationFee').value) || 0
        };

        // 深夜・時間帯別設定
        const nightShiftType = document.getElementById('nightShiftType').value;
        if (nightShiftType && nightShiftType !== 'none') {
          workplace.nightRate = {
            enabled: true,
            multiplier: nightShiftType === 'legal' ? 1.25 : 1.25,
            type: nightShiftType
          };
        }

        if (nightShiftType === 'flexible') {
          workplace.flexibleRates = [...currentFlexibleRates];
        }

        // 曜日別設定
        const selectedDays = [];
        ['0', '1', '2', '3', '4', '5', '6'].forEach(day => {
          if (document.getElementById(`dayPremium_${day}`)?.checked) {
            selectedDays.push(parseInt(day));
          }
        });

        if (selectedDays.length > 0) {
          const rate = parseFloat(document.getElementById('dayPremiumRate').value);
          const type = document.getElementById('dayPremiumType').value;

          if (rate && rate > 0) {
            workplace.dayPremium = {
              enabled: true,
              days: selectedDays,
              rate: rate,
              type: type,
              multiplier: type === 'fixed' ? rate / baseHourly : 1 + (rate / 100)
            };
          }
        }

        // 保存
        const workplaceId = editingWorkplaceId || `workplace-${workplaceIdCounter++}`;
        workplaces[workplaceId] = workplace;

        localStorage.setItem('workplaces', JSON.stringify(workplaces));
        localStorage.setItem('workplaceIdCounter', workplaceIdCounter.toString());

        closeWorkplaceForm();
        renderWorkplaceList();
        updateShiftWorkplaceOptions();
      }

      // 職場を削除
      function deleteWorkplace(workplaceId) {
        if (confirm('このバイト先を削除しますか？')) {
          delete workplaces[workplaceId];
          localStorage.setItem('workplaces', JSON.stringify(workplaces));
          renderWorkplaceList();
          updateShiftWorkplaceOptions();
        }
      }

      // 職場フォームを閉じる
      function closeWorkplaceForm() {
        document.getElementById('workplaceFormPopup').style.display = 'none';
        document.getElementById('workplacePopup').style.display = 'block';
      }

      // 曜日別設定フィールドの表示/非表示
      function updateDayPremiumFields() {
        const hasSelectedDays = Array.from(
          document.querySelectorAll('[id^="dayPremium_"]')
        ).some(checkbox => checkbox.checked);

        const rateInput = document.getElementById('dayPremiumRate');
        const typeSelect = document.getElementById('dayPremiumType');

        rateInput.disabled = !hasSelectedDays;
        typeSelect.disabled = !hasSelectedDays;

        // プレースホルダーを動的に更新
        if (hasSelectedDays) {
          const baseHourly = parseInt(document.getElementById('baseHourlyWage').value) || 1000;
          const type = typeSelect.value;

          if (type === 'fixed') {
            rateInput.placeholder = `${baseHourly + 100} (円)`;
          } else if (type === 'rate') {
            rateInput.placeholder = '10 (%)';
          }
        } else {
          rateInput.placeholder = '時給 (円)';
        }
      }

      // 深夜設定フィールドの表示/非表示
      function updateNightShiftFields() {
        const nightShiftType = document.getElementById('nightShiftType').value;
        const configureButton = document.getElementById('configureFlexible');
        const display = document.getElementById('flexibleRatesDisplay');

        if (nightShiftType === 'flexible') {
          configureButton.style.display = 'block';
          updateFlexibleRatesDisplay();
        } else {
          configureButton.style.display = 'none';
          display.style.display = 'none';
        }
      }

      // フレキシブルレート設定を開く
      function openFlexibleRateConfig() {
        currentFlexibleRates = [
          ...(editingWorkplaceId && workplaces[editingWorkplaceId]?.flexibleRates || [])
        ];
        if (currentFlexibleRates.length === 0) {
          addFlexibleTimeSlot();
        }
        document.getElementById('flexibleRatePopup').style.display = 'block';
        renderFlexibleRateSlots();
      }

      // フレキシブルレート設定を閉じる
      function closeFlexibleRateConfig() {
        document.getElementById('flexibleRatePopup').style.display = 'none';
      }

      // フレキシブル時間帯を追加
      function addFlexibleTimeSlot(startTime = '22:00', endTime = '05:00', rate = 125) {
        currentFlexibleRates.push({
          id: flexibleRateIdCounter++,
          startTime: startTime,
          endTime: endTime,
          rate: rate,
          crossMidnight: true
        });
        renderFlexibleRateSlots();
      }

      // フレキシブル時間帯を削除
      function removeFlexibleTimeSlot(id) {
        currentFlexibleRates = currentFlexibleRates.filter(slot => slot.id !== id);
        renderFlexibleRateSlots();
      }

      // フレキシブルレートスロットを描画
      function renderFlexibleRateSlots() {
        const container = document.getElementById('flexibleRateSlots');
        
        container.innerHTML = currentFlexibleRates.map(slot => `
          <div class="form-group" style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 12px; margin-bottom: 12px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr 100px auto; gap: 12px; align-items: end;">
              <div>
                <label style="font-size: 12px; color: #666;">開始時間</label>
                <input type="time" class="form-input" value="${slot.startTime}" 
                       onchange="updateFlexibleSlot(${slot.id}, 'startTime', this.value)">
              </div>
              <div>
                <label style="font-size: 12px; color: #666;">終了時間</label>
                <input type="time" class="form-input" value="${slot.endTime}"
                       onchange="updateFlexibleSlot(${slot.id}, 'endTime', this.value)">
                <label style="font-size: 11px; color: #888;">
                  <input type="checkbox" ${slot.crossMidnight ? 'checked' : ''} 
                         onchange="updateFlexibleSlot(${slot.id}, 'crossMidnight', this.checked)" style="margin-right: 4px;">翌日
                </label>
              </div>
              <div>
                <label style="font-size: 12px; color: #666;">割増率(%)</label>
                <input type="number" class="form-input" value="${slot.rate}" min="100" max="200"
                       onchange="updateFlexibleSlot(${slot.id}, 'rate', parseFloat(this.value))">
              </div>
              <button type="button" class="btn btn-danger btn-small" onclick="removeFlexibleTimeSlot(${slot.id})">削除</button>
            </div>
          </div>
        `).join('');
      }

      // フレキシブルスロットの値を更新
      function updateFlexibleSlot(id, field, value) {
        const slot = currentFlexibleRates.find(s => s.id === id);
        if (slot) {
          slot[field] = value;
        }
      }

      // フレキシブルレート設定を保存
      function saveFlexibleRateConfig() {
        updateFlexibleRatesDisplay();
        closeFlexibleRateConfig();
      }

      // フレキシブルレート表示を更新
      function updateFlexibleRatesDisplay() {
        const display = document.getElementById('flexibleRatesDisplay');
        const list = document.getElementById('flexibleRatesList');

        if (currentFlexibleRates.length === 0) {
          display.style.display = 'none';
          return;
        }

        display.style.display = 'block';
        list.innerHTML = currentFlexibleRates
          .map(slot => `${slot.startTime}-${slot.endTime} (${slot.rate}%)`)
          .join(' • ');
      }

      // ===== シフト管理機能 =====

      // ポップアップを開く
      function openShiftPopup(date) {
        const formattedDate = new Date(date).toLocaleDateString('ja-JP', {
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });

        document.getElementById('popupDate').textContent = formattedDate;
        document.getElementById('shiftDate').value = date;
        document.getElementById('popupOverlay').style.display = 'block';
        document.getElementById('shiftPopup').style.display = 'block';

        // 職場選択肢を更新
        updateShiftWorkplaceOptions();

        // 既存シフトがあれば設定
        const shift = shifts[date];
        if (shift) {
          document.getElementById('workplaceSelect').value = shift.workplace;
          document.getElementById('startTime').value = shift.start;
          document.getElementById('endTime').value = shift.end;
          document.getElementById('crossMidnight').checked = shift.crossMidnight || false;
          
          // タイトルを「編集」に変更
          document.getElementById('popupDate').textContent = 
            new Date(date).toLocaleDateString('ja-JP', {
              year: 'numeric',
              month: 'long', 
              day: 'numeric'
            }) + ' のシフト編集';
            
          updatePredictedEarnings();
        } else {
          // フォームクリア（新規作成）
          if (document.getElementById('workplaceSelect').options.length > 0) {
            document.getElementById('workplaceSelect').selectedIndex = 0;
          }
          document.getElementById('startTime').value = '10:00';
          document.getElementById('endTime').value = '18:00';
          document.getElementById('crossMidnight').checked = false;
          
          // タイトルを「登録」に変更
          document.getElementById('popupDate').textContent = 
            new Date(date).toLocaleDateString('ja-JP', {
              year: 'numeric',
              month: 'long',
              day: 'numeric'
            }) + ' のシフト登録';
            
          updatePredictedEarnings();
        }

        // 削除ボタンの表示/非表示
        const deleteBtn = document.getElementById('deleteShiftBtn');
        if (shift) {
          deleteBtn.style.display = 'block';
        } else {
          deleteBtn.style.display = 'none';
        }
      }

      // シフトポップアップを閉じる
      function closeShiftPopup() {
        document.getElementById('popupOverlay').style.display = 'none';
        document.getElementById('shiftPopup').style.display = 'none';
      }

      // 全ポップアップを閉じる
      function closePopups() {
        document.getElementById('popupOverlay').style.display = 'none';
        document.getElementById('workplacePopup').style.display = 'none';
        document.getElementById('workplaceFormPopup').style.display = 'none';
        document.getElementById('shiftPopup').style.display = 'none';
        editingWorkplaceId = null;
      }

      // 収入予測更新
      function updatePredictedEarnings() {
        const workplaceId = document.getElementById('workplaceSelect').value;
        const startTime = document.getElementById('startTime').value;
        const endTime = document.getElementById('endTime').value;
        const crossMidnight = document.getElementById('crossMidnight')?.checked || false;

        if (!workplaceId || !startTime || !endTime) {
          document.getElementById('predictedEarnings').textContent = '0円';
          return;
        }

        const workDate = document.getElementById('shiftDate').value; // 日付を取得
        const result = calculateExactEarnings(workplaceId, startTime, endTime, crossMidnight, workDate);
        document.getElementById('predictedEarnings').textContent = `${result.totalEarnings.toLocaleString()}円`;
      }

      // シフトを保存
      function saveShift() {
        const date = document.getElementById('shiftDate').value;
        const workplaceId = document.getElementById('workplaceSelect').value;
        const startTime = document.getElementById('startTime').value;
        const endTime = document.getElementById('endTime').value;
        const crossMidnight = document.getElementById('crossMidnight')?.checked || false;

        if (!workplaceId || !startTime || !endTime) {
          alert('バイト先、開始時間、終了時間を全て入力してください。');
          return;
        }

        if (!workplaces[workplaceId]) {
          alert('選択されたバイト先が見つかりません。');
          return;
        }

        // 収入計算
        const result = calculateExactEarnings(workplaceId, startTime, endTime, crossMidnight, date);

        // シフトデータ作成
        const shift = {
          date: date,
          workplace: workplaceId,
          start: startTime,
          end: endTime,
          crossMidnight: crossMidnight,
          hours: result.hours,
          earnings: result.totalEarnings
        };

        // 保存
        shifts[date] = shift;
        localStorage.setItem('shifts', JSON.stringify(shifts));

        closeShiftPopup();
        updateCalendar();
      }

      // シフトを削除
      function deleteShift() {
        const date = document.getElementById('shiftDate').value;
        if (confirm('このシフトを削除しますか？')) {
          delete shifts[date];
          localStorage.setItem('shifts', JSON.stringify(shifts));
          closeShiftPopup();
          updateCalendar();
        }
      }

      // シフトの職場選択肢を更新
      function updateShiftWorkplaceOptions() {
        const selectElement = document.getElementById('workplaceSelect');
        const workplaceEntries = Object.entries(workplaces);

        if (workplaceEntries.length === 0) {
          selectElement.innerHTML = '<option value="">まずバイト先を登録してください</option>';
          return;
        }

        selectElement.innerHTML = workplaceEntries
          .map(
            ([id, workplace]) =>
              `<option value="${id}">${workplace.name} (時給${workplace.baseHourly}円)</option>`
          )
          .join('');
      }

      // ===== 正確な収入計算 =====

      function calculateExactEarnings(workplaceId, startTime, endTime, crossMidnight = false, workDate = null) {
        const workplace = workplaces[workplaceId];
        if (!workplace) return { totalEarnings: 0, breakdown: [], hours: 0 };

        console.log('=== 収入計算開始 ===');
        console.log('職場:', workplace.name);
        console.log('勤務時間:', `${startTime} - ${endTime}`);
        console.log('翌日フラグ:', crossMidnight);

        const breakdown = [];
        let totalEarnings = 0;

        // 労働時間計算
        const totalHours = calculateHours(startTime, endTime);
        console.log('労働時間:', totalHours, 'h');

        // 基本時給を決定（曜日別設定があるかチェック）
        let hourlyRate = workplace.baseHourly;
        let isWeekendPremium = false;

        // 曜日の取得
        let dayOfWeek;
        if (workDate) {
          // workDateが文字列の場合（YYYY-MM-DD形式）を正しくパース
          const dateStr = typeof workDate === 'string' ? workDate : workDate.toString();
          console.log('🔍 workDate文字列:', dateStr);
          const [year, month, day] = dateStr.split('-').map(n => parseInt(n));
          const dateObj = new Date(year, month - 1, day);
          dayOfWeek = dateObj.getDay(); // monthは0ベース
          console.log('📅 パース結果:', {
            input: `${year}-${month}-${day}`,
            dateObject: dateObj.toDateString(),
            dayOfWeek: dayOfWeek
          });
          
          // 実際の曜日名をチェック
          const dayNames = ['日', '月', '火', '水', '木', '金', '土'];
          console.log('🗓️ 判定された曜日:', dayNames[dayOfWeek]);
          
          // さらに詳細確認のため
          console.log('🧮 詳細:', {
            年: year,
            月: month,
            日: day,
            'Date作成時の月': month - 1,
            'getDay結果': dayOfWeek
          });
        } else {
          dayOfWeek = new Date().getDay();
          console.log('現在の曜日:', dayOfWeek);
        }

        console.log('曜日:', dayOfWeek, '(0:日 1:月 ... 6:土)');

        // 曜日別割増の確認
        console.log('曜日別設定チェック:', workplace.dayPremium);
        if (workplace.dayPremium && workplace.dayPremium.enabled && workplace.dayPremium.days) {
          console.log('設定対象曜日:', workplace.dayPremium.days, '今日の曜日:', dayOfWeek);
          if (workplace.dayPremium.days.includes(dayOfWeek)) {
            // multiplierを再計算して確実に適用
            let multiplier;
            if (workplace.dayPremium.type === 'fixed') {
              multiplier = workplace.dayPremium.rate / workplace.baseHourly;
              hourlyRate = workplace.dayPremium.rate;
            } else {
              multiplier = 1 + (workplace.dayPremium.rate / 100);
              hourlyRate = workplace.baseHourly * multiplier;
            }
            isWeekendPremium = true;

            const dayNames = ['日', '月', '火', '水', '木', '金', '土'];
            breakdown.push(
              `${dayNames[dayOfWeek]}曜日割増: ${workplace.baseHourly}円 → ${Math.round(hourlyRate)}円 (${workplace.dayPremium.type === 'fixed' ? '固定' : '×' + multiplier.toFixed(2)})`
            );
            console.log('曜日割増適用:', {
              base: workplace.baseHourly,
              type: workplace.dayPremium.type,
              rate: workplace.dayPremium.rate,
              multiplier: multiplier,
              result: hourlyRate
            });
          } else {
            console.log('曜日割増対象外');
          }
        } else {
          console.log('曜日別設定なし');
        }

        // 基本時給計算
        let baseEarnings = totalHours * hourlyRate;
        totalEarnings += baseEarnings;

        if (isWeekendPremium) {
          breakdown.push(
            `割増給与: ${totalHours}h × ${Math.round(hourlyRate)}円 = ${Math.round(baseEarnings)}円`
          );
        } else {
          breakdown.push(
            `基本給: ${totalHours}h × ${hourlyRate}円 = ${Math.round(baseEarnings)}円`
          );
        }

        // 深夜・時間帯別手当計算
        if (workplace.nightRate && workplace.nightRate.enabled) {
          if (workplace.nightRate.type === 'legal') {
            // 法定深夜割増（22:00-5:00, 25%）
            const nightHours = calculateNightHours(startTime, endTime, crossMidnight);
            console.log('深夜時間:', nightHours, 'h');

            if (nightHours > 0) {
              // 曜日別割増が適用された時給ベースで深夜手当を計算
              const nightBonus = nightHours * hourlyRate * 0.25; // 25%割増
              totalEarnings += nightBonus;
              breakdown.push(
                `深夜手当: ${nightHours.toFixed(2)}h × ${Math.round(hourlyRate)}円 × 25% = ${Math.round(nightBonus)}円`
              );
              console.log('深夜手当適用:', {
                hours: nightHours,
                baseRate: hourlyRate,
                bonus: nightBonus
              });
            }
          } else if (workplace.nightRate.type === 'flexible' && workplace.flexibleRates) {
            // フレキシブル時間帯割増
            const flexibleBonus = calculateFlexibleRateEarnings(
              workplace.flexibleRates,
              startTime,
              endTime,
              crossMidnight,
              hourlyRate  // 曜日別割増が適用された時給を使用
            );
            if (flexibleBonus.total > 0) {
              totalEarnings += flexibleBonus.total;
              breakdown.push(...flexibleBonus.breakdown);
              console.log('フレキシブル時間帯手当適用:', flexibleBonus.total, '円');
            }
          }
        }

        // 交通費計算
        if (workplace.transportation && workplace.transportation > 0) {
          totalEarnings += workplace.transportation;
          breakdown.push(`交通費: ${workplace.transportation}円`);
        }

        console.log('最終計算結果:', Math.round(totalEarnings), '円');
        console.log('========================');

        return {
          totalEarnings: Math.round(totalEarnings),
          breakdown: breakdown,
          hours: totalHours,
        };
      }

      // 深夜時間の計算（22時-5時）
      function calculateNightHours(startTime, endTime, crossMidnight = false) {
        const [startHour, startMin] = startTime.split(':').map(Number);
        let [endHour, endMin] = endTime.split(':').map(Number);

        let startMinutes = startHour * 60 + startMin;
        let endMinutes = endHour * 60 + endMin;

        // 翌日対応
        if (crossMidnight && endMinutes < startMinutes) {
          endMinutes += 24 * 60;
        }

        let nightMinutes = 0;

        // 1分ごとに深夜時間をチェック
        for (let minute = startMinutes; minute < endMinutes; minute++) {
          const currentHour = Math.floor(minute / 60) % 24;
          if (currentHour >= 22 || currentHour < 5) {
            nightMinutes++;
          }
        }

        const nightHours = nightMinutes / 60;
        console.log('深夜時間詳細:', {
          start: startTime,
          end: endTime,
          crossMidnight,
          startMinutes,
          endMinutes,
          nightMinutes,
          nightHours
        });

        return nightHours; // 時間に変換
      }

      // フレキシブル時間帯での収入計算
      function calculateFlexibleRateEarnings(flexibleRates, startTime, endTime, crossMidnight, baseHourlyRate) {
        console.log('フレキシブル時間帯計算開始:', flexibleRates);
        
        let totalBonus = 0;
        const breakdown = [];
        
        const [startHour, startMin] = startTime.split(':').map(Number);
        let [endHour, endMin] = endTime.split(':').map(Number);

        if (crossMidnight && endHour < startHour) {
          endHour += 24;
        }

        // 各フレキシブル時間帯をチェック
        flexibleRates.forEach((slot, index) => {
          const slotHours = calculateTimeInSlot(
            startHour * 60 + startMin,
            endHour * 60 + endMin,
            slot
          );
          
          if (slotHours > 0) {
            const rateMultiplier = slot.rate / 100;
            const bonusAmount = slotHours * baseHourlyRate * (rateMultiplier - 1);
            totalBonus += bonusAmount;
            
            breakdown.push(
              `時間帯${index + 1}(${slot.startTime}-${slot.endTime}, ${slot.rate}%): ` +
              `${slotHours.toFixed(2)}h × ${Math.round(baseHourlyRate)}円 × ${((rateMultiplier - 1) * 100).toFixed(0)}% = ${Math.round(bonusAmount)}円`
            );
            console.log(`時間帯${index + 1}適用:`, slotHours, 'h', bonusAmount, '円');
          }
        });

        return {
          total: Math.round(totalBonus),
          breakdown: breakdown
        };
      }

      // 特定の時間帯内での労働時間を計算
      function calculateTimeInSlot(workStartMinutes, workEndMinutes, slot) {
        const [slotStartHour, slotStartMin] = slot.startTime.split(':').map(Number);
        let [slotEndHour, slotEndMin] = slot.endTime.split(':').map(Number);

        let slotStartMinutes = slotStartHour * 60 + slotStartMin;
        let slotEndMinutes = slotEndHour * 60 + slotEndMin;

        // 翌日対応
        if (slot.crossMidnight && slotEndMinutes < slotStartMinutes) {
          slotEndMinutes += 24 * 60;
        }

        // 勤務時間と時間帯の重複部分を計算
        const overlapStart = Math.max(workStartMinutes, slotStartMinutes);
        const overlapEnd = Math.min(workEndMinutes, slotEndMinutes);

        if (overlapEnd > overlapStart) {
          return (overlapEnd - overlapStart) / 60; // 時間に変換
        }

        return 0;
      }

      // 初期化
      document.addEventListener('DOMContentLoaded', function() {
        updateCalendar();
        
        // 職場が空の場合は注意メッセージ
        if (Object.keys(workplaces).length === 0) {
          console.log('バイト先が登録されていません。まず「バイト先を管理」から職場を追加してください。');
        }
      });
    </script>
    
    <!-- Force deploy: Mon Jul 21 23:35:00 JST 2025 -->
  </body>
</html>