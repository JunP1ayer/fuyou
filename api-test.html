<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenAI API 実動作テスト</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .result {
            padding: 15px;
            margin: 10px 0;
            border-radius: 6px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 16px;
        }
        button:hover { background: #45a049; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .upload-area {
            border: 2px dashed #4CAF50;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            margin: 20px 0;
        }
        .upload-area:hover { background: #f0f9ff; }
        #imagePreview {
            max-width: 100%;
            max-height: 300px;
            margin: 10px 0;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <h1>🔬 OpenAI GPT-4o Vision API 実動作テスト</h1>
    
    <div class="test-section">
        <h2>1. API接続テスト</h2>
        <button onclick="testAPIConnection()">OpenAI API 接続確認</button>
        <div id="connectionResult" class="result"></div>
    </div>

    <div class="test-section">
        <h2>2. 実際のシフト表画像解析テスト</h2>
        <div class="upload-area" onclick="document.getElementById('imageInput').click()">
            <div style="font-size: 48px; margin-bottom: 16px;">📷</div>
            <div style="font-size: 18px; font-weight: 600;">シフト表画像をアップロード</div>
            <div style="color: #666; margin-top: 8px;">実際のOpenAI GPT-4o Visionで解析します</div>
        </div>
        <input type="file" id="imageInput" accept="image/*" style="display: none;">
        <img id="imagePreview" style="display: none;">
        <button id="analyzeBtn" onclick="analyzeRealImage()" disabled>🚀 実際のAI解析実行</button>
        <div id="analysisResult" class="result"></div>
    </div>

    <div class="test-section">
        <h2>3. API利用コスト確認</h2>
        <button onclick="showCostEstimate()">コスト見積もり表示</button>
        <div id="costResult" class="result"></div>
    </div>

    <!-- 必要なスクリプト読み込み -->
    <script src="config.js"></script>
    <script src="ai-vision-service.js"></script>

    <script>
        let selectedFile = null;
        let aiVisionService = null;

        // 初期化
        window.addEventListener('DOMContentLoaded', () => {
            console.log('OpenAI API テストページ初期化中...');
            
            // 設定確認
            if (window.FUYOU_CONFIG) {
                console.log('設定読み込み成功:', window.FUYOU_CONFIG.api.openai);
            } else {
                console.error('設定が読み込まれていません');
            }

            // AI Vision Service 初期化
            if (typeof AIVisionService !== 'undefined') {
                aiVisionService = new AIVisionService();
                
                // 設定からAPIキーを設定
                const config = window.FUYOU_CONFIG || {};
                if (config.api?.openai?.apiKey) {
                    aiVisionService.apiKey = config.api.openai.apiKey;
                    console.log('OpenAI APIキー設定完了');
                }
            }

            // ファイル選択イベント
            document.getElementById('imageInput').addEventListener('change', handleFileSelect);
        });

        async function testAPIConnection() {
            const resultDiv = document.getElementById('connectionResult');
            resultDiv.innerHTML = '🔄 OpenAI API接続テスト中...';
            resultDiv.className = 'result info';

            try {
                if (!aiVisionService) {
                    throw new Error('AI Vision Service が初期化されていません');
                }

                if (!aiVisionService.isAvailable()) {
                    throw new Error('OpenAI APIキーが設定されていません');
                }

                // 簡単なAPI接続テスト用のダミー画像データ
                const testPayload = {
                    model: "gpt-4o",
                    messages: [
                        {
                            role: "user",
                            content: [
                                {
                                    type: "text",
                                    text: "この画像に何が写っていますか？簡潔に答えてください。"
                                },
                                {
                                    type: "image_url",
                                    image_url: {
                                        url: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==",
                                        detail: "low"
                                    }
                                }
                            ]
                        }
                    ],
                    max_tokens: 50
                };

                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${aiVisionService.apiKey}`
                    },
                    body: JSON.stringify(testPayload)
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(`API Error: ${response.status} - ${errorData.error?.message || response.statusText}`);
                }

                const data = await response.json();
                
                resultDiv.className = 'result success';
                resultDiv.innerHTML = `✅ OpenAI API 接続成功！
                
🔹 レスポンス概要:
- Model: ${data.model}
- Usage: ${JSON.stringify(data.usage, null, 2)}
- 接続確認: 正常

🎯 GPT-4o Vision が利用可能です。実際のシフト表画像解析が可能です。`;

            } catch (error) {
                console.error('API接続テスト失敗:', error);
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `❌ OpenAI API 接続失敗

🔹 エラー詳細:
${error.message}

🔧 確認項目:
- APIキーが正しく設定されているか
- APIキーに十分な残高があるか
- ネットワーク接続は正常か`;
            }
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.type.startsWith('image/')) {
                alert('画像ファイルを選択してください');
                return;
            }

            if (file.size > 20 * 1024 * 1024) { // 20MB制限
                alert('ファイルサイズが大きすぎます（20MB以下にしてください）');
                return;
            }

            selectedFile = file;
            
            // 画像プレビュー表示
            const reader = new FileReader();
            reader.onload = (e) => {
                const preview = document.getElementById('imagePreview');
                preview.src = e.target.result;
                preview.style.display = 'block';
            };
            reader.readAsDataURL(file);

            // 解析ボタンを有効化
            document.getElementById('analyzeBtn').disabled = false;
        }

        async function analyzeRealImage() {
            if (!selectedFile) {
                alert('画像を選択してください');
                return;
            }

            const resultDiv = document.getElementById('analysisResult');
            const analyzeBtn = document.getElementById('analyzeBtn');
            
            analyzeBtn.disabled = true;
            resultDiv.innerHTML = '🤖 OpenAI GPT-4o Vision でシフト表を解析中...';
            resultDiv.className = 'result info';

            try {
                if (!aiVisionService || !aiVisionService.isAvailable()) {
                    throw new Error('OpenAI API が利用できません');
                }

                console.log('実際のAPI解析開始:', {
                    fileName: selectedFile.name,
                    fileSize: selectedFile.size,
                    fileType: selectedFile.type
                });

                // 実際のOpenAI Vision APIで解析
                const result = await aiVisionService.analyzeShiftTable(selectedFile);

                console.log('API解析結果:', result);

                if (result.success && result.shifts && result.shifts.length > 0) {
                    resultDiv.className = 'result success';
                    
                    let analysisHtml = `✅ シフト表解析成功！

🎯 解析結果:
- 検出されたシフト数: ${result.shifts.length}件
- 信頼度: ${Math.round(result.confidence * 100)}%
- プロバイダー: ${result.metadata.provider}
- 処理時間: ${new Date(result.metadata.processedAt).toLocaleTimeString()}

📋 検出されたシフト詳細:`;

                    result.shifts.forEach((shift, index) => {
                        analysisHtml += `

${index + 1}. ${shift.date} (${shift.workplaceName})
   時間: ${shift.startTime} - ${shift.endTime} (${shift.hours}時間)
   備考: ${shift.notes || 'なし'}
   信頼度: ${Math.round(shift.confidence * 100)}%${shift.needsReview ? ' ⚠️要確認' : ''}`;
                    });

                    // コスト情報があれば表示
                    if (result.metadata.estimatedCost) {
                        analysisHtml += `

💰 推定コスト: ¥${result.metadata.estimatedCost}`;
                    }

                    resultDiv.innerHTML = analysisHtml;

                } else {
                    resultDiv.className = 'result warning';
                    resultDiv.innerHTML = `⚠️ シフト情報を検出できませんでした

🔍 原因の可能性:
- 画像が不鮮明
- シフト表の形式が特殊
- 手書き文字が多い
- 画像に文字情報が含まれていない

💡 改善方法:
- より鮮明な画像を使用
- 表形式のシフト表を選択
- 印刷されたシフト表を使用`;
                }

            } catch (error) {
                console.error('実際のAPI解析エラー:', error);
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `❌ シフト表解析失敗

🔹 エラー詳細:
${error.message}

🔧 対処方法:
- API残高を確認
- 画像形式を確認 (JPEG, PNG推奨)
- ファイルサイズを確認 (20MB以下)
- ネットワーク接続を確認`;
            } finally {
                analyzeBtn.disabled = false;
            }
        }

        function showCostEstimate() {
            const resultDiv = document.getElementById('costResult');
            
            if (!selectedFile) {
                resultDiv.className = 'result warning';
                resultDiv.innerHTML = 'まず画像を選択してください';
                return;
            }

            if (!aiVisionService) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = 'AI Vision Service が利用できません';
                return;
            }

            try {
                const costEstimate = aiVisionService.estimateCost(selectedFile);
                
                resultDiv.className = 'result info';
                resultDiv.innerHTML = `💰 OpenAI GPT-4o Vision 利用コスト見積もり

📊 詳細:
- 画像サイズ: ${(selectedFile.size / 1024 / 1024).toFixed(2)} MB
- 推定トークン数: ${costEstimate.tokens.toLocaleString()}
- 推定コスト (USD): $${costEstimate.estimatedCostUSD.toFixed(4)}
- 推定コスト (JPY): ¥${costEstimate.estimatedCostJPY}

ℹ️ これは概算です。実際のコストはOpenAIの最新料金体系に依存します。`;

            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `コスト見積もりエラー: ${error.message}`;
            }
        }
    </script>
</body>
</html>