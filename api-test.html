<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenAI API å®Ÿå‹•ä½œãƒ†ã‚¹ãƒˆ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .result {
            padding: 15px;
            margin: 10px 0;
            border-radius: 6px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 16px;
        }
        button:hover { background: #45a049; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .upload-area {
            border: 2px dashed #4CAF50;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            margin: 20px 0;
        }
        .upload-area:hover { background: #f0f9ff; }
        #imagePreview {
            max-width: 100%;
            max-height: 300px;
            margin: 10px 0;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <h1>ğŸ”¬ OpenAI GPT-4o Vision API å®Ÿå‹•ä½œãƒ†ã‚¹ãƒˆ</h1>
    
    <div class="test-section">
        <h2>1. APIæ¥ç¶šãƒ†ã‚¹ãƒˆ</h2>
        <button onclick="testAPIConnection()">OpenAI API æ¥ç¶šç¢ºèª</button>
        <div id="connectionResult" class="result"></div>
    </div>

    <div class="test-section">
        <h2>2. å®Ÿéš›ã®ã‚·ãƒ•ãƒˆè¡¨ç”»åƒè§£æãƒ†ã‚¹ãƒˆ</h2>
        <div class="upload-area" onclick="document.getElementById('imageInput').click()">
            <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“·</div>
            <div style="font-size: 18px; font-weight: 600;">ã‚·ãƒ•ãƒˆè¡¨ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</div>
            <div style="color: #666; margin-top: 8px;">å®Ÿéš›ã®OpenAI GPT-4o Visionã§è§£æã—ã¾ã™</div>
        </div>
        <input type="file" id="imageInput" accept="image/*" style="display: none;">
        <img id="imagePreview" style="display: none;">
        <button id="analyzeBtn" onclick="analyzeRealImage()" disabled>ğŸš€ å®Ÿéš›ã®AIè§£æå®Ÿè¡Œ</button>
        <div id="analysisResult" class="result"></div>
    </div>

    <div class="test-section">
        <h2>3. APIåˆ©ç”¨ã‚³ã‚¹ãƒˆç¢ºèª</h2>
        <button onclick="showCostEstimate()">ã‚³ã‚¹ãƒˆè¦‹ç©ã‚‚ã‚Šè¡¨ç¤º</button>
        <div id="costResult" class="result"></div>
    </div>

    <!-- å¿…è¦ãªã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿ -->
    <script src="config.js"></script>
    <script src="ai-vision-service.js"></script>

    <script>
        let selectedFile = null;
        let aiVisionService = null;

        // åˆæœŸåŒ–
        window.addEventListener('DOMContentLoaded', () => {
            console.log('OpenAI API ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸åˆæœŸåŒ–ä¸­...');
            
            // è¨­å®šç¢ºèª
            if (window.FUYOU_CONFIG) {
                console.log('è¨­å®šèª­ã¿è¾¼ã¿æˆåŠŸ:', window.FUYOU_CONFIG.api.openai);
            } else {
                console.error('è¨­å®šãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
            }

            // AI Vision Service åˆæœŸåŒ–
            if (typeof AIVisionService !== 'undefined') {
                aiVisionService = new AIVisionService();
                
                // è¨­å®šã‹ã‚‰APIã‚­ãƒ¼ã‚’è¨­å®š
                const config = window.FUYOU_CONFIG || {};
                if (config.api?.openai?.apiKey) {
                    aiVisionService.apiKey = config.api.openai.apiKey;
                    console.log('OpenAI APIã‚­ãƒ¼è¨­å®šå®Œäº†');
                }
            }

            // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚¤ãƒ™ãƒ³ãƒˆ
            document.getElementById('imageInput').addEventListener('change', handleFileSelect);
        });

        async function testAPIConnection() {
            const resultDiv = document.getElementById('connectionResult');
            resultDiv.innerHTML = 'ğŸ”„ OpenAI APIæ¥ç¶šãƒ†ã‚¹ãƒˆä¸­...';
            resultDiv.className = 'result info';

            try {
                if (!aiVisionService) {
                    throw new Error('AI Vision Service ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                }

                if (!aiVisionService.isAvailable()) {
                    throw new Error('OpenAI APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
                }

                // ç°¡å˜ãªAPIæ¥ç¶šãƒ†ã‚¹ãƒˆç”¨ã®ãƒ€ãƒŸãƒ¼ç”»åƒãƒ‡ãƒ¼ã‚¿
                const testPayload = {
                    model: "gpt-4o",
                    messages: [
                        {
                            role: "user",
                            content: [
                                {
                                    type: "text",
                                    text: "ã“ã®ç”»åƒã«ä½•ãŒå†™ã£ã¦ã„ã¾ã™ã‹ï¼Ÿç°¡æ½”ã«ç­”ãˆã¦ãã ã•ã„ã€‚"
                                },
                                {
                                    type: "image_url",
                                    image_url: {
                                        url: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==",
                                        detail: "low"
                                    }
                                }
                            ]
                        }
                    ],
                    max_tokens: 50
                };

                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${aiVisionService.apiKey}`
                    },
                    body: JSON.stringify(testPayload)
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(`API Error: ${response.status} - ${errorData.error?.message || response.statusText}`);
                }

                const data = await response.json();
                
                resultDiv.className = 'result success';
                resultDiv.innerHTML = `âœ… OpenAI API æ¥ç¶šæˆåŠŸï¼
                
ğŸ”¹ ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ¦‚è¦:
- Model: ${data.model}
- Usage: ${JSON.stringify(data.usage, null, 2)}
- æ¥ç¶šç¢ºèª: æ­£å¸¸

ğŸ¯ GPT-4o Vision ãŒåˆ©ç”¨å¯èƒ½ã§ã™ã€‚å®Ÿéš›ã®ã‚·ãƒ•ãƒˆè¡¨ç”»åƒè§£æãŒå¯èƒ½ã§ã™ã€‚`;

            } catch (error) {
                console.error('APIæ¥ç¶šãƒ†ã‚¹ãƒˆå¤±æ•—:', error);
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `âŒ OpenAI API æ¥ç¶šå¤±æ•—

ğŸ”¹ ã‚¨ãƒ©ãƒ¼è©³ç´°:
${error.message}

ğŸ”§ ç¢ºèªé …ç›®:
- APIã‚­ãƒ¼ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹
- APIã‚­ãƒ¼ã«ååˆ†ãªæ®‹é«˜ãŒã‚ã‚‹ã‹
- ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã¯æ­£å¸¸ã‹`;
            }
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.type.startsWith('image/')) {
                alert('ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            if (file.size > 20 * 1024 * 1024) { // 20MBåˆ¶é™
                alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™ï¼ˆ20MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„ï¼‰');
                return;
            }

            selectedFile = file;
            
            // ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
            const reader = new FileReader();
            reader.onload = (e) => {
                const preview = document.getElementById('imagePreview');
                preview.src = e.target.result;
                preview.style.display = 'block';
            };
            reader.readAsDataURL(file);

            // è§£æãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
            document.getElementById('analyzeBtn').disabled = false;
        }

        async function analyzeRealImage() {
            if (!selectedFile) {
                alert('ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            const resultDiv = document.getElementById('analysisResult');
            const analyzeBtn = document.getElementById('analyzeBtn');
            
            analyzeBtn.disabled = true;
            resultDiv.innerHTML = 'ğŸ¤– OpenAI GPT-4o Vision ã§ã‚·ãƒ•ãƒˆè¡¨ã‚’è§£æä¸­...';
            resultDiv.className = 'result info';

            try {
                if (!aiVisionService || !aiVisionService.isAvailable()) {
                    throw new Error('OpenAI API ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
                }

                console.log('å®Ÿéš›ã®APIè§£æé–‹å§‹:', {
                    fileName: selectedFile.name,
                    fileSize: selectedFile.size,
                    fileType: selectedFile.type
                });

                // å®Ÿéš›ã®OpenAI Vision APIã§è§£æ
                const result = await aiVisionService.analyzeShiftTable(selectedFile);

                console.log('APIè§£æçµæœ:', result);

                if (result.success && result.shifts && result.shifts.length > 0) {
                    resultDiv.className = 'result success';
                    
                    let analysisHtml = `âœ… ã‚·ãƒ•ãƒˆè¡¨è§£ææˆåŠŸï¼

ğŸ¯ è§£æçµæœ:
- æ¤œå‡ºã•ã‚ŒãŸã‚·ãƒ•ãƒˆæ•°: ${result.shifts.length}ä»¶
- ä¿¡é ¼åº¦: ${Math.round(result.confidence * 100)}%
- ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼: ${result.metadata.provider}
- å‡¦ç†æ™‚é–“: ${new Date(result.metadata.processedAt).toLocaleTimeString()}

ğŸ“‹ æ¤œå‡ºã•ã‚ŒãŸã‚·ãƒ•ãƒˆè©³ç´°:`;

                    result.shifts.forEach((shift, index) => {
                        analysisHtml += `

${index + 1}. ${shift.date} (${shift.workplaceName})
   æ™‚é–“: ${shift.startTime} - ${shift.endTime} (${shift.hours}æ™‚é–“)
   å‚™è€ƒ: ${shift.notes || 'ãªã—'}
   ä¿¡é ¼åº¦: ${Math.round(shift.confidence * 100)}%${shift.needsReview ? ' âš ï¸è¦ç¢ºèª' : ''}`;
                    });

                    // ã‚³ã‚¹ãƒˆæƒ…å ±ãŒã‚ã‚Œã°è¡¨ç¤º
                    if (result.metadata.estimatedCost) {
                        analysisHtml += `

ğŸ’° æ¨å®šã‚³ã‚¹ãƒˆ: Â¥${result.metadata.estimatedCost}`;
                    }

                    resultDiv.innerHTML = analysisHtml;

                } else {
                    resultDiv.className = 'result warning';
                    resultDiv.innerHTML = `âš ï¸ ã‚·ãƒ•ãƒˆæƒ…å ±ã‚’æ¤œå‡ºã§ãã¾ã›ã‚“ã§ã—ãŸ

ğŸ” åŸå› ã®å¯èƒ½æ€§:
- ç”»åƒãŒä¸é®®æ˜
- ã‚·ãƒ•ãƒˆè¡¨ã®å½¢å¼ãŒç‰¹æ®Š
- æ‰‹æ›¸ãæ–‡å­—ãŒå¤šã„
- ç”»åƒã«æ–‡å­—æƒ…å ±ãŒå«ã¾ã‚Œã¦ã„ãªã„

ğŸ’¡ æ”¹å–„æ–¹æ³•:
- ã‚ˆã‚Šé®®æ˜ãªç”»åƒã‚’ä½¿ç”¨
- è¡¨å½¢å¼ã®ã‚·ãƒ•ãƒˆè¡¨ã‚’é¸æŠ
- å°åˆ·ã•ã‚ŒãŸã‚·ãƒ•ãƒˆè¡¨ã‚’ä½¿ç”¨`;
                }

            } catch (error) {
                console.error('å®Ÿéš›ã®APIè§£æã‚¨ãƒ©ãƒ¼:', error);
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `âŒ ã‚·ãƒ•ãƒˆè¡¨è§£æå¤±æ•—

ğŸ”¹ ã‚¨ãƒ©ãƒ¼è©³ç´°:
${error.message}

ğŸ”§ å¯¾å‡¦æ–¹æ³•:
- APIæ®‹é«˜ã‚’ç¢ºèª
- ç”»åƒå½¢å¼ã‚’ç¢ºèª (JPEG, PNGæ¨å¥¨)
- ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã‚’ç¢ºèª (20MBä»¥ä¸‹)
- ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèª`;
            } finally {
                analyzeBtn.disabled = false;
            }
        }

        function showCostEstimate() {
            const resultDiv = document.getElementById('costResult');
            
            if (!selectedFile) {
                resultDiv.className = 'result warning';
                resultDiv.innerHTML = 'ã¾ãšç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„';
                return;
            }

            if (!aiVisionService) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = 'AI Vision Service ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“';
                return;
            }

            try {
                const costEstimate = aiVisionService.estimateCost(selectedFile);
                
                resultDiv.className = 'result info';
                resultDiv.innerHTML = `ğŸ’° OpenAI GPT-4o Vision åˆ©ç”¨ã‚³ã‚¹ãƒˆè¦‹ç©ã‚‚ã‚Š

ğŸ“Š è©³ç´°:
- ç”»åƒã‚µã‚¤ã‚º: ${(selectedFile.size / 1024 / 1024).toFixed(2)} MB
- æ¨å®šãƒˆãƒ¼ã‚¯ãƒ³æ•°: ${costEstimate.tokens.toLocaleString()}
- æ¨å®šã‚³ã‚¹ãƒˆ (USD): $${costEstimate.estimatedCostUSD.toFixed(4)}
- æ¨å®šã‚³ã‚¹ãƒˆ (JPY): Â¥${costEstimate.estimatedCostJPY}

â„¹ï¸ ã“ã‚Œã¯æ¦‚ç®—ã§ã™ã€‚å®Ÿéš›ã®ã‚³ã‚¹ãƒˆã¯OpenAIã®æœ€æ–°æ–™é‡‘ä½“ç³»ã«ä¾å­˜ã—ã¾ã™ã€‚`;

            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `ã‚³ã‚¹ãƒˆè¦‹ç©ã‚‚ã‚Šã‚¨ãƒ©ãƒ¼: ${error.message}`;
            }
        }
    </script>
</body>
</html>