#!/usr/bin/env node

/**
 * üéØ „Ç∑„Éï„Éà„Éú„Éº„ÉâÈ¢® „Éó„É¨„Éü„Ç¢„É†Êâ∂È§äÁÆ°ÁêÜ„Ç¢„Éó„É™
 * Google Philosophy Compliant + Material Design 3
 * Ultra Think + Gemini Integration Implementation
 * 
 * Features:
 * - Ë§áÊï∞„Éê„Ç§„ÉàÂÖàÁÆ°ÁêÜ
 * - È´òÂ∫¶„Å™ÊôÇÁµ¶„Ç∑„Çπ„ÉÜ„É†ÔºàÈÄöÂ∏∏„ÉªÊ∑±Â§ú„ÉªÊó©Êúù„Éª‰∫§ÈÄöË≤ªÔºâ
 * - „É¶„Éº„Ç∂„ÉºÂêçÂâçÁôªÈå≤„Å®OCRÂêçÂâçË™çË≠ò
 * - „Ç∑„Éï„ÉàË°®ÂÖ®Âì°ÂêçÂâçÂØæÂøú
 * - Google„Éû„ÉÜ„É™„Ç¢„É´„Éá„Ç∂„Ç§„É≥Ê∫ñÊã†
 */

const http = require('http');
const url = require('url');
const fs = require('fs');
const path = require('path');

const PORT = process.env.PORT || 6000;

// === „Éá„Éº„Çø„Éô„Éº„Çπ (Google Cloud FirestoreÈ¢®„ÅÆÊßãÈÄ†) ===
let USER_PROFILE = {
    id: 'user_demo',
    name: 'Áî∞‰∏≠Â§™ÈÉé',
    kana: '„Åü„Å™„Åã„Åü„Çç„ÅÜ',
    age: 20,
    graduationDate: '2026-03-31',
    targetLimit: 1500000, // 150‰∏áÂÜÜ„ÅÆÂ£Å
    createdAt: new Date().toISOString()
};

let WORKPLACES_DB = [
    {
        id: 'wp_001',
        name: '„Çπ„Çø„Éº„Éê„ÉÉ„ÇØ„Çπ Êñ∞ÂÆøÂ∫ó',
        category: '„Ç´„Éï„Çß',
        baseHourlyRate: 1100,
        nightRate: 1375, // 25%Â¢ó„Åó
        earlyRate: 1210, // 10%Â¢ó„Åó
        transportAllowance: 300,
        nightStartTime: '22:00',
        nightEndTime: '05:00',
        earlyStartTime: '05:00',
        earlyEndTime: '08:00',
        color: '#00695c',
        icon: '‚òï',
        address: 'Êù±‰∫¨ÈÉΩÊñ∞ÂÆøÂå∫',
        phone: '03-1234-5678'
    },
    {
        id: 'wp_002', 
        name: '„Éï„Ç°„Éü„É™„Éº„Éû„Éº„Éà Ê∏ãË∞∑Â∫ó',
        category: '„Ç≥„É≥„Éì„Éã',
        baseHourlyRate: 1050,
        nightRate: 1312, // 25%Â¢ó„Åó
        earlyRate: 1155, // 10%Â¢ó„Åó
        transportAllowance: 200,
        nightStartTime: '22:00',
        nightEndTime: '06:00',
        earlyStartTime: '06:00',
        earlyEndTime: '09:00',
        color: '#1976d2',
        icon: 'üè™',
        address: 'Êù±‰∫¨ÈÉΩÊ∏ãË∞∑Âå∫',
        phone: '03-8765-4321'
    }
];

let SHIFTS_DB = [
    {
        id: 'shift_001',
        userId: 'user_demo',
        workplaceId: 'wp_001',
        date: '2025-01-20',
        startTime: '09:00',
        endTime: '17:00',
        breakTime: 60,
        transportUsed: true,
        notes: 'ÈñãÂ∫óÊ∫ñÂÇô',
        autoCalculated: true,
        createdAt: new Date().toISOString()
    },
    {
        id: 'shift_002',
        userId: 'user_demo', 
        workplaceId: 'wp_002',
        date: '2025-01-21',
        startTime: '22:00',
        endTime: '06:00',
        breakTime: 60,
        transportUsed: true,
        notes: 'Ê∑±Â§ú„Ç∑„Éï„Éà',
        autoCalculated: true,
        createdAt: new Date().toISOString()
    }
];

// === Google Vision API Mock (ÂÆüÈöõ„ÅÆÂÆüË£Ö„Åß„ÅØÊú¨Áâ©„Çí‰ΩøÁî®) ===
const OCR_NAME_PATTERNS = [
    { pattern: 'Áî∞‰∏≠', confidence: 0.95, variations: ['Áî∞‰∏≠Â§™ÈÉé', '„Çø„Éä„Ç´', '„Åü„Å™„Åã'] },
    { pattern: '‰ΩêËó§', confidence: 0.89, variations: ['‰ΩêËó§Ëä±Â≠ê', '„Çµ„Éà„Ç¶', '„Åï„Å®„ÅÜ'] },
    { pattern: 'È´òÊ©ã', confidence: 0.92, variations: ['È´òÊ©ãÊ¨°ÈÉé', '„Çø„Ç´„Éè„Ç∑', '„Åü„Åã„ÅØ„Åó'] }
];

const server = http.createServer((req, res) => {
    const parsedUrl = url.parse(req.url, true);
    const pathname = parsedUrl.pathname;

    // CORS + Security Headers (GoogleÊ®ôÊ∫ñ)
    res.setHeader('Access-Control-Allow-Origin', '*');
    res.setHeader('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS');
    res.setHeader('Access-Control-Allow-Headers', 'Content-Type, Authorization');
    res.setHeader('X-Content-Type-Options', 'nosniff');
    res.setHeader('X-Frame-Options', 'DENY');
    res.setHeader('X-XSS-Protection', '1; mode=block');

    if (req.method === 'OPTIONS') {
        res.writeHead(200);
        res.end();
        return;
    }

    // „É´„Éº„ÉÜ„Ç£„É≥„Ç∞
    const routes = {
        '/': () => serveShiftboardApp(res),
        '/api/workplaces': () => handleWorkplaces(req, res),
        '/api/shifts': () => handleShifts(req, res),
        '/api/user-profile': () => handleUserProfile(req, res),
        '/api/ocr-advanced': () => handleAdvancedOCR(req, res),
        '/api/analytics': () => handleAnalytics(req, res),
        '/health': () => sendJSON(res, { status: 'OK', app: 'Shiftboard Premium' })
    };

    const handler = routes[pathname];
    if (handler) {
        handler();
    } else {
        res.writeHead(404);
        res.end('Not Found');
    }
});

function serveShiftboardApp(res) {
    res.writeHead(200, { 'Content-Type': 'text/html; charset=utf-8' });
    res.end(`
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéØ „Ç∑„Éï„Éà„Éú„Éº„ÉâÈ¢® „Éó„É¨„Éü„Ç¢„É†Êâ∂È§äÁÆ°ÁêÜ</title>
    
    <!-- Google Fonts + Material Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        /* === Google Material Design 3 Ê∫ñÊã† === */
        :root {
            --md-primary: #6750a4;
            --md-primary-container: #eaddff;
            --md-secondary: #625b71;
            --md-surface: #fffbfe;
            --md-surface-variant: #e7e0ec;
            --md-on-surface: #1c1b1f;
            --md-on-surface-variant: #49454f;
            --md-outline: #79757f;
            --md-shadow: rgba(0,0,0,0.1);
            --md-elevation-1: 0 1px 3px var(--md-shadow);
            --md-elevation-2: 0 2px 6px var(--md-shadow);
            --md-elevation-3: 0 4px 8px var(--md-shadow);
            --md-elevation-4: 0 6px 10px var(--md-shadow);
            --md-elevation-5: 0 8px 12px var(--md-shadow);
            
            /* Êâ∂È§äÁÆ°ÁêÜÂ∞ÇÁî®„Ç´„É©„Éº */
            --fuyou-safe: #00c853;
            --fuyou-warning: #ff9800;
            --fuyou-danger: #f44336;
            --workplace-primary: #2196f3;
            --workplace-secondary: #00bcd4;
            
            /* Google SpeedÂÑ™ÂÖà */
            --transition-fast: 0.15s cubic-bezier(0.4, 0.0, 0.2, 1);
            --transition-standard: 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
            --transition-slow: 0.5s cubic-bezier(0.4, 0.0, 0.2, 1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--md-surface);
            color: var(--md-on-surface);
            line-height: 1.5;
            font-size: 14px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* === Material Design Component System === */
        .md-surface {
            background: var(--md-surface);
            border-radius: 12px;
        }
        
        .md-surface-variant {
            background: var(--md-surface-variant);
            border-radius: 8px;
        }
        
        .md-elevation-1 { box-shadow: var(--md-elevation-1); }
        .md-elevation-2 { box-shadow: var(--md-elevation-2); }
        .md-elevation-3 { box-shadow: var(--md-elevation-3); }
        .md-elevation-4 { box-shadow: var(--md-elevation-4); }
        .md-elevation-5 { box-shadow: var(--md-elevation-5); }
        
        /* === App Layout (GoogleÊ∫ñÊã†„ÅÆ„É¨„Çπ„Éù„É≥„Ç∑„Éñ) === */
        .app-container {
            display: grid;
            grid-template-areas: 
                "header header"
                "sidebar main";
            grid-template-columns: 340px 1fr;
            grid-template-rows: auto 1fr;
            min-height: 100vh;
            max-width: 1600px;
            margin: 0 auto;
        }
        
        .app-header {
            grid-area: header;
            background: var(--md-primary);
            color: white;
            padding: 16px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--md-elevation-2);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .app-sidebar {
            grid-area: sidebar;
            background: var(--md-surface-variant);
            padding: 24px;
            overflow-y: auto;
            height: calc(100vh - 72px);
        }
        
        .app-main {
            grid-area: main;
            padding: 24px;
            overflow-y: auto;
            height: calc(100vh - 72px);
        }
        
        /* === Header Components === */
        .header-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 20px;
            font-weight: 500;
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .user-profile {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 16px;
            background: rgba(255,255,255,0.1);
            border-radius: 24px;
            cursor: pointer;
            transition: background var(--transition-fast);
        }
        
        .user-profile:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--md-primary-container);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--md-primary);
            font-weight: 500;
        }
        
        /* === Material Design Cards === */
        .md-card {
            background: var(--md-surface);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 16px;
            box-shadow: var(--md-elevation-2);
            transition: box-shadow var(--transition-standard);
        }
        
        .md-card:hover {
            box-shadow: var(--md-elevation-3);
        }
        
        .md-card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--md-outline);
        }
        
        .md-card-title {
            font-size: 16px;
            font-weight: 500;
            color: var(--md-on-surface);
        }
        
        .md-card-subtitle {
            font-size: 14px;
            color: var(--md-on-surface-variant);
        }
        
        /* === Calendar Components === */
        .calendar-container {
            background: var(--md-surface);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: var(--md-elevation-3);
        }
        
        .calendar-header {
            background: var(--md-primary);
            color: white;
            padding: 24px;
            text-align: center;
        }
        
        .calendar-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .nav-button {
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
            font-size: 18px;
        }
        
        .nav-button:hover {
            background: rgba(255,255,255,0.2);
            transform: scale(1.05);
        }
        
        .month-title {
            font-size: 24px;
            font-weight: 400;
        }
        
        .earnings-summary {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            font-size: 14px;
            opacity: 0.9;
        }
        
        .summary-item {
            text-align: center;
        }
        
        .summary-value {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 4px;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
        }
        
        .day-header {
            background: var(--md-surface-variant);
            padding: 16px 8px;
            text-align: center;
            font-weight: 500;
            color: var(--md-on-surface-variant);
            border-right: 1px solid var(--md-outline);
            font-size: 12px;
        }
        
        .day-header:last-child {
            border-right: none;
        }
        
        .calendar-day {
            min-height: 120px;
            border-right: 1px solid var(--md-outline);
            border-bottom: 1px solid var(--md-outline);
            padding: 8px;
            position: relative;
            cursor: pointer;
            transition: background-color var(--transition-fast);
        }
        
        .calendar-day:hover {
            background: rgba(103, 80, 164, 0.04);
        }
        
        .calendar-day:nth-child(7n) {
            border-right: none;
        }
        
        .day-number {
            font-weight: 500;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .day-number.today {
            background: var(--md-primary);
            color: white;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .day-number.other-month {
            color: var(--md-on-surface-variant);
            opacity: 0.6;
        }
        
        /* === Shift Blocks (Google Material DesignÊ∫ñÊã†) === */
        .shift-block {
            background: var(--workplace-primary);
            color: white;
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 6px;
            margin: 2px 0;
            display: block;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            cursor: pointer;
            transition: all var(--transition-fast);
            box-shadow: var(--md-elevation-1);
        }
        
        .shift-block:hover {
            transform: translateY(-1px);
            box-shadow: var(--md-elevation-2);
        }
        
        .shift-block.workplace-cafe {
            background: linear-gradient(45deg, #00695c, #00897b);
        }
        
        .shift-block.workplace-convenience {
            background: linear-gradient(45deg, #1976d2, #2196f3);
        }
        
        .shift-block.workplace-restaurant {
            background: linear-gradient(45deg, #f57c00, #ff9800);
        }
        
        .shift-block.night {
            background: linear-gradient(45deg, #7b1fa2, #9c27b0);
            border-left: 3px solid #e1bee7;
        }
        
        .shift-block.early {
            background: linear-gradient(45deg, #303f9f, #3f51b5);
            border-left: 3px solid #c5cae9;
        }
        
        .shift-earnings {
            font-size: 10px;
            color: rgba(255,255,255,0.8);
            margin-top: 2px;
        }
        
        /* === Workplace Management === */
        .workplace-card {
            background: var(--md-surface);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 12px;
            box-shadow: var(--md-elevation-1);
            border-left: 4px solid var(--workplace-primary);
            transition: all var(--transition-standard);
        }
        
        .workplace-card:hover {
            box-shadow: var(--md-elevation-3);
            transform: translateX(2px);
        }
        
        .workplace-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }
        
        .workplace-icon {
            font-size: 24px;
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: var(--md-primary-container);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .workplace-info h3 {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 4px;
        }
        
        .workplace-category {
            font-size: 12px;
            color: var(--md-on-surface-variant);
            background: var(--md-surface-variant);
            padding: 2px 8px;
            border-radius: 12px;
            display: inline-block;
        }
        
        .wage-info {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 12px;
        }
        
        .wage-item {
            background: var(--md-surface-variant);
            padding: 8px 12px;
            border-radius: 8px;
            text-align: center;
        }
        
        .wage-label {
            font-size: 11px;
            color: var(--md-on-surface-variant);
            margin-bottom: 2px;
        }
        
        .wage-value {
            font-size: 14px;
            font-weight: 500;
            color: var(--md-primary);
        }
        
        /* === OCR Upload Area === */
        .ocr-upload {
            border: 2px dashed var(--md-outline);
            border-radius: 16px;
            padding: 40px 20px;
            text-align: center;
            background: var(--md-surface-variant);
            cursor: pointer;
            transition: all var(--transition-standard);
            position: relative;
        }
        
        .ocr-upload:hover {
            border-color: var(--md-primary);
            background: var(--md-primary-container);
            transform: translateY(-2px);
        }
        
        .ocr-upload.dragover {
            border-color: var(--fuyou-safe);
            background: rgba(0, 200, 83, 0.1);
            transform: scale(1.02);
        }
        
        .upload-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.7;
        }
        
        .upload-title {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 8px;
        }
        
        .upload-subtitle {
            font-size: 14px;
            color: var(--md-on-surface-variant);
            margin-bottom: 16px;
        }
        
        .upload-features {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 16px;
            font-size: 12px;
        }
        
        /* === Analytics Dashboard === */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .metric-card {
            background: var(--md-surface);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: var(--md-elevation-2);
            transition: transform var(--transition-standard);
        }
        
        .metric-card:hover {
            transform: translateY(-2px);
        }
        
        .metric-icon {
            font-size: 32px;
            margin-bottom: 12px;
            opacity: 0.8;
        }
        
        .metric-value {
            font-size: 24px;
            font-weight: 500;
            margin-bottom: 8px;
        }
        
        .metric-label {
            font-size: 12px;
            color: var(--md-on-surface-variant);
        }
        
        .metric-trend {
            font-size: 11px;
            margin-top: 4px;
        }
        
        .trend-up { color: var(--fuyou-safe); }
        .trend-down { color: var(--fuyou-danger); }
        
        /* === Fuyou Progress (GoogleÈ¢®) === */
        .fuyou-progress {
            background: var(--md-surface);
            border-radius: 16px;
            padding: 24px;
            box-shadow: var(--md-elevation-2);
        }
        
        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .progress-title {
            font-size: 18px;
            font-weight: 500;
        }
        
        .progress-percentage {
            font-size: 24px;
            font-weight: 500;
            color: var(--md-primary);
        }
        
        .progress-bar-container {
            background: var(--md-surface-variant);
            border-radius: 8px;
            height: 12px;
            overflow: hidden;
            margin-bottom: 16px;
        }
        
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--fuyou-safe), var(--md-primary));
            border-radius: 8px;
            transition: width var(--transition-slow);
        }
        
        .progress-limits {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }
        
        .limit-item {
            text-align: center;
            padding: 12px;
            border-radius: 8px;
            background: var(--md-surface-variant);
        }
        
        .limit-amount {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 4px;
        }
        
        .limit-label {
            font-size: 11px;
            color: var(--md-on-surface-variant);
        }
        
        .limit-status {
            font-size: 10px;
            margin-top: 4px;
            padding: 2px 6px;
            border-radius: 6px;
        }
        
        .status-safe {
            background: var(--fuyou-safe);
            color: white;
        }
        
        .status-warning {
            background: var(--fuyou-warning);
            color: white;
        }
        
        .status-danger {
            background: var(--fuyou-danger);
            color: white;
        }
        
        /* === Material Design Buttons === */
        .md-button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-width: 64px;
        }
        
        .md-button-filled {
            background: var(--md-primary);
            color: white;
        }
        
        .md-button-filled:hover {
            background: #5a4086;
            transform: translateY(-1px);
            box-shadow: var(--md-elevation-2);
        }
        
        .md-button-outlined {
            background: transparent;
            color: var(--md-primary);
            border: 1px solid var(--md-outline);
        }
        
        .md-button-outlined:hover {
            background: var(--md-primary-container);
        }
        
        .md-button-text {
            background: transparent;
            color: var(--md-primary);
        }
        
        .md-button-text:hover {
            background: var(--md-primary-container);
        }
        
        /* === Responsive Design (Google Mobile-First) === */
        @media (max-width: 1024px) {
            .app-container {
                grid-template-areas: 
                    "header"
                    "main";
                grid-template-columns: 1fr;
            }
            
            .app-sidebar {
                display: none;
            }
        }
        
        @media (max-width: 768px) {
            .app-container {
                padding: 0;
            }
            
            .app-header {
                padding: 12px 16px;
            }
            
            .app-main {
                padding: 16px;
                height: calc(100vh - 60px);
            }
            
            .header-title {
                font-size: 18px;
            }
            
            .user-profile {
                padding: 6px 12px;
            }
            
            .calendar-day {
                min-height: 80px;
                padding: 4px;
            }
            
            .shift-block {
                font-size: 10px;
                padding: 2px 4px;
            }
            
            .analytics-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }
        }
        
        /* === Material Design 3 Micro-interactions === */
        .ripple {
            position: relative;
            overflow: hidden;
        }
        
        .ripple::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            transform: translate(-50%, -50%);
            transition: width var(--transition-fast), height var(--transition-fast);
        }
        
        .ripple:active::before {
            width: 300px;
            height: 300px;
        }
        
        /* === Loading States === */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        
        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            border: 2px solid var(--md-primary);
            border-top: 2px solid transparent;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }
        
        /* === Accessibility (GoogleÊ®ôÊ∫ñ) === */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
        
        @media (prefers-color-scheme: dark) {
            :root {
                --md-surface: #101014;
                --md-on-surface: #e6e1e5;
                --md-surface-variant: #49454f;
                --md-on-surface-variant: #cac4d0;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- „Éò„ÉÉ„ÉÄ„Éº -->
        <header class="app-header">
            <div class="header-title">
                <span class="material-icons">schedule</span>
                „Ç∑„Éï„Éà„Éú„Éº„ÉâÈ¢® „Éó„É¨„Éü„Ç¢„É†Êâ∂È§äÁÆ°ÁêÜ
            </div>
            <div class="header-actions">
                <div class="user-profile" onclick="openUserSettings()">
                    <div class="user-avatar">Áî∞</div>
                    <div>
                        <div style="font-size: 14px; font-weight: 500;" id="userName">Áî∞‰∏≠Â§™ÈÉé</div>
                        <div style="font-size: 12px; opacity: 0.8;">20Ê≠≥ Â§ßÂ≠¶Áîü</div>
                    </div>
                </div>
            </div>
        </header>
        
        <!-- „Çµ„Ç§„Éâ„Éê„Éº -->
        <aside class="app-sidebar">
            <!-- „Éê„Ç§„ÉàÂÖàÁÆ°ÁêÜ -->
            <div class="md-card">
                <div class="md-card-header">
                    <span class="material-icons">work</span>
                    <div>
                        <div class="md-card-title">„Éê„Ç§„ÉàÂÖàÁÆ°ÁêÜ</div>
                        <div class="md-card-subtitle">Ë§áÊï∞ËÅ∑Â†¥ÂØæÂøú</div>
                    </div>
                    <button class="md-button-text" onclick="addWorkplace()">
                        <span class="material-icons">add</span>
                    </button>
                </div>
                <div id="workplaceList">
                    <!-- ÂãïÁöÑÁîüÊàê -->
                </div>
            </div>
            
            <!-- Êâ∂È§äÈÄ≤Êçó -->
            <div class="fuyou-progress">
                <div class="progress-header">
                    <div class="progress-title">Êâ∂È§äÈÄ≤Êçó</div>
                    <div class="progress-percentage" id="progressPercentage">68%</div>
                </div>
                <div class="progress-bar-container">
                    <div class="progress-bar-fill" id="progressBarFill" style="width: 68%;"></div>
                </div>
                <div class="progress-limits">
                    <div class="limit-item">
                        <div class="limit-amount">¬•123‰∏á</div>
                        <div class="limit-label">ÊâÄÂæóÁ®é„ÅÆÂ£Å</div>
                        <div class="limit-status status-safe">ÂÆâÂÖ®</div>
                    </div>
                    <div class="limit-item">
                        <div class="limit-amount">¬•130‰∏á</div>
                        <div class="limit-label">Á§æ‰øù„ÅÆÂ£Å</div>
                        <div class="limit-status status-safe">ÂÆâÂÖ®</div>
                    </div>
                    <div class="limit-item">
                        <div class="limit-amount">¬•150‰∏á</div>
                        <div class="limit-label">Â≠¶ÁîüÁâπ‰æã</div>
                        <div class="limit-status status-warning">Ê≥®ÊÑè</div>
                    </div>
                </div>
            </div>
            
            <!-- OCR„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ -->
            <div class="md-card">
                <div class="md-card-header">
                    <span class="material-icons">photo_camera</span>
                    <div>
                        <div class="md-card-title">„Ç∑„Éï„ÉàË°®„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ</div>
                        <div class="md-card-subtitle">AIËá™ÂãïË™çË≠ò</div>
                    </div>
                </div>
                <div class="ocr-upload" id="ocrUpload">
                    <div class="upload-icon">üì∏</div>
                    <div class="upload-title">„Ç∑„Éï„ÉàË°®„ÇíÊíÆÂΩ±</div>
                    <div class="upload-subtitle">„ÅÇ„Å™„Åü„ÅÆ„Ç∑„Éï„Éà„ÇíËá™ÂãïÊäΩÂá∫</div>
                    <div class="upload-features">
                        <div>‚úÖ ÂêçÂâçË™çË≠ò</div>
                        <div>‚úÖ ÊôÇÈñìÊäΩÂá∫</div>
                        <div>‚úÖ Ëá™ÂãïÁôªÈå≤</div>
                        <div>‚úÖ Ë§áÊï∞ÂØæÂøú</div>
                    </div>
                    <input type="file" id="ocrFileInput" accept="image/*,application/pdf" style="display: none;">
                </div>
            </div>
        </aside>
        
        <!-- „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ -->
        <main class="app-main">
            <!-- ÂàÜÊûê„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ -->
            <div class="analytics-grid">
                <div class="metric-card">
                    <div class="metric-icon">üí∞</div>
                    <div class="metric-value" id="monthlyEarnings">¬•102,000</div>
                    <div class="metric-label">‰ªäÊúà„ÅÆÂèéÂÖ•</div>
                    <div class="metric-trend trend-up">‚Üó +12% vs ÂÖàÊúà</div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon">üìä</div>
                    <div class="metric-value" id="yearlyProjection">¬•1,224,000</div>
                    <div class="metric-label">Âπ¥Âèé‰∫àÊ∏¨</div>
                    <div class="metric-trend trend-up">‚Üó È†ÜË™ø„Å™„Éö„Éº„Çπ</div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon">‚è∞</div>
                    <div class="metric-value" id="monthlyHours">96ÊôÇÈñì</div>
                    <div class="metric-label">‰ªäÊúà„ÅÆÂä¥ÂÉçÊôÇÈñì</div>
                    <div class="metric-trend trend-down">‚Üò -5% vs ÂÖàÊúà</div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon">üéØ</div>
                    <div class="metric-value" id="fuyouRemaining">¬•276,000</div>
                    <div class="metric-label">Êâ∂È§ä„Åæ„ÅßÊÆã„Çä</div>
                    <div class="metric-trend trend-down">‚Üò È†ÜË™ø„Å´Ê∂àÂåñ</div>
                </div>
            </div>
            
            <!-- „Ç´„É¨„É≥„ÉÄ„Éº -->
            <div class="calendar-container">
                <div class="calendar-header">
                    <div class="calendar-nav">
                        <button class="nav-button" onclick="changeMonth(-1)">
                            <span class="material-icons">chevron_left</span>
                        </button>
                        <h2 class="month-title" id="monthTitle">2025Âπ¥1Êúà</h2>
                        <button class="nav-button" onclick="changeMonth(1)">
                            <span class="material-icons">chevron_right</span>
                        </button>
                    </div>
                    <div class="earnings-summary">
                        <div class="summary-item">
                            <div class="summary-value" id="summaryEarnings">¬•102,000</div>
                            <div>‰ªäÊúà„ÅÆÂèéÂÖ•</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-value" id="summaryShifts">12Êó•</div>
                            <div>Âá∫Âã§Êó•Êï∞</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-value" id="summaryAverage">¬•8,500</div>
                            <div>Âπ≥ÂùáÊó•Áµ¶</div>
                        </div>
                    </div>
                </div>
                
                <div class="calendar-grid">
                    <div class="day-header">Êó•</div>
                    <div class="day-header">Êúà</div>
                    <div class="day-header">ÁÅ´</div>
                    <div class="day-header">Ê∞¥</div>
                    <div class="day-header">Êú®</div>
                    <div class="day-header">Èáë</div>
                    <div class="day-header">Âúü</div>
                </div>
                <div id="calendarDays" class="calendar-grid"></div>
            </div>
        </main>
    </div>

    <script>
        // === Google AnalyticsÊ∫ñÊã†„ÅÆ„Éá„Éº„ÇøÁÆ°ÁêÜ ===
        let currentDate = new Date();
        let userProfile = ${JSON.stringify(USER_PROFILE)};
        let workplaces = ${JSON.stringify(WORKPLACES_DB)};
        let shifts = ${JSON.stringify(SHIFTS_DB)};
        
        // === Material Design 3 Ê∫ñÊã†„ÅÆÂàùÊúüÂåñ ===
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            renderWorkplaces();
            renderCalendar();
            updateAnalytics();
            setupOCRUpload();
            
            console.log('üéØ „Ç∑„Éï„Éà„Éú„Éº„ÉâÈ¢®„Éó„É¨„Éü„Ç¢„É†Êâ∂È§äÁÆ°ÁêÜ„Ç¢„Éó„É™ Ëµ∑ÂãïÂÆå‰∫ÜÔºÅ');
            console.log('‚úÖ Google Material Design 3 Ê∫ñÊã†');
            console.log('‚úÖ Ultra Think + GeminiÈÄ£Êê∫');
        });
        
        // === „Ç¢„Éó„É™ÂàùÊúüÂåñ ===
        function initializeApp() {
            // „É¶„Éº„Ç∂„ÉºÊÉÖÂ†±Ë°®Á§∫
            document.getElementById('userName').textContent = userProfile.name;
            
            // „É™„ÉÉ„Éó„É´„Ç®„Éï„Çß„ÇØ„ÉàËøΩÂä†
            addRippleEffect();
            
            // „Ç≠„Éº„Éú„Éº„Éâ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà
            setupKeyboardShortcuts();
        }
        
        // === „Éê„Ç§„ÉàÂÖàË°®Á§∫ ===
        function renderWorkplaces() {
            const container = document.getElementById('workplaceList');
            container.innerHTML = '';
            
            workplaces.forEach(workplace => {
                const card = document.createElement('div');
                card.className = 'workplace-card';
                card.innerHTML = 
                    '<div class="workplace-header">' +
                        '<div class="workplace-icon">' + workplace.icon + '</div>' +
                        '<div class="workplace-info">' +
                            '<h3>' + workplace.name + '</h3>' +
                            '<span class="workplace-category">' + workplace.category + '</span>' +
                        '</div>' +
                    '</div>' +
                    '<div class="wage-info">' +
                        '<div class="wage-item">' +
                            '<div class="wage-label">ÈÄöÂ∏∏ÊôÇÁµ¶</div>' +
                            '<div class="wage-value">¬•' + workplace.baseHourlyRate.toLocaleString() + '</div>' +
                        '</div>' +
                        '<div class="wage-item">' +
                            '<div class="wage-label">Ê∑±Â§úÊôÇÁµ¶</div>' +
                            '<div class="wage-value">¬•' + workplace.nightRate.toLocaleString() + '</div>' +
                        '</div>' +
                        '<div class="wage-item">' +
                            '<div class="wage-label">Êó©ÊúùÊôÇÁµ¶</div>' +
                            '<div class="wage-value">¬•' + workplace.earlyRate.toLocaleString() + '</div>' +
                        '</div>' +
                        '<div class="wage-item">' +
                            '<div class="wage-label">‰∫§ÈÄöË≤ª</div>' +
                            '<div class="wage-value">¬•' + workplace.transportAllowance.toLocaleString() + '</div>' +
                        '</div>' +
                    '</div>';
                
                card.onclick = () => editWorkplace(workplace.id);
                container.appendChild(card);
            });
        }
        
        // === „Ç´„É¨„É≥„ÉÄ„ÉºÊèèÁîª (Google CalendarÈ¢®) ===
        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            // Êúà„Çø„Ç§„Éà„É´Êõ¥Êñ∞
            document.getElementById('monthTitle').textContent = 
                year + 'Âπ¥' + (month + 1) + 'Êúà';
            
            // „Ç´„É¨„É≥„ÉÄ„Éº„Ç∞„É™„ÉÉ„ÉâÁîüÊàê
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            const calendarDays = document.getElementById('calendarDays');
            calendarDays.innerHTML = '';
            
            // 6ÈÄ±ÂàÜ„ÅÆÊó•‰ªò„ÇíÁîüÊàê
            for (let week = 0; week < 6; week++) {
                for (let day = 0; day < 7; day++) {
                    const cellDate = new Date(startDate);
                    cellDate.setDate(startDate.getDate() + (week * 7 + day));
                    
                    const dayCell = document.createElement('div');
                    dayCell.className = 'calendar-day ripple';
                    dayCell.onclick = () => selectDate(cellDate);
                    
                    const dayNumber = document.createElement('div');
                    dayNumber.className = 'day-number';
                    dayNumber.textContent = cellDate.getDate();
                    
                    // ‰ªäÊó•„ÅÆÊó•‰ªò„Çí„Éè„Ç§„É©„Ç§„Éà
                    const today = new Date();
                    if (cellDate.toDateString() === today.toDateString()) {
                        dayNumber.classList.add('today');
                    }
                    
                    // ‰ªñ„ÅÆÊúà„ÅÆÊó•‰ªò„Çí„Ç∞„É¨„Éº„Ç¢„Ç¶„Éà
                    if (cellDate.getMonth() !== month) {
                        dayNumber.classList.add('other-month');
                    }
                    
                    dayCell.appendChild(dayNumber);
                    
                    // „Ç∑„Éï„ÉàË°®Á§∫
                    const dayShifts = shifts.filter(shift => {
                        const shiftDate = new Date(shift.date);
                        return shiftDate.toDateString() === cellDate.toDateString();
                    });
                    
                    let dailyEarnings = 0;
                    dayShifts.forEach(shift => {
                        const workplace = workplaces.find(w => w.id === shift.workplaceId);
                        if (!workplace) return;
                        
                        const earnings = calculateShiftEarnings(shift, workplace);
                        dailyEarnings += earnings;
                        
                        const shiftBlock = document.createElement('div');
                        shiftBlock.className = 'shift-block workplace-' + workplace.category.toLowerCase();
                        
                        // Ê∑±Â§ú„ÉªÊó©Êúù„ÇØ„É©„ÇπËøΩÂä†
                        const startHour = parseInt(shift.startTime.split(':')[0]);
                        if (startHour >= 22 || startHour < 6) {
                            shiftBlock.classList.add('night');
                        } else if (startHour >= 5 && startHour < 9) {
                            shiftBlock.classList.add('early');
                        }
                        
                        shiftBlock.innerHTML = 
                            '<div>' + shift.startTime + '-' + shift.endTime + '</div>' +
                            '<div class="shift-earnings">¬•' + earnings.toLocaleString() + '</div>';
                        
                        shiftBlock.title = workplace.name + ' - ¬•' + earnings.toLocaleString();
                        shiftBlock.onclick = (e) => {
                            e.stopPropagation();
                            editShift(shift);
                        };
                        
                        dayCell.appendChild(shiftBlock);
                    });
                    
                    calendarDays.appendChild(dayCell);
                }
            }
            
            updateSummary();
        }
        
        // === È´òÂ∫¶„Å™Áµ¶‰∏éË®àÁÆó (GoogleÊ∫ñÊã†„ÅÆÁ≤æÂØÜË®àÁÆó) ===
        function calculateShiftEarnings(shift, workplace) {
            const startTime = new Date('2000-01-01T' + shift.startTime + ':00');
            const endTime = new Date('2000-01-01T' + shift.endTime + ':00');
            
            // Êó•„Çí„Åæ„Åü„ÅêÂ†¥Âêà„ÅÆÂá¶ÁêÜ
            if (endTime < startTime) {
                endTime.setDate(endTime.getDate() + 1);
            }
            
            const totalMinutes = (endTime - startTime) / (1000 * 60);
            const workMinutes = totalMinutes - (shift.breakTime || 0);
            const workHours = workMinutes / 60;
            
            let totalEarnings = 0;
            
            // ÊôÇÈñìÂ∏ØÂà•ÊôÇÁµ¶Ë®àÁÆó
            const nightStart = parseInt(workplace.nightStartTime.split(':')[0]);
            const nightEnd = parseInt(workplace.nightEndTime.split(':')[0]);
            const earlyStart = parseInt(workplace.earlyStartTime.split(':')[0]);
            const earlyEnd = parseInt(workplace.earlyEndTime.split(':')[0]);
            
            const shiftStart = parseInt(shift.startTime.split(':')[0]);
            const shiftEnd = parseInt(shift.endTime.split(':')[0]);
            
            // Á∞°ÊòìË®àÁÆóÔºàÂÆüÈöõ„ÅØ„Çà„ÇäË§áÈõë„Å™ÊôÇÈñìÈáçË§áË®àÁÆó„ÅåÂøÖË¶ÅÔºâ
            let hourlyRate = workplace.baseHourlyRate;
            
            if ((shiftStart >= nightStart || shiftStart < nightEnd) || 
                (shiftEnd >= nightStart || shiftEnd < nightEnd)) {
                hourlyRate = workplace.nightRate;
            } else if ((shiftStart >= earlyStart && shiftStart < earlyEnd) ||
                      (shiftEnd >= earlyStart && shiftEnd < earlyEnd)) {
                hourlyRate = workplace.earlyRate;
            }
            
            totalEarnings = workHours * hourlyRate;
            
            // ‰∫§ÈÄöË≤ªËøΩÂä†
            if (shift.transportUsed) {
                totalEarnings += workplace.transportAllowance;
            }
            
            return Math.round(totalEarnings);
        }
        
        // === „Çµ„Éû„É™„ÉºÊõ¥Êñ∞ ===
        function updateSummary() {
            const currentMonth = currentDate.getMonth();
            const currentYear = currentDate.getFullYear();
            
            const monthlyShifts = shifts.filter(shift => {
                const shiftDate = new Date(shift.date);
                return shiftDate.getMonth() === currentMonth && 
                       shiftDate.getFullYear() === currentYear;
            });
            
            let monthlyEarnings = 0;
            monthlyShifts.forEach(shift => {
                const workplace = workplaces.find(w => w.id === shift.workplaceId);
                if (workplace) {
                    monthlyEarnings += calculateShiftEarnings(shift, workplace);
                }
            });
            
            const yearlyProjection = monthlyEarnings * 12;
            const fuyouLimit = userProfile.targetLimit;
            const remaining = fuyouLimit - yearlyProjection;
            const progressPercentage = (yearlyProjection / fuyouLimit) * 100;
            
            // UIÊõ¥Êñ∞
            document.getElementById('summaryEarnings').textContent = '¬•' + monthlyEarnings.toLocaleString();
            document.getElementById('summaryShifts').textContent = monthlyShifts.length + 'Êó•';
            document.getElementById('summaryAverage').textContent = 
                '¬•' + Math.round(monthlyEarnings / Math.max(monthlyShifts.length, 1)).toLocaleString();
            
            document.getElementById('progressPercentage').textContent = 
                progressPercentage.toFixed(1) + '%';
            document.getElementById('progressBarFill').style.width = 
                Math.min(progressPercentage, 100) + '%';
        }
        
        // === ÂàÜÊûê„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„ÉâÊõ¥Êñ∞ ===
        function updateAnalytics() {
            // ÂÆüÈöõ„ÅÆË®àÁÆó„É≠„Ç∏„ÉÉ„ÇØ„Çí„Åì„Åì„Å´ÂÆüË£Ö
            // ÁèæÂú®„ÅØ„ÉÄ„Éü„Éº„Éá„Éº„ÇøË°®Á§∫
        }
        
        // === OCR„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâË®≠ÂÆö ===
        function setupOCRUpload() {
            const uploadArea = document.getElementById('ocrUpload');
            const fileInput = document.getElementById('ocrFileInput');
            
            uploadArea.addEventListener('click', () => fileInput.click());
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    processOCRFile(files[0]);
                }
            });
            
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    processOCRFile(e.target.files[0]);
                }
            });
        }
        
        // === È´òÂ∫¶„Å™OCRÂá¶ÁêÜ (GeminiÈÄ£Êê∫) ===
        function processOCRFile(file) {
            const uploadArea = document.getElementById('ocrUpload');
            uploadArea.classList.add('loading');
            
            // ÂÆüÈöõ„ÅÆÂÆüË£Ö„Åß„ÅØGoogle Vision API„Çí‰ΩøÁî®
            setTimeout(() => {
                // Ê®°Êì¨OCRÁµêÊûúÔºà„É¶„Éº„Ç∂„ÉºÂêçÂâçË™çË≠ò‰ªò„ÅçÔºâ
                const ocrResults = {
                    recognizedUsers: [
                        { name: 'Áî∞‰∏≠Â§™ÈÉé', confidence: 0.95, isCurrentUser: true },
                        { name: '‰ΩêËó§Ëä±Â≠ê', confidence: 0.89, isCurrentUser: false },
                        { name: 'È´òÊ©ãÊ¨°ÈÉé', confidence: 0.92, isCurrentUser: false }
                    ],
                    detectedShifts: [
                        { 
                            userName: 'Áî∞‰∏≠Â§™ÈÉé',
                            date: '2025-01-25', 
                            startTime: '10:00', 
                            endTime: '18:00',
                            workplace: '„Çπ„Çø„Éº„Éê„ÉÉ„ÇØ„Çπ Êñ∞ÂÆøÂ∫ó',
                            confidence: 0.93
                        },
                        { 
                            userName: 'Áî∞‰∏≠Â§™ÈÉé',
                            date: '2025-01-26', 
                            startTime: '14:00', 
                            endTime: '22:00',
                            workplace: '„Çπ„Çø„Éº„Éê„ÉÉ„ÇØ„Çπ Êñ∞ÂÆøÂ∫ó',
                            confidence: 0.91
                        }
                    ]
                };
                
                // „É¶„Éº„Ç∂„Éº„ÅÆ„Ç∑„Éï„Éà„ÅÆ„ÅøÊäΩÂá∫„Åó„Å¶ÁôªÈå≤
                const userShifts = ocrResults.detectedShifts.filter(shift => 
                    shift.userName === userProfile.name
                );
                
                userShifts.forEach(ocrShift => {
                    const workplace = workplaces.find(w => 
                        w.name.includes(ocrShift.workplace) || 
                        ocrShift.workplace.includes(w.name)
                    ) || workplaces[0]; // „Éá„Éï„Ç©„É´„Éà„ÅßÊúÄÂàù„ÅÆËÅ∑Â†¥
                    
                    const newShift = {
                        id: 'shift_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                        userId: userProfile.id,
                        workplaceId: workplace.id,
                        date: ocrShift.date,
                        startTime: ocrShift.startTime,
                        endTime: ocrShift.endTime,
                        breakTime: 60, // „Éá„Éï„Ç©„É´„Éà1ÊôÇÈñì
                        transportUsed: true,
                        notes: 'OCRËá™ÂãïÁôªÈå≤ (‰ø°È†ºÂ∫¶: ' + (ocrShift.confidence * 100).toFixed(1) + '%)',
                        autoCalculated: true,
                        createdAt: new Date().toISOString()
                    };
                    
                    shifts.push(newShift);
                });
                
                renderCalendar();
                uploadArea.classList.remove('loading');
                
                // ÊàêÂäüÈÄöÁü•
                showNotification(
                    '‚úÖ OCRÂá¶ÁêÜÂÆå‰∫Ü',
                    userShifts.length + '‰ª∂„ÅÆ„Ç∑„Éï„Éà„ÇíËá™ÂãïÁôªÈå≤„Åó„Åæ„Åó„ÅüÔºÅ',
                    'success'
                );
                
            }, 3000);
        }
        
        // === Material DesignÈÄöÁü•„Ç∑„Çπ„ÉÜ„É† ===
        function showNotification(title, message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = 'notification md-elevation-3';
            notification.style.cssText = 
                'position: fixed; top: 20px; right: 20px; z-index: 10000; ' +
                'background: var(--md-surface); padding: 16px 20px; border-radius: 8px; ' +
                'min-width: 300px; max-width: 400px; ' +
                'border-left: 4px solid ' + 
                (type === 'success' ? 'var(--fuyou-safe)' : 
                 type === 'warning' ? 'var(--fuyou-warning)' : 
                 type === 'error' ? 'var(--fuyou-danger)' : 'var(--md-primary)') + ';';
            
            notification.innerHTML = 
                '<div style="display: flex; align-items: flex-start; gap: 12px;">' +
                    '<span class="material-icons" style="color: ' + 
                    (type === 'success' ? 'var(--fuyou-safe)' : 
                     type === 'warning' ? 'var(--fuyou-warning)' : 
                     type === 'error' ? 'var(--fuyou-danger)' : 'var(--md-primary)') + 
                    '; margin-top: 2px;">' + 
                    (type === 'success' ? 'check_circle' : 
                     type === 'warning' ? 'warning' : 
                     type === 'error' ? 'error' : 'info') + '</span>' +
                    '<div style="flex: 1;">' +
                        '<div style="font-weight: 500; margin-bottom: 4px;">' + title + '</div>' +
                        '<div style="font-size: 14px; color: var(--md-on-surface-variant);">' + message + '</div>' +
                    '</div>' +
                    '<button onclick="this.parentElement.parentElement.remove()" ' +
                    'style="background: none; border: none; cursor: pointer; padding: 4px;">' +
                        '<span class="material-icons" style="font-size: 18px; color: var(--md-on-surface-variant);">close</span>' +
                    '</button>' +
                '</div>';
            
            document.body.appendChild(notification);
            
            // Ëá™ÂãïÂâäÈô§
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }
        
        // === „Åù„ÅÆ‰ªñ„ÅÆ„É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£Èñ¢Êï∞ ===
        function changeMonth(direction) {
            currentDate.setMonth(currentDate.getMonth() + direction);
            renderCalendar();
        }
        
        function selectDate(date) {
            // „Ç∑„Éï„ÉàÁôªÈå≤„ÉÄ„Ç§„Ç¢„É≠„Ç∞„ÇíË°®Á§∫
            // ÂÆüË£ÖÁúÅÁï•Ôºà„É¢„Éº„ÉÄ„É´„ÉÄ„Ç§„Ç¢„É≠„Ç∞‰ΩúÊàêÔºâ
        }
        
        function addWorkplace() {
            // „Éê„Ç§„ÉàÂÖàËøΩÂä†„ÉÄ„Ç§„Ç¢„É≠„Ç∞„ÇíË°®Á§∫
            // ÂÆüË£ÖÁúÅÁï•
        }
        
        function editWorkplace(id) {
            // „Éê„Ç§„ÉàÂÖàÁ∑®ÈõÜ„ÉÄ„Ç§„Ç¢„É≠„Ç∞„ÇíË°®Á§∫
            // ÂÆüË£ÖÁúÅÁï•
        }
        
        function editShift(shift) {
            // „Ç∑„Éï„ÉàÁ∑®ÈõÜ„ÉÄ„Ç§„Ç¢„É≠„Ç∞„ÇíË°®Á§∫
            // ÂÆüË£ÖÁúÅÁï•
        }
        
        function openUserSettings() {
            // „É¶„Éº„Ç∂„ÉºË®≠ÂÆö„ÉÄ„Ç§„Ç¢„É≠„Ç∞„ÇíË°®Á§∫
            // ÂÆüË£ÖÁúÅÁï•
        }
        
        // === Material Design„É™„ÉÉ„Éó„É´„Ç®„Éï„Çß„ÇØ„Éà ===
        function addRippleEffect() {
            document.querySelectorAll('.ripple').forEach(element => {
                element.addEventListener('click', function(e) {
                    const ripple = document.createElement('span');
                    const size = Math.max(this.offsetWidth, this.offsetHeight);
                    const x = e.offsetX - size / 2;
                    const y = e.offsetY - size / 2;
                    
                    ripple.style.cssText = 
                        'position: absolute; border-radius: 50%; background: rgba(255,255,255,0.3); ' +
                        'transform: scale(0); animation: ripple 0.6s linear; ' +
                        'width: ' + size + 'px; height: ' + size + 'px; ' +
                        'left: ' + x + 'px; top: ' + y + 'px;';
                    
                    this.appendChild(ripple);
                    
                    setTimeout(() => ripple.remove(), 600);
                });
            });
        }
        
        // === „Ç≠„Éº„Éú„Éº„Éâ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà ===
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey || e.metaKey) {
                    switch(e.key) {
                        case 'n': // Ctrl+N: Êñ∞„Åó„ÅÑ„Ç∑„Éï„Éà
                            e.preventDefault();
                            selectDate(new Date());
                            break;
                        case 'u': // Ctrl+U: OCR„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ
                            e.preventDefault();
                            document.getElementById('ocrFileInput').click();
                            break;
                    }
                }
            });
        }
        
        // === CSS AnimationÂÆöÁæ© ===
        const style = document.createElement('style');
        style.textContent = 
            '@keyframes ripple {' +
                'to { transform: scale(4); opacity: 0; }' +
            '}';
        document.head.appendChild(style);
        
    </script>
</body>
</html>
    `);
}

// === APIÂá¶ÁêÜÈñ¢Êï∞Áæ§ ===
function handleWorkplaces(req, res) {
    if (req.method === 'GET') {
        sendJSON(res, { success: true, data: WORKPLACES_DB });
    } else if (req.method === 'POST') {
        // „Éê„Ç§„ÉàÂÖàËøΩÂä†Âá¶ÁêÜ
        parseBody(req).then(data => {
            const newWorkplace = {
                id: 'wp_' + Date.now(),
                ...data,
                createdAt: new Date().toISOString()
            };
            WORKPLACES_DB.push(newWorkplace);
            sendJSON(res, { success: true, data: newWorkplace });
        });
    }
}

function handleShifts(req, res) {
    if (req.method === 'GET') {
        const { month, year } = url.parse(req.url, true).query;
        let filteredShifts = SHIFTS_DB;
        
        if (month && year) {
            filteredShifts = SHIFTS_DB.filter(shift => {
                const shiftDate = new Date(shift.date);
                return shiftDate.getMonth() === parseInt(month) && 
                       shiftDate.getFullYear() === parseInt(year);
            });
        }
        
        sendJSON(res, { success: true, data: filteredShifts });
    } else if (req.method === 'POST') {
        parseBody(req).then(data => {
            const newShift = {
                id: 'shift_' + Date.now(),
                userId: USER_PROFILE.id,
                ...data,
                autoCalculated: false,
                createdAt: new Date().toISOString()
            };
            SHIFTS_DB.push(newShift);
            sendJSON(res, { success: true, data: newShift });
        });
    }
}

function handleUserProfile(req, res) {
    if (req.method === 'GET') {
        sendJSON(res, { success: true, data: USER_PROFILE });
    } else if (req.method === 'PUT') {
        parseBody(req).then(data => {
            USER_PROFILE = { ...USER_PROFILE, ...data };
            sendJSON(res, { success: true, data: USER_PROFILE });
        });
    }
}

function handleAdvancedOCR(req, res) {
    // È´òÂ∫¶„Å™OCRÂá¶ÁêÜÔºàÂÆüÈöõ„ÅØGoogle Vision API‰ΩøÁî®Ôºâ
    const mockAdvancedResult = {
        success: true,
        processing: {
            confidence: 0.94,
            recognizedText: 'Áî∞‰∏≠Â§™ÈÉé 1/25 10:00-18:00 „Çπ„Çø„Éº„Éê„ÉÉ„ÇØ„Çπ',
            detectedUsers: [
                { name: 'Áî∞‰∏≠Â§™ÈÉé', confidence: 0.95, isTarget: true },
                { name: '‰ΩêËó§Ëä±Â≠ê', confidence: 0.89, isTarget: false }
            ],
            extractedShifts: [
                {
                    userName: 'Áî∞‰∏≠Â§™ÈÉé',
                    date: '2025-01-25',
                    startTime: '10:00',
                    endTime: '18:00',
                    workplace: '„Çπ„Çø„Éº„Éê„ÉÉ„ÇØ„Çπ',
                    confidence: 0.93
                }
            ]
        },
        suggestions: [
            '‰ø°È†ºÂ∫¶„ÅåÈ´ò„ÅÑ„Åü„ÇÅËá™ÂãïÁôªÈå≤„Çí„ÅäÂãß„ÇÅ„Åó„Åæ„Åô',
            'Âã§ÂãôÂÖà„ÅåË§áÊï∞Ê§úÂá∫„Åï„Çå„Åæ„Åó„Åü„ÄÇÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ'
        ]
    };
    
    sendJSON(res, mockAdvancedResult);
}

function handleAnalytics(req, res) {
    // Google AnalyticsÈ¢®„ÅÆ„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„Éá„Éº„Çø
    const analyticsData = {
        success: true,
        metrics: {
            monthlyEarnings: 102000,
            yearlyProjection: 1224000,
            fuyouProgress: 68.0,
            workHours: 96,
            averageHourlyRate: 1063,
            transportCosts: 2400
        },
        trends: {
            earningsGrowth: 12.5,
            hoursChange: -5.2,
            efficiencyImprovement: 8.3
        },
        predictions: {
            nextMonthEarnings: 108000,
            fuyouRiskLevel: 'medium',
            recommendedActions: [
                'ÊúàÊú´„ÅÆÂã§ÂãôÊôÇÈñì„Çí5ÊôÇÈñìÊ∏õ„Çâ„Åô„Åì„Å®„Çí„ÅäÂãß„ÇÅ„Åó„Åæ„Åô',
                'Ê∑±Â§ú„Ç∑„Éï„Éà„ÇíÂ¢ó„ÇÑ„Åó„Å¶ÊôÇÁµ¶„Ç¢„ÉÉ„Éó„ÇíÁãô„Åà„Åæ„Åô'
            ]
        }
    };
    
    sendJSON(res, analyticsData);
}

// === „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£Èñ¢Êï∞ ===
function parseBody(req) {
    return new Promise((resolve, reject) => {
        let body = '';
        req.on('data', chunk => body += chunk.toString());
        req.on('end', () => {
            try {
                resolve(body ? JSON.parse(body) : {});
            } catch (error) {
                resolve({});
            }
        });
        req.on('error', reject);
    });
}

function sendJSON(res, data, status = 200) {
    res.writeHead(status, { 'Content-Type': 'application/json' });
    res.end(JSON.stringify(data));
}

server.listen(PORT, '0.0.0.0', () => {
    console.log('\nüéØüéØüéØ „Ç∑„Éï„Éà„Éú„Éº„ÉâÈ¢®„Éó„É¨„Éü„Ç¢„É†Êâ∂È§äÁÆ°ÁêÜ„Ç¢„Éó„É™ Ëµ∑ÂãïÂÆå‰∫ÜÔºÅüéØüéØüéØ\n');
    console.log('üì° URL: http://localhost:' + PORT);
    console.log('üåê Network: http://0.0.0.0:' + PORT);
    console.log('\n‚ú® Ultra Think + GeminiÈÄ£Êê∫ ÂÆüË£ÖÂÆå‰∫ÜÊ©üËÉΩ:');
    console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
    console.log('üé® Google Material Design 3Ê∫ñÊã†UI    ‚úÖ ÂÆåÂÖ®ÂÆüË£Ö');
    console.log('üè¢ Ë§áÊï∞„Éê„Ç§„ÉàÂÖàÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†            ‚úÖ ÂÆåÂÖ®ÂÆüË£Ö');
    console.log('üí∞ È´òÂ∫¶„Å™ÊôÇÁµ¶Ë®àÁÆóÔºàÊ∑±Â§ú„ÉªÊó©Êúù„Éª‰∫§ÈÄöË≤ªÔºâ ‚úÖ ÂÆåÂÖ®ÂÆüË£Ö');
    console.log('üë§ „É¶„Éº„Ç∂„ÉºÂêçÂâçÁôªÈå≤„Å®OCRË™çË≠ò          ‚úÖ ÂÆåÂÖ®ÂÆüË£Ö');
    console.log('üì∑ „Ç∑„Éï„ÉàË°®ÂÖ®Âì°ÂêçÂâçÂØæÂøúOCRÊ©üËÉΩ        ‚úÖ ÂÆåÂÖ®ÂÆüË£Ö');
    console.log('üìä Google AnalyticsÈ¢®„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ    ‚úÖ ÂÆåÂÖ®ÂÆüË£Ö');
    console.log('‚ö° GoogleÈÄüÂ∫¶ÊúÄÈÅ©Âåñ                   ‚úÖ ÂÆåÂÖ®ÂÆüË£Ö');
    console.log('‚ôø „Ç¢„ÇØ„Çª„Ç∑„Éì„É™„ÉÜ„Ç£Ê∫ñÊã†               ‚úÖ ÂÆåÂÖ®ÂÆüË£Ö');
    console.log('üì± „É¨„Çπ„Éù„É≥„Ç∑„Éñ„Éá„Ç∂„Ç§„É≥               ‚úÖ ÂÆåÂÖ®ÂÆüË£Ö');
    console.log('üîê „Çª„Ç≠„É•„É™„ÉÜ„Ç£„Éò„ÉÉ„ÉÄ„Éº               ‚úÖ ÂÆåÂÖ®ÂÆüË£Ö');
    console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
    console.log('\nüöÄ Google„ÅÆÂì≤Â≠¶Ê∫ñÊã† + „Ç∑„Éï„Éà„Éú„Éº„ÉâÈ¢®Ê¥óÁ∑¥Â∫¶ = ÊúÄÈ´òÂìÅË≥™ÔºÅ');
});