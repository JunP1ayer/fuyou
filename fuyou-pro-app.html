<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Êâ∂È§ä„Éó„É≠ - Â≠¶Áîü„Éê„Ç§„ÉàÊâ∂È§äÁÆ°ÁêÜ„Ç¢„Éó„É™</title>
    
    <!-- PWA „É°„Çø„Éá„Éº„Çø -->
    <meta name="theme-color" content="#4CAF50">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Êâ∂È§ä„Éó„É≠">
    <meta name="msapplication-TileColor" content="#4CAF50">
    <meta name="msapplication-config" content="browserconfig.xml">
    
    <!-- „Ç¢„Ç§„Ç≥„É≥ -->
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="mask-icon" href="safari-pinned-tab.svg" color="#4CAF50">
    
    <!-- PWA „Éû„Éã„Éï„Çß„Çπ„Éà -->
    <link rel="manifest" href="manifest.json">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            min-height: calc(100vh - env(safe-area-inset-bottom));
            color: #333;
            -webkit-font-smoothing: antialiased;
            padding-top: env(safe-area-inset-top);
            
            /* üÜï „É¢„Éê„Ç§„É´ÊúÄÈÅ©Âåñ */
            overflow-x: hidden;
            position: relative;
            width: 100%;
            max-width: 100vw;
        }

        .app-container {
            max-width: 420px;
            margin: 0 auto;
            background: #ffffff;
            min-height: 100vh;
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            
            /* üÜï Ë¶ãÂàá„ÇåÈò≤Ê≠¢ */
            width: 100%;
            max-width: min(420px, 100vw);
            overflow-x: hidden;
        }

        /* „Éë„ÇΩ„Ç≥„É≥„Éª„Çø„Éñ„É¨„ÉÉ„ÉàÂØæÂøú */
        @media (min-width: 768px) {
            .app-container {
                max-width: 800px;
                margin: 20px auto;
                border-radius: 16px;
                overflow: hidden;
                min-height: calc(100vh - 40px);
            }

            body {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                padding: 0;
            }
        }

        @media (min-width: 1200px) {
            .app-container {
                max-width: 1000px;
                display: grid;
                grid-template-columns: 300px 1fr;
                grid-template-rows: auto 1fr;
            }

            .header {
                grid-column: 1 / -1;
            }

            .tabs {
                grid-column: 1;
                flex-direction: column !important;
                background: #f8f9fa;
                padding: 20px 0;
                border-bottom: none;
                border-right: 1px solid #e9ecef;
            }

            .tab-button {
                width: 100% !important;
                margin: 5px 10px !important;
                text-align: left !important;
                padding: 15px 20px !important;
                border-radius: 8px !important;
            }

            .tab-content {
                grid-column: 2;
                padding: 20px;
                overflow-y: auto;
                max-height: calc(100vh - 140px);
            }
        }

        /* „Éò„ÉÉ„ÉÄ„Éº - „Çπ„Éû„Éõ„Ç¢„Éó„É™„É©„Ç§„ÇØ */
        .header {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: max(env(safe-area-inset-top), 8px) 16px 16px;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(76, 175, 80, 0.4);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }
        
        .header:hover {
            box-shadow: 0 6px 25px rgba(76, 175, 80, 0.5);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .app-title {
            font-size: 20px;
            font-weight: 600;
        }

        .settings-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
        }

        .fuyou-status {
            background: rgba(255,255,255,0.2);
            padding: 16px;
            border-radius: 16px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.3);
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .fuyou-status::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, #fff, rgba(255,255,255,0.5), #fff);
            opacity: 0.6;
        }
        
        .fuyou-status:active {
            transform: scale(0.98);
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        }

        .fuyou-amount {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .fuyou-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .fuyou-bar {
            height: 8px;
            background: rgba(255,255,255,0.25);
            border-radius: 6px;
            margin-top: 12px;
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .fuyou-progress {
            height: 100%;
            background: linear-gradient(90deg, #ffffff, #f1f8e9, #ffffff);
            border-radius: 6px;
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            box-shadow: 0 0 10px rgba(255,255,255,0.5);
        }
        
        .fuyou-progress::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: linear-gradient(180deg, rgba(255,255,255,0.4), transparent);
            border-radius: 6px 6px 0 0;
        }

        /* „Çø„Éñ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ - „Çπ„Éû„Éõ„Ç¢„Éó„É™„É©„Ç§„ÇØ */
        .tab-nav {
            display: flex;
            background: linear-gradient(135deg, #ffffff, #f8f9fa);
            border-bottom: 1px solid rgba(76, 175, 80, 0.1);
            overflow-x: auto;
            box-shadow: 0 2px 12px rgba(76, 175, 80, 0.08);
            position: sticky;
            top: calc(env(safe-area-inset-top) + 120px);
            z-index: 50;
            backdrop-filter: blur(15px);
            /* „Çø„Ç§„É†„ÉÑ„É™„ÉºÈ¢®„ÅÆÊ¥óÁ∑¥„Åï„Çå„Åü„Éá„Ç∂„Ç§„É≥ */
            padding: 4px 8px;
            margin-bottom: 2px;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }
        
        .tab-nav::-webkit-scrollbar {
            display: none;
        }

        /* „Çø„Éñ„É¨„ÉÉ„Éà„Éª„Éá„Çπ„ÇØ„Éà„ÉÉ„Éó„Åß„ÅÆ„Çø„ÉñË™øÊï¥ */
        @media (min-width: 768px) {
            .tab-nav {
                justify-content: center;
                overflow-x: visible;
            }
            
            .tab-btn {
                min-width: 120px;
                padding: 16px 24px !important;
            }
        }

        .tab-btn {
            flex: 1;
            padding: 12px 8px;
            background: transparent;
            border: none;
            font-size: 13px;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            border-radius: 10px;
            margin: 0 2px;
            /* „Ç∑„É≥„Éó„É´„Ç´„É¨„É≥„ÉÄ„ÉºÈ¢®„ÅÆ„Éü„Éã„Éû„É´„Éá„Ç∂„Ç§„É≥ */
            min-height: 48px;
            -webkit-tap-highlight-color: rgba(76, 175, 80, 0.15);
            touch-action: manipulation;
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: center;
            /* „Çø„Ç§„É†„ÉÑ„É™„ÉºÈ¢®„ÅÆËâ≤ÂàÜ„Åë„Çµ„Éù„Éº„Éà */
            overflow: hidden;
            
            /* üÜï Ë¶ãÂàá„ÇåÈò≤Ê≠¢ */
            max-width: 25%;
            min-width: 60px;
            white-space: nowrap;
            text-overflow: ellipsis;
        }
        
        .tab-btn:hover,
        .tab-btn:focus {
            color: #4CAF50;
            background: rgba(76, 175, 80, 0.05);
        }
        
        /* „Çø„ÉÉ„ÉÅ„Éá„Éê„Ç§„ÇπÂêë„Åë„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÁä∂ÊÖãÂº∑Âåñ */
        .tab-btn:active {
            transform: scale(0.96);
            background: rgba(76, 175, 80, 0.12);
            color: #4CAF50;
        }

        .tab-btn.active {
            color: #4CAF50;
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.1), rgba(76, 175, 80, 0.15));
            font-weight: 700;
            /* „Ç∑„Éï„Éà„Éú„Éº„ÉâÈ¢®„ÅÆ„Ç¢„ÇØ„ÉÜ„Ç£„ÉñË°®Á§∫ */
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.2);
            transform: translateY(-1px);
        }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -4px;
            left: 50%;
            transform: translateX(-50%);
            width: 24px;
            height: 3px;
            background: linear-gradient(90deg, #4CAF50, #66BB6A);
            border-radius: 2px;
            box-shadow: 0 0 8px rgba(76, 175, 80, 0.4);
        }
        
        /* „Çø„Ç§„É†„ÉÑ„É™„ÉºÈ¢®„ÅÆ„Çø„Éñ„Ç¢„Ç§„Ç≥„É≥ËøΩÂä†„Çµ„Éù„Éº„Éà */
        .tab-btn::before {
            content: attr(data-icon);
            font-size: 16px;
            margin-right: 4px;
            opacity: 0.8;
        }
        
        .tab-btn.active::before {
            opacity: 1;
        }

        /* „Çø„Éñ„Ç≥„É≥„ÉÜ„É≥„ÉÑ */
        .tab-content {
            display: none;
            padding: 16px;
            min-height: calc(100vh - 200px);
        }

        .tab-content.active {
            display: block;
        }

        /* „Ç´„É¨„É≥„ÉÄ„Éº„Çø„Éñ */
        .calendar-month {
            text-align: center;
            font-size: 20px;
            font-weight: 700;
            margin: 20px 0 16px 0;
            color: #2c3e50;
            padding: 16px;
            background: linear-gradient(135deg, #ffffff, #f8f9fa);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border: 1px solid rgba(76, 175, 80, 0.1);
            /* „Çø„Ç§„É†„ÉÑ„É™„ÉºÈ¢®„ÅÆ„Ç®„É¨„Ç¨„É≥„ÉàÊÑü */
            letter-spacing: 0.5px;
            user-select: none;
        }

        .weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            margin-bottom: 8px;
        }

        .weekday {
            text-align: center;
            padding: 8px 4px;
            font-size: 12px;
            font-weight: 600;
            color: #666;
        }

        .weekday.sunday { color: #f44336; }
        .weekday.saturday { color: #2196f3; }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #e9ecef;
            border-radius: 8px;
            overflow: hidden;
        }

        .calendar-cell {
            aspect-ratio: 1;
            background: #ffffff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 6px;
            margin: 1px;
            /* „Ç∑„Éï„Éà„Éú„Éº„ÉâÈ¢®„ÅÆÊ¥óÁ∑¥„Åï„Çå„Åü„Çª„É´ */
            border: 1px solid rgba(0,0,0,0.04);
            box-shadow: 0 1px 3px rgba(0,0,0,0.02);
        }

        .calendar-cell:hover {
            background: rgba(76, 175, 80, 0.05);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.08);
        }

        .calendar-cell.today {
            background: linear-gradient(135deg, #e8f5e8, #f1f8e9);
            border: 2px solid #4CAF50;
            box-shadow: 0 0 12px rgba(76, 175, 80, 0.2);
            /* „Çø„Ç§„É†„ÉÑ„É™„ÉºÈ¢®„ÅÆ‰ªäÊó•Âº∑Ë™ø */
            font-weight: 700;
        }

        .calendar-cell.disabled {
            background: #f8f9fa;
            color: #bbb;
            cursor: default;
            opacity: 0.6;
        }

        .calendar-day {
            font-size: 14px;
            font-weight: 500;
        }

        .shift-indicators {
            display: flex;
            gap: 2px;
            margin-top: 2px;
        }

        .shift-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #4CAF50;
        }

        .shift-dot.warning { background: #ff9800; }
        .shift-dot.danger { background: #f44336; }

        /* „Éê„Ç§„ÉàÂÖàÁÆ°ÁêÜ„Çø„Éñ */
        .workplace-list {
            margin-bottom: 16px;
        }

        .workplace-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .workplace-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .workplace-name {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .workplace-wage {
            color: #4CAF50;
            font-weight: 600;
        }

        .workplace-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-top: 12px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 2px;
        }

        .add-workplace-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .add-workplace-btn:hover {
            transform: translateY(-1px);
        }

        /* AIÂàÜÊûê„Çø„Éñ */
        .ai-upload-area {
            border: 2px dashed #4CAF50;
            border-radius: 12px;
            padding: 32px 16px;
            text-align: center;
            margin-bottom: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .ai-upload-area:hover {
            background: #f8fff8;
            transform: translateY(-2px);
        }

        .upload-icon {
            font-size: 48px;
            color: #4CAF50;
            margin-bottom: 12px;
        }

        .upload-text {
            font-size: 16px;
            color: #333;
            margin-bottom: 8px;
        }

        .upload-subtext {
            font-size: 14px;
            color: #666;
        }

        .ai-analysis-status {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
            display: none;
        }

        .ai-status-text {
            color: #1976d2;
            font-weight: 500;
        }

        /* ÂàÜÊûê„Çø„Éñ */
        .analytics-cards {
            display: grid;
            gap: 16px;
        }

        .analytics-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #333;
        }

        .income-chart {
            height: 120px;
            background: linear-gradient(135deg, #e8f5e8, #c8e6c8);
            border-radius: 8px;
            display: flex;
            align-items: end;
            padding: 8px;
            gap: 4px;
        }

        .chart-bar {
            flex: 1;
            background: #4CAF50;
            border-radius: 2px 2px 0 0;
            opacity: 0.8;
            transition: opacity 0.3s ease;
        }

        .chart-bar:hover {
            opacity: 1;
        }

        .prediction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .prediction-item:last-child {
            border-bottom: none;
        }

        .prediction-label {
            color: #666;
        }

        .prediction-value {
            font-weight: 600;
        }

        .prediction-value.warning {
            color: #ff9800;
        }

        .prediction-value.danger {
            color: #f44336;
        }

        /* „Éú„Éà„É†„Ç∑„Éº„Éà */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .bottom-sheet {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%) translateY(100%);
            width: calc(100% - 16px);
            max-width: min(420px, calc(100vw - 16px));
            background: white;
            border-radius: 20px 20px 0 0;
            z-index: 1000;
            transition: transform 0.3s ease;
            max-height: min(85vh, calc(100vh - env(safe-area-inset-top) - 60px));
            overflow-y: auto;
            
            /* üÜï „Çπ„Éû„Éõ„Åß„ÅÆË¶ãÂàá„ÇåÈò≤Ê≠¢ */
            margin: 0 8px;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
        }

        .bottom-sheet.show {
            transform: translateX(-50%) translateY(0);
        }

        .sheet-handle {
            width: 40px;
            height: 4px;
            background: #ddd;
            border-radius: 2px;
            margin: 12px auto 8px;
        }

        .sheet-content {
            padding: 16px 20px 32px;
        }

        .sheet-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            text-align: center;
        }

        /* „Éï„Ç©„Éº„É† */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }
        
        /* üÜï Êñ∞Ê©üËÉΩÁî®„Çπ„Çø„Ç§„É´ */
        .form-section {
            margin: 24px 0;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 12px;
            border-left: 4px solid #4CAF50;
        }
        
        .section-header {
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .form-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            margin-bottom: 12px;
        }
        
        .form-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #4CAF50;
        }
        
        .checkbox-label {
            font-weight: 500;
            color: #2c3e50;
        }
        
        .bonus-settings {
            margin-left: 26px;
            padding: 12px;
            background: #ffffff;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
        }
        
        .form-input.small, .form-select.small {
            width: 100px;
        }
        
        .input-unit {
            font-size: 14px;
            color: #666;
            font-weight: 500;
        }
        
        .transport-details {
            margin-top: 12px;
            padding: 12px;
            background: #ffffff;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #4CAF50;
        }

        .time-group {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .time-input {
            flex: 1;
        }

        .time-separator {
            font-weight: 600;
            color: #666;
        }

        .earnings-preview {
            background: #f8fff8;
            border: 1px solid #4CAF50;
            border-radius: 8px;
            padding: 16px;
            text-align: center;
            margin-bottom: 20px;
        }

        .preview-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 4px;
        }

        .preview-amount {
            font-size: 24px;
            font-weight: 700;
            color: #4CAF50;
        }

        .button-group {
            display: flex;
            gap: 12px;
        }

        .btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #666;
            border: 1px solid #dee2e6;
        }

        .btn-secondary:hover {
            background: #e9ecef;
        }

        /* „Éá„Çπ„ÇØ„Éà„ÉÉ„ÉóÂêë„Åë„Éú„Çø„É≥„Éª„Éï„Ç©„Éº„É†ÊúÄÈÅ©Âåñ */
        @media (min-width: 768px) {
            .btn {
                min-height: 48px;
                padding: 14px 24px;
                font-size: 16px;
            }
            
            .btn-large {
                min-height: 56px;
                padding: 18px 32px;
                font-size: 18px;
            }
            
            .form-input, .form-select, textarea {
                padding: 14px 16px;
                font-size: 16px;
                min-height: 48px;
            }
            
            .sheet-content {
                padding: 24px;
                max-width: 600px;
                margin: 0 auto;
            }
        }

        /* „É¨„Çπ„Éù„É≥„Ç∑„ÉñÂØæÂøú */
        /* „Çπ„Éû„ÉõÁ∏¶ÁîªÈù¢ÊúÄÈÅ©Âåñ */
        @media (max-width: 480px) {
            .app-container {
                max-width: 100%;
                margin: 0;
                border-radius: 0;
                box-shadow: none;
                min-height: 100vh;
                min-height: calc(100vh - env(safe-area-inset-bottom));
            }
            
            .header {
                padding: 20px 16px 16px;
                padding-top: calc(env(safe-area-inset-top) + 20px);
            }
            
            .header h1 {
                font-size: 20px;
                text-align: center;
            }
            
            .tab-nav {
                min-height: 64px;
                padding: 0 8px;
            }
            
            .tab-content {
                padding: 16px 12px;
                padding-bottom: calc(env(safe-area-inset-bottom) + 80px);
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }

            /* „É¢„Éê„Ç§„É´Âêë„Åë„Éú„Çø„É≥„Çµ„Ç§„Ç∫ÊúÄÈÅ©Âåñ */
            .btn {
                min-height: 52px; /* „Çø„ÉÉ„ÉÅ„Çø„Éº„Ç≤„ÉÉ„Éà„Çµ„Ç§„Ç∫Á£∫‰øù */
                font-size: 16px;
                padding: 16px 20px;
                border-radius: 12px;
            }

            .tab-btn {
                min-height: 52px;
                font-size: 13px;
                padding: 18px 8px;
            }

            .calendar-cell {
                min-height: 52px;
                font-size: 12px;
            }
            
            /* „Éï„Ç©„Éº„É†Ë¶ÅÁ¥†ÊúÄÈÅ©Âåñ */
            input, select, textarea {
                min-height: 48px;
                font-size: 16px; /* iOS zoom prevention */
                padding: 12px 16px;
                border-radius: 8px;
                border: 1px solid #ddd;
                background: #fff;
                -webkit-appearance: none;
                appearance: none;
            }
            
            input:focus, select:focus, textarea:focus {
                outline: none;
                border-color: #4CAF50;
                box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
                transform: none;
            }
        }

        /* Ë∂ÖÂ∞èÁîªÈù¢ÂØæÂøúÔºàiPhone SEÁ≠âÔºâ */
        @media (max-width: 360px) {
            .header h1 {
                font-size: 18px;
            }
            
            .tab-btn {
                font-size: 11px;
                padding: 16px 4px;
                min-height: 48px;
            }
            
            .calendar-cell {
                font-size: 10px;
                min-height: 44px;
            }
            
            .btn {
                min-height: 48px;
                font-size: 14px;
                padding: 14px 16px;
            }
            
            .tab-content {
                padding: 12px 8px;
            }
        }

        /* Ê®™ÁîªÈù¢ÂØæÂøúÔºà„É©„É≥„Éâ„Çπ„Ç±„Éº„Éó„É¢„Éº„ÉâÔºâ */
        @media (orientation: landscape) and (max-height: 500px) {
            .app-container {
                min-height: 100vh;
                display: flex;
                flex-direction: column;
            }
            
            .header {
                padding: 8px 16px;
                flex-shrink: 0;
            }
            
            .header h1 {
                font-size: 16px;
            }
            
            .tab-nav {
                min-height: 48px;
                flex-shrink: 0;
            }
            
            .tab-btn {
                padding: 10px 8px;
                min-height: 40px;
                font-size: 12px;
            }
            
            .tab-content {
                flex: 1;
                overflow-y: auto;
                padding: 12px;
            }
            
            /* „É©„É≥„Éâ„Çπ„Ç±„Éº„Éó„Åß„ÅÆË¶ÅÁ¥†Ë™øÊï¥ */
            .calendar-grid {
                grid-template-rows: repeat(auto-fit, minmax(35px, 1fr));
            }
            
            .calendar-cell {
                min-height: 35px;
                font-size: 11px;
            }
        }

        /* „Çπ„ÇØ„É≠„Éº„É´ÊúÄÈÅ©Âåñ */
        .tab-content {
            overflow-y: auto;
            -webkit-overflow-scrolling: touch; /* iOS „Çπ„É†„Éº„Çπ„Çπ„ÇØ„É≠„Éº„É´ */
            scroll-behavior: smooth;
        }

        /* „Çπ„Éû„ÉõÂêë„Åë„Éï„É≠„Éº„ÉÜ„Ç£„É≥„Ç∞„Ç¢„ÇØ„Ç∑„Éß„É≥„Éú„Çø„É≥ */
        .floating-action-btn {
            position: fixed;
            bottom: calc(env(safe-area-inset-bottom) + 80px);
            right: 20px;
            width: 64px; /* „Çø„ÉÉ„ÉÅ„Åó„ÇÑ„Åô„ÅÑ„Çµ„Ç§„Ç∫„Å´Êã°Â§ß */
            height: 64px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border: none;
            font-size: 28px;
            cursor: pointer;
            box-shadow: 0 6px 16px rgba(76, 175, 80, 0.4);
            z-index: 1000;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            display: none;
            /* „Çπ„Éû„ÉõÂêë„Åë„Çø„ÉÉ„ÉÅÊúÄÈÅ©Âåñ */
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            user-select: none;
        }

        .floating-action-btn.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .floating-action-btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 20px rgba(76, 175, 80, 0.5);
        }

        .floating-action-btn:active {
            transform: translateY(-1px) scale(0.98);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
        }
        
        /* „Éï„Ç°„Éñ„É™„ÉÉ„Éó„É´„Ç®„Éï„Çß„ÇØ„Éà */
        .floating-action-btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.3s, height 0.3s;
            pointer-events: none;
        }
        
        .floating-action-btn:active::after {
            width: 100px;
            height: 100px;
        }

        /* „Çπ„Éû„ÉõÂêë„Åë„Çπ„ÉÜ„Ç£„ÉÉ„Ç≠„Éº„Éú„Çø„É≥„Ç∞„É´„Éº„Éó */
        .sticky-bottom-actions {
            position: sticky;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(255,255,255,1) 80%, rgba(255,255,255,0));
            padding: 16px;
            padding-bottom: calc(env(safe-area-inset-bottom) + 16px);
            margin-top: 20px;
            z-index: 100;
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(0,0,0,0.05);
        }
        
        .sticky-bottom-actions .btn {
            width: 100%;
            justify-content: center;
            margin-bottom: 0;
        }

        /* ÊîπÂñÑ„Åï„Çå„Åü„Éú„Çø„É≥„Çπ„Çø„Ç§„É´ */
        .btn-large {
            padding: 16px 24px;
            font-size: 18px;
            min-height: 56px;
            font-weight: 600;
        }

        .btn-icon {
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-icon::before {
            content: attr(data-icon);
            font-size: 20px;
        }

        /* „Ç´„É¨„É≥„ÉÄ„Éº„Çª„É´ÊîπÂñÑ */
        .calendar-cell {
            min-height: 52px;
            padding: 4px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .calendar-day {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 2px;
        }

        /* „Éú„Éà„É†„Ç∑„Éº„ÉàÊîπÂñÑ */
        .bottom-sheet {
            max-height: 85vh;
        }

        .sheet-content {
            padding: 20px;
            max-height: calc(85vh - 40px);
            overflow-y: auto;
        }

        /* ÂÖ•Âäõ„Éï„Ç£„Éº„É´„ÉâÊîπÂñÑ */
        .form-input, .form-select {
            min-height: 48px;
            font-size: 16px; /* iOS„Ç∫„Éº„É†Èò≤Ê≠¢ */
        }

        /* „É≠„Éº„Éá„Ç£„É≥„Ç∞Áä∂ÊÖã */
        .loading {
            position: relative;
            pointer-events: none;
            opacity: 0.7;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 2px solid #4CAF50;
            border-top: 2px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* „Çπ„ÇØ„É≠„Éº„É´„Éê„ÉºÊîπÂñÑ */
        .tab-content::-webkit-scrollbar {
            width: 4px;
        }

        .tab-content::-webkit-scrollbar-track {
            background: transparent;
        }

        .tab-content::-webkit-scrollbar-thumb {
            background: rgba(76, 175, 80, 0.3);
            border-radius: 2px;
        }

        .tab-content::-webkit-scrollbar-thumb:hover {
            background: rgba(76, 175, 80, 0.5);
        }

        /* „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .fade-in {
            animation: slideUp 0.3s ease-out;
        }


        /* „Ç™„Éï„É©„Ç§„É≥ÈÄöÁü• */
        .offline-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #ff9800;
            color: white;
            padding: 8px 16px;
            text-align: center;
            font-size: 14px;
            z-index: 1002;
            transform: translateY(-100%);
            transition: transform 0.3s ease;
        }

        .offline-banner.show {
            transform: translateY(0);
        }

        /* „Çø„ÉÉ„ÉÅÊìç‰ΩúÊúÄÈÅ©Âåñ */
        .btn, .calendar-cell, .workplace-card, .tab-btn {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            /* „Çπ„Éû„ÉõÂêë„Åë„Éï„Ç©„Éº„Ç´„ÇπÊîπÂñÑ */
            outline: none;
            position: relative;
        }

        .btn:active {
            transform: scale(0.96);
        }
        
        .calendar-cell:active {
            transform: scale(0.98);
            background: rgba(76, 175, 80, 0.1) !important;
        }
        
        .workplace-card:active {
            transform: scale(0.98);
        }
        
        /* „Çø„ÉÉ„ÉÅ„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØÂº∑Âåñ */
        .btn:active::after,
        .tab-btn:active::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, transparent 70%);
            transform: translate(-50%, -50%);
            border-radius: 50%;
            animation: ripple 0.3s ease-out;
            pointer-events: none;
        }
        
        @keyframes ripple {
            0% {
                width: 0;
                height: 0;
                opacity: 1;
            }
            100% {
                width: 200%;
                height: 200%;
                opacity: 0;
            }
        }

        /* „Çπ„ÉØ„Ç§„Éó„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº */
        .swipe-indicator {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .swipe-indicator.show {
            opacity: 1;
        }

        /* ÊåØÂãï„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØÁî®„ÇØ„É©„Çπ */
        /* Âº∑Âåñ„Åï„Çå„Åü„Éè„Éó„ÉÜ„Ç£„ÉÉ„ÇØ„Éª„Éì„Ç∏„É•„Ç¢„É´„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ */
        .haptic-feedback {
            animation: haptic-pulse 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes haptic-pulse {
            0% { 
                transform: scale(1); 
                box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.3);
            }
            50% { 
                transform: scale(0.96); 
                box-shadow: 0 0 0 4px rgba(76, 175, 80, 0.1);
            }
            100% { 
                transform: scale(1); 
                box-shadow: 0 0 0 0 rgba(76, 175, 80, 0);
            }
        }

        /* „Çπ„É†„Éº„Ç∫„Å™„Éö„Éº„Ç∏ÈÅ∑Áßª */
        .tab-content {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .tab-content:not(.active) {
            opacity: 0;
            transform: translateX(10px);
            pointer-events: none;
        }

        .tab-content.active {
            opacity: 1;
            transform: translateX(0);
            pointer-events: auto;
        }

        /* „É≠„Éº„Éá„Ç£„É≥„Ç∞„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Âº∑Âåñ */
        .loading-spinner {
            width: 32px;
            height: 32px;
            border: 3px solid rgba(76, 175, 80, 0.2);
            border-top: 3px solid #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        /* üÜï ÂÖ®ÁîªÈù¢„É≠„Éº„Éá„Ç£„É≥„Ç∞ */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(8px);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .loading-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        
        .loading-text {
            margin-top: 16px;
            color: #666;
            font-size: 14px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* „Ç´„Éº„Éâ„Éõ„Éê„Éº„Ç®„Éï„Çß„ÇØ„Éà */
        .workplace-card, .fuyou-status-card, .income-history-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .workplace-card:hover, .fuyou-status-card:hover, .income-history-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
        }

        /* „Éó„ÉÉ„Ç∑„É•ÈÄöÁü•Ë®±ÂèØ„Éê„Éä„Éº */
        .notification-banner {
            position: fixed;
            top: 60px;
            left: 16px;
            right: 16px;
            background: #2196f3;
            color: white;
            padding: 16px;
            border-radius: 8px;
            z-index: 1001;
            transform: translateY(-120%);
            transition: transform 0.3s ease;
            max-width: 420px;
            margin: 0 auto;
        }

        .notification-banner.show {
            transform: translateY(0);
        }

        .notification-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
        }

        /* „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£ */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .text-success {
            color: #4CAF50;
        }

        .text-warning {
            color: #ff9800;
        }

        .text-danger {
            color: #f44336;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- „Éò„ÉÉ„ÉÄ„Éº -->
        <header class="header">
            <div class="header-top">
                <h1 class="app-title">Êâ∂È§ä„Éó„É≠</h1>
                <button class="settings-btn" onclick="openSettings()">‚öôÔ∏è</button>
            </div>
            <div class="fuyou-status">
                <div class="fuyou-amount" id="fuyouAmount">¬•0</div>
                <div class="fuyou-label" id="fuyouLimitLabel">Âπ¥ÈñìÂèéÂÖ• / <span id="dynamicLimitDisplay">¬•1,230,000</span></div>
                <div class="fuyou-bar">
                    <div class="fuyou-progress" id="fuyouProgress" style="width: 0%"></div>
                </div>
            </div>
        </header>

        <!-- „Çø„Éñ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ -->
        <nav class="tab-nav">
            <button class="tab-btn active" data-tab="calendar" data-icon="üìÖ">„Ç´„É¨„É≥„ÉÄ„Éº</button>
            <button class="tab-btn" data-tab="workplaces" data-icon="üè¢">„Éê„Ç§„ÉàÂÖà</button>
            <button class="tab-btn" data-tab="ai-analysis" data-icon="ü§ñ">AIÂàÜÊûê</button>
            <button class="tab-btn" data-tab="analytics" data-icon="üìä">ÂàÜÊûê</button>
        </nav>

        <!-- „Ç´„É¨„É≥„ÉÄ„Éº„Çø„Éñ -->
        <div class="tab-content active" id="calendar">
            <div class="calendar-month" id="calendarMonth"></div>
            <div class="weekdays">
                <div class="weekday sunday">Êó•</div>
                <div class="weekday">Êúà</div>
                <div class="weekday">ÁÅ´</div>
                <div class="weekday">Ê∞¥</div>
                <div class="weekday">Êú®</div>
                <div class="weekday">Èáë</div>
                <div class="weekday saturday">Âúü</div>
            </div>
            <div class="calendar-grid" id="calendarGrid"></div>
            
            <!-- ‰ªäÊúà„ÅÆÂèéÂÖ•„Çµ„Éû„É™„Éº -->
            <div class="sticky-bottom-actions">
                <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: #666;">‰ªäÊúà„ÅÆÂèéÂÖ•</span>
                        <span style="font-weight: 600; color: #4CAF50;" id="monthlyIncome">¬•0</span>
                    </div>
                </div>
                <button class="btn btn-primary btn-large btn-icon" data-icon="+" onclick="quickAddShift()" style="width: 100%;">
                    ‰ªäÊó•„ÅÆ„Ç∑„Éï„Éà„ÇíËøΩÂä†
                </button>
            </div>
        </div>

        <!-- „Éê„Ç§„ÉàÂÖàÁÆ°ÁêÜ„Çø„Éñ -->
        <div class="tab-content" id="workplaces">
            <div class="workplace-list" id="workplaceList"></div>
            <div class="sticky-bottom-actions">
                <button class="btn btn-primary btn-large btn-icon" data-icon="+" onclick="openAddWorkplace()" style="width: 100%;">
                    Êñ∞„Åó„ÅÑ„Éê„Ç§„ÉàÂÖà„ÇíËøΩÂä†
                </button>
            </div>
        </div>

        <!-- AIÂàÜÊûê„Çø„Éñ -->
        <div class="tab-content" id="ai-analysis">
            <div style="background: #e8f5e8; padding: 16px; border-radius: 8px; border-left: 4px solid #4CAF50; margin-bottom: 20px;">
                <div style="font-weight: 600; margin-bottom: 8px; color: #2e7d32;">
                    ‚úÖ OpenAI GPT-4o Vision Ê∫ñÂÇôÂÆå‰∫Ü
                </div>
                <div style="font-size: 14px; color: #555;">
                    ÂÆüÈöõ„ÅÆAI„Åß„Ç∑„Éï„ÉàË°®ÁîªÂÉè„ÇíËß£Êûê„Åó„Åæ„Åô<br>
                    <small style="color: #777;">Êó•Êú¨Ë™û„ÅÆÊâãÊõ∏„Åç„ÉªÂç∞Âà∑„Ç∑„Éï„ÉàË°®„Å´ÂØæÂøú</small>
                </div>
            </div>
            
            <div class="ai-upload-area" onclick="openImageUpload()">
                <div class="upload-icon">üì∑</div>
                <div class="upload-text">„Ç∑„Éï„ÉàË°®ÁîªÂÉè„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ</div>
                <div class="upload-subtext">OpenAI GPT-4o Vision„ÅßËá™ÂãïËß£Êûê„Åó„Åæ„Åô</div>
            </div>
            <div class="ai-analysis-status" id="aiStatus">
                <div class="ai-status-text">AIÂàÜÊûê‰∏≠...</div>
            </div>
            
            <!-- AIÂàÜÊûêÂ±•Ê≠¥ -->
            <div id="aiHistorySection" style="margin-top: 20px; display: none;">
                <h3 style="margin-bottom: 12px; color: #333;">ÊúÄËøë„ÅÆÂàÜÊûêÂ±•Ê≠¥</h3>
                <div id="aiHistoryList"></div>
            </div>
            
            <div class="sticky-bottom-actions">
                <button class="btn btn-secondary btn-large btn-icon" data-icon="üìÅ" onclick="showAnalysisHistory()" style="width: 100%; margin-bottom: 8px;">
                    ÂàÜÊûêÂ±•Ê≠¥„ÇíË°®Á§∫
                </button>
                <button class="btn btn-primary btn-large btn-icon" data-icon="üì∑" onclick="openImageUpload()" style="width: 100%;">
                    „Ç∑„Éï„ÉàË°®„ÇíÂàÜÊûê
                </button>
            </div>
            
            <input type="file" id="imageInput" accept="image/*" style="display: none;">
        </div>

        <!-- ÂàÜÊûê„Çø„Éñ -->
        <div class="tab-content" id="analytics">
            <!-- „Ç¢„É©„Éº„Éà„Éë„Éç„É´ -->
            <div id="alertsPanel" class="analytics-card" style="margin-bottom: 16px; display: none;">
                <div class="card-title" style="color: #f44336;">‚ö†Ô∏è ÈáçË¶Å„Å™ÈÄöÁü•</div>
                <div id="alertsList"></div>
            </div>

            <div class="analytics-cards">
                <!-- Êâ∂È§ä„Çπ„ÉÜ„Éº„Çø„Çπ„Ç´„Éº„Éâ -->
                <div class="analytics-card">
                    <div class="card-title">üìä Êâ∂È§äÊéßÈô§„Çπ„ÉÜ„Éº„Çø„ÇπÔºà2025Âπ¥Âà∂Â∫¶Ôºâ</div>
                    <div id="fuyouStatusDetail">
                        <div class="prediction-item">
                            <span class="prediction-label">ÈÅ©Áî®Âà∂Â∫¶</span>
                            <span class="prediction-value" id="currentTaxRegime">2025Âπ¥Êñ∞Âà∂Â∫¶</span>
                        </div>
                        <div class="prediction-item">
                            <span class="prediction-label">Âπ¥ÂèéÈôêÂ∫¶È°ç</span>
                            <span class="prediction-value" id="currentDependentLimit">¬•1,500,000</span>
                        </div>
                        <div class="prediction-item">
                            <span class="prediction-label">Êâ∂È§äÊÆã„Çä‰∫àÁÆó</span>
                            <span class="prediction-value" id="remainingBudget">¬•0</span>
                        </div>
                        <div class="prediction-item">
                            <span class="prediction-label">ÂÆâÂÖ®„Éû„Éº„Ç∏„É≥</span>
                            <span class="prediction-value" id="safetyMargin">¬•0</span>
                        </div>
                        <div class="prediction-item">
                            <span class="prediction-label">ÁèæÂú®„ÅÆ„É™„Çπ„ÇØ„É¨„Éô„É´</span>
                            <span class="prediction-value" id="currentRiskLevel">ÂÆâÂÖ®</span>
                        </div>
                        <div class="prediction-item">
                            <span class="prediction-label">üí∞ Âπ¥ÈñìÁØÄÁ®éÂäπÊûú</span>
                            <span class="prediction-value safe" id="taxBenefitAmount">¬•0</span>
                        </div>
                    </div>
                </div>

                <!-- ÂèéÂÖ•‰∫àÊ∏¨„Ç´„Éº„Éâ -->
                <div class="analytics-card">
                    <div class="card-title">Âπ¥Êú´ÂèéÂÖ•‰∫àÊ∏¨</div>
                    <div id="predictions">
                        <div class="prediction-item">
                            <span class="prediction-label">‰øùÂÆàÁöÑ‰∫àÊ∏¨</span>
                            <span class="prediction-value" id="conservativePrediction">¬•0</span>
                        </div>
                        <div class="prediction-item">
                            <span class="prediction-label">ÁèæÂÆüÁöÑ‰∫àÊ∏¨</span>
                            <span class="prediction-value" id="realisticPrediction">¬•0</span>
                        </div>
                        <div class="prediction-item">
                            <span class="prediction-label">Ê•ΩË¶≥ÁöÑ‰∫àÊ∏¨</span>
                            <span class="prediction-value" id="optimisticPrediction">¬•0</span>
                        </div>
                    </div>
                </div>

                <!-- ÊúàÈñìÂèéÂÖ•Êé®Áßª -->
                <div class="analytics-card">
                    <div class="card-title">ÊúàÈñìÂèéÂÖ•Êé®Áßª</div>
                    <div class="income-chart" id="incomeChart"></div>
                </div>

                <!-- ÊúÄÈÅ©ÂåñÊèêÊ°à -->
                <div class="analytics-card" id="optimizationCard">
                    <div class="card-title">üí° ÊúÄÈÅ©ÂåñÊèêÊ°à</div>
                    <div id="optimizationSuggestions">
                        <div style="text-align: center; color: #666; padding: 20px;">
                            ÊúÄÈÅ©ÂåñÊèêÊ°à„ÇíÁîüÊàê‰∏≠...
                        </div>
                    </div>
                </div>

                <!-- Âã§ÂãôÂÖàÂäπÁéáÂàÜÊûê -->
                <div class="analytics-card" id="workplaceEfficiencyCard" style="display: none;">
                    <div class="card-title">Âã§ÂãôÂÖàÂäπÁéáÂàÜÊûê</div>
                    <div id="workplaceEfficiency"></div>
                </div>
            </div>

            <!-- Ë©≥Á¥∞„É¨„Éù„Éº„Éà„Éú„Çø„É≥ -->
            <button class="btn btn-primary" onclick="openDetailedReport()" style="width: 100%; margin-top: 16px;">
                üìä Ë©≥Á¥∞„É¨„Éù„Éº„Éà„ÇíË°®Á§∫
            </button>
        </div>
    </div>


    <!-- „Ç™„Éï„É©„Ç§„É≥ÈÄöÁü•„Éê„Éä„Éº -->
    <div class="offline-banner" id="offlineBanner">
        üì∂ „Ç™„Éï„É©„Ç§„É≥„É¢„Éº„Éâ„ÅßÂãï‰Ωú‰∏≠„Åß„Åô
    </div>

    <!-- „Éó„ÉÉ„Ç∑„É•ÈÄöÁü•Ë®±ÂèØ„Éê„Éä„Éº -->
    <div class="notification-banner" id="notificationBanner">
        <div style="display: flex; align-items: center; gap: 12px;">
            <div style="font-size: 20px;">üîî</div>
            <div style="flex: 1;">
                <div style="font-weight: 600; margin-bottom: 4px;">ÈÄöÁü•„ÇíÊúâÂäπ„Å´„Åô„Çã</div>
                <div style="font-size: 14px; opacity: 0.9;">Êâ∂È§äÈôêÂ∫¶È°ç„ÅÆË≠¶Âëä„Çí„ÅäÁü•„Çâ„Åõ„Åó„Åæ„Åô</div>
            </div>
            <button class="btn btn-primary" onclick="requestNotificationPermission()" style="padding: 8px 16px; font-size: 14px; margin-right: 8px;">
                Ë®±ÂèØ
            </button>
            <button class="notification-close" onclick="dismissNotificationBanner()">‚úï</button>
        </div>
    </div>

    <!-- „Çπ„ÉØ„Ç§„Éó„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº -->
    <div class="swipe-indicator" id="swipeIndicator">
        Â∑¶Âè≥„Å´„Çπ„ÉØ„Ç§„Éó„Åß„Çø„ÉñÂàá„ÇäÊõø„Åà
    </div>

    <!-- „Ç™„Éº„Éê„Éº„É¨„Ç§„Éª„Éú„Éà„É†„Ç∑„Éº„Éà -->
    <div class="overlay" id="overlay"></div>
    <div class="bottom-sheet" id="bottomSheet">
        <div class="sheet-handle"></div>
        <div class="sheet-content" id="sheetContent"></div>
    </div>
    
    <!-- üÜï „É≠„Éº„Éá„Ç£„É≥„Ç∞„Ç™„Éº„Éê„Éº„É¨„Ç§ -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">Âá¶ÁêÜ‰∏≠...</div>
    </div>

    <!-- „Çª„Ç≠„É•„Ç¢Ë®≠ÂÆöË™≠„ÅøËæº„Åø -->
    <script src="secure-config-loader.js"></script>
    <!-- Ë®≠ÂÆö„Éï„Ç°„Ç§„É´ -->
    <script src="config.js"></script>
    <!-- AI Vision Service -->
    <script src="ai-vision-service.js"></script>
    <!-- Gemini Vision Service -->
    <script src="gemini-vision-service.js"></script>
    <!-- Êâ∂È§äÊúÄÈÅ©Âåñ„Ç®„É≥„Ç∏„É≥ -->
    <script src="fuyou-optimization-engine.js"></script>
    <!-- Êà¶Áï•ÁöÑÊ©üËÉΩ„É¢„Ç∏„É•„Éº„É´ -->
    <script src="setup-wizard.js"></script>
    <script src="analytics-tracker.js"></script>
    <script src="backup-manager.js"></script>
    <script src="premium-features.js"></script>
    
    <script>
        // ========== Áä∂ÊÖãÁÆ°ÁêÜ ==========
        let appState = {
            workplaces: JSON.parse(localStorage.getItem('fuyou_workplaces') || '[]'),
            shifts: JSON.parse(localStorage.getItem('fuyou_shifts') || '[]'),
            yearlyIncome: parseInt(localStorage.getItem('fuyou_yearly_income') || '0'),
            currentTab: 'calendar',
            selectedDate: null,
            currentYear: new Date().getFullYear(),
            currentMonth: new Date().getMonth()
        };

        // ========== „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£Èñ¢Êï∞ ==========
        function saveState() {
            localStorage.setItem('fuyou_workplaces', JSON.stringify(appState.workplaces));
            localStorage.setItem('fuyou_shifts', JSON.stringify(appState.shifts));
            localStorage.setItem('fuyou_yearly_income', appState.yearlyIncome.toString());
        }

        function formatCurrency(amount) {
            return `¬•${amount.toLocaleString()}`;
        }

        function formatDate(year, month, day) {
            return `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        }

        function calculateHours(startTime, endTime) {
            const start = new Date(`2000-01-01T${startTime}`);
            const end = new Date(`2000-01-01T${endTime}`);
            return (end - start) / (1000 * 60 * 60);
        }

        function getFuyouRisk() {
            // 2025Âπ¥Á®éÂà∂ÂØæÂøúÔºö„É¶„Éº„Ç∂„Éº„ÅÆÁä∂Ê≥Å„Å´Âøú„Åò„ÅüÈôêÂ∫¶È°ç„Çí‰ΩøÁî®
            const dependentLimit = window.getDependentLimit ? window.getDependentLimit() : 1230000;
            const percentage = (appState.yearlyIncome / dependentLimit) * 100;
            if (percentage >= 95) return { level: 'danger', text: 'Âç±Èô∫' };
            if (percentage >= 90) return { level: 'warning', text: 'Ê≥®ÊÑè' };
            return { level: 'safe', text: 'ÂÆâÂÖ®' };
        }

        // ========== UIÊõ¥Êñ∞Èñ¢Êï∞ ==========
        function updateFuyouStatus() {
            const amount = document.getElementById('fuyouAmount');
            const progress = document.getElementById('fuyouProgress');
            
            // 2025Âπ¥Á®éÂà∂ÂØæÂøúÔºö„É¶„Éº„Ç∂„Éº„ÅÆÁä∂Ê≥Å„Å´Âøú„Åò„ÅüÈôêÂ∫¶È°ç„Çí‰ΩøÁî®
            const dependentLimit = window.getDependentLimit ? window.getDependentLimit() : 1230000;
            
            amount.textContent = formatCurrency(appState.yearlyIncome);
            const percentage = Math.min((appState.yearlyIncome / dependentLimit) * 100, 100);
            progress.style.width = percentage + '%';
            
            // ÂãïÁöÑÈôêÂ∫¶È°çË°®Á§∫„ÇíÊõ¥Êñ∞
            const dynamicLimitDisplay = document.getElementById('dynamicLimitDisplay');
            if (dynamicLimitDisplay) {
                dynamicLimitDisplay.textContent = formatCurrency(dependentLimit);
            }
            
            // „É¶„Éº„Ç∂„Éº„ÅÆÂà∂Â∫¶ÊÉÖÂ†±„ÇíË°®Á§∫
            const userSettings = JSON.parse(localStorage.getItem('fuyou_user_settings') || '{}');
            const studentStatus = userSettings.studentStatus || 'general';
            
            // ÈôêÂ∫¶È°ç„É©„Éô„É´„Å´„É¶„Éº„Ç∂„ÉºÂà∂Â∫¶„ÇíÂèçÊò†
            const fuyouLimitLabel = document.getElementById('fuyouLimitLabel');
            if (fuyouLimitLabel) {
                let labelText = 'Âπ¥ÈñìÂèéÂÖ• / ';
                if (studentStatus === 'student-19-22') {
                    labelText = 'Âπ¥ÈñìÂèéÂÖ• (Â≠¶Áîü„Éª19-22Ê≠≥) / ';
                } else if (studentStatus === 'student-other') {
                    labelText = 'Âπ¥ÈñìÂèéÂÖ• (Â≠¶Áîü) / ';
                } else {
                    labelText = 'Âπ¥ÈñìÂèéÂÖ• (‰∏ÄËà¨) / ';
                }
                fuyouLimitLabel.innerHTML = labelText + `<span id="dynamicLimitDisplay">${formatCurrency(dependentLimit)}</span>`;
            }
        }

        function updateCalendar() {
            const monthElement = document.getElementById('calendarMonth');
            const gridElement = document.getElementById('calendarGrid');
            
            monthElement.textContent = `${appState.currentYear}Âπ¥${appState.currentMonth + 1}Êúà`;
            
            const firstDay = new Date(appState.currentYear, appState.currentMonth, 1).getDay();
            const daysInMonth = new Date(appState.currentYear, appState.currentMonth + 1, 0).getDate();
            const today = new Date();
            
            let html = '';
            
            // ÂâçÊúà„ÅÆÁ©∫ÁôΩ
            for (let i = 0; i < firstDay; i++) {
                html += '<div class="calendar-cell disabled"></div>';
            }
            
            // ÂΩìÊúà„ÅÆÊó•‰ªò
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = formatDate(appState.currentYear, appState.currentMonth, day);
                const dayShifts = appState.shifts.filter(shift => shift.date === dateStr);
                const isToday = today.getFullYear() === appState.currentYear && 
                               today.getMonth() === appState.currentMonth && 
                               today.getDate() === day;
                
                let cellClass = 'calendar-cell';
                if (isToday) cellClass += ' today';
                
                let indicators = '';
                if (dayShifts.length > 0) {
                    const risk = getFuyouRisk();
                    indicators = `<div class="shift-indicators">
                        ${dayShifts.map(() => `<div class="shift-dot ${risk.level}"></div>`).join('')}
                    </div>`;
                }
                
                html += `
                    <div class="${cellClass}" onclick="openDayDetail(${day})">
                        <div class="calendar-day">${day}</div>
                        ${indicators}
                    </div>
                `;
            }
            
            gridElement.innerHTML = html;
            
            // ÊúàÊ¨°ÂèéÂÖ•„ÇíÊõ¥Êñ∞
            updateMonthlyIncomeDisplay();
        }

        function updateMonthlyIncomeDisplay() {
            const monthlyIncomeElement = document.getElementById('monthlyIncome');
            if (monthlyIncomeElement) {
                const monthlyEarnings = calculateMonthlyEarnings();
                monthlyIncomeElement.textContent = formatCurrency(monthlyEarnings);
            }
        }

        function quickAddShift() {
            const today = new Date().getDate();
            appState.selectedDate = formatDate(appState.currentYear, appState.currentMonth, today);
            openAddShift();
        }

        function showAnalysisHistory() {
            const historySection = document.getElementById('aiHistorySection');
            const historyList = document.getElementById('aiHistoryList');
            
            // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Åã„ÇâAIÂàÜÊûêÂ±•Ê≠¥„ÇíÂèñÂæó
            const analysisHistory = JSON.parse(localStorage.getItem('ai_analysis_history') || '[]');
            
            if (analysisHistory.length === 0) {
                historyList.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #666;">
                        <div style="font-size: 48px; margin-bottom: 12px;">üìã</div>
                        <div>ÂàÜÊûêÂ±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>
                        <div style="font-size: 14px; margin-top: 8px;">„Ç∑„Éï„ÉàË°®„ÇíÂàÜÊûê„Åô„Çã„Å®Â±•Ê≠¥„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô</div>
                    </div>
                `;
            } else {
                let html = '';
                analysisHistory.slice(0, 5).forEach((history, index) => {
                    const date = new Date(history.processedAt).toLocaleDateString('ja-JP');
                    const time = new Date(history.processedAt).toLocaleTimeString('ja-JP', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    html += `
                        <div style="border: 1px solid #e9ecef; border-radius: 8px; padding: 12px; margin-bottom: 8px; cursor: pointer;"
                             onclick="viewAnalysisHistory(${index})">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                                <strong>${history.fileName}</strong>
                                <span style="font-size: 12px; color: #666;">${date} ${time}</span>
                            </div>
                            <div style="font-size: 14px; color: #666;">
                                Ê§úÂá∫: ${history.shiftsCount}‰ª∂ | ‰ø°È†ºÂ∫¶: ${Math.round(history.confidence * 100)}%
                            </div>
                        </div>
                    `;
                });
                historyList.innerHTML = html;
            }
            
            historySection.style.display = historySection.style.display === 'none' ? 'block' : 'none';
        }

        function viewAnalysisHistory(index) {
            const analysisHistory = JSON.parse(localStorage.getItem('ai_analysis_history') || '[]');
            const history = analysisHistory[index];
            
            if (history && history.shifts) {
                // ÂàÜÊûêÁµêÊûú„ÇíÂÜçË°®Á§∫
                const content = createAIResultDialog(history.shifts, history.confidence, {
                    ...history,
                    isHistorical: true
                });
                openBottomSheet(content);
            }
        }

        function saveAnalysisHistory(result) {
            const history = JSON.parse(localStorage.getItem('ai_analysis_history') || '[]');
            
            const newEntry = {
                fileName: result.metadata.fileName,
                processedAt: result.metadata.processedAt,
                confidence: result.confidence,
                shiftsCount: result.shifts.length,
                shifts: result.shifts,
                provider: result.metadata.provider || 'Unknown'
            };
            
            history.unshift(newEntry);
            
            // ÊúÄÂ§ß10‰ª∂„Åæ„Åß‰øùÂ≠ò
            if (history.length > 10) {
                history.splice(10);
            }
            
            localStorage.setItem('ai_analysis_history', JSON.stringify(history));
        }

        function updateWorkplaceList() {
            const listElement = document.getElementById('workplaceList');
            
            if (appState.workplaces.length === 0) {
                listElement.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: #666;">
                        <div style="font-size: 48px; margin-bottom: 16px;">üè¢</div>
                        <div>„Åæ„Å†„Éê„Ç§„ÉàÂÖà„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</div>
                        <div style="font-size: 14px; margin-top: 8px;">‰∏ã„ÅÆ„Éú„Çø„É≥„Åã„ÇâËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            appState.workplaces.forEach(workplace => {
                const workplaceShifts = appState.shifts.filter(shift => shift.workplaceId === workplace.id);
                const totalHours = workplaceShifts.reduce((sum, shift) => sum + shift.hours, 0);
                const totalEarnings = workplaceShifts.reduce((sum, shift) => sum + shift.earnings, 0);
                
                // üÜï ÊôÇÁµ¶Â§âÂãïÊÉÖÂ†±„ÅÆÊßãÁØâ
                let wageInfo = `Âü∫Êú¨ ${formatCurrency(workplace.hourlyWage)}`;
                if (workplace.weekendBonus && workplace.weekendBonus > 0) {
                    wageInfo += ` / ÂúüÊó• ${formatCurrency(workplace.hourlyWage + workplace.weekendBonus)}`;
                }
                if (workplace.nightShiftRate && workplace.nightShiftRate > 1) {
                    wageInfo += ` / Ê∑±Â§ú ${formatCurrency(workplace.hourlyWage * workplace.nightShiftRate)}`;
                }
                
                // üÜï ‰∫§ÈÄöË≤ªÊÉÖÂ†±„ÅÆÊßãÁØâ
                let transportInfo = '';
                if (workplace.transportType && workplace.transportType !== 'none') {
                    switch (workplace.transportType) {
                        case 'actual':
                            transportInfo = `ÁâáÈÅì ${formatCurrency(workplace.oneWayFare)}`;
                            break;
                        case 'monthly':
                            transportInfo = `ÂÆöÊúü ${formatCurrency(workplace.monthlyPass)}`;
                            break;
                        case 'daily':
                            transportInfo = `Êó•È°ç ${formatCurrency(workplace.dailyCost)}`;
                            break;
                    }
                }

                html += `
                    <div class="workplace-card">
                        <div class="workplace-header">
                            <div class="workplace-name">${workplace.name}</div>
                            <div class="workplace-wage">ÊôÇÁµ¶: ${wageInfo}</div>
                        </div>
                        ${transportInfo ? `
                            <div class="workplace-transport" style="display: flex; align-items: center; gap: 8px; margin: 8px 0; font-size: 14px; color: #666;">
                                <span class="transport-icon">üöá</span>
                                <span class="transport-text">‰∫§ÈÄöË≤ª: ${transportInfo}</span>
                            </div>
                        ` : ''}
                        <div class="workplace-stats">
                            <div class="stat-item">
                                <div class="stat-value">${totalHours.toFixed(1)}h</div>
                                <div class="stat-label">Á∑èÂä¥ÂÉçÊôÇÈñì</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${formatCurrency(totalEarnings)}</div>
                                <div class="stat-label">Á∑èÂèéÂÖ•</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            listElement.innerHTML = html;
        }

        function updateAnalytics() {
            updateIncomeChart();
            updateAdvancedAnalytics();
        }

        function updateIncomeChart() {
            const chartElement = document.getElementById('incomeChart');
            const months = [];
            const currentDate = new Date();
            
            // ÈÅéÂéª6„É∂Êúà„ÅÆ„Éá„Éº„Çø„ÇíÁîüÊàê
            for (let i = 5; i >= 0; i--) {
                const date = new Date(currentDate.getFullYear(), currentDate.getMonth() - i, 1);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                const monthShifts = appState.shifts.filter(shift => shift.date.startsWith(monthKey));
                const monthEarnings = monthShifts.reduce((sum, shift) => sum + shift.earnings, 0);
                months.push(monthEarnings);
            }
            
            const maxEarnings = Math.max(...months, 50000);
            let html = '';
            
            months.forEach(earnings => {
                const height = (earnings / maxEarnings) * 100;
                html += `<div class="chart-bar" style="height: ${height}%" title="${formatCurrency(earnings)}"></div>`;
            });
            
            chartElement.innerHTML = html;
        }

        function updateAdvancedAnalytics() {
            if (!optimizationEngine) {
                console.warn('ÊúÄÈÅ©Âåñ„Ç®„É≥„Ç∏„É≥„ÅåÂà©Áî®„Åß„Åç„Åæ„Åõ„Çì');
                return;
            }

            try {
                // ÂåÖÊã¨ÁöÑ„Å™„É™„Çπ„ÇØÂàÜÊûê„ÇíÂÆüË°å
                const analysis = optimizationEngine.analyzeRisk(
                    appState.yearlyIncome,
                    appState.shifts,
                    appState.workplaces
                );

                // Êâ∂È§ä„Çπ„ÉÜ„Éº„Çø„ÇπË©≥Á¥∞„ÅÆÊõ¥Êñ∞
                updateFuyouStatusDetail(analysis.current);
                
                // ÂèéÂÖ•‰∫àÊ∏¨„ÅÆÊõ¥Êñ∞
                updatePredictionsAdvanced(analysis.prediction);
                
                // ÊúÄÈÅ©ÂåñÊèêÊ°à„ÅÆÊõ¥Êñ∞
                updateOptimizationSuggestions(analysis.optimization);
                
                // „Ç¢„É©„Éº„Éà„ÅÆÊõ¥Êñ∞
                updateAlerts(analysis.alerts);
                
                // Âã§ÂãôÂÖàÂäπÁéáÂàÜÊûê
                if (appState.workplaces.length > 1) {
                    updateWorkplaceEfficiency();
                }

            } catch (error) {
                console.error('ÂàÜÊûêÊõ¥Êñ∞„Ç®„É©„Éº:', error);
            }
        }

        function updateFuyouStatusDetail(currentStatus) {
            // 2025Âπ¥Á®éÂà∂ÂØæÂøúÔºöÂãïÁöÑ„Å™ÈôêÂ∫¶È°çË®àÁÆó
            const dependentLimit = window.getDependentLimit ? window.getDependentLimit() : 1230000;
            const remaining = Math.max(0, dependentLimit - appState.yearlyIncome);
            
            // „É¶„Éº„Ç∂„ÉºË®≠ÂÆö„Å´Âü∫„Å•„ÅèÂà∂Â∫¶ÊÉÖÂ†±Ë°®Á§∫
            const userSettings = JSON.parse(localStorage.getItem('fuyou_user_settings') || '{}');
            const studentStatus = userSettings.studentStatus || 'general';
            
            // ÈÅ©Áî®Âà∂Â∫¶„ÅÆË°®Á§∫
            let regimeText = '2025Âπ¥Êñ∞Âà∂Â∫¶';
            if (studentStatus === 'student-19-22') {
                regimeText += ' (Â≠¶Áîü„Éª19-22Ê≠≥)';
            } else if (studentStatus === 'student-other') {
                regimeText += ' (Â≠¶Áîü„Éª„Åù„ÅÆ‰ªñÂπ¥ÈΩ¢)';
            } else {
                regimeText += ' (‰∏ÄËà¨)';
            }
            document.getElementById('currentTaxRegime').textContent = regimeText;
            
            // ÈôêÂ∫¶È°çË°®Á§∫
            document.getElementById('currentDependentLimit').textContent = formatCurrency(dependentLimit);
            
            // Âü∫Êú¨ÊÉÖÂ†±Êõ¥Êñ∞
            document.getElementById('remainingBudget').textContent = formatCurrency(remaining);
            document.getElementById('safetyMargin').textContent = formatCurrency(Math.max(0, dependentLimit * 0.8 - appState.yearlyIncome));
            
            const riskElement = document.getElementById('currentRiskLevel');
            const risk = getFuyouRisk();
            riskElement.textContent = risk.text;
            riskElement.className = `prediction-value ${risk.level}`;
            
            // Á®éÂà∂„É°„É™„ÉÉ„ÉàË°®Á§∫Ôºà2025Âπ¥ÂØæÂøúÔºâ
            if (window.calculateTaxBenefit) {
                const benefit = window.calculateTaxBenefit(appState.yearlyIncome);
                const benefitElement = document.getElementById('taxBenefitAmount');
                if (benefitElement) {
                    benefitElement.textContent = formatCurrency(Math.round(benefit.totalBenefit));
                    // „É°„É™„ÉÉ„Éà„ÅÆÂ§ß„Åç„Åï„Å´Âøú„Åò„Å¶Ëâ≤ÂàÜ„Åë
                    if (benefit.totalBenefit > 150000) {
                        benefitElement.className = 'prediction-value safe';
                    } else if (benefit.totalBenefit > 80000) {
                        benefitElement.className = 'prediction-value warning';
                    } else {
                        benefitElement.className = 'prediction-value danger';
                    }
                }
            }
        }

        function updatePredictionsAdvanced(prediction) {
            document.getElementById('conservativePrediction').textContent = formatCurrency(Math.round(prediction.scenarios.conservative));
            document.getElementById('realisticPrediction').textContent = formatCurrency(Math.round(prediction.scenarios.realistic));
            document.getElementById('optimisticPrediction').textContent = formatCurrency(Math.round(prediction.scenarios.optimistic));
            
            // „É™„Çπ„ÇØ„É¨„Éô„É´„Å´Âøú„Åò„ÅüËâ≤ÂàÜ„Åë
            const scenarios = ['conservative', 'realistic', 'optimistic'];
            scenarios.forEach(scenario => {
                const element = document.getElementById(`${scenario}Prediction`);
                const risk = prediction.riskAssessment[scenario];
                element.className = `prediction-value ${getRiskClassFromLevel(risk)}`;
            });
        }

        function updateOptimizationSuggestions(suggestions) {
            const container = document.getElementById('optimizationSuggestions');
            
            if (suggestions.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #4CAF50; padding: 20px;">
                        <div style="font-size: 24px; margin-bottom: 8px;">‚úÖ</div>
                        <div>ÁèæÂú®„ÅÆÂÉç„ÅçÊñπ„ÅØÊúÄÈÅ©„Åß„ÅôÔºÅ</div>
                    </div>
                `;
                return;
            }

            let html = '';
            suggestions.forEach((suggestion, index) => {
                const priorityColor = suggestion.priority === 'high' ? '#f44336' : 
                                    suggestion.priority === 'medium' ? '#ff9800' : '#4CAF50';
                const priorityText = suggestion.priority === 'high' ? 'Á∑äÊÄ•' : 
                                   suggestion.priority === 'medium' ? 'ÈáçË¶Å' : 'Êé®Â•®';

                html += `
                    <div style="border: 1px solid #e9ecef; border-radius: 8px; padding: 16px; margin-bottom: 12px; border-left: 4px solid ${priorityColor};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <strong>${suggestion.title}</strong>
                            <span style="background: ${priorityColor}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px;">
                                ${priorityText}
                            </span>
                        </div>
                        <div style="color: #666; margin-bottom: 12px; font-size: 14px;">
                            ${suggestion.description}
                        </div>
                        ${suggestion.actions.length > 0 ? `
                            <div style="margin-top: 8px;">
                                <strong style="font-size: 14px;">Êé®Â•®„Ç¢„ÇØ„Ç∑„Éß„É≥:</strong>
                                <ul style="margin: 8px 0 0 20px; font-size: 14px;">
                                    ${suggestion.actions.map(action => `<li style="margin-bottom: 4px;">${action.description || action}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        <button class="btn btn-primary" onclick="applySuggestion(${index})" style="padding: 6px 12px; font-size: 14px; margin-top: 8px;">
                            Ë©≥Á¥∞„ÇíË¶ã„Çã
                        </button>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function updateAlerts(alerts) {
            const alertsPanel = document.getElementById('alertsPanel');
            const alertsList = document.getElementById('alertsList');
            
            if (alerts.length === 0) {
                alertsPanel.style.display = 'none';
                return;
            }

            alertsPanel.style.display = 'block';
            
            let html = '';
            alerts.forEach(alert => {
                const alertColor = alert.type === 'critical' ? '#f44336' : 
                                 alert.type === 'warning' ? '#ff9800' : '#2196f3';
                const alertIcon = alert.type === 'critical' ? 'üö®' : 
                                alert.type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';

                html += `
                    <div style="background: ${alertColor}15; border: 1px solid ${alertColor}40; border-radius: 8px; padding: 12px; margin-bottom: 8px;">
                        <div style="display: flex; align-items: center; margin-bottom: 8px;">
                            <span style="margin-right: 8px; font-size: 16px;">${alertIcon}</span>
                            <strong style="color: ${alertColor};">${alert.title}</strong>
                        </div>
                        <div style="color: #333; font-size: 14px; margin-bottom: 8px;">
                            ${alert.message}
                        </div>
                        ${alert.actions.length > 0 ? `
                            <div style="font-size: 12px; color: #666;">
                                Êé®Â•®ÂØæÁ≠ñ: ${alert.actions.join(', ')}
                            </div>
                        ` : ''}
                    </div>
                `;
            });

            alertsList.innerHTML = html;
        }

        function updateWorkplaceEfficiency() {
            const efficiencyCard = document.getElementById('workplaceEfficiencyCard');
            const efficiencyContainer = document.getElementById('workplaceEfficiency');
            
            if (appState.workplaces.length < 2) {
                efficiencyCard.style.display = 'none';
                return;
            }

            efficiencyCard.style.display = 'block';
            
            let html = '';
            const workplaceStats = appState.workplaces.map(workplace => {
                const workplaceShifts = appState.shifts.filter(s => s.workplaceId === workplace.id);
                const totalHours = workplaceShifts.reduce((sum, shift) => sum + shift.hours, 0);
                const totalEarnings = workplaceShifts.reduce((sum, shift) => sum + shift.earnings, 0);
                const avgHoursPerShift = workplaceShifts.length > 0 ? totalHours / workplaceShifts.length : 0;
                
                return {
                    workplace,
                    totalHours,
                    totalEarnings,
                    avgHoursPerShift,
                    efficiency: workplace.hourlyWage,
                    shiftsCount: workplaceShifts.length
                };
            }).sort((a, b) => b.efficiency - a.efficiency);

            workplaceStats.forEach((stats, index) => {
                const isHighest = index === 0;
                const isLowest = index === workplaceStats.length - 1;
                const bgColor = isHighest ? '#e8f5e8' : isLowest ? '#fff3e0' : '#f8f9fa';
                
                html += `
                    <div style="background: ${bgColor}; border-radius: 8px; padding: 12px; margin-bottom: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <strong>${stats.workplace.name}</strong>
                            <span style="color: #4CAF50; font-weight: 600;">
                                ${formatCurrency(stats.efficiency)}/ÊôÇ
                            </span>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; font-size: 12px; color: #666;">
                            <div>
                                <div>Á∑èÊôÇÈñì</div>
                                <div style="color: #333; font-weight: 500;">${stats.totalHours.toFixed(1)}h</div>
                            </div>
                            <div>
                                <div>Á∑èÂèéÂÖ•</div>
                                <div style="color: #333; font-weight: 500;">${formatCurrency(stats.totalEarnings)}</div>
                            </div>
                            <div>
                                <div>„Ç∑„Éï„ÉàÊï∞</div>
                                <div style="color: #333; font-weight: 500;">${stats.shiftsCount}Âõû</div>
                            </div>
                        </div>
                    </div>
                `;
            });

            efficiencyContainer.innerHTML = html;
        }

        function getRiskLevelText(level) {
            switch (level) {
                case 'safe': return 'ÂÆâÂÖ®';
                case 'warning': return 'Ê≥®ÊÑè';
                case 'danger': return 'Âç±Èô∫';
                default: return '‰∏çÊòé';
            }
        }

        function getRiskClassFromLevel(level) {
            switch (level) {
                case 'low': return 'text-success';
                case 'medium': return 'text-warning';
                case 'high': return 'text-danger';
                case 'critical': return 'text-danger';
                default: return '';
            }
        }

        function applySuggestion(index) {
            if (!optimizationEngine) return;
            
            // Ë©≥Á¥∞„Å™ÊèêÊ°àË°®Á§∫ÔºàÂÆüË£Ö‰∫àÂÆöÔºâ
            alert('Ë©≥Á¥∞„Å™ÊèêÊ°àÊ©üËÉΩ„ÅØÈñãÁô∫‰∏≠„Åß„Åô');
        }

        function openDetailedReport() {
            if (!optimizationEngine) {
                alert('ÊúÄÈÅ©Âåñ„Ç®„É≥„Ç∏„É≥„ÅåÂà©Áî®„Åß„Åç„Åæ„Åõ„Çì');
                return;
            }

            try {
                const report = optimizationEngine.generateDetailedReport(
                    appState.yearlyIncome,
                    appState.shifts,
                    appState.workplaces
                );

                const content = createDetailedReportContent(report);
                openBottomSheet(content);
            } catch (error) {
                console.error('„É¨„Éù„Éº„ÉàÁîüÊàê„Ç®„É©„Éº:', error);
                alert('„É¨„Éù„Éº„Éà„ÅÆÁîüÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
        }

        function createDetailedReportContent(report) {
            return `
                <div class="sheet-title">üìä Ë©≥Á¥∞ÂàÜÊûê„É¨„Éù„Éº„Éà</div>
                <div style="max-height: 70vh; overflow-y: auto;">
                    <!-- „Çµ„Éû„É™„Éº -->
                    <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                        <h3 style="margin-bottom: 12px; color: #333;">Ê¶ÇË¶Å</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div>
                                <div style="font-size: 12px; color: #666;">Âπ¥ÈñìÂèéÂÖ•</div>
                                <div style="font-size: 18px; font-weight: 600; color: #333;">
                                    ${formatCurrency(report.summary.totalIncome)}
                                </div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: #666;">ÊÆã„Çä‰∫àÁÆó</div>
                                <div style="font-size: 18px; font-weight: 600; color: #4CAF50;">
                                    ${formatCurrency(report.summary.remainingBudget)}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Êé®Â•®‰∫ãÈ†Ö -->
                    <div style="margin-bottom: 16px;">
                        <h3 style="margin-bottom: 12px; color: #333;">‰∏ªË¶ÅÊé®Â•®‰∫ãÈ†Ö</h3>
                        ${report.recommendations.map(rec => `
                            <div style="border-left: 4px solid #4CAF50; padding: 12px; margin-bottom: 8px; background: #f8fff8;">
                                <div style="font-weight: 600; margin-bottom: 4px;">${rec.title}</div>
                                <div style="font-size: 14px; color: #666;">${rec.description}</div>
                            </div>
                        `).join('')}
                    </div>

                    <!-- Âã§ÂãôÂÖàÂà•Ë©≥Á¥∞ -->
                    <div style="margin-bottom: 16px;">
                        <h3 style="margin-bottom: 12px; color: #333;">Âã§ÂãôÂÖàÂà•ÂàÜÊûê</h3>
                        ${Object.entries(report.detailedBreakdown.byWorkplace).map(([name, data]) => `
                            <div style="border: 1px solid #e9ecef; border-radius: 8px; padding: 12px; margin-bottom: 8px;">
                                <div style="font-weight: 600; margin-bottom: 8px;">${name}</div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 14px;">
                                    <div>Á∑è„Ç∑„Éï„ÉàÊï∞: ${data.totalShifts}Âõû</div>
                                    <div>Á∑èÂä¥ÂÉçÊôÇÈñì: ${data.totalHours.toFixed(1)}ÊôÇÈñì</div>
                                    <div>Á∑èÂèéÂÖ•: ${formatCurrency(data.totalEarnings)}</div>
                                    <div>Âπ≥Âùá„Ç∑„Éï„ÉàÊôÇÈñì: ${data.averageShiftLength.toFixed(1)}ÊôÇÈñì</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    <!-- „Ç¢„ÇØ„Ç∑„Éß„É≥„Éó„É©„É≥ -->
                    <div style="margin-bottom: 16px;">
                        <h3 style="margin-bottom: 12px; color: #333;">„Ç¢„ÇØ„Ç∑„Éß„É≥„Éó„É©„É≥</h3>
                        ${report.actionPlan.immediate.length > 0 ? `
                            <div style="margin-bottom: 12px;">
                                <div style="font-weight: 600; color: #f44336; margin-bottom: 4px;">üö® Âç≥Â∫ß„Å´ÂÆüË°å</div>
                                <ul style="margin-left: 20px;">
                                    ${report.actionPlan.immediate.map(action => `<li style="margin-bottom: 2px;">${action}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        
                        ${report.actionPlan.shortTerm.length > 0 ? `
                            <div style="margin-bottom: 12px;">
                                <div style="font-weight: 600; color: #ff9800; margin-bottom: 4px;">‚è∞ Áü≠ÊúüÂØæÂøú (1-3„É∂Êúà)</div>
                                <ul style="margin-left: 20px;">
                                    ${report.actionPlan.shortTerm.map(action => `<li style="margin-bottom: 2px;">${action}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        
                        ${report.actionPlan.longTerm.length > 0 ? `
                            <div>
                                <div style="font-weight: 600; color: #4CAF50; margin-bottom: 4px;">üìÖ Èï∑ÊúüË®àÁîª (3„É∂Êúà‰ª•‰∏ä)</div>
                                <ul style="margin-left: 20px;">
                                    ${report.actionPlan.longTerm.map(action => `<li style="margin-bottom: 2px;">${action}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                    </div>
                </div>
                <button class="btn btn-secondary" onclick="closeBottomSheet()" style="width: 100%; margin-top: 16px;">
                    Èñâ„Åò„Çã
                </button>
            `;
        }

        // ========== „Çø„ÉñÁÆ°ÁêÜ ==========
        function switchTab(tabName) {
            // „Çø„Éñ„Éú„Çø„É≥„ÅÆÊõ¥Êñ∞
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.tab === tabName) {
                    btn.classList.add('active');
                }
            });
            
            // „Çø„Éñ„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÅÆÊõ¥Êñ∞
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
                if (content.id === tabName) {
                    content.classList.add('active');
                }
            });
            
            appState.currentTab = tabName;
            
            // „Çø„ÉñÂà•„ÅÆÊõ¥Êñ∞Âá¶ÁêÜ
            switch (tabName) {
                case 'calendar':
                    updateCalendar();
                    break;
                case 'workplaces':
                    updateWorkplaceList();
                    break;
                case 'analytics':
                    updateAnalytics();
                    break;
            }
        }

        // ========== „É≠„Éº„Éá„Ç£„É≥„Ç∞ÁÆ°ÁêÜ ==========
        function showLoading(text = 'Âá¶ÁêÜ‰∏≠...') {
            const overlay = document.getElementById('loadingOverlay');
            const textElement = document.getElementById('loadingText');
            
            if (textElement) textElement.textContent = text;
            if (overlay) {
                overlay.classList.add('show');
                document.body.style.overflow = 'hidden';
            }
        }
        
        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.classList.remove('show');
                document.body.style.overflow = '';
            }
        }

        // ========== „Éú„Éà„É†„Ç∑„Éº„ÉàÁÆ°ÁêÜ ==========
        function openBottomSheet(content) {
            document.getElementById('sheetContent').innerHTML = content;
            document.getElementById('overlay').classList.add('show');
            document.getElementById('bottomSheet').classList.add('show');
            
            // üÜï „É¢„Éê„Ç§„É´„Åß„ÅÆ„Éú„Éá„Ç£„Çπ„ÇØ„É≠„Éº„É´Èò≤Ê≠¢
            document.body.style.overflow = 'hidden';
            
            // üÜï Esc„Ç≠„Éº„Åß„ÅÆÈñâ„Åò„ÇãÂá¶ÁêÜ
            document.addEventListener('keydown', handleEscapeKey);
            
            // üÜï „Ç™„Éº„Éê„Éº„É¨„Ç§„ÇØ„É™„ÉÉ„ÇØ„Åß„ÅÆÈñâ„Åò„ÇãÂá¶ÁêÜ
            const overlay = document.getElementById('overlay');
            overlay.addEventListener('click', closeBottomSheet);
            overlay.addEventListener('touchend', closeBottomSheet);
        }
        
        function handleEscapeKey(e) {
            if (e.key === 'Escape') {
                closeBottomSheet();
                document.removeEventListener('keydown', handleEscapeKey);
            }
        }

        function closeBottomSheet() {
            const overlay = document.getElementById('overlay');
            const bottomSheet = document.getElementById('bottomSheet');
            
            if (overlay) overlay.classList.remove('show');
            if (bottomSheet) bottomSheet.classList.remove('show');
            
            // üÜï „É¢„Éê„Ç§„É´„Åß„ÅÆ„Éú„Éá„Ç£„Çπ„ÇØ„É≠„Éº„É´Âæ©ÂÖÉ
            document.body.style.overflow = '';
            
            // üÜï „Éï„Ç©„Éº„Ç´„ÇπÂæ©ÂÖÉ
            if (document.activeElement && document.activeElement.blur) {
                document.activeElement.blur();
            }
            
            // üÜï „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºÂâäÈô§
            document.removeEventListener('keydown', handleEscapeKey);
            const overlay = document.getElementById('overlay');
            if (overlay) {
                overlay.removeEventListener('click', closeBottomSheet);
                overlay.removeEventListener('touchend', closeBottomSheet);
            }
        }

        // ========== ÂêÑÁ®Æ„ÉÄ„Ç§„Ç¢„É≠„Ç∞ ==========
        function openDayDetail(day) {
            appState.selectedDate = formatDate(appState.currentYear, appState.currentMonth, day);
            const dayShifts = appState.shifts.filter(shift => shift.date === appState.selectedDate);
            
            let content = `
                <div class="sheet-title">${appState.currentMonth + 1}Êúà${day}Êó•„ÅÆ„Ç∑„Éï„Éà</div>
            `;
            
            if (dayShifts.length > 0) {
                content += '<div style="margin-bottom: 20px;">';
                dayShifts.forEach(shift => {
                    const workplace = appState.workplaces.find(w => w.id === shift.workplaceId);
                    content += `
                        <div style="padding: 16px; border: 1px solid #e9ecef; border-radius: 8px; margin-bottom: 8px;">
                            <div style="font-weight: 600; margin-bottom: 4px;">${workplace?.name || '‰∏çÊòé'}</div>
                            <div style="color: #666; margin-bottom: 4px;">${shift.startTime} - ${shift.endTime}</div>
                            <div style="color: #4CAF50; font-weight: 600;">${formatCurrency(shift.earnings)}</div>
                        </div>
                    `;
                });
                content += '</div>';
                
                content += `
                    <div class="button-group">
                        <button class="btn btn-primary" onclick="openAddShift()">„Ç∑„Éï„ÉàËøΩÂä†</button>
                        <button class="btn btn-secondary" onclick="closeBottomSheet()">Èñâ„Åò„Çã</button>
                    </div>
                `;
            } else {
                content += `
                    <div style="text-align: center; padding: 20px; color: #666; margin-bottom: 20px;">
                        „Åì„ÅÆÊó•„ÅÆ„Ç∑„Éï„Éà„ÅØ„Åæ„Å†ÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì
                    </div>
                    <div class="button-group">
                        <button class="btn btn-primary" onclick="openAddShift()">„Ç∑„Éï„ÉàËøΩÂä†</button>
                        <button class="btn btn-secondary" onclick="closeBottomSheet()">Èñâ„Åò„Çã</button>
                    </div>
                `;
            }
            
            openBottomSheet(content);
        }

        function openAddShift() {
            if (appState.workplaces.length === 0) {
                alert('ÂÖà„Å´„Éê„Ç§„ÉàÂÖà„ÇíÁôªÈå≤„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                closeBottomSheet();
                switchTab('workplaces');
                return;
            }
            
            let workplaceOptions = '';
            appState.workplaces.forEach(workplace => {
                workplaceOptions += `<option value="${workplace.id}" data-wage="${workplace.hourlyWage}">${workplace.name} (ÊôÇÁµ¶${formatCurrency(workplace.hourlyWage)})</option>`;
            });
            
            const content = `
                <div class="sheet-title">„Ç∑„Éï„ÉàËøΩÂä†</div>
                <form id="shiftForm">
                    <div class="form-group">
                        <label class="form-label">„Éê„Ç§„ÉàÂÖà</label>
                        <select class="form-select" id="workplaceSelect" required onchange="updateShiftPreview()">
                            <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                            ${workplaceOptions}
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ÊôÇÈñì</label>
                        <div class="time-group">
                            <input type="time" class="form-input time-input" id="startTime" value="10:00" required onchange="updateShiftPreview()">
                            <span class="time-separator">„Äú</span>
                            <input type="time" class="form-input time-input" id="endTime" value="18:00" required onchange="updateShiftPreview()">
                        </div>
                    </div>
                    <div class="earnings-preview" id="shiftPreview">
                        <div class="preview-label">‰∫àÊÉ≥ÂèéÂÖ•</div>
                        <div class="preview-amount">¬•0</div>
                    </div>
                    <div class="button-group">
                        <button type="submit" class="btn btn-primary">ËøΩÂä†</button>
                        <button type="button" class="btn btn-secondary" onclick="closeBottomSheet()">„Ç≠„É£„É≥„Çª„É´</button>
                    </div>
                </form>
            `;
            
            openBottomSheet(content);
            
            // „Éï„Ç©„Éº„É†„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
            document.getElementById('shiftForm').addEventListener('submit', handleAddShift);
        }

        function openAddWorkplace() {
            const content = `
                <div class="sheet-title">„Éê„Ç§„ÉàÂÖàËøΩÂä†</div>
                <form id="workplaceForm">
                    <div class="form-group">
                        <label class="form-label">„Éê„Ç§„ÉàÂÖàÂêç</label>
                        <input type="text" class="form-input" id="workplaceName" placeholder="‰æã: „Ç≥„É≥„Éì„Éã‚óã‚óãÂ∫ó" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Âü∫Êú¨ÊôÇÁµ¶</label>
                        <input type="number" class="form-input" id="hourlyWage" placeholder="1000" min="1" required>
                    </div>
                    
                    <!-- üÜï ÊôÇÁµ¶Â§âÂãïË®≠ÂÆö -->
                    <div class="form-section">
                        <label class="form-label section-header">‚è∞ ÊôÇÁµ¶Â§âÂãïË®≠ÂÆö</label>
                        <div class="wage-variation-settings">
                            <div class="form-group">
                                <label class="form-checkbox">
                                    <input type="checkbox" id="weekendBonus" onchange="toggleWageSettings()">
                                    <span class="checkbox-label">ÂúüÊó•Á•ùÊó•„ÅÆÊôÇÁµ¶„Ç¢„ÉÉ„Éó</span>
                                </label>
                                <div class="bonus-settings" id="weekendBonusSettings" style="display: none;">
                                    <input type="number" class="form-input small" id="weekendBonusAmount" placeholder="100" min="0">
                                    <span class="input-unit">ÂÜÜ/ÊôÇÈñì</span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-checkbox">
                                    <input type="checkbox" id="nightBonus" onchange="toggleWageSettings()">
                                    <span class="checkbox-label">Ê∑±Â§úÊôÇÁµ¶Ôºà22ÊôÇ„Äú5ÊôÇÔºâ</span>
                                </label>
                                <div class="bonus-settings" id="nightBonusSettings" style="display: none;">
                                    <select class="form-select small" id="nightBonusType">
                                        <option value="amount">Âõ∫ÂÆöÈ°ç</option>
                                        <option value="percentage">Ââ≤Â¢óÁéá</option>
                                    </select>
                                    <input type="number" class="form-input small" id="nightBonusValue" placeholder="25" min="0">
                                    <span class="input-unit" id="nightBonusUnit">%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- üÜï ‰∫§ÈÄöË≤ªË®≠ÂÆö -->
                    <div class="form-section">
                        <label class="form-label section-header">üöá ‰∫§ÈÄöË≤ªË®≠ÂÆö</label>
                        <div class="transport-settings">
                            <div class="form-group">
                                <label class="form-label">‰∫§ÈÄöË≤ª„Çø„Ç§„Éó</label>
                                <select class="form-select" id="transportType" onchange="toggleTransportSettings()">
                                    <option value="none">„Å™„Åó</option>
                                    <option value="actual">ÂÆüË≤ªÁ≤æÁÆó</option>
                                    <option value="monthly">ÂÆöÊúüÂà∏Ë£úÂä©</option>
                                    <option value="daily">Êó•È°çÊîØÁµ¶</option>
                                </select>
                            </div>
                            <div class="transport-details" id="transportDetails" style="display: none;">
                                <div class="form-group" id="actualCostGroup" style="display: none;">
                                    <label class="form-label">ÁâáÈÅì‰∫§ÈÄöË≤ª</label>
                                    <input type="number" class="form-input" id="oneWayCost" placeholder="200" min="0">
                                    <span class="input-unit">ÂÜÜ</span>
                                </div>
                                <div class="form-group" id="monthlyCostGroup" style="display: none;">
                                    <label class="form-label">ÊúàÈ°çÂÆöÊúü‰ª£</label>
                                    <input type="number" class="form-input" id="monthlyCost" placeholder="8000" min="0">
                                    <span class="input-unit">ÂÜÜ</span>
                                </div>
                                <div class="form-group" id="dailyCostGroup" style="display: none;">
                                    <label class="form-label">Êó•È°ç‰∫§ÈÄöË≤ª</label>
                                    <input type="number" class="form-input" id="dailyCost" placeholder="500" min="0">
                                    <span class="input-unit">ÂÜÜ</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">„É°„É¢Ôºà‰ªªÊÑèÔºâ</label>
                        <input type="text" class="form-input" id="workplaceMemo" placeholder="‰∫§ÈÄöË≤ª„ÄÅÂà∂Êúç„Å™„Å©">
                    </div>
                    <div class="button-group">
                        <button type="submit" class="btn btn-primary">ËøΩÂä†</button>
                        <button type="button" class="btn btn-secondary" onclick="closeBottomSheet()">„Ç≠„É£„É≥„Çª„É´</button>
                    </div>
                </form>
            `;
            
            openBottomSheet(content);
            
            // „Éï„Ç©„Éº„É†„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
            document.getElementById('workplaceForm').addEventListener('submit', handleAddWorkplace);
        }

        function openImageUpload() {
            document.getElementById('imageInput').click();
        }

        function openSettings() {
            const config = window.FUYOU_CONFIG || {};
            const hasAnyAPI = config.api?.openai?.enabled || config.api?.gemini?.enabled;
            
            const content = `
                <div class="sheet-title">‚öôÔ∏è Ë®≠ÂÆö</div>
                
                <!-- AIË®≠ÂÆö -->
                <div style="margin-bottom: 24px;">
                    <h3 style="color: #333; margin-bottom: 12px;">ü§ñ AIÊ©üËÉΩ</h3>
                    <div style="background: #e8f5e8; padding: 16px; border-radius: 8px; border-left: 4px solid #4CAF50;">
                        <div style="font-weight: 600; margin-bottom: 8px; color: #2e7d32;">
                            ‚úÖ OpenAI GPT-4o Vision Âà©Áî®ÂèØËÉΩ
                        </div>
                        <div style="font-size: 14px; color: #555; margin-bottom: 8px;">
                            „Ç∑„Éï„ÉàË°®ÁîªÂÉè„ÇíËá™ÂãïËß£Êûê„Åß„Åç„Åæ„Åô<br>
                            <small style="color: #777;">API„Ç≠„Éº„ÅØ‰∫ãÂâçË®≠ÂÆöÊ∏à„Åø„Åß„Åô</small>
                        </div>
                        <div style="display: flex; align-items: center; font-size: 13px; color: #666;">
                            <span style="color: #4CAF50; margin-right: 8px;">üîµ</span>
                            ÊúÄÊñ∞„ÅÆAIÊäÄË°ì„ÅßÈ´òÁ≤æÂ∫¶Ëß£Êûê
                        </div>
                    </div>
                </div>

                <!-- „Éá„Éº„ÇøÁÆ°ÁêÜ -->
                <div style="margin-bottom: 24px;">
                    <h3 style="color: #333; margin-bottom: 12px;">üìä „Éá„Éº„ÇøÁÆ°ÁêÜ</h3>
                    <button class="btn btn-secondary" onclick="exportData()" style="width: 100%; margin-bottom: 8px;">
                        üì§ „Éá„Éº„Çø„Çí„Ç®„ÇØ„Çπ„Éù„Éº„Éà
                    </button>
                    <button class="btn btn-secondary" onclick="importData()" style="width: 100%; margin-bottom: 8px;">
                        üì• „Éá„Éº„Çø„Çí„Ç§„É≥„Éù„Éº„Éà
                    </button>
                    <button class="btn btn-secondary" onclick="confirmDataReset()" style="width: 100%; margin-bottom: 8px; color: #f44336;">
                        üóëÔ∏è „Éá„Éº„Çø„Çí„É™„Çª„ÉÉ„Éà
                    </button>
                </div>

                <!-- „Ç¢„Éó„É™ÊÉÖÂ†± -->
                <div style="margin-bottom: 24px;">
                    <h3 style="color: #333; margin-bottom: 12px;">‚ÑπÔ∏è „Ç¢„Éó„É™ÊÉÖÂ†±</h3>
                    <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; font-size: 14px; color: #666;">
                        <div><strong>„Éê„Éº„Ç∏„Éß„É≥:</strong> 1.0.0</div>
                        <div><strong>Áí∞Â¢É:</strong> ${config.environment || 'development'}</div>
                        <div><strong>ÊúÄÁµÇÊõ¥Êñ∞:</strong> 2025Âπ¥7Êúà19Êó•</div>
                        <div><strong>ÈñãÁô∫:</strong> Fuyou Pro Team</div>
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn btn-secondary" onclick="closeBottomSheet()" style="width: 100%;">Èñâ„Åò„Çã</button>
                </div>
            `;
            
            openBottomSheet(content);
        }

        function exportData() {
            try {
                const exportData = {
                    version: "1.0.0",
                    exportDate: new Date().toISOString(),
                    data: {
                        shifts: appState.shifts,
                        workplaces: appState.workplaces,
                        yearlyIncome: appState.yearlyIncome,
                        analysisHistory: JSON.parse(localStorage.getItem('ai_analysis_history') || '[]')
                    }
                };
                
                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `fuyou-data-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                alert('„Éá„Éº„Çø„Çí„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åó„Åæ„Åó„Åü');
                closeBottomSheet();
            } catch (error) {
                alert('„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
            }
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const importData = JSON.parse(e.target.result);
                            
                            if (confirm('„Ç§„É≥„Éù„Éº„Éà„Åô„Çã„Å®ÁèæÂú®„ÅÆ„Éá„Éº„Çø„Åå‰∏äÊõ∏„Åç„Åï„Çå„Åæ„Åô„ÄÇÁ∂öË°å„Åó„Åæ„Åô„ÅãÔºü')) {
                                if (importData.data) {
                                    appState.shifts = importData.data.shifts || [];
                                    appState.workplaces = importData.data.workplaces || [];
                                    appState.yearlyIncome = importData.data.yearlyIncome || 0;
                                    
                                    if (importData.data.analysisHistory) {
                                        localStorage.setItem('ai_analysis_history', JSON.stringify(importData.data.analysisHistory));
                                    }
                                    
                                    saveState();
                                    updateCalendar();
                                    updateWorkplaceList();
                                    updateFuyouStatus();
                                    updateAnalytics();
                                    
                                    alert('„Éá„Éº„Çø„Çí„Ç§„É≥„Éù„Éº„Éà„Åó„Åæ„Åó„Åü');
                                    closeBottomSheet();
                                }
                            }
                        } catch (error) {
                            alert('„Ç§„É≥„Éù„Éº„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        function confirmDataReset() {
            if (confirm('„Åô„Åπ„Å¶„ÅÆ„Éá„Éº„Çø„ÇíÂâäÈô§„Åó„Åæ„Åô„ÄÇ„Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„Çì„ÄÇ\nÊú¨ÂΩì„Å´ÂÆüË°å„Åó„Åæ„Åô„ÅãÔºü')) {
                if (confirm('ÊúÄÁµÇÁ¢∫Ë™ç: Êú¨ÂΩì„Å´„Åô„Åπ„Å¶„ÅÆ„Éá„Éº„Çø„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                    localStorage.clear();
                    location.reload();
                }
            }
        }

        // ========== „Éï„Ç©„Éº„É†Âá¶ÁêÜ ==========
        // ========== üÜï ÊôÇÁµ¶Â§âÂãï„Éª‰∫§ÈÄöË≤ªË®≠ÂÆöUIÂà∂Âæ° ==========
        function toggleWageSettings() {
            const weekendBonus = document.getElementById('weekendBonus');
            const weekendSettings = document.getElementById('weekendBonusSettings');
            const nightBonus = document.getElementById('nightBonus');
            const nightSettings = document.getElementById('nightBonusSettings');
            const nightBonusType = document.getElementById('nightBonusType');
            const nightBonusUnit = document.getElementById('nightBonusUnit');
            
            if (weekendSettings) {
                weekendSettings.style.display = weekendBonus.checked ? 'flex' : 'none';
            }
            if (nightSettings) {
                nightSettings.style.display = nightBonus.checked ? 'flex' : 'none';
            }
            
            // Ê∑±Â§úÊôÇÁµ¶„ÅÆÂçò‰ΩçÂàá„ÇäÊõø„Åà
            if (nightBonusType && nightBonusUnit) {
                nightBonusType.addEventListener('change', function() {
                    nightBonusUnit.textContent = this.value === 'percentage' ? '%' : 'ÂÜÜ';
                    document.getElementById('nightBonusValue').placeholder = 
                        this.value === 'percentage' ? '25' : '200';
                });
            }
        }
        
        function toggleTransportSettings() {
            const transportType = document.getElementById('transportType');
            const transportDetails = document.getElementById('transportDetails');
            const actualGroup = document.getElementById('actualCostGroup');
            const monthlyGroup = document.getElementById('monthlyCostGroup');
            const dailyGroup = document.getElementById('dailyCostGroup');
            
            if (transportType && transportDetails) {
                const type = transportType.value;
                transportDetails.style.display = type === 'none' ? 'none' : 'block';
                
                if (actualGroup) actualGroup.style.display = type === 'actual' ? 'block' : 'none';
                if (monthlyGroup) monthlyGroup.style.display = type === 'monthly' ? 'block' : 'none';
                if (dailyGroup) dailyGroup.style.display = type === 'daily' ? 'block' : 'none';
            }
        }
        
        // Êã°Âºµ„Åï„Çå„ÅüÊôÇÁµ¶Ë®àÁÆóÔºàÊõúÊó•Âà•„ÉªÊôÇÈñìÂ∏ØÂà•ÂØæÂøúÔºâ
        function calculateEnhancedWage(workplace, date, startTime, endTime) {
            let totalEarnings = 0;
            const hours = calculateHours(startTime, endTime);
            let baseWage = workplace.hourlyWage;
            
            // Êó•‰ªò„Åã„Çâ„ÅÆÊõúÊó•Âà§ÂÆö
            const dayOfWeek = new Date(date).getDay();
            const isWeekend = dayOfWeek === 0 || dayOfWeek === 6; // Êó•Êõú=0, ÂúüÊõú=6
            
            // ÊôÇÈñì„ÇíÂàÜÂâ≤„Åó„Å¶Ë®àÁÆó
            const start = parseTime(startTime);
            const end = parseTime(endTime);
            
            for (let time = start; time < end; time += 60) { // 1ÊôÇÈñì„Åö„Å§
                let hourlyWage = baseWage;
                const currentHour = Math.floor(time / 60);
                
                // Ê∑±Â§úÊôÇÁµ¶ÈÅ©Áî®Ôºà22ÊôÇ„Äú5ÊôÇÔºâ
                if (workplace.nightBonus && workplace.nightBonusEnabled) {
                    if (currentHour >= 22 || currentHour < 5) {
                        if (workplace.nightBonusType === 'percentage') {
                            hourlyWage += Math.round(baseWage * (workplace.nightBonusValue / 100));
                        } else {
                            hourlyWage += workplace.nightBonusValue;
                        }
                    }
                }
                
                // ÂúüÊó•Á•ùÊó•ÊôÇÁµ¶ÈÅ©Áî®
                if (workplace.weekendBonusEnabled && isWeekend) {
                    hourlyWage += workplace.weekendBonusAmount || 0;
                }
                
                totalEarnings += hourlyWage;
            }
            
            return Math.round(totalEarnings);
        }
        
        // ‰∫§ÈÄöË≤ªË®àÁÆó
        function calculateTransportCost(workplace, date) {
            if (!workplace.transportType || workplace.transportType === 'none') {
                return 0;
            }
            
            switch (workplace.transportType) {
                case 'actual':
                    return (workplace.oneWayCost || 0) * 2; // ÂæÄÂæ©
                case 'daily':
                    return workplace.dailyCost || 0;
                case 'monthly':
                    // ÊúàÈ°çÂÆöÊúü„ÇíÊó•Ââ≤„ÇäË®àÁÆóÔºàÂπ≥Âùá22Êó•Âã§Âãô„Å®„Åó„Å¶Ôºâ
                    return Math.round((workplace.monthlyCost || 0) / 22);
                default:
                    return 0;
            }
        }
        
        function parseTime(timeStr) {
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        }

        function handleAddWorkplace(e) {
            e.preventDefault();
            
            const name = document.getElementById('workplaceName').value;
            const wage = parseInt(document.getElementById('hourlyWage').value);
            const memo = document.getElementById('workplaceMemo').value;
            
            // üÜï Êñ∞Ê©üËÉΩ„Éá„Éº„ÇøÂèéÈõÜ
            const weekendBonusEnabled = document.getElementById('weekendBonus')?.checked || false;
            const weekendBonusAmount = parseInt(document.getElementById('weekendBonusAmount')?.value || '0');
            const nightBonusEnabled = document.getElementById('nightBonus')?.checked || false;
            const nightBonusType = document.getElementById('nightBonusType')?.value || 'percentage';
            const nightBonusValue = parseInt(document.getElementById('nightBonusValue')?.value || '0');
            const transportType = document.getElementById('transportType')?.value || 'none';
            const oneWayCost = parseInt(document.getElementById('oneWayCost')?.value || '0');
            const monthlyCost = parseInt(document.getElementById('monthlyCost')?.value || '0');
            const dailyCost = parseInt(document.getElementById('dailyCost')?.value || '0');
            
            const newWorkplace = {
                id: Date.now(),
                name: name,
                hourlyWage: wage,
                memo: memo,
                createdAt: new Date().toISOString(),
                // üÜï ÊôÇÁµ¶Â§âÂãïË®≠ÂÆö
                weekendBonusEnabled,
                weekendBonusAmount,
                nightBonusEnabled,
                nightBonusType,
                nightBonusValue,
                // üÜï ‰∫§ÈÄöË≤ªË®≠ÂÆö
                transportType,
                oneWayCost,
                monthlyCost,
                dailyCost
            };
            
            appState.workplaces.push(newWorkplace);
            saveState();
            updateWorkplaceList();
            closeBottomSheet();
        }

        function handleAddShift(e) {
            e.preventDefault();
            
            const workplaceId = parseInt(document.getElementById('workplaceSelect').value);
            const startTime = document.getElementById('startTime').value;
            const endTime = document.getElementById('endTime').value;
            
            if (!workplaceId || !startTime || !endTime) {
                alert('„Åô„Åπ„Å¶„ÅÆÈ†ÖÁõÆ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            const workplace = appState.workplaces.find(w => w.id === workplaceId);
            const hours = calculateHours(startTime, endTime);
            
            // üÜï Êã°ÂºµÊôÇÁµ¶Ë®àÁÆóÔºàÊõúÊó•Âà•„ÉªÊôÇÈñìÂ∏ØÂà•ÂØæÂøúÔºâ
            const enhancedWage = calculateEnhancedWage(workplace, appState.selectedDate, startTime, endTime);
            const wageEarnings = Math.round(hours * enhancedWage);
            
            // üÜï ‰∫§ÈÄöË≤ªË®àÁÆó
            const transportCost = calculateTransportCost(workplace, appState.selectedDate);
            const earnings = wageEarnings + transportCost;
            
            const newShift = {
                id: Date.now(),
                date: appState.selectedDate,
                workplaceId: workplaceId,
                startTime: startTime,
                endTime: endTime,
                hours: hours,
                earnings: earnings,
                createdAt: new Date().toISOString()
            };
            
            appState.shifts.push(newShift);
            appState.yearlyIncome += earnings;
            saveState();
            updateCalendar();
            updateFuyouStatus();
            closeBottomSheet();
        }

        function updateShiftPreview() {
            const workplaceSelect = document.getElementById('workplaceSelect');
            const startTime = document.getElementById('startTime').value;
            const endTime = document.getElementById('endTime').value;
            const preview = document.getElementById('shiftPreview');
            
            if (workplaceSelect.value && startTime && endTime) {
                const workplaceId = workplaceSelect.value;
                const workplace = appState.workplaces.find(w => w.id === workplaceId);
                const hours = calculateHours(startTime, endTime);
                
                // üÜï Êã°ÂºµÊôÇÁµ¶Ë®àÁÆóÔºàÊõúÊó•Âà•„ÉªÊôÇÈñìÂ∏ØÂà•ÂØæÂøúÔºâ
                const enhancedWage = calculateEnhancedWage(workplace, appState.selectedDate, startTime, endTime);
                const wageEarnings = Math.round(hours * enhancedWage);
                
                // üÜï ‰∫§ÈÄöË≤ªË®àÁÆó
                const transportCost = calculateTransportCost(workplace, appState.selectedDate);
                const earnings = wageEarnings + transportCost;
                
                // Ë©≥Á¥∞ÂÜÖË®≥Ë°®Á§∫
                let breakdownText = formatCurrency(earnings);
                if (transportCost > 0) {
                    breakdownText += ` (ÊôÇÁµ¶: ${formatCurrency(wageEarnings)} + ‰∫§ÈÄöË≤ª: ${formatCurrency(transportCost)})`;
                } else if (enhancedWage !== workplace.hourlyWage) {
                    breakdownText += ` (ÊôÇÁµ¶: ${formatCurrency(enhancedWage)}/ÊôÇÈñì)`;
                }
                
                preview.querySelector('.preview-amount').textContent = breakdownText;
            } else {
                preview.querySelector('.preview-amount').textContent = '¬•0';
            }
        }

        // ========== ÊúÄÈÅ©Âåñ„Ç®„É≥„Ç∏„É≥ ==========
        let optimizationEngine = null;

        function initializeOptimizationEngine() {
            if (typeof FuyouOptimizationEngine !== 'undefined') {
                optimizationEngine = new FuyouOptimizationEngine();
                console.log('Êâ∂È§äÊúÄÈÅ©Âåñ„Ç®„É≥„Ç∏„É≥„ÇíÂàùÊúüÂåñ„Åó„Åæ„Åó„Åü');
            } else {
                console.error('Êâ∂È§äÊúÄÈÅ©Âåñ„Ç®„É≥„Ç∏„É≥„ÅåË™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
            }
        }

        // ========== AIÁîªÂÉèËß£Êûê ==========
        let aiVisionService = null;

        function initializeAIService() {
            if (typeof AIVisionService !== 'undefined') {
                aiVisionService = new AIVisionService();
                
                // Ë®≠ÂÆö„Åã„ÇâAPI„Ç≠„Éº„ÇíËá™ÂãïË®≠ÂÆö
                const config = window.FUYOU_CONFIG || {};
                if (config.api?.openai?.apiKey) {
                    aiVisionService.apiKey = config.api.openai.apiKey;
                    console.log('OpenAI API„Ç≠„Éº„ÇíË®≠ÂÆö„Åã„ÇâËá™ÂãïË®≠ÂÆö„Åó„Åæ„Åó„Åü');
                }
                
                // Gemini „Çµ„Éº„Éì„Çπ„ÇÇÂàùÊúüÂåñ
                aiVisionService.initializeGeminiService();
                
                // API „Ç≠„Éº„ÅÆË®≠ÂÆöÁä∂Ê≥Å„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                const hasOpenAI = aiVisionService.isAvailable();
                const hasGemini = aiVisionService.geminiService?.isAvailable();
                
                console.log(`AI Service ÂàùÊúüÂåñÂÆå‰∫Ü - OpenAI: ${hasOpenAI ? '‚úì' : '‚úó'}, Gemini: ${hasGemini ? '‚úì' : '‚úó'}`);
                
                if (hasOpenAI || hasGemini) {
                    console.log('AIÂàÜÊûêÊ©üËÉΩ„ÅåÂà©Áî®ÂèØËÉΩ„Åß„Åô');
                } else {
                    console.warn('AI API „Ç≠„Éº„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ„Éá„É¢„É¢„Éº„Éâ„ÅßÂãï‰Ωú„Åó„Åæ„Åô„ÄÇ');
                }
            } else {
                console.error('AI Vision Service „ÅåË™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
            }
        }

        function showAPIKeySetupHint() {
            // „Éó„É≠„ÉÄ„ÇØ„Ç∑„Éß„É≥Áí∞Â¢É„ÅßAPI„Ç≠„ÉºË®≠ÂÆö„ÅÆ„Éí„É≥„Éà„ÇíË°®Á§∫
            if (window.FUYOU_CONFIG?.environment === 'production') {
                setTimeout(() => {
                    const hint = document.createElement('div');
                    hint.innerHTML = `
                        <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 12px; margin: 16px; color: #856404;">
                            <strong>üí° Pro Tip:</strong> AIÂàÜÊûêÊ©üËÉΩ„Çí‰ΩøÁî®„Åô„Çã„Å´„ÅØ„ÄÅË®≠ÂÆö„ÅßAPI„Ç≠„Éº„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
                            <button onclick="openAPISettings()" style="background: #ffc107; border: none; color: white; padding: 4px 8px; border-radius: 4px; margin-left: 8px; cursor: pointer;">
                                Ë®≠ÂÆö
                            </button>
                        </div>
                    `;
                    document.querySelector('.app-container').appendChild(hint);
                    
                    setTimeout(() => {
                        hint.remove();
                    }, 10000);
                }, 3000);
            }
        }

        function openAPISettings() {
            const content = `
                <div class="sheet-title">üîë APIË®≠ÂÆö</div>
                <div style="margin-bottom: 20px;">
                    <p style="color: #666; margin-bottom: 16px;">
                        AIÂàÜÊûêÊ©üËÉΩ„Çí‰ΩøÁî®„Åô„Çã„Å´„ÅØ„ÄÅOpenAI„Åæ„Åü„ÅØGemini„ÅÆAPI„Ç≠„Éº„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ
                    </p>
                    
                    <div class="form-group">
                        <label class="form-label">OpenAI API Key</label>
                        <input type="password" class="form-input" id="openaiKey" placeholder="sk-...">
                        <div style="font-size: 12px; color: #666; margin-top: 4px;">
                            <a href="https://platform.openai.com/api-keys" target="_blank">OpenAI Platform</a>„ÅßAPI„Ç≠„Éº„ÇíÂèñÂæó
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Gemini API Key</label>
                        <input type="password" class="form-input" id="geminiKey" placeholder="AI...">
                        <div style="font-size: 12px; color: #666; margin-top: 4px;">
                            <a href="https://makersuite.google.com/app/apikey" target="_blank">Google AI Studio</a>„ÅßAPI„Ç≠„Éº„ÇíÂèñÂæó
                        </div>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin-bottom: 16px;">
                        <div style="font-size: 14px; color: #666;">
                            <strong>üìã ÊñôÈáë„ÅÆÁõÆÂÆâ:</strong><br>
                            ‚Ä¢ OpenAI: 1Êûö„ÅÇ„Åü„ÇäÁ¥Ñ¬•1-3<br>
                            ‚Ä¢ Gemini: 1Êûö„ÅÇ„Åü„ÇäÁ¥Ñ¬•0.5-1.5<br>
                            ‚Äª ÁîªÂÉè„Çµ„Ç§„Ç∫„Å´„Çà„ÇäÂ§âÂãï
                        </div>
                    </div>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-primary" onclick="saveAPISettings()">‰øùÂ≠ò</button>
                    <button class="btn btn-secondary" onclick="closeBottomSheet()">„Ç≠„É£„É≥„Çª„É´</button>
                </div>
            `;
            
            openBottomSheet(content);
            
            // ÁèæÂú®„ÅÆË®≠ÂÆöÂÄ§„ÇíË™≠„ÅøËæº„Åø
            const config = window.FUYOU_CONFIG || {};
            if (config.api?.openai?.apiKey) {
                document.getElementById('openaiKey').value = config.api.openai.apiKey;
            }
            if (config.api?.gemini?.apiKey) {
                document.getElementById('geminiKey').value = config.api.gemini.apiKey;
            }
        }

        function saveAPISettings() {
            const openaiKey = document.getElementById('openaiKey').value.trim();
            const geminiKey = document.getElementById('geminiKey').value.trim();
            
            const newConfig = {
                api: {
                    openai: {
                        apiKey: openaiKey || null,
                        enabled: !!openaiKey
                    },
                    gemini: {
                        apiKey: geminiKey || null,
                        enabled: !!geminiKey
                    }
                }
            };
            
            if (window.updateConfig) {
                window.updateConfig(newConfig);
                
                // AI„Çµ„Éº„Éì„Çπ„ÇíÂÜçÂàùÊúüÂåñ
                initializeAIService();
                
                closeBottomSheet();
                
                const message = [];
                if (openaiKey) message.push('OpenAI');
                if (geminiKey) message.push('Gemini');
                
                if (message.length > 0) {
                    alert(`${message.join('„Éª')} API„Ç≠„Éº„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü„ÄÇAIÂàÜÊûêÊ©üËÉΩ„ÅåÂà©Áî®ÂèØËÉΩ„Å´„Å™„Çä„Åæ„Åô„ÄÇ`);
                } else {
                    alert('API„Ç≠„Éº„ÅåÂâäÈô§„Åï„Çå„Åæ„Åó„Åü„ÄÇ„Éá„É¢„É¢„Éº„Éâ„ÅßÂãï‰Ωú„Åó„Åæ„Åô„ÄÇ');
                }
            }
        }

        async function handleImageUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            // „Éï„Ç°„Ç§„É´Ê§úË®º
            if (!file.type.startsWith('image/')) {
                alert('ÁîªÂÉè„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            if (file.size > 5 * 1024 * 1024) { // 5MBÂà∂Èôê
                alert('„Éï„Ç°„Ç§„É´„Çµ„Ç§„Ç∫„ÅåÂ§ß„Åç„Åô„Åé„Åæ„ÅôÔºà5MB‰ª•‰∏ã„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºâ');
                return;
            }

            // üÜï „É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫
            showLoading('ÁîªÂÉè„ÇíËß£Êûê‰∏≠...');
            triggerHapticFeedback();
            
            const statusElement = document.getElementById('aiStatus');
            statusElement.style.display = 'block';
            
            try {
                // „Ç≥„Çπ„ÉàË¶ãÁ©ç„ÇÇ„ÇäË°®Á§∫
                if (aiVisionService) {
                    const costEstimate = aiVisionService.estimateCost(file);
                    statusElement.querySelector('.ai-status-text').textContent = 
                        `AIÂàÜÊûê‰∏≠... (‰∫àÊÉ≥„Ç≥„Çπ„Éà: ¬•${costEstimate.estimatedCostJPY})`;
                }

                let result;
                
                if (aiVisionService) {
                    // Ë§áÊï∞„Éó„É≠„Éê„Ç§„ÉÄ„Éº„Åß„ÅÆËß£Êûê„ÇíË©¶Ë°å
                    result = await aiVisionService.analyzeWithMultipleProviders(file);
                } else {
                    // AI Vision Service „ÅåÂà©Áî®„Åß„Åç„Å™„ÅÑÂ†¥Âêà„ÅØÊòéÁ¢∫„Å´„Ç®„É©„Éº„ÇíË°®Á§∫
                    throw new Error('OpenAI API „ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇÂÆüÈöõ„ÅÆ„Ç∑„Éï„ÉàË°®Ëß£Êûê„Å´„ÅØÊúâÂäπ„Å™API„Ç≠„Éº„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ');
                }

                if (result.success && result.shifts.length > 0) {
                    // ÂàÜÊûêÂ±•Ê≠¥„Çí‰øùÂ≠ò
                    saveAnalysisHistory(result);
                    
                    await processAIAnalysisResult(result);
                    statusElement.querySelector('.ai-status-text').textContent = 
                        `ÂàÜÊûêÂÆå‰∫ÜÔºÅ${result.shifts.length}‰ª∂„ÅÆ„Ç∑„Éï„Éà„ÇíÊ§úÂá∫„Åó„Åæ„Åó„Åü`;
                    hideLoading(); // üÜï ÊàêÂäüÊôÇ„Å´„É≠„Éº„Éá„Ç£„É≥„Ç∞ÈùûË°®Á§∫
                } else {
                    statusElement.querySelector('.ai-status-text').textContent = 
                        '„Ç∑„Éï„ÉàÊÉÖÂ†±„ÇíÊ§úÂá∫„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü';
                    
                    setTimeout(() => {
                        statusElement.style.display = 'none';
                    }, 3000);
                    hideLoading(); // üÜï Â§±ÊïóÊôÇ„Å´„ÇÇ„É≠„Éº„Éá„Ç£„É≥„Ç∞ÈùûË°®Á§∫
                }

            } catch (error) {
                console.error('AIÂàÜÊûê„Ç®„É©„Éº:', error);
                statusElement.querySelector('.ai-status-text').textContent = 
                    `„Ç®„É©„Éº: ${error.message}`;
                
                setTimeout(() => {
                    statusElement.style.display = 'none';
                }, 5000);
            } finally {
                // üÜï „É≠„Éº„Éá„Ç£„É≥„Ç∞ÈùûË°®Á§∫
                hideLoading();
            }
        }

        async function processAIAnalysisResult(result) {
            const { shifts, confidence, metadata } = result;
            
            // ÂàÜÊûêÁµêÊûú„ÇíÁ¢∫Ë™çÁî®„ÉÄ„Ç§„Ç¢„É≠„Ç∞„ÅßË°®Á§∫
            const content = createAIResultDialog(shifts, confidence, metadata);
            openBottomSheet(content);
            
            // 3ÁßíÂæå„Å´„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÈùûË°®Á§∫
            setTimeout(() => {
                document.getElementById('aiStatus').style.display = 'none';
            }, 3000);
        }

        function createAIResultDialog(shifts, confidence, metadata) {
            let shiftsHtml = '';
            
            shifts.forEach((shift, index) => {
                const confidenceClass = shift.confidence > 0.8 ? 'text-success' : 
                                       shift.confidence > 0.6 ? 'text-warning' : 'text-danger';
                const reviewBadge = shift.needsReview ? 
                    '<span style="background: #ff9800; color: white; padding: 2px 6px; border-radius: 4px; font-size: 12px; margin-left: 8px;">Ë¶ÅÁ¢∫Ë™ç</span>' : '';
                
                shiftsHtml += `
                    <div style="border: 1px solid #e9ecef; border-radius: 8px; padding: 16px; margin-bottom: 12px; ${shift.needsReview ? 'border-color: #ff9800;' : ''}">
                        <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 8px;">
                            <strong>${shift.date}</strong>
                            <span class="${confidenceClass}" style="font-size: 12px;">
                                ‰ø°È†ºÂ∫¶: ${Math.round(shift.confidence * 100)}%${reviewBadge}
                            </span>
                        </div>
                        <div style="margin-bottom: 4px;">
                            <strong>ÊôÇÈñì:</strong> ${shift.startTime} - ${shift.endTime} (${shift.hours.toFixed(1)}h)
                        </div>
                        <div style="margin-bottom: 4px;">
                            <strong>Âã§ÂãôÂÖà:</strong> ${shift.workplaceName}
                        </div>
                        ${shift.notes ? `<div style="color: #666; font-size: 14px;">${shift.notes}</div>` : ''}
                        <div style="margin-top: 8px;">
                            <button class="btn btn-primary" onclick="approveAIShift(${index})" style="padding: 6px 12px; font-size: 14px; margin-right: 8px;">
                                ÊâøË™ç
                            </button>
                            <button class="btn btn-secondary" onclick="editAIShift(${index})" style="padding: 6px 12px; font-size: 14px;">
                                Á∑®ÈõÜ
                            </button>
                        </div>
                    </div>
                `;
            });

            return `
                <div class="sheet-title">AIÂàÜÊûêÁµêÊûú</div>
                <div style="margin-bottom: 16px;">
                    <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin-bottom: 16px;">
                        <div style="font-size: 14px; color: #666; margin-bottom: 4px;">
                            Ê§úÂá∫‰ª∂Êï∞: ${shifts.length}‰ª∂ | ÂÖ®‰Ωì‰ø°È†ºÂ∫¶: ${Math.round(confidence * 100)}%
                        </div>
                    </div>
                    <div style="max-height: 400px; overflow-y: auto;">
                        ${shiftsHtml}
                    </div>
                </div>
                <div class="button-group">
                    <button class="btn btn-primary" onclick="approveAllAIShifts()">ÂÖ®„Å¶ÊâøË™ç</button>
                    <button class="btn btn-secondary" onclick="closeBottomSheet()">„Ç≠„É£„É≥„Çª„É´</button>
                </div>
            `;
        }

        // AIÂàÜÊûêÁµêÊûú„ÅÆÂá¶ÁêÜÁî®‰∏ÄÊôÇ‰øùÂ≠ò
        let currentAIShifts = [];

        function approveAIShift(index) {
            const shift = currentAIShifts[index];
            addAIShiftToCalendar(shift);
            closeBottomSheet();
        }

        function editAIShift(index) {
            const shift = currentAIShifts[index];
            // Á∑®ÈõÜ„É¢„Éº„Éâ„Åß„Ç∑„Éï„ÉàËøΩÂä†ÁîªÈù¢„ÇíÈñã„Åè
            openEditAIShift(shift);
        }

        function approveAllAIShifts() {
            currentAIShifts.forEach(shift => {
                if (!shift.needsReview || confirm(`„Äå${shift.workplaceName}„Äç„ÅÆ„Ç∑„Éï„Éà (${shift.date}) „ÇíËøΩÂä†„Åó„Åæ„Åô„ÅãÔºü`)) {
                    addAIShiftToCalendar(shift);
                }
            });
            currentAIShifts = [];
            closeBottomSheet();
        }

        function addAIShiftToCalendar(aiShift) {
            // ÂØæÂøú„Åô„ÇãÂã§ÂãôÂÖà„ÇíÊé¢„Åô
            let workplace = appState.workplaces.find(w => 
                w.name.toLowerCase().includes(aiShift.workplaceName.toLowerCase()) ||
                aiShift.workplaceName.toLowerCase().includes(w.name.toLowerCase())
            );

            // Âã§ÂãôÂÖà„ÅåË¶ã„Å§„Åã„Çâ„Å™„ÅÑÂ†¥Âêà„ÅØÊñ∞Ë¶è‰ΩúÊàê„ÇíÊèêÊ°à
            if (!workplace) {
                const shouldCreate = confirm(`Âã§ÂãôÂÖà„Äå${aiShift.workplaceName}„Äç„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ\nÊñ∞Ë¶è‰ΩúÊàê„Åó„Åæ„Åô„ÅãÔºüÔºàÊôÇÁµ¶1000ÂÜÜ„Åß‰ªÆÁôªÈå≤Ôºâ`);
                if (shouldCreate) {
                    workplace = {
                        id: Date.now(),
                        name: aiShift.workplaceName,
                        hourlyWage: 1000,
                        memo: 'AIÂàÜÊûê„Å´„Çà„ÇäËá™Âãï‰ΩúÊàê',
                        createdAt: new Date().toISOString()
                    };
                    appState.workplaces.push(workplace);
                } else {
                    return; // ËøΩÂä†„Çí„Ç≠„É£„É≥„Çª„É´
                }
            }

            // „Ç∑„Éï„Éà„Çí‰ΩúÊàê
            // üÜï Êã°ÂºµÊôÇÁµ¶Ë®àÁÆóÔºàÊõúÊó•Âà•„ÉªÊôÇÈñìÂ∏ØÂà•ÂØæÂøúÔºâ
            const enhancedWage = calculateEnhancedWage(workplace, aiShift.date, aiShift.startTime, aiShift.endTime);
            const wageEarnings = Math.round(aiShift.hours * enhancedWage);
            
            // üÜï ‰∫§ÈÄöË≤ªË®àÁÆó
            const transportCost = calculateTransportCost(workplace, aiShift.date);
            const earnings = wageEarnings + transportCost;
            const newShift = {
                id: Date.now(),
                date: aiShift.date,
                workplaceId: workplace.id,
                startTime: aiShift.startTime,
                endTime: aiShift.endTime,
                hours: aiShift.hours,
                earnings: earnings,
                notes: aiShift.notes || '',
                source: 'ai_analysis',
                confidence: aiShift.confidence,
                createdAt: new Date().toISOString()
            };

            appState.shifts.push(newShift);
            appState.yearlyIncome += earnings;
            
            saveState();
            updateCalendar();
            updateFuyouStatus();
            updateWorkplaceList();
        }

        function openEditAIShift(shift) {
            // AIÊ§úÂá∫„Ç∑„Éï„Éà„ÅÆÁ∑®ÈõÜÁîªÈù¢
            const content = `
                <div class="sheet-title">AIÊ§úÂá∫„Ç∑„Éï„Éà„ÅÆÁ∑®ÈõÜ</div>
                <form id="editAIShiftForm">
                    <div class="form-group">
                        <label class="form-label">Êó•‰ªò</label>
                        <input type="date" class="form-input" id="editDate" value="${shift.date}" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Âã§ÂãôÂÖàÂêç</label>
                        <input type="text" class="form-input" id="editWorkplaceName" value="${shift.workplaceName}" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ÊôÇÈñì</label>
                        <div class="time-group">
                            <input type="time" class="form-input time-input" id="editStartTime" value="${shift.startTime}" required>
                            <span class="time-separator">„Äú</span>
                            <input type="time" class="form-input time-input" id="editEndTime" value="${shift.endTime}" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">„É°„É¢</label>
                        <input type="text" class="form-input" id="editNotes" value="${shift.notes || ''}" placeholder="‰ºëÊÜ©ÊôÇÈñì„Å™„Å©">
                    </div>
                    <div class="button-group">
                        <button type="submit" class="btn btn-primary">Êõ¥Êñ∞„Åó„Å¶ËøΩÂä†</button>
                        <button type="button" class="btn btn-secondary" onclick="closeBottomSheet()">„Ç≠„É£„É≥„Çª„É´</button>
                    </div>
                </form>
            `;
            
            openBottomSheet(content);
            
            // „Éï„Ç©„Éº„É†„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
            document.getElementById('editAIShiftForm').addEventListener('submit', (e) => {
                e.preventDefault();
                
                const updatedShift = {
                    date: document.getElementById('editDate').value,
                    startTime: document.getElementById('editStartTime').value,
                    endTime: document.getElementById('editEndTime').value,
                    workplaceName: document.getElementById('editWorkplaceName').value,
                    notes: document.getElementById('editNotes').value,
                    hours: calculateHours(
                        document.getElementById('editStartTime').value,
                        document.getElementById('editEndTime').value
                    ),
                    confidence: shift.confidence,
                    needsReview: false
                };
                
                addAIShiftToCalendar(updatedShift);
                closeBottomSheet();
            });
        }


        // ========== AIÂàÜÊûêÁµêÊûú‰øùÂ≠òÁî® ==========
        function processAIAnalysisResult(result) {
            const { shifts, confidence, metadata } = result;
            
            // ÂàÜÊûêÁµêÊûú„ÇíÁ¢∫Ë™çÁî®„ÉÄ„Ç§„Ç¢„É≠„Ç∞„ÅßË°®Á§∫
            currentAIShifts = shifts; // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞„Å´‰øùÂ≠ò
            const content = createAIResultDialog(shifts, confidence, metadata);
            openBottomSheet(content);
            
            // 3ÁßíÂæå„Å´„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÈùûË°®Á§∫
            setTimeout(() => {
                document.getElementById('aiStatus').style.display = 'none';
            }, 3000);
        }

        // ========== „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºË®≠ÂÆö ==========
        // „Åì„ÅÆÈñ¢Êï∞„ÅØÈáçË§á„ÅÆ„Åü„ÇÅÂâäÈô§Ôºà„É°„Ç§„É≥ÂàùÊúüÂåñÈñ¢Êï∞„ÅØ‰∏ãÈÉ®„Å´„ÅÇ„Çä„Åæ„ÅôÔºâ

        // ========== PWAÊ©üËÉΩ ==========

        function initializePWA() {
            // Service Worker „ÅÆÁôªÈå≤
            if ('serviceWorker' in navigator) {
                registerServiceWorker();
            }

            // „Éó„ÉÉ„Ç∑„É•ÈÄöÁü•„ÅÆË®±ÂèØÁä∂ÊÖã„ÉÅ„Çß„ÉÉ„ÇØ
            checkNotificationPermission();

            // „Ç™„Éï„É©„Ç§„É≥/„Ç™„É≥„É©„Ç§„É≥Áä∂ÊÖã„ÅÆÁõ£Ë¶ñ
            window.addEventListener('online', handleOnline);
            window.addEventListener('offline', handleOffline);

            // „Çø„ÉÉ„ÉÅÊìç‰Ωú„ÅÆÊúÄÈÅ©Âåñ
            initializeTouchOptimizations();

            // „Çπ„ÉØ„Ç§„Éó„Ç∏„Çß„Çπ„ÉÅ„É£„Éº
            initializeSwipeGestures();
        }

        async function registerServiceWorker() {
            try {
                const registration = await navigator.serviceWorker.register('./sw.js');
                console.log('Service Worker ÁôªÈå≤ÊàêÂäü:', registration);

                // „Ç¢„ÉÉ„Éó„Éá„Éº„ÉàÈÄöÁü•
                registration.addEventListener('updatefound', () => {
                    const newWorker = registration.installing;
                    newWorker.addEventListener('statechange', () => {
                        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                            showUpdateAvailable();
                        }
                    });
                });

                // Service Worker„Å®„ÅÆÈÄö‰ø°Ë®≠ÂÆö
                navigator.serviceWorker.addEventListener('message', (event) => {
                    if (event.data.action === 'get-yearly-income') {
                        event.ports[0].postMessage({ yearlyIncome: appState.yearlyIncome });
                    }
                });

            } catch (error) {
                console.error('Service Worker ÁôªÈå≤Â§±Êïó:', error);
            }
        }


        function checkNotificationPermission() {
            if ('Notification' in window) {
                if (Notification.permission === 'default' && 
                    !localStorage.getItem('notification-banner-dismissed')) {
                    setTimeout(() => {
                        showNotificationBanner();
                    }, 5000); // 5ÁßíÂæå„Å´Ë°®Á§∫
                }
            }
        }

        function showNotificationBanner() {
            const banner = document.getElementById('notificationBanner');
            banner.classList.add('show');
        }

        function dismissNotificationBanner() {
            const banner = document.getElementById('notificationBanner');
            banner.classList.remove('show');
            localStorage.setItem('notification-banner-dismissed', 'true');
        }

        async function requestNotificationPermission() {
            if ('Notification' in window) {
                const permission = await Notification.requestPermission();
                
                if (permission === 'granted') {
                    // „Éó„ÉÉ„Ç∑„É•ÈÄöÁü•„ÅÆÁôªÈå≤
                    await subscribeToPushNotifications();
                    triggerHapticFeedback();
                    alert('ÈÄöÁü•„ÅåÊúâÂäπ„Å´„Å™„Çä„Åæ„Åó„ÅüÔºÅ');
                }
                
                dismissNotificationBanner();
            }
        }

        async function subscribeToPushNotifications() {
            try {
                const registration = await navigator.serviceWorker.ready;
                
                // „Éó„ÉÉ„Ç∑„É•ÈÄöÁü•„ÅÆË≥ºË™≠ÔºàÂÆüÈöõ„ÅÆÂÆüË£Ö„Åß„ÅØ VAPID „Ç≠„Éº„ÅåÂøÖË¶ÅÔºâ
                const subscription = await registration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: 'YOUR_VAPID_PUBLIC_KEY' // ÂÆüÈöõ„ÅÆVAPID„Ç≠„Éº„Å´ÁΩÆ„ÅçÊèõ„Åà
                });
                
                console.log('„Éó„ÉÉ„Ç∑„É•ÈÄöÁü•Ë≥ºË™≠ÊàêÂäü:', subscription);
                
                // „Çµ„Éº„Éê„Éº„Å´Ë≥ºË™≠ÊÉÖÂ†±„ÇíÈÄÅ‰ø°ÔºàÂÆüË£Ö‰∫àÂÆöÔºâ
                // await sendSubscriptionToServer(subscription);
                
            } catch (error) {
                console.error('„Éó„ÉÉ„Ç∑„É•ÈÄöÁü•Ë≥ºË™≠„Ç®„É©„Éº:', error);
            }
        }

        function handleOnline() {
            const banner = document.getElementById('offlineBanner');
            banner.classList.remove('show');
            
            // „Éê„ÉÉ„ÇØ„Ç∞„É©„Ç¶„É≥„ÉâÂêåÊúü„Çí„Éà„É™„Ç¨„Éº
            if ('serviceWorker' in navigator && 'sync' in window.ServiceWorkerRegistration.prototype) {
                navigator.serviceWorker.ready.then((registration) => {
                    return registration.sync.register('background-sync-shifts');
                });
            }
        }

        function handleOffline() {
            const banner = document.getElementById('offlineBanner');
            banner.classList.add('show');
        }

        function showUpdateAvailable() {
            if (confirm('Êñ∞„Åó„ÅÑ„Éê„Éº„Ç∏„Éß„É≥„ÅåÂà©Áî®ÂèØËÉΩ„Åß„Åô„ÄÇÊõ¥Êñ∞„Åó„Åæ„Åô„ÅãÔºü')) {
                navigator.serviceWorker.controller.postMessage({ action: 'skip-waiting' });
                window.location.reload();
            }
        }

        // ========== „Çø„ÉÉ„ÉÅÊúÄÈÅ©Âåñ ==========
        function initializeTouchOptimizations() {
            // Èï∑Êäº„ÅóÈò≤Ê≠¢
            document.addEventListener('contextmenu', (e) => {
                if (e.target.closest('.btn') || e.target.closest('.calendar-cell')) {
                    e.preventDefault();
                }
            });

            // „ÉÄ„Éñ„É´„Çø„ÉÉ„Éó„Ç∫„Éº„É†Èò≤Ê≠¢
            let lastTouchEnd = 0;
            document.addEventListener('touchend', (e) => {
                const now = (new Date()).getTime();
                if (now - lastTouchEnd <= 300) {
                    e.preventDefault();
                }
                lastTouchEnd = now;
            }, false);

            // „Çø„ÉÉ„ÉÅ„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ
            document.addEventListener('touchstart', (e) => {
                if (e.target.closest('.btn') || e.target.closest('.calendar-cell') || 
                    e.target.closest('.tab-btn')) {
                    triggerHapticFeedback();
                }
            });
        }

        function triggerHapticFeedback(element = null) {
            // üÜï ÊîπÂñÑ„Åï„Çå„ÅüÊåØÂãï„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ
            if ('vibrate' in navigator) {
                navigator.vibrate([30]); // „Çà„ÇäËá™ÁÑ∂„Å™ÊåØÂãï
            }
            
            // üÜï ÊîπÂñÑ„Åï„Çå„Åü„Éì„Ç∏„É•„Ç¢„É´„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ
            const targetElement = element || document.activeElement || event?.target;
            if (targetElement && targetElement.classList) {
                targetElement.classList.add('haptic-feedback');
                setTimeout(() => {
                    targetElement.classList.remove('haptic-feedback');
                }, 200);
            }
        }

        // ========== „Çπ„ÉØ„Ç§„Éó„Ç∏„Çß„Çπ„ÉÅ„É£„Éº ==========
        let touchStartX = 0;
        let touchStartY = 0;
        let isSwiping = false;

        function initializeSwipeGestures() {
            const appContainer = document.querySelector('.app-container');
            
            appContainer.addEventListener('touchstart', handleTouchStart, { passive: true });
            appContainer.addEventListener('touchmove', handleTouchMove, { passive: false });
            appContainer.addEventListener('touchend', handleTouchEnd, { passive: true });

            // ÂàùÂõû‰ΩøÁî®ÊôÇ„ÅÆ„Çπ„ÉØ„Ç§„Éó„Ç¨„Ç§„ÉâË°®Á§∫
            if (!localStorage.getItem('swipe-guide-shown')) {
                setTimeout(() => {
                    showSwipeGuide();
                }, 3000);
            }
        }

        function handleTouchStart(e) {
            if (e.target.closest('.bottom-sheet') || e.target.closest('.overlay')) {
                return;
            }
            
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
            isSwiping = false;
        }

        function handleTouchMove(e) {
            if (!touchStartX || !touchStartY) return;

            const touchCurrentX = e.touches[0].clientX;
            const touchCurrentY = e.touches[0].clientY;
            
            const diffX = Math.abs(touchCurrentX - touchStartX);
            const diffY = Math.abs(touchCurrentY - touchStartY);

            // Ê∞¥Âπ≥„Çπ„ÉØ„Ç§„Éó„ÅÆÊ§úÂá∫
            if (diffX > diffY && diffX > 30) {
                isSwiping = true;
                e.preventDefault(); // „Çπ„ÇØ„É≠„Éº„É´„ÇíÈò≤Ê≠¢
            }
        }

        function handleTouchEnd(e) {
            if (!isSwiping || !touchStartX) return;

            const touchEndX = e.changedTouches[0].clientX;
            const diffX = touchStartX - touchEndX;
            const threshold = 80;

            if (Math.abs(diffX) > threshold) {
                const currentTabIndex = getCurrentTabIndex();
                const tabs = ['calendar', 'workplaces', 'ai-analysis', 'analytics'];
                
                let newTabIndex;
                if (diffX > 0) {
                    // Â∑¶„Çπ„ÉØ„Ç§„Éó - Ê¨°„ÅÆ„Çø„Éñ
                    newTabIndex = Math.min(currentTabIndex + 1, tabs.length - 1);
                } else {
                    // Âè≥„Çπ„ÉØ„Ç§„Éó - Ââç„ÅÆ„Çø„Éñ
                    newTabIndex = Math.max(currentTabIndex - 1, 0);
                }

                if (newTabIndex !== currentTabIndex) {
                    switchTab(tabs[newTabIndex]);
                    triggerHapticFeedback();
                }
            }

            touchStartX = 0;
            touchStartY = 0;
            isSwiping = false;
        }

        function getCurrentTabIndex() {
            const tabs = ['calendar', 'workplaces', 'ai-analysis', 'analytics'];
            return tabs.indexOf(appState.currentTab);
        }

        function showSwipeGuide() {
            const indicator = document.getElementById('swipeIndicator');
            indicator.classList.add('show');
            
            setTimeout(() => {
                indicator.classList.remove('show');
                localStorage.setItem('swipe-guide-shown', 'true');
            }, 3000);
        }

        // ========== „É¢„Éê„Ç§„É´ÊúÄÈÅ©Âåñ„É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£ ==========
        function optimizeForMobile() {
            // „Éì„É•„Éº„Éù„Éº„Éà„ÅÆÂãïÁöÑË™øÊï¥
            const viewportMeta = document.querySelector('meta[name="viewport"]');
            if (window.DeviceMotionEvent) {
                viewportMeta.content = 'width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover';
            }

            // SafeAreaÂØæÂøúÔºàiPhone X‰ª•ÈôçÔºâ
            if (CSS.supports('padding: env(safe-area-inset-top)')) {
                document.documentElement.style.setProperty('--safe-area-top', 'env(safe-area-inset-top)');
                document.documentElement.style.setProperty('--safe-area-bottom', 'env(safe-area-inset-bottom)');
            }

            // „Éï„É´„Çπ„ÇØ„É™„Éº„É≥Ë°®Á§∫„ÅÆÊúÄÈÅ©Âåñ
            if (isStandalone) {
                document.body.classList.add('standalone');
            }

            // ÁîªÈù¢„ÅÆÂêë„Åç„É≠„ÉÉ„ÇØÔºàÁ∏¶Âêë„ÅçÂõ∫ÂÆöÔºâ
            if (screen.orientation && screen.orientation.lock) {
                screen.orientation.lock('portrait').catch(() => {
                    console.log('ÁîªÈù¢Âêë„Åç„É≠„ÉÉ„ÇØ„ÅØ„Çµ„Éù„Éº„Éà„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                });
            }
        }

        // ========== „Éê„ÉÉ„ÇØ„Ç∞„É©„Ç¶„É≥„ÉâÂá¶ÁêÜ ==========
        function scheduleBackgroundTasks() {
            // ÂÆöÊúüÁöÑ„Å™Êâ∂È§äÈôêÂ∫¶È°ç„ÉÅ„Çß„ÉÉ„ÇØ
            if ('serviceWorker' in navigator && 'sync' in window.ServiceWorkerRegistration.prototype) {
                navigator.serviceWorker.ready.then((registration) => {
                    // Êó•Ê¨°„ÉÅ„Çß„ÉÉ„ÇØ„ÅÆ„Çπ„Ç±„Ç∏„É•„Éº„É´
                    if ('periodicSync' in registration) {
                        registration.periodicSync.register('fuyou-check', {
                            minInterval: 24 * 60 * 60 * 1000 // 24ÊôÇÈñì
                        }).catch(() => {
                            console.log('ÂÆöÊúüÂêåÊúü„ÅØ„Çµ„Éù„Éº„Éà„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                        });
                    }
                });
            }
        }

        // ========== Êà¶Áï•ÁöÑÊ©üËÉΩÂàùÊúüÂåñ ==========
        function initializeStrategicFeatures() {
            try {
                // „Éó„É¨„Éü„Ç¢„É†Ê©üËÉΩ„ÅÆÂàùÊúüÂåñ
                if (typeof premium !== 'undefined') {
                    console.log('„Éó„É¨„Éü„Ç¢„É†Ê©üËÉΩ„Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñÂÆå‰∫Ü');
                    
                    // „Éó„É¨„Éü„Ç¢„É†„Éê„ÉÉ„Ç∏„ÅÆÂàùÊúüÂåñ
                    if (!document.querySelector('.premium-badge')) {
                        const header = document.querySelector('.header-top');
                        if (header) {
                            const badge = document.createElement('div');
                            badge.className = 'premium-badge';
                            badge.style.cssText = `
                                background: linear-gradient(45deg, #FFD700, #FFA500);
                                color: #333;
                                padding: 4px 8px;
                                border-radius: 12px;
                                font-size: 12px;
                                font-weight: bold;
                                display: none;
                            `;
                            header.appendChild(badge);
                        }
                    }
                }
                
                // „Ç¢„Éä„É™„ÉÜ„Ç£„ÇØ„ÇπÂàùÊúüÂåñ
                if (typeof analytics !== 'undefined') {
                    // ÂàùÂõûË®™ÂïèÊôÇ„Å´„Éó„É©„Ç§„Éê„Ç∑„ÉºÂêåÊÑè„ÇíÊ±Ç„ÇÅ„Çã
                    const consent = localStorage.getItem('analytics_consent');
                    if (consent === null) {
                        setTimeout(() => {
                            analytics.requestConsent();
                        }, 2000);
                    }
                    
                    // „Ç¢„Éó„É™Ëµ∑Âãï„Ç§„Éô„É≥„Éà
                    analytics.trackEvent('app', 'launch', window.location.pathname);
                    console.log('„Ç¢„Éä„É™„ÉÜ„Ç£„ÇØ„Çπ„Éà„É©„ÉÉ„Ç´„ÉºÂàùÊúüÂåñÂÆå‰∫Ü');
                }
                
                // „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Éû„Éç„Éº„Ç∏„É£„ÉºÂàùÊúüÂåñ
                if (typeof backupManager !== 'undefined') {
                    // Ë®≠ÂÆöÁîªÈù¢„Å´„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Éú„Çø„É≥„ÇíËøΩÂä†
                    addBackupButtons();
                    console.log('„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Éû„Éç„Éº„Ç∏„É£„ÉºÂàùÊúüÂåñÂÆå‰∫Ü');
                }
                
                // „Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó„Ç¶„Ç£„Ç∂„Éº„ÉâÂàùÊúüÂåñÔºàÊó¢„Å´Ëá™ÂãïËµ∑ÂãïË®≠ÂÆöÊ∏à„ÅøÔºâ
                if (typeof wizardInstance !== 'undefined') {
                    console.log('„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó„Ç¶„Ç£„Ç∂„Éº„ÉâÂàùÊúüÂåñÂÆå‰∫Ü');
                }
                
                // „Ç´„Çπ„Çø„É†„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºËøΩÂä†
                addStrategicEventListeners();
                
            } catch (error) {
                console.error('Êà¶Áï•ÁöÑÊ©üËÉΩÂàùÊúüÂåñ„Ç®„É©„Éº:', error);
            }
        }
        
        function addBackupButtons() {
            // Ë®≠ÂÆö„Ç®„É™„Ç¢„ÅÆÁâπÂÆöÔºà„Å™„Åë„Çå„Å∞‰ΩúÊàêÔºâ
            let settingsArea = document.querySelector('.settings-area');
            if (!settingsArea) {
                settingsArea = document.createElement('div');
                settingsArea.className = 'settings-area';
                settingsArea.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    right: 20px;
                    display: flex;
                    flex-direction: column;
                    gap: 8px;
                    z-index: 1000;
                `;
                document.body.appendChild(settingsArea);
            }
            
            // „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Éú„Çø„É≥
            const backupBtn = document.createElement('button');
            backupBtn.id = 'backup-btn';
            backupBtn.innerHTML = 'üíæ';
            backupBtn.title = '„Éá„Éº„Çø„Çí„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó';
            backupBtn.style.cssText = `
                width: 48px;
                height: 48px;
                border: none;
                border-radius: 50%;
                background: #4CAF50;
                color: white;
                font-size: 20px;
                cursor: pointer;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                transition: all 0.3s;
            `;
            
            backupBtn.addEventListener('mouseenter', () => {
                backupBtn.style.transform = 'scale(1.1)';
            });
            
            backupBtn.addEventListener('mouseleave', () => {
                backupBtn.style.transform = 'scale(1)';
            });
            
            // Âæ©ÂÖÉÁî®„Éï„Ç°„Ç§„É´ÂÖ•Âäõ
            const restoreInput = document.createElement('input');
            restoreInput.type = 'file';
            restoreInput.id = 'restore-input';
            restoreInput.accept = '.json';
            restoreInput.style.display = 'none';
            
            // „Éó„É¨„Éü„Ç¢„É†„Éú„Çø„É≥„ÅØÂâäÈô§ÔºàÂÆåÂÖ®ÁÑ°Êñô„Ç¢„Éó„É™„ÅÆ„Åü„ÇÅÔºâ
            
            settingsArea.appendChild(backupBtn);
            settingsArea.appendChild(restoreInput);
        }
        
        function addStrategicEventListeners() {
            // AIÊ©üËÉΩ„ÅØÂ∏∏„Å´Âà©Áî®ÂèØËÉΩÔºàÂÆåÂÖ®ÁÑ°Êñô„ÅÆ„Åü„ÇÅÂà∂Èôê„Å™„ÅóÔºâ
            const originalHandleImageUpload = window.handleImageUpload;
            if (originalHandleImageUpload) {
                window.handleImageUpload = function(event) {
                    try {
                        // „Éó„É¨„Éü„Ç¢„É†„ÉÅ„Çß„ÉÉ„ÇØ„ÇíÂâäÈô§ - Â∏∏„Å´Âà©Áî®ÂèØËÉΩ
                        return originalHandleImageUpload.call(this, event);
                    } catch (error) {
                        console.error('AIÊ©üËÉΩ‰ΩøÁî®„Ç®„É©„Éº:', error);
                    }
                };
            }
            
            // „Ç¢„Éä„É™„ÉÜ„Ç£„ÇØ„ÇπËøΩË∑°„ÅÆËøΩÂä†
            document.addEventListener('click', (e) => {
                if (typeof analytics !== 'undefined' && analytics.consentGiven) {
                    const button = e.target.closest('button');
                    if (button && button.dataset.tab) {
                        analytics.trackEvent('navigation', 'tab_click', button.dataset.tab);
                    }
                }
            });
        }

        // ========== „Çπ„Éû„Éõ„Ç≠„Éº„Éú„Éº„ÉâÂØæÂøú ==========
        function initializeKeyboardHandling() {
            let initialViewportHeight = window.innerHeight;
            let isKeyboardOpen = false;
            
            // „Ç≠„Éº„Éú„Éº„ÉâË°®Á§∫/ÈùûË°®Á§∫Ê§úÁü•
            function handleViewportChange() {
                const currentHeight = window.innerHeight;
                const heightDifference = initialViewportHeight - currentHeight;
                
                if (heightDifference > 150) { // „Ç≠„Éº„Éú„Éº„Éâ„ÅåÈñã„ÅÑ„Åü
                    if (!isKeyboardOpen) {
                        isKeyboardOpen = true;
                        document.body.classList.add('keyboard-open');
                        
                        // „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™ÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„ÇíÂèØË¶ñÁØÑÂõ≤„Å´
                        const activeElement = document.activeElement;
                        if (activeElement && (activeElement.tagName === 'INPUT' || activeElement.tagName === 'TEXTAREA')) {
                            setTimeout(() => {
                                activeElement.scrollIntoView({
                                    behavior: 'smooth',
                                    block: 'center'
                                });
                            }, 100);
                        }
                    }
                } else { // „Ç≠„Éº„Éú„Éº„Éâ„ÅåÈñâ„Åò„Åü
                    if (isKeyboardOpen) {
                        isKeyboardOpen = false;
                        document.body.classList.remove('keyboard-open');
                    }
                }
            }
            
            // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºÁôªÈå≤
            window.addEventListener('resize', handleViewportChange);
            window.addEventListener('orientationchange', () => {
                setTimeout(() => {
                    initialViewportHeight = window.innerHeight;
                    handleViewportChange();
                }, 500);
            });
            
            // ÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„Éï„Ç©„Éº„Ç´„ÇπÊôÇ„ÅÆÂá¶ÁêÜ
            document.addEventListener('focusin', (e) => {
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                    // iOS Safari„Åß„ÅÆ„Ç∫„Éº„É†Èò≤Ê≠¢Ôºàfont-size: 16px‰ª•‰∏äÂøÖË¶ÅÔºâ
                    if (parseFloat(getComputedStyle(e.target).fontSize) < 16) {
                        e.target.style.fontSize = '16px';
                    }
                    
                    // „Éï„Ç£„Éº„É´„Éâ„ÅåÁîªÈù¢‰∏ãÈÉ®„Å´Èö†„Çå„ÇãÂ†¥Âêà„ÅÆ„Çπ„ÇØ„É≠„Éº„É´Ë™øÊï¥
                    setTimeout(() => {
                        const rect = e.target.getBoundingClientRect();
                        const keyboardHeight = isKeyboardOpen ? 250 : 0; // Êé®ÂÆö„Ç≠„Éº„Éú„Éº„ÉâÈ´ò„Åï
                        
                        if (rect.bottom > window.innerHeight - keyboardHeight - 50) {
                            e.target.scrollIntoView({
                                behavior: 'smooth',
                                block: 'center'
                            });
                        }
                    }, 300);
                }
            });
            
            // Enter „Ç≠„ÉºÊäº‰∏ãÊôÇ„ÅÆÂá¶ÁêÜ
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && e.target.tagName === 'INPUT') {
                    e.target.blur(); // „Ç≠„Éº„Éú„Éº„Éâ„ÇíÈñâ„Åò„Çã
                }
            });
        }
        
        // „Ç≠„Éº„Éú„Éº„ÉâË°®Á§∫ÊôÇ„ÅÆCSSË™øÊï¥
        const keyboardStyles = document.createElement('style');
        keyboardStyles.textContent = `
            .keyboard-open .app-container {
                height: 100vh;
                overflow: hidden;
            }
            
            .keyboard-open .tab-content {
                max-height: calc(100vh - 200px);
                overflow-y: auto;
            }
            
            .keyboard-open .floating-action-btn {
                display: none !important;
            }
            
            .keyboard-open .sticky-bottom-actions {
                position: relative;
                padding-bottom: 16px;
            }
        `;
        document.head.appendChild(keyboardStyles);

        // ========== „Çø„ÉÉ„ÉÅÂèçÂøúÊÄßÂº∑Âåñ ==========
        function enhanceTouchResponsiveness() {
            console.log('üì± „Çø„ÉÉ„ÉÅÂèçÂøúÊÄß„ÇíÂº∑Âåñ‰∏≠...');
            
            // ÂÖ®„Å¶„ÅÆ„Éú„Çø„É≥„Å´Âç≥Â∫ß„ÅÆË¶ñË¶öÁöÑ„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ„ÇíËøΩÂä†
            document.querySelectorAll('button, .btn, .tab-btn, .card').forEach(element => {
                // „Çø„ÉÉ„ÉÅÈñãÂßãÊôÇ„ÅÆÂç≥Â∫ß„ÅÆ„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ
                element.addEventListener('touchstart', function(e) {
                    this.style.transform = 'scale(0.95)';
                    this.style.transition = 'transform 0.1s ease';
                }, { passive: true });
                
                // „Çø„ÉÉ„ÉÅÁµÇ‰∫ÜÊôÇ„ÅÆÂæ©Â∏∞
                element.addEventListener('touchend', function(e) {
                    this.style.transform = 'scale(1)';
                    // „Éè„Éó„ÉÜ„Ç£„ÉÉ„ÇØ„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØÔºàÂØæÂøú„Éá„Éê„Ç§„Çπ„ÅßÔºâ
                    if (navigator.vibrate) {
                        navigator.vibrate(10);
                    }
                }, { passive: true });
                
                // „Çø„ÉÉ„ÉÅ„Ç≠„É£„É≥„Çª„É´ÊôÇ„ÅÆÂæ©Â∏∞
                element.addEventListener('touchcancel', function(e) {
                    this.style.transform = 'scale(1)';
                }, { passive: true });
            });
            
            // „ÉÄ„Éñ„É´„Çø„ÉÉ„Éó„Ç∫„Éº„É†Èò≤Ê≠¢
            document.addEventListener('touchend', function(e) {
                const now = new Date().getTime();
                const timesince = now - lastTouchEnd;
                if ((timesince < 300) && (timesince > 0)) {
                    e.preventDefault();
                }
                lastTouchEnd = now;
            }, false);
            
            let lastTouchEnd = 0;
        }

        // ========== „Ç∑„Éï„Éà„Éú„Éº„Éâ„É©„Ç§„ÇØUX ==========
        function initializeShiftBoardUX() {
            console.log('üìã „Ç∑„Éï„Éà„Éú„Éº„Éâ„É©„Ç§„ÇØUX„ÇíÂàùÊúüÂåñ‰∏≠...');
            
            // üÜï „Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó„Åß„Ç∑„Éï„ÉàÁßªÂãï
            initializeDragAndDrop();
            
            // üÜï Èï∑Êäº„Åó„Åß„ÇØ„Ç§„ÉÉ„ÇØ„Ç¢„ÇØ„Ç∑„Éß„É≥
            initializeLongPressActions();
            
            // üÜï „Çπ„ÉØ„Ç§„Éó„Ç∏„Çß„Çπ„ÉÅ„É£„ÉºÂº∑Âåñ
            initializeAdvancedSwipeGestures();
            
            // üÜï Âø´ÈÅ©„Å™„Çπ„ÇØ„É≠„Éº„É´
            initializeSmoothScrolling();
            
            // üÜï „Ç§„É≥„Çø„É©„ÇØ„ÉÜ„Ç£„Éñ„Å™„Ç´„É¨„É≥„ÉÄ„Éº
            initializeInteractiveCalendar();
        }

        function initializeDragAndDrop() {
            // „Ç∑„Éï„Éà„Ç´„Éº„Éâ„ÅÆ„Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„ÉóÂÆüË£Ö
            document.querySelectorAll('.shift-card').forEach(card => {
                card.draggable = true;
                
                card.addEventListener('dragstart', function(e) {
                    e.dataTransfer.setData('text/plain', this.dataset.shiftId);
                    this.style.opacity = '0.5';
                });
                
                card.addEventListener('dragend', function(e) {
                    this.style.opacity = '1';
                });
            });
            
            // „Éâ„É≠„ÉÉ„Éó„Ç®„É™„Ç¢„ÅÆË®≠ÂÆö
            document.querySelectorAll('.calendar-day').forEach(day => {
                day.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    this.style.backgroundColor = '#e8f5e8';
                });
                
                day.addEventListener('dragleave', function(e) {
                    this.style.backgroundColor = '';
                });
                
                day.addEventListener('drop', function(e) {
                    e.preventDefault();
                    const shiftId = e.dataTransfer.getData('text/plain');
                    const newDate = this.dataset.date;
                    moveShift(shiftId, newDate);
                    this.style.backgroundColor = '';
                });
            });
        }

        function initializeLongPressActions() {
            let longPressTimer;
            
            document.querySelectorAll('.shift-card, .calendar-day').forEach(element => {
                element.addEventListener('touchstart', function(e) {
                    longPressTimer = setTimeout(() => {
                        // Èï∑Êäº„Åó„Ç¢„ÇØ„Ç∑„Éß„É≥„É°„Éã„É•„Éº„ÇíË°®Á§∫
                        showQuickActionMenu(this, e.touches[0]);
                    }, 500);
                }, { passive: true });
                
                element.addEventListener('touchend', function(e) {
                    clearTimeout(longPressTimer);
                }, { passive: true });
                
                element.addEventListener('touchmove', function(e) {
                    clearTimeout(longPressTimer);
                }, { passive: true });
            });
        }

        function showQuickActionMenu(element, touch) {
            console.log('üì± „ÇØ„Ç§„ÉÉ„ÇØ„Ç¢„ÇØ„Ç∑„Éß„É≥„É°„Éã„É•„ÉºË°®Á§∫');
            // „Éè„Éó„ÉÜ„Ç£„ÉÉ„ÇØ„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ
            if (navigator.vibrate) {
                navigator.vibrate([10, 50, 10]);
            }
            
            // „É°„Éã„É•„ÉºUIÂÆüË£ÖÔºàÂæå„ÅßË©≥Á¥∞ÂÆüË£ÖÔºâ
            const menu = document.createElement('div');
            menu.className = 'quick-action-menu';
            menu.style.cssText = `
                position: fixed;
                top: ${touch.clientY}px;
                left: ${touch.clientX}px;
                background: white;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 9999;
                padding: 8px;
            `;
            
            const actions = ['Á∑®ÈõÜ', 'ÂâäÈô§', '„Ç≥„Éî„Éº', 'Ë©≥Á¥∞'];
            actions.forEach(action => {
                const btn = document.createElement('button');
                btn.textContent = action;
                btn.style.cssText = 'display: block; width: 100%; padding: 8px; margin: 2px 0; border: none; background: #f5f5f5;';
                menu.appendChild(btn);
            });
            
            document.body.appendChild(menu);
            
            // 3ÁßíÂæå„Å´Ëá™ÂãïÂâäÈô§
            setTimeout(() => {
                if (menu.parentNode) {
                    menu.parentNode.removeChild(menu);
                }
            }, 3000);
        }

        function initializeAdvancedSwipeGestures() {
            let startX, startY, currentX, currentY;
            
            document.addEventListener('touchstart', function(e) {
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
            }, { passive: true });
            
            document.addEventListener('touchmove', function(e) {
                if (!startX || !startY) return;
                
                currentX = e.touches[0].clientX;
                currentY = e.touches[0].clientY;
                
                const diffX = startX - currentX;
                const diffY = startY - currentY;
                
                // Ê∞¥Âπ≥„Çπ„ÉØ„Ç§„Éó„Åß„Çø„ÉñÂàá„ÇäÊõø„Åà
                if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) {
                    if (diffX > 0) {
                        // Â∑¶„Çπ„ÉØ„Ç§„ÉóÔºöÊ¨°„ÅÆ„Çø„Éñ
                        switchToNextTab();
                    } else {
                        // Âè≥„Çπ„ÉØ„Ç§„ÉóÔºöÂâç„ÅÆ„Çø„Éñ
                        switchToPreviousTab();
                    }
                    startX = startY = null;
                }
            }, { passive: true });
        }

        function initializeSmoothScrolling() {
            // iOSÈ¢®„ÅÆÊªë„Çâ„Åã„Å™„Çπ„ÇØ„É≠„Éº„É´
            document.querySelectorAll('.tab-content, .calendar-container').forEach(element => {
                element.style.cssText += `
                    -webkit-overflow-scrolling: touch;
                    scroll-behavior: smooth;
                `;
            });
        }

        function initializeInteractiveCalendar() {
            // „Ç´„É¨„É≥„ÉÄ„Éº„ÅÆÊó•‰ªò„Çª„É´„Çí„Çà„Çä„Ç§„É≥„Çø„É©„ÇØ„ÉÜ„Ç£„Éñ„Å´
            document.querySelectorAll('.calendar-day').forEach(day => {
                // „Éõ„Éê„ÉºÂäπÊûúÔºàPCÔºâ
                day.addEventListener('mouseenter', function() {
                    if (!this.classList.contains('other-month')) {
                        this.style.backgroundColor = '#f0f8ff';
                    }
                });
                
                day.addEventListener('mouseleave', function() {
                    if (!this.classList.contains('selected')) {
                        this.style.backgroundColor = '';
                    }
                });
                
                // „Çø„ÉÉ„ÉóÂäπÊûúÔºà„É¢„Éê„Ç§„É´Ôºâ
                day.addEventListener('touchstart', function() {
                    if (!this.classList.contains('other-month')) {
                        this.style.backgroundColor = '#e3f2fd';
                    }
                }, { passive: true });
            });
        }

        function initializeEnhancedNavigation() {
            console.log('üß≠ Âº∑Âåñ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥„ÇíÂàùÊúüÂåñ‰∏≠...');
            
            document.querySelectorAll('.tab-btn').forEach((btn, index) => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Âç≥Â∫ß„ÅÆË¶ñË¶öÁöÑ„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ
                    this.style.transform = 'scale(0.95)';
                    setTimeout(() => {
                        this.style.transform = 'scale(1)';
                    }, 100);
                    
                    // „Éè„Éó„ÉÜ„Ç£„ÉÉ„ÇØ„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ
                    if (navigator.vibrate) {
                        navigator.vibrate(5);
                    }
                    
                    // „Çø„ÉñÂàá„ÇäÊõø„ÅàÂÆüË°å
                    const tabName = this.dataset.tab;
                    if (tabName) {
                        switchTab(tabName);
                    }
                });
                
                // „Ç≠„Éº„Éú„Éº„Éâ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ÂØæÂøú
                btn.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        this.click();
                    }
                });
            });
        }

        // ========== ËøΩÂä†„ÅÆ„Éò„É´„Éë„ÉºÈñ¢Êï∞ ==========
        function switchToNextTab() {
            const tabs = ['calendar', 'ai-analysis', 'analytics', 'settings'];
            const currentIndex = tabs.indexOf(appState.currentTab);
            const nextIndex = (currentIndex + 1) % tabs.length;
            switchTab(tabs[nextIndex]);
        }

        function switchToPreviousTab() {
            const tabs = ['calendar', 'ai-analysis', 'analytics', 'settings'];
            const currentIndex = tabs.indexOf(appState.currentTab);
            const prevIndex = (currentIndex - 1 + tabs.length) % tabs.length;
            switchTab(tabs[prevIndex]);
        }

        function moveShift(shiftId, newDate) {
            console.log(`üìÖ „Ç∑„Éï„ÉàÁßªÂãï: ${shiftId} ‚Üí ${newDate}`);
            
            // „Ç∑„Éï„Éà„ÇíÊñ∞„Åó„ÅÑÊó•‰ªò„Å´ÁßªÂãï
            const shift = appState.shifts.find(s => s.id === shiftId);
            if (shift) {
                shift.date = newDate;
                saveState();
                updateCalendar();
                
                // ÊàêÂäü„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ
                showToast('‚úÖ „Ç∑„Éï„Éà„ÇíÁßªÂãï„Åó„Åæ„Åó„Åü', 'success');
                
                // „Éè„Éó„ÉÜ„Ç£„ÉÉ„ÇØ„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ
                if (navigator.vibrate) {
                    navigator.vibrate([10, 50, 10]);
                }
            }
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : '#2196F3'};
                color: white;
                padding: 12px 24px;
                border-radius: 24px;
                z-index: 10000;
                font-size: 14px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                animation: slideInFromTop 0.3s ease;
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOutToTop 0.3s ease forwards';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 2000);
        }

        // ========== „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥CSS ==========
        const animationStyles = document.createElement('style');
        animationStyles.textContent = `
            @keyframes slideInFromTop {
                from { transform: translate(-50%, -100%); opacity: 0; }
                to { transform: translate(-50%, 0); opacity: 1; }
            }
            
            @keyframes slideOutToTop {
                from { transform: translate(-50%, 0); opacity: 1; }
                to { transform: translate(-50%, -100%); opacity: 0; }
            }
            
            .quick-action-menu {
                animation: fadeInScale 0.2s ease;
            }
            
            @keyframes fadeInScale {
                from { transform: scale(0.8); opacity: 0; }
                to { transform: scale(1); opacity: 1; }
            }
            
            /* „Ç∑„Éï„Éà„Éú„Éº„Éâ„É©„Ç§„ÇØ„Å™„Éõ„Éê„ÉºÂäπÊûú */
            .calendar-day:hover {
                background-color: #f0f8ff !important;
                cursor: pointer;
                transition: background-color 0.2s ease;
            }
            
            .shift-card {
                transition: all 0.2s ease;
                cursor: move;
            }
            
            .shift-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            }
            
            /* „Çø„ÉÉ„ÉÅ„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØÂº∑Âåñ */
            button:active, .btn:active, .tab-btn:active {
                transform: scale(0.95);
                transition: transform 0.1s ease;
            }
            
            /* „Çπ„Éû„Éõ„Åß„ÅÆÈÅ∏ÊäûÁ¶ÅÊ≠¢ */
            .calendar-day, .shift-card, .tab-btn {
                -webkit-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
                -webkit-tap-highlight-color: transparent;
            }
        `;
        document.head.appendChild(animationStyles);

        // ========== „Ç¢„Éó„É™ÂàùÊúüÂåñ ==========
        function initializeApp() {
            console.log('üöÄ Êâ∂È§ä„Éó„É≠ÂàùÊúüÂåñÈñãÂßã...');
            
            try {
                // PWA Ê©üËÉΩÂàùÊúüÂåñ
                initializePWA();
                
                // „É¢„Éê„Ç§„É´ÊúÄÈÅ©Âåñ
                optimizeForMobile();
                
                // üÜï „Çø„ÉÉ„ÉÅÂèçÂøúÊÄßÂº∑Âåñ
                enhanceTouchResponsiveness();
                
                // AI „Çµ„Éº„Éì„ÇπÂàùÊúüÂåñ
                initializeAIService();
                
                // ÊúÄÈÅ©Âåñ„Ç®„É≥„Ç∏„É≥ÂàùÊúüÂåñ
                initializeOptimizationEngine();
                
                // Êà¶Áï•ÁöÑÊ©üËÉΩ„ÅÆÂàùÊúüÂåñ
                initializeStrategicFeatures();
                
                // üÜï „Ç∑„Éï„Éà„Éú„Éº„Éâ„É©„Ç§„ÇØ„Å™UXÂàùÊúüÂåñ
                initializeShiftBoardUX();
                
                // „Çø„Éñ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ÔºàÂº∑ÂåñÁâàÔºâ
                initializeEnhancedNavigation();
                
                // ÁîªÂÉè„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ
                const imageInput = document.getElementById('imageInput');
                if (imageInput) {
                    imageInput.addEventListener('change', handleImageUpload);
                }
                
                // „Çπ„Éû„Éõ„Ç≠„Éº„Éú„Éº„ÉâÂØæÂøú„ÅÆÂàùÊúüÂåñ
                initializeKeyboardHandling();
            
                // „Éê„ÉÉ„ÇØ„Ç∞„É©„Ç¶„É≥„Éâ„Çø„Çπ„ÇØ„ÅÆ„Çπ„Ç±„Ç∏„É•„Éº„É´
                scheduleBackgroundTasks();
                
                // ÂàùÊúüË°®Á§∫Êõ¥Êñ∞
                updateFuyouStatus();
                updateCalendar();
                updateWorkplaceList();
                updateAnalytics();

                // URL „Éë„É©„É°„Éº„Çø„ÅÆÂá¶ÁêÜ
                handleURLParameters();
                
                console.log('‚úÖ Êâ∂È§ä„Éó„É≠ÂàùÊúüÂåñÂÆå‰∫ÜÔºÅ');
                
                // ÊàêÂäü„É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫
                showToast('üöÄ Êâ∂È§ä„Éó„É≠„ÅåËµ∑Âãï„Åó„Åæ„Åó„Åü', 'success');
                
            } catch (error) {
                console.error('‚ùå ÂàùÊúüÂåñ„Ç®„É©„Éº:', error);
                showToast('‚ö†Ô∏è ÂàùÊúüÂåñ‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü', 'error');
                
                // „Ç®„É©„Éº„Åß„ÇÇÂü∫Êú¨Ê©üËÉΩ„ÅØÂãï‰Ωú„Åô„Çã„Çà„ÅÜ„Å´
                try {
                    updateFuyouStatus();
                    updateCalendar();
                } catch (fallbackError) {
                    console.error('‚ùå „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÂàùÊúüÂåñ„ÇÇÂ§±Êïó:', fallbackError);
                }
            }
        }

        function handleURLParameters() {
            const params = new URLSearchParams(window.location.search);
            
            if (params.has('tab')) {
                const tab = params.get('tab');
                switchTab(tab);
            }
            
            if (params.has('action')) {
                const action = params.get('action');
                if (action === 'add-shift') {
                    // „Ç∑„Éï„ÉàËøΩÂä†ÁîªÈù¢„ÇíÈñã„Åè
                    setTimeout(() => {
                        const today = new Date().getDate();
                        handleDateClick(today);
                    }, 500);
                }
            }
        }

        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>